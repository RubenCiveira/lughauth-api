# @autogenerated
# Etapa 1: Instalación de dependencias con Composer
FROM composer:latest AS build

ARG AUTH_JSON_PATH

# Establece el directorio de trabajo
WORKDIR /app

# Copia solo los archivos necesarios para Composer
COPY  .auth.json auth.json
COPY composer.json composer.lock ./

# Instala las dependencias con todas las optimizaciones posibles
RUN composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

# Usa una imagen base de PHP con FPM
FROM php:8.3-fpm

# Instala Nginx y otras extensiones necesarias para PHP
RUN apt-get update && apt-get install -y nginx \
    libgmp-dev libpq-dev libmariadb-dev libzip-dev libcurl4-openssl-dev unzip \
    && docker-php-ext-install zip pdo pdo_pgsql pgsql pdo_mysql gmp bcmath opcache curl

# Variables de entorno para OPcache
ENV PHP_OPCACHE_ENABLE=1
ENV PHP_OPCACHE_MEMORY_CONSUMPTION=128
ENV PHP_OPCACHE_MAX_ACCELERATED_FILES=10000
ENV PHP_OPCACHE_VALIDATE_TIMESTAMPS=0
ENV PHP_OPCACHE_REVALIDATE_FREQ=0

# Crea el archivo de configuración de Nginx
RUN cat <<'EOF' > /etc/nginx/nginx.conf
user www-data;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;

    gzip on;
    gzip_types text/plain application/json application/javascript text/css;

    server {
        listen 80;
        root /var/www/html;
        index index.php index.html index.htm;

        location / {
            try_files $uri /public/index.php$is_args$args;
        }

        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
            fastcgi_index index.php;
            fastcgi_pass unix:/run/php/php-fpm.sock;
        }

        location ~ /\.ht {
            deny all;
        }
    }
}
EOF

# Crea el archivo de configuración de PHP-FPM www.conf
RUN cat <<'EOF' > /usr/local/etc/php-fpm.d/zz-docker.conf
[www]
user = www-data
group = www-data
listen = /run/php/php-fpm.sock
listen.owner = www-data
listen.group = www-data
pm = dynamic
pm.max_children = 10
pm.start_servers = 3
pm.min_spare_servers = 2
pm.max_spare_servers = 5
EOF

# Crea el directorio de socket para PHP-FPM
RUN mkdir -p /run/php && chown www-data:www-data /run/php

# Crear el script de inicio directamente en el Dockerfile
RUN cat <<'EOF' > /start.sh
#!/bin/bash

# Inicia PHP-FPM en segundo plano
php-fpm &

# Inicia Nginx en primer plano
nginx -g "daemon off;"
EOF

RUN chmod +x /start.sh

# Copia el proyecto al directorio /var/www/html
COPY ./config /var/www/html/config
COPY ./database /var/www/html/database
COPY ./public /var/www/html/public
COPY ./resources /var/www/html/resources
COPY ./src /var/www/html/src
COPY --from=build /app/vendor /var/www/html/vendor

# Cambia los permisos
RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

# Expon el puerto 80
EXPOSE 80

# Inicia Nginx y PHP-FPM juntos
CMD ["/start.sh"]
