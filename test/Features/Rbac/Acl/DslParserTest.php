<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;

final class DslParserTest extends TestCase
{
    public function testLoadMatcherAll()
    {
        $dsl = <<<DSL
          match * {
              actions {
                  allow * if role == "ADMIN"
              }
              attributes {
                  view {
                      allow * if role == "ADMIN"
                  }
                  modify {
                      allow * if role == "ADMIN"
                  }
              }
          }
      DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $this->assertArrayHasKey('matches', $result);
        $this->assertArrayHasKey('*', $result['matches']);
        $this->assertArrayHasKey('actions', $result['matches']['*']);
        $this->assertArrayHasKey('attributes:view', $result['matches']['*']);
        $this->assertArrayHasKey('attributes:modify', $result['matches']['*']);
    }

    public function testParseRoleInheritance(): void
    {
        $dsl = <<<DSL
            role editor extends viewer;
            role admin extends editor;
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $this->assertArrayHasKey('roles', $result);
        $this->assertEquals(['viewer'], $result['roles']['editor']['inherits']);
        $this->assertEquals(['editor'], $result['roles']['admin']['inherits']);
    }

    public function testParseResourceInheritance(): void
    {
        $dsl = <<<DSL
            resource comment extends message;
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $this->assertArrayHasKey('resources', $result);
        $this->assertEquals(['message'], $result['resources']['comment']['inherits']);
    }

    public function testParseSimpleActionsBlock(): void
    {
        $dsl = <<<DSL
            match post {
              actions {
                allow read, list if role == "admin";
                deny delete if role != "admin";
              }
            }
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $actions = $result['matches']['post']['actions'];
        $this->assertCount(2, $actions);
        $this->assertEquals('allow', $actions[0]['effect']);
        $this->assertEquals(['read', 'list'], $actions[0]['items']);
    }

    public function testParseNestedAttributes(): void
    {
        $dsl = <<<DSL
            match user {
              attributes {
                view {
                  allow name, email if role in ("admin", "editor");
                  deny password if role != "admin";
                }
                modify {
                  allow email if role == "admin";
                }
              }
            }
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $attrsView = $result['matches']['user']['attributes:view'];
        $attrsMod  = $result['matches']['user']['attributes:modify'];

        $this->assertCount(2, $attrsView);
        $this->assertEquals('deny', $attrsView[1]['effect']);
        $this->assertEquals('modify', explode(':', array_keys($result['matches']['user'])[1])[1]);
        $this->assertEquals(['email'], $attrsMod[0]['items']);
    }

    public function testParseConditions(): void
    {
        $dsl = <<<DSL
            match config {
              actions {
                allow update if role == "admin";
                allow read if role in ("admin", "viewer");
                deny delete if role not in ("admin");
              }
            }
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $actions = $result['matches']['config']['actions'];
        $this->assertEquals(['==' => ['role' => 'admin']], $actions[0]['condition']);
        $this->assertEquals(['in' => ['role' => ['admin', 'viewer']]], $actions[1]['condition']);
        $this->assertEquals(['not_in' => ['role' => ['admin']]], $actions[2]['condition']);
    }

    public function testParseAttributeBlocksAreTaggedCorrectly(): void
    {
        $dsl = <<<DSL
            match document {
              attributes {
                view {
                  allow title, author if role == "editor";
                }
                modify {
                  allow title if role == "admin";
                  deny author if role != "admin";
                }
              }
            }
        DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $this->assertArrayHasKey('matches', $result);
        $this->assertArrayHasKey('document', $result['matches']);

        $match = $result['matches']['document'];

        $this->assertArrayHasKey('attributes:view', $match);
        $this->assertArrayHasKey('attributes:modify', $match);

        $this->assertCount(1, $match['attributes:view']);
        $this->assertEquals('allow', $match['attributes:view'][0]['effect']);
        $this->assertEquals(['title', 'author'], $match['attributes:view'][0]['items']);

        $this->assertCount(2, $match['attributes:modify']);
        $this->assertEquals('allow', $match['attributes:modify'][0]['effect']);
        $this->assertEquals(['title'], $match['attributes:modify'][0]['items']);
        $this->assertEquals('deny', $match['attributes:modify'][1]['effect']);
    }

    public function testParseSpecialFlags(): void
    {
        $dsl = <<<DSL
        match resource {
            actions {
                allow read if @everyone;
                allow write if @authenticated;
                deny delete if @anonymous;
            }
        }
    DSL;

        $parser = new DslParser();
        $result = $parser->parse($dsl);

        $actions = $result['matches']['resource']['actions'];

        $this->assertCount(3, $actions);

        $this->assertEquals('allow', $actions[0]['effect']);
        $this->assertEquals(['read'], $actions[0]['items']);
        $this->assertEquals(['flag' => '@everyone'], $actions[0]['condition']);

        $this->assertEquals('allow', $actions[1]['effect']);
        $this->assertEquals(['write'], $actions[1]['items']);
        $this->assertEquals(['flag' => '@authenticated'], $actions[1]['condition']);

        $this->assertEquals('deny', $actions[2]['effect']);
        $this->assertEquals(['delete'], $actions[2]['items']);
        $this->assertEquals(['flag' => '@anonymous'], $actions[2]['condition']);
    }
}
