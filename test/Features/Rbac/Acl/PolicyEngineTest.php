<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Tests\Features\Rbac\Acl\Application;

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Rbac\Acl\Application\PolicyEngine;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;
use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;

class PolicyEngineTest extends TestCase
{
    private function parseRules(string $dsl): RuleSet
    {
        $parser = new DslParser();
        $array = $parser->parse($dsl);
        return RuleSet::fromArray($array);
    }

    public function testSimpleAllowView()
    {
        $dsl = <<<DSL
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['viewer']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'viewer' => [
                'article' => [
                    'hidden' => ['author'],
                    'readonly' => ['title', 'content']
                ]
            ]
        ], $result);
    }

    public function stestInheritedModify()
    {
        $dsl = <<<DSL
            role editor extends viewer;
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'hidden' => ['author'],
                    'readonly' => ['title']
                ]
            ]
        ], $result);
    }

    public function testDenyOverridesAllow()
    {
        $dsl = <<<DSL
            role editor extends viewer;

            match article {
              attributes {
                view {
                  allow title, content, author if role == "editor";
                  deny author if role == "editor";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'hidden' => ['author'],
                    'readonly' => ['title']
                ]
            ]
        ], $result);
    }

    public function testNoPermissionImpliesDeny()
    {
        $dsl = <<<DSL
            role guest extends none;

            match article {
              attributes {
                view {
                  allow title if role == "viewer";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'article' => [
                    'hidden' => ['title', 'content'],
                    'readonly' => []
                ]
            ]
        ], $result);
    }


    public function testModifyInheritedFromEditor()
    {
        $dsl = <<<DSL
        role editor extends viewer;

        match article {
          attributes {
            view {
              allow title, content if role == "viewer";
            }
            modify {
              allow content if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'hidden' => ['author'],
                    'readonly' => ['title']
                ]
            ]
        ], $result);
    }

    public function testDenyOverridesAllowForView()
    {
        $dsl = <<<DSL
        match article {
          attributes {
            view {
              allow title, content, author if role == "editor";
              deny author if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'hidden' => ['author'],
                    'readonly' => ['title', 'content']
                ]
            ]
        ], $result);
    }

    public function testWildcardAllow()
    {
        $dsl = <<<DSL
        match config {
          attributes {
            view {
              allow * if role == "admin";
            }
            modify {
              allow setting1, setting2 if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'config' => ['attributes' => ['setting1', 'setting2', 'hiddenSetting']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'admin' => [
                'config' => [
                    'hidden' => [],
                    'readonly' => ['hiddenSetting']
                ]
            ]
        ], $result);
    }

    public function testMultipleRolesCombinedPermissions()
    {
        $dsl = <<<DSL

        match report {
          attributes {
            view {
              allow summary if role == "auditor";
              allow fullText if role == "editor";
            }
            modify {
              allow fullText if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor', 'auditor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'report' => ['attributes' => ['summary', 'fullText']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'report' => [
                    'hidden' => ['summary'],
                    'readonly' => []
                ]
            ],
            'auditor' => [
                'report' => [
                    'hidden' => ['fullText'],
                    'readonly' => ['summary']
                ]
            ]
        ], $result);
    }

    public function testNoPermissionsImpliedDeny()
    {
        $dsl = <<<DSL
        match dashboard {
          attributes {
            view {
              allow stats if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'dashboard' => ['attributes' => ['stats', 'metrics']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'dashboard' => [
                    'hidden' => ['stats', 'metrics'],
                    'readonly' => []
                ]
            ]
        ], $result);
    }
}
