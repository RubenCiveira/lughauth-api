<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Tests\Features\Rbac\Acl\Application;

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Rbac\Acl\Application\PolicyEngine;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;
use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;

class PolicyEngineTest extends TestCase
{
    private function parseRules(string $dsl): RuleSet
    {
        $parser = new DslParser();
        $array = $parser->parse($dsl);
        return RuleSet::fromArray($array);
    }

    public function testSimpleAllowView()
    {
        $dsl = <<<DSL
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['viewer']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'viewer' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testInheritedModify()
    {
        $dsl = <<<DSL
            role editor extends viewer;
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content']
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testAllAllowedForAdmin()
    {
        $dsl = <<<DSL
          match * {
              actions {
                  allow * if role == "ADMIN"
              }
              attributes {
                  view {
                      allow * if role == "ADMIN"
                  }
                  modify {
                      allow * if role == "ADMIN"
                  }
              }
          }
      DSL;
        $engine = new PolicyEngine();
        $engine->setRoles(['ADMIN']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
          'article' => [
            'attributes' => ['title', 'content', 'author']
            ]
          ]);

        $result = $engine->expand();
        $this->assertEquals([
            'ADMIN' => [
                'article' => [
                    'view' => ['title', 'content', 'author'],
                    'modify' => ['title', 'content', 'author']
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testDenyOverridesAllow()
    {
        $dsl = <<<DSL
            role editor extends viewer;

            match article {
              attributes {
                view {
                  allow title, content, author if role == "editor";
                  deny author if role == "editor";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content']
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testNoPermissionImpliesDeny()
    {
        $dsl = <<<DSL
            role guest extends none;

            match article {
              attributes {
                view {
                  allow title if role == "viewer";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'article' => [
                    'view' => [],
                    'modify' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testModifyInheritedFromEditor()
    {
        $dsl = <<<DSL
        role editor extends viewer;

        match article {
          attributes {
            view {
              allow title, content if role == "viewer";
            }
            modify {
              allow content if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content']
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testDenyOverridesAllowForView()
    {
        $dsl = <<<DSL
        match article {
          attributes {
            view {
              allow title, content, author if role == "editor";
              deny author if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testWildcardAllow()
    {
        $dsl = <<<DSL
        match config {
          attributes {
            view {
              allow * if role == "admin";
            }
            modify {
              allow setting1, setting2 if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'config' => ['attributes' => ['setting1', 'setting2', 'hiddenSetting']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'admin' => [
                'config' => [
                    'view' => ['setting1', 'setting2', 'hiddenSetting'],
                    'modify' => ['setting1', 'setting2']
                ]
            ],
            '@everyone' => [
              'config' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'config' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'config' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testMultipleRolesCombinedPermissions()
    {
        $dsl = <<<DSL

        match report {
          attributes {
            view {
              allow summary if role == "auditor";
              allow fullText if role == "editor";
            }
            modify {
              allow fullText if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor', 'auditor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'report' => ['attributes' => ['summary', 'fullText']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'report' => [
                    'view' => ['fullText'],
                    'modify' => ['fullText']
                ]
            ],
            'auditor' => [
                'report' => [
                    'view' => ['summary'],
                    'modify' => []
                ]
            ],
            '@everyone' => [
              'report' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'report' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'report' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testNoPermissionsImpliedDeny()
    {
        $dsl = <<<DSL
        match dashboard {
          attributes {
            view {
              allow stats if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'dashboard' => ['attributes' => ['stats', 'metrics']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'dashboard' => [
                    'view' => [],
                    'modify' => []
                ]
            ],
            '@everyone' => [
              'dashboard' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@authenticated' => [
              'dashboard' => [
                'view' => [],
                'modify' => []
              ]
            ],
            '@anonymous' => [
              'dashboard' => [
                'view' => [],
                'modify' => []
              ]
          ]
        ], $result);
    }

    public function testSpecialFlagsInConditions()
    {
        $dsl = <<<DSL
            match article {
                attributes {
                    view {
                        allow title if @everyone;
                        allow content if @authenticated;
                        allow author if role == "admin";
                        deny content if @anonymous;
                    }
                }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $engine->setRoles([]);
        $resultAnon = $engine->expand();

        $this->assertEquals([
            '@everyone' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => []
                ]
            ],
            '@authenticated' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => []
                ]
            ],
            '@anonymous' => [
                'article' => [
                    'view' => ['title'],
                    'modify' => []
                ]
            ]
        ], $resultAnon);
    }

    public function testRoleNotIn()
    {
        $dsl = <<<DSL
        match config {
            attributes {
                view {
                    allow setting1, setting2 if role not in ("guest");
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'config' => ['attributes' => ['setting1', 'setting2']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['setting1', 'setting2'], $result['admin']['config']['view']);
    }

    public function testWildcardWithPartialDeny()
    {
        $dsl = <<<DSL
        match user {
            attributes {
                view {
                    allow * if role == "admin";
                    deny email if role == "admin";
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'user' => ['attributes' => ['name', 'email', 'address']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['name', 'address'], $result['admin']['user']['view']);
    }

    public function testMultipleInheritance()
    {
        $dsl = <<<DSL
        role editor extends viewer, contributor;
        role viewer extends guest;

        match article {
            attributes {
                view {
                    allow title if role == "viewer";
                    allow summary if role == "contributor";
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'summary']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['title', 'summary'], $result['editor']['article']['view']);
    }

}
