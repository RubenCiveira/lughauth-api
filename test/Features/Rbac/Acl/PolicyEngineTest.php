<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Tests\Features\Rbac\Acl\Application;

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Rbac\Acl\Application\PolicyEngine;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;
use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;

class PolicyEngineTest extends TestCase
{
    private function parseRules(string $dsl): RuleSet
    {
        $parser = new DslParser();
        $array = $parser->parse($dsl);
        return RuleSet::fromArray($array);
    }

    public function testSimpleAllowView()
    {
        $dsl = <<<DSL
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['viewer']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'viewer' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testInheritedModify()
    {
        $dsl = <<<DSL
            role editor extends viewer;
            role viewer extends guest;

            match article {
              attributes {
                view {
                  allow title, content if role == "viewer";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content'],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testAllAllowedForAdmin()
    {
        $dsl = <<<DSL
          match * {
              actions {
                  allow * if role == "ADMIN"
              }
              attributes {
                  view {
                      allow * if role == "ADMIN"
                  }
                  modify {
                      allow * if role == "ADMIN"
                  }
              }
          }
      DSL;
        $engine = new PolicyEngine();
        $engine->setRoles(['ADMIN']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
          'article' => [
            'attributes' => ['title', 'content', 'author']
            ]
          ]);

        $result = $engine->expand();
        $this->assertEquals([
            'ADMIN' => [
                'article' => [
                    'view' => ['title', 'content', 'author'],
                    'modify' => ['title', 'content', 'author'],
                    'actions' => []
                  ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testDenyOverridesAllow()
    {
        $dsl = <<<DSL
            role editor extends viewer;

            match article {
              attributes {
                view {
                  allow title, content, author if role == "editor";
                  deny author if role == "editor";
                }
                modify {
                  allow content if role == "editor";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content'],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testNoPermissionImpliesDeny()
    {
        $dsl = <<<DSL
            role guest extends none;

            match article {
              attributes {
                view {
                  allow title if role == "viewer";
                }
              }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'article' => [
                    'view' => [],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testModifyInheritedFromEditor()
    {
        $dsl = <<<DSL
        role editor extends viewer;

        match article {
          attributes {
            view {
              allow title, content if role == "viewer";
            }
            modify {
              allow content if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author'],
                    'actions' => []]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => ['content'],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testDenyOverridesAllowForView()
    {
        $dsl = <<<DSL
        match article {
          attributes {
            view {
              allow title, content, author if role == "editor";
              deny author if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author'],
                    'actions' => []]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'article' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testWildcardAllow()
    {
        $dsl = <<<DSL
        match config {
          attributes {
            view {
              allow * if role == "admin";
            }
            modify {
              allow setting1, setting2 if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'config' => ['attributes' => ['setting1', 'setting2', 'hiddenSetting']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'admin' => [
                'config' => [
                    'view' => ['setting1', 'setting2', 'hiddenSetting'],
                    'modify' => ['setting1', 'setting2'],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'config' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'config' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'config' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testMultipleRolesCombinedPermissions()
    {
        $dsl = <<<DSL

        match report {
          attributes {
            view {
              allow summary if role == "auditor";
              allow fullText if role == "editor";
            }
            modify {
              allow fullText if role == "editor";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor', 'auditor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'report' => ['attributes' => ['summary', 'fullText'],
                    'actions' => []]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'editor' => [
                'report' => [
                    'view' => ['fullText'],
                    'modify' => ['fullText'],
                    'actions' => []
                ]
            ],
            'auditor' => [
                'report' => [
                    'view' => ['summary'],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'report' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'report' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'report' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testNoPermissionsImpliedDeny()
    {
        $dsl = <<<DSL
        match dashboard {
          attributes {
            view {
              allow stats if role == "admin";
            }
          }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['guest']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'dashboard' => ['attributes' => ['stats', 'metrics']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([
            'guest' => [
                'dashboard' => [
                    'view' => [],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@everyone' => [
              'dashboard' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@authenticated' => [
              'dashboard' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
            ],
            '@anonymous' => [
              'dashboard' => [
                'view' => [],
                'modify' => [],
                    'actions' => []
              ]
          ]
        ], $result);
    }

    public function testSpecialFlagsInConditions()
    {
        $dsl = <<<DSL
            match article {
                attributes {
                    view {
                        allow title if @everyone;
                        allow content if @authenticated;
                        allow author if role == "admin";
                        deny content if @anonymous;
                    }
                }
            }
        DSL;

        $engine = new PolicyEngine();
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);

        $engine->setRoles([]);
        $resultAnon = $engine->expand();

        $this->assertEquals([
            '@everyone' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@authenticated' => [
                'article' => [
                    'view' => ['title', 'content'],
                    'modify' => [],
                    'actions' => []
                ]
            ],
            '@anonymous' => [
                'article' => [
                    'view' => ['title'],
                    'modify' => [],
                    'actions' => []
                ]
            ]
        ], $resultAnon);
    }

    public function testRoleNotIn()
    {
        $dsl = <<<DSL
        match config {
            attributes {
                view {
                    allow setting1, setting2 if role not in ("guest");
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'config' => ['attributes' => ['setting1', 'setting2']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['setting1', 'setting2'], $result['admin']['config']['view']);
    }

    public function testWildcardWithPartialDeny()
    {
        $dsl = <<<DSL
        match user {
            attributes {
                view {
                    allow * if role == "admin";
                    deny email if role == "admin";
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'user' => ['attributes' => ['name', 'email', 'address']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['name', 'address'], $result['admin']['user']['view']);
    }

    public function testMultipleInheritance()
    {
        $dsl = <<<DSL
        role editor extends viewer, contributor;
        role viewer extends guest;

        match article {
            attributes {
                view {
                    allow title if role == "viewer";
                    allow summary if role == "contributor";
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'article' => ['attributes' => ['title', 'summary']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['title', 'summary'], $result['editor']['article']['view']);
    }

    public function testAllowActionsExplicit()
    {
        $dsl = <<<DSL
        match invoice {
            actions {
                allow download, archive if role == accountant;
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['accountant']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'invoice' => ['attributes' => [], 'actions' => ['download', 'archive', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['download', 'archive'], $result['accountant']['invoice']['actions']);
    }

    public function testAllowAllActionsWildcard()
    {
        $dsl = <<<DSL
        match invoice {
            actions {
                allow * if role == admin;
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'invoice' => ['attributes' => [], 'actions' => ['download', 'archive', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['download', 'archive', 'delete'], $result['admin']['invoice']['actions']);
    }

    public function testWildcardActionAllowWithSpecificDeny()
    {
        $dsl = <<<DSL
        match adminPanel {
            actions {
                allow * if role == admin;
                deny delete if role == admin;
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['admin']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'adminPanel' => ['attributes' => [], 'actions' => ['view', 'edit', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['view', 'edit'], $result['admin']['adminPanel']['actions']);
    }

    public function testMultipleRolesCombineActionPermissions()
    {
        $dsl = <<<DSL
        match reports {
            actions {
                allow download if role == viewer;
                allow archive if role == editor;
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['viewer', 'editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'reports' => ['attributes' => [], 'actions' => ['download', 'archive', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['download'], $result['viewer']['reports']['actions']);
        $this->assertEquals(['archive'], $result['editor']['reports']['actions']);
    }

    public function testNoActionRulesMeansNoActionsAllowed()
    {
        $dsl = <<<DSL
        match files {
            attributes {
                view {
                    allow name if role == user;
                }
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['user']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'files' => ['attributes' => ['name'], 'actions' => ['download', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals([], $result['user']['files']['actions']);
    }

    public function testActionAllowForNotInRole()
    {
        $dsl = <<<DSL
        match documents {
            actions {
                allow edit if role not in ("guest");
            }
        }
    DSL;

        $engine = new PolicyEngine();
        $engine->setRoles(['editor']);
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setResources([
            'documents' => ['attributes' => [], 'actions' => ['edit', 'delete']]
        ]);

        $result = $engine->expand();

        $this->assertEquals(['edit'], $result['editor']['documents']['actions']);
    }
}
