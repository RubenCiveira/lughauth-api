<?php

# @autogenerated
declare(strict_types=1);

use Civi\Lughauth\Features\Access\User\Domain\UserRef;
use Civi\Lughauth\Shared\Security\AesCypherService;
use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\UserAccessTemporalCode;

final class UserAccessTemporalCodeUnitTest extends TestCase
{
    public function test_init_store_values(): void
    {
        // @Arrange
        $one = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );

        // @Act
        $other = $one->toAttributes()->build();

        // @Assert
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getUser(), $other->getUser());
        $this->assertTrue($one->isUserChanged());
        $this->assertEquals($one->getTempSecondFactorSeed(), $other->getTempSecondFactorSeed());
        $this->assertTrue($one->isTempSecondFactorSeedChanged());
        $this->assertEquals($one->getTempSecondFactorSeedExpiration(), $other->getTempSecondFactorSeedExpiration());
        $this->assertTrue($one->isTempSecondFactorSeedExpirationChanged());
        $this->assertEquals($one->getRegisterCode(), $other->getRegisterCode());
        $this->assertTrue($one->isRegisterCodeChanged());
        $this->assertEquals($one->getRegisterCodeUrl(), $other->getRegisterCodeUrl());
        $this->assertTrue($one->isRegisterCodeUrlChanged());
        $this->assertEquals($one->getRegisterCodeExpiration(), $other->getRegisterCodeExpiration());
        $this->assertTrue($one->isRegisterCodeExpirationChanged());
        $this->assertEquals($one->getRecoveryCode(), $other->getRecoveryCode());
        $this->assertTrue($one->isRecoveryCodeChanged());
        $this->assertEquals($one->getRecoveryCodeExpiration(), $other->getRecoveryCodeExpiration());
        $this->assertTrue($one->isRecoveryCodeExpirationChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
    }
    public function test_replace_change_values(): void
    {
        // @Arrange
        $base = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $other = new UserAccessTemporalCode(
            uid: 'other',
            user: new UserRef('other'),
            tempSecondFactorSeed: 'cyphered://ocyphered',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            failedLoginAttempts: 2,
            registerCode: 'other',
            registerCodeUrl: 'other',
            registerCodeExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            recoveryCode: 'other',
            recoveryCodeExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            version: 2,
        );

        // @Act
        $one = $base->replace($other->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $base->uid());
        $this->assertEquals($one->getUser(), $other->getUser());
        $this->assertTrue($one->isUserChanged($base));
        $this->assertEquals($one->getTempSecondFactorSeed(), $other->getTempSecondFactorSeed());
        $this->assertTrue($one->isTempSecondFactorSeedChanged($base));
        $this->assertEquals($one->getTempSecondFactorSeedExpiration(), $other->getTempSecondFactorSeedExpiration());
        $this->assertTrue($one->isTempSecondFactorSeedExpirationChanged($base));
        $this->assertEquals($one->getRegisterCode(), $other->getRegisterCode());
        $this->assertTrue($one->isRegisterCodeChanged($base));
        $this->assertEquals($one->getRegisterCodeUrl(), $other->getRegisterCodeUrl());
        $this->assertTrue($one->isRegisterCodeUrlChanged($base));
        $this->assertEquals($one->getRegisterCodeExpiration(), $other->getRegisterCodeExpiration());
        $this->assertTrue($one->isRegisterCodeExpirationChanged($base));
        $this->assertEquals($one->getRecoveryCode(), $other->getRecoveryCode());
        $this->assertTrue($one->isRecoveryCodeChanged($base));
        $this->assertEquals($one->getRecoveryCodeExpiration(), $other->getRecoveryCodeExpiration());
        $this->assertTrue($one->isRecoveryCodeExpirationChanged($base));
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged($base));
    }
    public function test_json_compare(): void
    {
        // @Arrange
        $one = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );

        // @Act
        $json = $one->asPublicJson();

        // @Assert
        $this->assertEquals('one', $json['uid']);
        $this->assertEquals('one', $json['user']['$ref']);
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $json['tempSecondFactorSeedExpiration']);
        $this->assertEquals(1, $json['failedLoginAttempts']);
        $this->assertEquals('one', $json['registerCode']);
        $this->assertEquals('one', $json['registerCodeUrl']);
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $json['registerCodeExpiration']);
        $this->assertEquals('one', $json['recoveryCode']);
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $json['recoveryCodeExpiration']);
        $this->assertEquals(1, $json['version']);
    }
    public function test_create_store_values(): void
    {
        // @Arrange
        $one = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );

        // @Act
        $other = UserAccessTemporalCode::create($one->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getUser(), $other->getUser());
        $this->assertTrue($one->isUserChanged());
        $this->assertEquals($one->getTempSecondFactorSeed(), $other->getTempSecondFactorSeed());
        $this->assertTrue($one->isTempSecondFactorSeedChanged());
        $this->assertEquals($one->getTempSecondFactorSeedExpiration(), $other->getTempSecondFactorSeedExpiration());
        $this->assertTrue($one->isTempSecondFactorSeedExpirationChanged());
        $this->assertEquals($one->getRegisterCode(), $other->getRegisterCode());
        $this->assertTrue($one->isRegisterCodeChanged());
        $this->assertEquals($one->getRegisterCodeUrl(), $other->getRegisterCodeUrl());
        $this->assertTrue($one->isRegisterCodeUrlChanged());
        $this->assertEquals($one->getRegisterCodeExpiration(), $other->getRegisterCodeExpiration());
        $this->assertTrue($one->isRegisterCodeExpirationChanged());
        $this->assertEquals($one->getRecoveryCode(), $other->getRecoveryCode());
        $this->assertTrue($one->isRecoveryCodeChanged());
        $this->assertEquals($one->getRecoveryCodeExpiration(), $other->getRecoveryCodeExpiration());
        $this->assertTrue($one->isRecoveryCodeExpirationChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
        $this->assertCount(0, $one->getTheEvents());
        $this->assertCount(1, $other->getTheEvents());
    }
    public function test_update_change_values(): void
    {
        $base = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $other = new UserAccessTemporalCode(
            uid: 'other',
            user: new UserRef('other'),
            tempSecondFactorSeed: 'cyphered://ocyphered',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            failedLoginAttempts: 2,
            registerCode: 'other',
            registerCodeUrl: 'other',
            registerCodeExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            recoveryCode: 'other',
            recoveryCodeExpiration: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            version: 2,
        );

        // @Act
        $one = $base->update($other->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $base->uid());
        $this->assertEquals($one->getUser(), $other->getUser());
        $this->assertTrue($one->isUserChanged($base));
        $this->assertEquals($one->getTempSecondFactorSeed(), $other->getTempSecondFactorSeed());
        $this->assertTrue($one->isTempSecondFactorSeedChanged($base));
        $this->assertEquals($one->getTempSecondFactorSeedExpiration(), $other->getTempSecondFactorSeedExpiration());
        $this->assertTrue($one->isTempSecondFactorSeedExpirationChanged($base));
        $this->assertEquals($one->getRegisterCode(), $other->getRegisterCode());
        $this->assertTrue($one->isRegisterCodeChanged($base));
        $this->assertEquals($one->getRegisterCodeUrl(), $other->getRegisterCodeUrl());
        $this->assertTrue($one->isRegisterCodeUrlChanged($base));
        $this->assertEquals($one->getRegisterCodeExpiration(), $other->getRegisterCodeExpiration());
        $this->assertTrue($one->isRegisterCodeExpirationChanged($base));
        $this->assertEquals($one->getRecoveryCode(), $other->getRecoveryCode());
        $this->assertTrue($one->isRecoveryCodeChanged($base));
        $this->assertEquals($one->getRecoveryCodeExpiration(), $other->getRecoveryCodeExpiration());
        $this->assertTrue($one->isRecoveryCodeExpirationChanged($base));
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged($base));
        $this->assertCount(0, $other->getTheEvents());
        $this->assertCount(1, $one->getTheEvents());
    }
    public function test_delete_store_values(): void
    {
        // @Arrange
        $one = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );

        // @Act
        $other = $one->delete();

        // @Assert
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getUser(), $other->getUser());
        $this->assertTrue($one->isUserChanged());
        $this->assertEquals($one->getTempSecondFactorSeed(), $other->getTempSecondFactorSeed());
        $this->assertTrue($one->isTempSecondFactorSeedChanged());
        $this->assertEquals($one->getTempSecondFactorSeedExpiration(), $other->getTempSecondFactorSeedExpiration());
        $this->assertTrue($one->isTempSecondFactorSeedExpirationChanged());
        $this->assertEquals($one->getRegisterCode(), $other->getRegisterCode());
        $this->assertTrue($one->isRegisterCodeChanged());
        $this->assertEquals($one->getRegisterCodeUrl(), $other->getRegisterCodeUrl());
        $this->assertTrue($one->isRegisterCodeUrlChanged());
        $this->assertEquals($one->getRegisterCodeExpiration(), $other->getRegisterCodeExpiration());
        $this->assertTrue($one->isRegisterCodeExpirationChanged());
        $this->assertEquals($one->getRecoveryCode(), $other->getRecoveryCode());
        $this->assertTrue($one->isRecoveryCodeChanged());
        $this->assertEquals($one->getRecoveryCodeExpiration(), $other->getRecoveryCodeExpiration());
        $this->assertTrue($one->isRecoveryCodeExpirationChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
    }
    public function test_mark_login_fail_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceFailedLoginAttempts = 1;
        $targetFailedLoginAttempts = $source->getFailedLoginAttempts() + 1 ;
        $source = $source->withFailedLoginAttempts($sourceFailedLoginAttempts);

        // @Act
        $target = $source->markLoginFail();

        // @Assert
        $this->assertEquals(1, $source->getFailedLoginAttempts());
        $this->assertEquals($targetFailedLoginAttempts, $target->getFailedLoginAttempts());
        $this->assertNotEquals($sourceFailedLoginAttempts, $target->getFailedLoginAttempts());
    }
    public function test_mark_login_block_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceFailedLoginAttempts = 1;
        $targetFailedLoginAttempts = 0;
        $source = $source->withFailedLoginAttempts($sourceFailedLoginAttempts);

        // @Act
        $target = $source->markLoginBlock();

        // @Assert
        $this->assertEquals(1, $source->getFailedLoginAttempts());
        $this->assertEquals($targetFailedLoginAttempts, $target->getFailedLoginAttempts());
        $this->assertNotEquals($sourceFailedLoginAttempts, $target->getFailedLoginAttempts());
    }
    public function test_mark_login_ok_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceFailedLoginAttempts = 1;
        $targetFailedLoginAttempts = 0;
        $source = $source->withFailedLoginAttempts($sourceFailedLoginAttempts);

        // @Act
        $target = $source->markLoginOk();

        // @Assert
        $this->assertEquals(1, $source->getFailedLoginAttempts());
        $this->assertEquals($targetFailedLoginAttempts, $target->getFailedLoginAttempts());
        $this->assertNotEquals($sourceFailedLoginAttempts, $target->getFailedLoginAttempts());
    }
    public function test_generate_mfa_temporal_code_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $cypher = $this->createMock(AesCypherService::class);
        $sourceTempSecondFactorSeed = 'cyphered://cypher';
        $targetTempSecondFactorSeed = 'cyphered://ocyphered';
        $source = $source->withTempSecondFactorSeed($sourceTempSecondFactorSeed);
        $sourceTempSecondFactorSeedExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetTempSecondFactorSeedExpiration = (new \DateTimeImmutable('1981-09-06T14:32:45.123Z'));
        $source = $source->withTempSecondFactorSeedExpiration($sourceTempSecondFactorSeedExpiration);

        // @Act
        $target = $source->generateMfaTemporalCode($cypher, $targetTempSecondFactorSeed, $targetTempSecondFactorSeedExpiration);

        // @Assert
        $this->assertEquals('****er', $source->getTempSecondFactorSeed());
        $this->assertEquals('****ed', $target->getTempSecondFactorSeed());
        $this->assertNotEquals($sourceTempSecondFactorSeed, $target->getTempSecondFactorSeed());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getTempSecondFactorSeedExpiration());
        $this->assertEquals((new \DateTimeImmutable('1981-09-06T14:32:45.123Z')), $target->getTempSecondFactorSeedExpiration());
        $this->assertNotEquals($sourceTempSecondFactorSeedExpiration, $target->getTempSecondFactorSeedExpiration());
    }
    public function test_reset_mfa_temporal_code_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceTempSecondFactorSeed = 'cyphered://cypher';
        $targetTempSecondFactorSeed = null;
        $source = $source->withTempSecondFactorSeed($sourceTempSecondFactorSeed);
        $sourceTempSecondFactorSeedExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetTempSecondFactorSeedExpiration = null;
        $source = $source->withTempSecondFactorSeedExpiration($sourceTempSecondFactorSeedExpiration);

        // @Act
        $target = $source->resetMfaTemporalCode();

        // @Assert
        $this->assertEquals('****er', $source->getTempSecondFactorSeed());
        $this->assertEquals($targetTempSecondFactorSeed, $target->getTempSecondFactorSeed());
        $this->assertNotEquals($sourceTempSecondFactorSeed, $target->getTempSecondFactorSeed());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getTempSecondFactorSeedExpiration());
        $this->assertEquals($targetTempSecondFactorSeedExpiration, $target->getTempSecondFactorSeedExpiration());
        $this->assertNotEquals($sourceTempSecondFactorSeedExpiration, $target->getTempSecondFactorSeedExpiration());
    }
    public function test_generated_register_verification_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceRegisterCode = 'one';
        $targetRegisterCode = 'other';
        $source = $source->withRegisterCode($sourceRegisterCode);
        $sourceRegisterCodeUrl = 'one';
        $targetRegisterCodeUrl = 'other';
        $source = $source->withRegisterCodeUrl($sourceRegisterCodeUrl);
        $sourceRegisterCodeExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetRegisterCodeExpiration = (new \DateTimeImmutable('1981-09-06T14:32:45.123Z'));
        $source = $source->withRegisterCodeExpiration($sourceRegisterCodeExpiration);

        // @Act
        $target = $source->generatedRegisterVerification($targetRegisterCode, $targetRegisterCodeUrl, $targetRegisterCodeExpiration);

        // @Assert
        $this->assertEquals('one', $source->getRegisterCode());
        $this->assertEquals('other', $target->getRegisterCode());
        $this->assertNotEquals($sourceRegisterCode, $target->getRegisterCode());
        $this->assertEquals('one', $source->getRegisterCodeUrl());
        $this->assertEquals('other', $target->getRegisterCodeUrl());
        $this->assertNotEquals($sourceRegisterCodeUrl, $target->getRegisterCodeUrl());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getRegisterCodeExpiration());
        $this->assertEquals((new \DateTimeImmutable('1981-09-06T14:32:45.123Z')), $target->getRegisterCodeExpiration());
        $this->assertNotEquals($sourceRegisterCodeExpiration, $target->getRegisterCodeExpiration());
    }
    public function test_reset_register_verification_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceRegisterCode = 'one';
        $targetRegisterCode = null;
        $source = $source->withRegisterCode($sourceRegisterCode);
        $sourceRegisterCodeUrl = 'one';
        $targetRegisterCodeUrl = null;
        $source = $source->withRegisterCodeUrl($sourceRegisterCodeUrl);
        $sourceRegisterCodeExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetRegisterCodeExpiration = null;
        $source = $source->withRegisterCodeExpiration($sourceRegisterCodeExpiration);

        // @Act
        $target = $source->resetRegisterVerification();

        // @Assert
        $this->assertEquals('one', $source->getRegisterCode());
        $this->assertEquals($targetRegisterCode, $target->getRegisterCode());
        $this->assertNotEquals($sourceRegisterCode, $target->getRegisterCode());
        $this->assertEquals('one', $source->getRegisterCodeUrl());
        $this->assertEquals($targetRegisterCodeUrl, $target->getRegisterCodeUrl());
        $this->assertNotEquals($sourceRegisterCodeUrl, $target->getRegisterCodeUrl());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getRegisterCodeExpiration());
        $this->assertEquals($targetRegisterCodeExpiration, $target->getRegisterCodeExpiration());
        $this->assertNotEquals($sourceRegisterCodeExpiration, $target->getRegisterCodeExpiration());
    }
    public function test_generate_password_recover_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceRecoveryCode = 'one';
        $targetRecoveryCode = 'other';
        $source = $source->withRecoveryCode($sourceRecoveryCode);
        $sourceRecoveryCodeExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetRecoveryCodeExpiration = (new \DateTimeImmutable('1981-09-06T14:32:45.123Z'));
        $source = $source->withRecoveryCodeExpiration($sourceRecoveryCodeExpiration);

        // @Act
        $target = $source->generatePasswordRecover('other', $targetRecoveryCode, $targetRecoveryCodeExpiration);

        // @Assert
        $this->assertEquals('one', $source->getRecoveryCode());
        $this->assertEquals('other', $target->getRecoveryCode());
        $this->assertNotEquals($sourceRecoveryCode, $target->getRecoveryCode());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getRecoveryCodeExpiration());
        $this->assertEquals((new \DateTimeImmutable('1981-09-06T14:32:45.123Z')), $target->getRecoveryCodeExpiration());
        $this->assertNotEquals($sourceRecoveryCodeExpiration, $target->getRecoveryCodeExpiration());
    }
    public function test_reset_password_recover_modify(): void
    {
        // @Arrange
        $source = new UserAccessTemporalCode(
            uid: 'one',
            user: new UserRef('one'),
            tempSecondFactorSeed: 'cyphered://cypher',
            tempSecondFactorSeedExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            failedLoginAttempts: 1,
            registerCode: 'one',
            registerCodeUrl: 'one',
            registerCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            recoveryCode: 'one',
            recoveryCodeExpiration: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            version: 1,
        );
        $sourceTempSecondFactorSeed = 'cyphered://cypher';
        $targetTempSecondFactorSeed = null;
        $source = $source->withTempSecondFactorSeed($sourceTempSecondFactorSeed);
        $sourceTempSecondFactorSeedExpiration = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetTempSecondFactorSeedExpiration = null;
        $source = $source->withTempSecondFactorSeedExpiration($sourceTempSecondFactorSeedExpiration);

        // @Act
        $target = $source->resetPasswordRecover();

        // @Assert
        $this->assertEquals('****er', $source->getTempSecondFactorSeed());
        $this->assertEquals($targetTempSecondFactorSeed, $target->getTempSecondFactorSeed());
        $this->assertNotEquals($sourceTempSecondFactorSeed, $target->getTempSecondFactorSeed());
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getTempSecondFactorSeedExpiration());
        $this->assertEquals($targetTempSecondFactorSeedExpiration, $target->getTempSecondFactorSeedExpiration());
        $this->assertNotEquals($sourceTempSecondFactorSeedExpiration, $target->getTempSecondFactorSeedExpiration());
    }
}
