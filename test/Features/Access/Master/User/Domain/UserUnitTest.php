<?php

# @autogenerated
declare(strict_types=1);

use Civi\Lughauth\Features\Access\Master\Tenant\Domain\TenantRef;
use Civi\Lughauth\Features\Access\Master\User\Domain\UserApproveOptions;
use Civi\Lughauth\Shared\Security\AesCypherService;
use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Features\Access\Master\User\Domain\User;

final class UserUnitTest extends TestCase
{
    public function test_init_store_values(): void
    {
        // @Arrange
        $one = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );

        // @Act
        $other = $one->toAttributes()->build();
        $calculated = User::calculatedFields();

        // @Assert
        $this->assertEquals([ 'wellcomeAt', 'enabled', 'approve', 'secondFactorSeed', 'blockedUntil', 'provider'], $calculated);
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getTenant(), $other->getTenant());
        $this->assertTrue($one->isTenantChanged());
        $this->assertEquals($one->getName(), $other->getName());
        $this->assertTrue($one->isNameChanged());
        $this->assertEquals($one->getPassword(), $other->getPassword());
        $this->assertTrue($one->isPasswordChanged());
        $this->assertEquals($one->getEmail(), $other->getEmail());
        $this->assertTrue($one->isEmailChanged());
        $this->assertEquals($one->isTemporalPassword(), $other->isTemporalPassword());
        $this->assertTrue($one->isTemporalPasswordChanged());
        $this->assertEquals($one->isUseSecondFactors(), $other->isUseSecondFactors());
        $this->assertTrue($one->isUseSecondFactorsChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
    }
    public function test_replace_change_values(): void
    {
        // @Arrange
        $base = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $other = new User(
            uid: 'other',
            tenant: new TenantRef('other'),
            name: 'other',
            password: 'cyphered://ocyphered',
            email: 'other@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            enabled: false,
            approve: UserApproveOptions::PENDING,
            temporalPassword: false,
            useSecondFactors: false,
            secondFactorSeed: 'cyphered://ocyphered',
            blockedUntil: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            provider: 'other',
            version: 2,
        );

        // @Act
        $one = $base->replace($other->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $base->uid());
        $this->assertEquals($one->getTenant(), $other->getTenant());
        $this->assertTrue($one->isTenantChanged($base));
        $this->assertEquals($one->getName(), $other->getName());
        $this->assertTrue($one->isNameChanged($base));
        $this->assertEquals($one->getPassword(), $other->getPassword());
        $this->assertTrue($one->isPasswordChanged($base));
        $this->assertEquals($one->getEmail(), $other->getEmail());
        $this->assertTrue($one->isEmailChanged($base));
        $this->assertEquals($one->isTemporalPassword(), $other->isTemporalPassword());
        $this->assertTrue($one->isTemporalPasswordChanged($base));
        $this->assertEquals($one->isUseSecondFactors(), $other->isUseSecondFactors());
        $this->assertTrue($one->isUseSecondFactorsChanged($base));
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged($base));
    }
    public function test_json_compare(): void
    {
        // @Arrange
        $one = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );

        // @Act
        $json = $one->asPublicJson();

        // @Assert
        $this->assertEquals('one', $json['uid']);
        $this->assertEquals('one', $json['tenant']['$ref']);
        $this->assertEquals('one', $json['name']);
        $this->assertEquals('one@fakemail.net', $json['email']);
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $json['wellcomeAt']);
        $this->assertEquals(true, $json['enabled']);
        $this->assertEquals(UserApproveOptions::UNVERIFIED, $json['approve']);
        $this->assertEquals(true, $json['temporalPassword']);
        $this->assertEquals(true, $json['useSecondFactors']);
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $json['blockedUntil']);
        $this->assertEquals('one', $json['provider']);
        $this->assertEquals(1, $json['version']);
    }
    public function test_create_store_values(): void
    {
        // @Arrange
        $one = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );

        // @Act
        $other = User::create($one->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getTenant(), $other->getTenant());
        $this->assertTrue($one->isTenantChanged());
        $this->assertEquals($one->getName(), $other->getName());
        $this->assertTrue($one->isNameChanged());
        $this->assertEquals($one->getPassword(), $other->getPassword());
        $this->assertTrue($one->isPasswordChanged());
        $this->assertEquals($one->getEmail(), $other->getEmail());
        $this->assertTrue($one->isEmailChanged());
        $this->assertEquals($one->isTemporalPassword(), $other->isTemporalPassword());
        $this->assertTrue($one->isTemporalPasswordChanged());
        $this->assertEquals($one->isUseSecondFactors(), $other->isUseSecondFactors());
        $this->assertTrue($one->isUseSecondFactorsChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
        $this->assertCount(0, $one->getTheEvents());
        $this->assertCount(1, $other->getTheEvents());
    }
    public function test_update_change_values(): void
    {
        $base = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $other = new User(
            uid: 'other',
            tenant: new TenantRef('other'),
            name: 'other',
            password: 'cyphered://ocyphered',
            email: 'other@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            enabled: false,
            approve: UserApproveOptions::PENDING,
            temporalPassword: false,
            useSecondFactors: false,
            secondFactorSeed: 'cyphered://ocyphered',
            blockedUntil: (new \DateTimeImmutable('1981-09-06T14:32:45.123Z')),
            provider: 'other',
            version: 2,
        );

        // @Act
        $one = $base->update($other->toAttributes());

        // @Assert
        $this->assertEquals($one->uid(), $base->uid());
        $this->assertEquals($one->getTenant(), $other->getTenant());
        $this->assertTrue($one->isTenantChanged($base));
        $this->assertEquals($one->getName(), $other->getName());
        $this->assertTrue($one->isNameChanged($base));
        $this->assertEquals($one->getPassword(), $other->getPassword());
        $this->assertTrue($one->isPasswordChanged($base));
        $this->assertEquals($one->getEmail(), $other->getEmail());
        $this->assertTrue($one->isEmailChanged($base));
        $this->assertEquals($one->isTemporalPassword(), $other->isTemporalPassword());
        $this->assertTrue($one->isTemporalPasswordChanged($base));
        $this->assertEquals($one->isUseSecondFactors(), $other->isUseSecondFactors());
        $this->assertTrue($one->isUseSecondFactorsChanged($base));
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged($base));
        $this->assertCount(0, $other->getTheEvents());
        $this->assertCount(1, $one->getTheEvents());
    }
    public function test_delete_store_values(): void
    {
        // @Arrange
        $one = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );

        // @Act
        $other = $one->delete();

        // @Assert
        $this->assertEquals($one->uid(), $other->uid());
        $this->assertEquals($one->getTenant(), $other->getTenant());
        $this->assertTrue($one->isTenantChanged());
        $this->assertEquals($one->getName(), $other->getName());
        $this->assertTrue($one->isNameChanged());
        $this->assertEquals($one->getPassword(), $other->getPassword());
        $this->assertTrue($one->isPasswordChanged());
        $this->assertEquals($one->getEmail(), $other->getEmail());
        $this->assertTrue($one->isEmailChanged());
        $this->assertEquals($one->isTemporalPassword(), $other->isTemporalPassword());
        $this->assertTrue($one->isTemporalPasswordChanged());
        $this->assertEquals($one->isUseSecondFactors(), $other->isUseSecondFactors());
        $this->assertTrue($one->isUseSecondFactorsChanged());
        $this->assertEquals($one->getVersion(), $other->getVersion());
        $this->assertTrue($one->isVersionChanged());
    }
    public function test_register_modify(): void
    {
        // @Arrange
        $targetUid = 'other';
        $targetName = 'other';
        $targetEmail = 'other@fakemail.net';
        $cypher = $this->createMock(AesCypherService::class);
        $targetPassword = 'cyphered://ocyphered';
        $targetTenant = new TenantRef('other');

        // @Act
        $target = User::register($targetUid, $targetName, $targetEmail, $cypher, $targetPassword, $targetTenant);

        // @Assert
        $this->assertEquals('other', $target->uid());
        $this->assertEquals('other', $target->getName());
        $this->assertEquals('other@fakemail.net', $target->getEmail());
        $this->assertEquals('****ed', $target->getPassword());
        $this->assertEquals(new TenantRef('other'), $target->getTenant());
    }
    public function test_verify_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceApprove = UserApproveOptions::UNVERIFIED;
        $targetApprove = UserApproveOptions::PENDING;
        $source = $source->withApprove($sourceApprove);

        // @Act
        $target = $source->verify($targetApprove);

        // @Assert
        $this->assertEquals(UserApproveOptions::UNVERIFIED, $source->getApprove());
        $this->assertEquals(UserApproveOptions::PENDING, $target->getApprove());
        $this->assertNotEquals($sourceApprove, $target->getApprove());
    }
    public function test_accept_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceApprove = UserApproveOptions::UNVERIFIED;
        $targetApprove = UserApproveOptions::ACCEPTED;
        $source = $source->withApprove($sourceApprove);

        // @Act
        $target = $source->accept();

        // @Assert
        $this->assertEquals(UserApproveOptions::UNVERIFIED, $source->getApprove());
        $this->assertEquals($targetApprove, $target->getApprove());
        $this->assertNotEquals($sourceApprove, $target->getApprove());
    }
    public function test_reject_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceApprove = UserApproveOptions::UNVERIFIED;
        $targetApprove = UserApproveOptions::REJECTED;
        $source = $source->withApprove($sourceApprove);

        // @Act
        $target = $source->reject();

        // @Assert
        $this->assertEquals(UserApproveOptions::UNVERIFIED, $source->getApprove());
        $this->assertEquals($targetApprove, $target->getApprove());
        $this->assertNotEquals($sourceApprove, $target->getApprove());
    }
    public function test_disable_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceEnabled = true;
        $targetEnabled = false;
        $source = $source->withEnabled($sourceEnabled);

        // @Act
        $target = $source->disable();

        // @Assert
        $this->assertEquals(true, $source->isEnabled());
        $this->assertEquals($targetEnabled, $target->isEnabled());
        $this->assertNotEquals($sourceEnabled, $target->isEnabled());
    }
    public function test_enable_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceEnabled = false;
        $targetEnabled = true;
        $source = $source->withEnabled($sourceEnabled);

        // @Act
        $target = $source->enable();

        // @Assert
        $this->assertEquals(false, $source->isEnabled());
        $this->assertEquals($targetEnabled, $target->isEnabled());
        $this->assertNotEquals($sourceEnabled, $target->isEnabled());
    }
    public function test_unlock_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceBlockedUntil = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetBlockedUntil = null;
        $source = $source->withBlockedUntil($sourceBlockedUntil);

        // @Act
        $target = $source->unlock();

        // @Assert
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getBlockedUntil());
        $this->assertEquals($targetBlockedUntil, $target->getBlockedUntil());
        $this->assertNotEquals($sourceBlockedUntil, $target->getBlockedUntil());
    }
    public function test_block_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $sourceBlockedUntil = (new \DateTimeImmutable('1980-08-20T14:32:45.123Z'));
        $targetBlockedUntil = (new \DateTimeImmutable('1981-09-06T14:32:45.123Z'));
        $source = $source->withBlockedUntil($sourceBlockedUntil);

        // @Act
        $target = $source->block($targetBlockedUntil);

        // @Assert
        $this->assertEquals((new \DateTimeImmutable('1980-08-20T14:32:45.123Z')), $source->getBlockedUntil());
        $this->assertEquals((new \DateTimeImmutable('1981-09-06T14:32:45.123Z')), $target->getBlockedUntil());
        $this->assertNotEquals($sourceBlockedUntil, $target->getBlockedUntil());
    }
    public function test_set_mfa_seed_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $cypher = $this->createMock(AesCypherService::class);
        $sourceSecondFactorSeed = 'cyphered://cypher';
        $targetSecondFactorSeed = 'cyphered://ocyphered';
        $source = $source->withSecondFactorSeed($sourceSecondFactorSeed);
        $sourceUseSecondFactors = false;
        $targetUseSecondFactors = true;
        $source = $source->withUseSecondFactors($sourceUseSecondFactors);

        // @Act
        $target = $source->setMfaSeed($cypher, $targetSecondFactorSeed);

        // @Assert
        $this->assertEquals('****er', $source->getSecondFactorSeed());
        $this->assertEquals('****ed', $target->getSecondFactorSeed());
        $this->assertNotEquals($sourceSecondFactorSeed, $target->getSecondFactorSeed());
        $this->assertEquals(false, $source->isUseSecondFactors());
        $this->assertEquals($targetUseSecondFactors, $target->isUseSecondFactors());
        $this->assertNotEquals($sourceUseSecondFactors, $target->isUseSecondFactors());
    }
    public function test_change_password_modify(): void
    {
        // @Arrange
        $source = new User(
            uid: 'one',
            tenant: new TenantRef('one'),
            name: 'one',
            password: 'cyphered://cypher',
            email: 'one@fakemail.net',
            wellcomeAt: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            enabled: true,
            approve: UserApproveOptions::UNVERIFIED,
            temporalPassword: true,
            useSecondFactors: true,
            secondFactorSeed: 'cyphered://cypher',
            blockedUntil: (new \DateTimeImmutable('1980-08-20T14:32:45.123Z')),
            provider: 'one',
            version: 1,
        );
        $cypher = $this->createMock(AesCypherService::class);
        $sourcePassword = 'cyphered://cypher';
        $targetPassword = 'cyphered://ocyphered';
        $source = $source->withPassword($sourcePassword);
        $sourceTemporalPassword = true;
        $targetTemporalPassword = false;
        $source = $source->withTemporalPassword($sourceTemporalPassword);

        // @Act
        $target = $source->changePassword($cypher, $targetPassword);

        // @Assert
        $this->assertEquals('****er', $source->getPassword());
        $this->assertEquals('****ed', $target->getPassword());
        $this->assertNotEquals($sourcePassword, $target->getPassword());
        $this->assertEquals(true, $source->isTemporalPassword());
        $this->assertEquals($targetTemporalPassword, $target->isTemporalPassword());
        $this->assertNotEquals($sourceTemporalPassword, $target->isTemporalPassword());
    }
}
