<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use DI\ContainerBuilder;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Security\Connection;
use Civi\Lughauth\Shared\Security\Identity;

/**
 * Unit tests for {@see Context}.
 */
final class ContextUnitTest extends TestCase
{
    /**
     * Verifies security context can be set and retrieved.
     */
    public function testSetAndGetSecurityContext(): void
    {
        /* Arrange: create context and security objects. */
        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        $connection = $this->createMock(Connection::class);
        $identity = $this->createMock(Identity::class);

        /* Act: set security context. */
        $context->setSecurityContext($connection, $identity);

        /* Assert: security context is returned. */
        $this->assertSame($connection, $context->getConnection());
        $this->assertSame($identity, $context->getIdentity());
    }

    /**
     * Verifies anonymous identity is returned when none set.
     */
    public function testGetIdentityReturnsAnonymousWhenNotSet(): void
    {
        /* Arrange: create context without security context. */
        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get identity. */
        $identity = $context->getIdentity();

        /* Assert: anonymous identity is returned. */
        $this->assertTrue($identity->anonimous);
    }

    /**
     * Verifies remote HTTP connection is returned when none set.
     */
    public function testGetConnectionReturnsRemoteHttpWhenNotSet(): void
    {
        /* Arrange: set server variables needed for Connection. */
        $_SERVER['REQUEST_URI'] = '/test';
        $_SERVER['REMOTE_ADDR'] = '127.0.0.1';

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get connection. */
        $connection = $context->getConnection();

        /* Assert: remote HTTP connection is returned. */
        $this->assertTrue($connection->remote);
    }

    /**
     * Verifies detached container can be built.
     */
    public function testDetachedContainer(): void
    {
        /* Arrange: create context with container builder. */
        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: build detached container. */
        $container = $context->detachedContainer();

        /* Assert: container is built and implements interface. */
        $this->assertInstanceOf(ContainerInterface::class, $container);
    }

    /**
     * Verifies base URL is constructed correctly from server variables.
     */
    public function testGetBaseUrl(): void
    {
        /* Arrange: set server variables. */
        $_SERVER['HTTPS'] = 'on';
        $_SERVER['HTTP_HOST'] = 'example.com';
        $_SERVER['SCRIPT_NAME'] = '/index.php';

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get base URL. */
        $baseUrl = $context->getBaseUrl();

        /* Assert: base URL is constructed correctly. */
        $this->assertSame('https://example.com', $baseUrl);
    }

    /**
     * Verifies base URL includes script path when needed.
     */
    public function testGetBaseUrlWithScriptPath(): void
    {
        /* Arrange: set server variables with subdirectory. */
        $_SERVER['HTTPS'] = 'off';
        $_SERVER['HTTP_HOST'] = 'example.com';
        $_SERVER['SCRIPT_NAME'] = '/subdir/app.php';

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get base URL. */
        $baseUrl = $context->getBaseUrl();

        /* Assert: base URL includes subdirectory. */
        $this->assertSame('http://example.com/subdir', $baseUrl);
    }

    /**
     * Verifies base URL defaults to localhost when host not set.
     */
    public function testGetBaseUrlDefaultsToLocalhost(): void
    {
        /* Arrange: clear server variables. */
        unset($_SERVER['HTTPS'], $_SERVER['HTTP_HOST'], $_SERVER['SCRIPT_NAME']);

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get base URL. */
        $baseUrl = $context->getBaseUrl();

        /* Assert: base URL defaults to localhost. */
        $this->assertSame('http://localhost', $baseUrl);
    }

    /**
     * Verifies current path is extracted correctly from request URI.
     */
    public function testGetCurrentPath(): void
    {
        /* Arrange: set server variables. */
        $_SERVER['REQUEST_URI'] = '/api/users/123?param=value';
        $_SERVER['SCRIPT_NAME'] = '/index.php';

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get current path. */
        $currentPath = $context->getCurrentPath();

        /* Assert: path is extracted without query string. */
        $this->assertSame('/api/users/123', $currentPath);
    }

    /**
     * Verifies current path handles base path correctly.
     */
    public function testGetCurrentPathWithBasePath(): void
    {
        /* Arrange: set server variables with base path. */
        $_SERVER['REQUEST_URI'] = '/subdir/api/users';
        $_SERVER['SCRIPT_NAME'] = '/subdir/index.php';

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get current path. */
        $currentPath = $context->getCurrentPath();

        /* Assert: base path is removed from current path. */
        $this->assertSame('/api/users', $currentPath);
    }

    /**
     * Verifies current path defaults to root when not set.
     */
    public function testGetCurrentPathDefaultsToRoot(): void
    {
        /* Arrange: clear server variables. */
        unset($_SERVER['REQUEST_URI'], $_SERVER['SCRIPT_NAME']);

        $builder = new ContainerBuilder();
        $config = $this->createMock(AppConfig::class);
        $context = new Context($builder, $config);

        /* Act: get current path. */
        $currentPath = $context->getCurrentPath();

        /* Assert: path defaults to root. */
        $this->assertSame('/', $currentPath);
    }

    /**
     * Verifies instance data is returned from config.
     */
    public function testGetInstanceData(): void
    {
        /* Arrange: create config with instance data. */
        $config = $this->createMock(AppConfig::class);
        $config->method('get')
            ->willReturnCallback(function ($key, $default = null) {
                $map = [
                    'app.id.name' => 'test-service',
                    'app.id.namespace' => 'test-namespace',
                    'app.id.version' => '2.0.0',
                    'app.id.instance' => 'test-instance',
                    'app.id.enviroment' => 'test-env'
                ];
                return $map[$key] ?? $default;
            });

        $builder = new ContainerBuilder();
        $context = new Context($builder, $config);

        /* Act: get instance data. */
        $instanceData = $context->getInstanceData();

        /* Assert: instance data contains all expected fields. */
        $expected = [
            'service.name' => 'test-service',
            'service.namespace' => 'test-namespace',
            'service.version' => '2.0.0',
            'service.instance.id' => 'test-instance',
            'deployment.environment' => 'test-env'
        ];
        $this->assertSame($expected, $instanceData);
    }

    /**
     * Verifies instance data uses defaults when config not available.
     */
    public function testGetInstanceDataUsesDefaults(): void
    {
        /* Arrange: create config that returns null for all values. */
        $config = $this->createMock(AppConfig::class);
        $config->method('get')
            ->willReturnCallback(function ($key, $default = null) {
                return $default; // Return the default value
            });

        $builder = new ContainerBuilder();
        $context = new Context($builder, $config);

        /* Act: get instance data. */
        $instanceData = $context->getInstanceData();

        /* Assert: default values are used. */
        $this->assertSame('phylax', $instanceData['service.name']);
        $this->assertSame('backoffice', $instanceData['service.namespace']);
        $this->assertSame('1.0.0', $instanceData['service.version']);
        $this->assertStringContainsString('-', $instanceData['service.instance.id']);
        $this->assertSame('prod', $instanceData['deployment.environment']);
    }
}
