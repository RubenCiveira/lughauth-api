<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\AppConfig;

/**
 * Unit tests for {@see AppConfig}.
 */
final class AppConfigUnitTest extends TestCase
{
    /**
     * Verifies configuration loads from environment variables.
     */
    public function testGetLoadsFromEnvironment(): void
    {
        /* Arrange: set environment variable. */
        $_ENV['TEST_VALUE'] = 'from-env';
        $_ENV['APP_NAME'] = 'test-app';

        $config = new AppConfig(__DIR__ . '/../../../fixtures');

        /* Act: get value from environment. */
        $result = $config->get('test.value');

        /* Assert: environment variable is returned. */
        $this->assertSame('from-env', $result);
        $this->assertSame('test-app', $config->name);
    }

    /**
         * Verifies configuration loads from YAML file.
         */
    public function testGetLoadsFromYaml(): void
    {
        /* Arrange: create config directory and YAML file. */
        $configDir = $this->createConfigDir();
        $yamlContent = [
            'app' => [
                'id' => [
                    'name' => 'yaml-service',
                    'namespace' => 'yaml-namespace',
                    'version' => '2.0.0',
                    'instance' => 'yaml-instance',
                    'enviroment' => 'yaml-env'
                ]
            ],
            'test' => [
                'nested' => [
                    'value' => 'yaml-value'
                ]
            ]
        ];
        file_put_contents($configDir . '/config/application.yaml', json_encode($yamlContent));

        $config = new AppConfig($configDir);

        /* Act: get values from YAML. */
        $result = $config->get('test.nested.value');
        $serviceName = $config->get('app.id.name');

        /* Assert: YAML values are returned. */
        $this->assertSame('yaml-value', $result);
        $this->assertSame('yaml-service', $serviceName);
    }

    /**
     * Verifies default value is returned when key not found.
     */
    public function testGetReturnsDefault(): void
    {
        /* Arrange: create config without env or YAML. */
        $config = new AppConfig(__DIR__ . '/nonexistent');

        /* Act: get non-existent key with default. */
        $result = $config->get('nonexistent.key', 'default-value');

        /* Assert: default value is returned. */
        $this->assertSame('default-value', $result);
    }

    /**
     * Verifies boolean evaluation works correctly.
     */
    public function testIsEvaluatesBooleans(): void
    {
        /* Arrange: set various boolean values. */
        $_ENV['BOOL_TRUE_1'] = 'enabled';
        $_ENV['BOOL_TRUE_2'] = '1';
        $_ENV['BOOL_TRUE_3'] = 'true';
        $_ENV['BOOL_FALSE_1'] = 'disabled';
        $_ENV['BOOL_FALSE_2'] = '0';
        $_ENV['BOOL_FALSE_3'] = 'false';

        $config = new AppConfig(__DIR__ . '/nonexistent');

        /* Act & Assert: verify true values. */
        $this->assertTrue($config->is('bool.true.1'));
        $this->assertTrue($config->is('bool.true.2'));
        $this->assertTrue($config->is('bool.true.3'));

        /* Act & Assert: verify false values. */
        $this->assertFalse($config->is('bool.false.1'));
        $this->assertFalse($config->is('bool.false.2'));
        $this->assertFalse($config->is('bool.false.3'));

        /* Act & Assert: verify default handling. */
        $this->assertTrue($config->is('nonexistent.true', true));
        $this->assertFalse($config->is('nonexistent.false', false));
    }

    /**
         * Verifies all configuration is dumped correctly.
         */
    public function testAllDumpsConfiguration(): void
    {
        /* Arrange: set environment and YAML config. */
        $_ENV['APP_NAME'] = 'test-app';
        $_ENV['DATABASE_SECRET'] = 'super-secret-password';
        $_ENV['API_KEY'] = '12345678';
        $_ENV['NORMAL_VALUE'] = 'normal-value';

        $configDir = $this->createConfigDir();
        $yamlContent = [
            'app' => [
                'id' => [
                    'name' => 'yaml-service'
                ]
            ],
            'nested' => [
                'array' => [
                    'item1' => 'value1',
                    'item2' => 'value2'
                ],
                'simple' => 'yaml-value'
            ]
        ];
        file_put_contents($configDir . '/config/application.yaml', json_encode($yamlContent));

        $config = new AppConfig($configDir);

        /* Act: get all configuration. */
        $all = $config->all();

        /* Assert: environment variables are included. */
        $this->assertSame('test-app', $all['app.name']['value']);
        $this->assertSame('normal-value', $all['normal.value']['value']);

        /* Assert: secret values are masked for environment variables. */
        $this->assertSame('su****rd', $all['database.secret']['value']);
        $this->assertSame('12****78', $all['api.key']['value']);

        /* Assert: YAML values are included (they use original keys, not transformed). */
        $this->assertSame('yaml-service', $all['app.id.name']['value']);
        $this->assertSame('yaml-value', $all['nested.simple']['value']);
    }

    /**
     * Verifies key transformation for dumping works correctly.
     */
    public function testKeyToDumpTransformsCorrectly(): void
    {
        /* Arrange: set environment variable with underscores. */
        $_ENV['APP_ID_NAME'] = 'transformed-name';

        $config = new AppConfig(__DIR__ . '/nonexistent');

        /* Act: get all configuration. */
        $all = $config->all();

        /* Assert: key is transformed correctly. */
        $this->assertSame('transformed-name', $all['app.id.name']['value']);
    }

    /**
         * Verifies array flattening works correctly.
         */
    public function testFlattenArrayWorksCorrectly(): void
    {
        /* Arrange: create YAML with nested arrays. */
        $configDir = $this->createConfigDir();
        $yamlContent = [
            'level1' => [
                'level2' => [
                    'level3' => 'deep-value'
                ],
                'simple' => 'level2-value'
            ],
            'root' => 'root-value'
        ];
        file_put_contents($configDir . '/config/application.yaml', json_encode($yamlContent));

        $config = new AppConfig($configDir);

        /* Act: get nested value. */
        $result = $config->get('level1.level2.level3');

        /* Assert: nested value is accessible. */
        $this->assertSame('deep-value', $result);
    }

    private function createConfigDir(): string
    {
        $dir = sys_get_temp_dir() . '/config_' . uniqid();
        mkdir($dir, 0777, true);
        mkdir($dir . '/config', 0777, true);
        return $dir;
    }
}
