<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Observability\TraceContext;
use OpenTelemetry\API\Trace\Span;
use OpenTelemetry\API\Trace\SpanContext;

final class TraceContextUnitTest extends TestCase
{
    public function testExtractsFromTraceparentHeader(): void
    {
        $headers = [
            'traceparent' => '00-4bf92f3577b34da6a3ce929d0e0e4736-00f067aa0ba902b7-01',
            'X-Span-Id' => 'span-123'
        ];
        $context = new TraceContext($headers);

        $this->assertSame('4bf92f3577b34da6a3ce929d0e0e4736', $context->getTraceId());
        $this->assertSame('span-123', $context->getSpanId());
    }

    public function testExtractsFromTraceHeaderFallback(): void
    {
        $context = new TraceContext(['X-Trace-Id' => 'trace-abc']);

        $this->assertSame('trace-abc', $context->getTraceId());
    }

    public function testGeneratesFallbackIdsOnce(): void
    {
        $context = new TraceContext([]);

        $traceId = $context->getTraceId();
        $spanId = $context->getSpanId();

        $this->assertSame($traceId, $context->getTraceId());
        $this->assertSame($spanId, $context->getSpanId());
        $this->assertSame(32, strlen($traceId));
        $this->assertSame(16, strlen($spanId));
    }

    public function testAsArrayReturnsBothIds(): void
    {
        $headers = [
            'X-Trace-Id' => 'trace-xyz',
            'X-Span-Id' => 'span-xyz'
        ];
        $context = new TraceContext($headers);

        $this->assertSame([
            'traceId' => 'trace-xyz',
            'spanId' => 'span-xyz'
        ], $context->asArray());
    }

    public function testUsesActiveSpanContextWhenValid(): void
    {
        $traceId = '4bf92f3577b34da6a3ce929d0e0e4736';
        $spanId = '00f067aa0ba902b7';
        $spanContext = SpanContext::create($traceId, $spanId);
        $span = Span::wrap($spanContext);
        $scope = $span->activate();

        try {
            $context = new TraceContext(['X-Trace-Id' => 'trace-header', 'X-Span-Id' => 'span-header']);
            $this->assertSame($traceId, $context->getTraceId());
            $this->assertSame($spanId, $context->getSpanId());
        } finally {
            $scope->detach();
        }
    }
}
