<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use OpenTelemetry\API\Trace\SpanInterface;
use OpenTelemetry\Context\ScopeInterface;
use Civi\Lughauth\Shared\Observability\SpanHolder;

final class SpanHolderUnitTest extends TestCase
{
    public function testEndDoesNothingWhenNoSpan(): void
    {
        $holder = new SpanHolder(null, null);
        $holder->end();

        $this->assertFalse($holder->isRecording());
    }

    public function testEndClosesSpanAndScope(): void
    {
        $span = $this->createMock(SpanInterface::class);
        $scope = $this->createMock(ScopeInterface::class);
        $span->expects($this->once())->method('end');
        $scope->expects($this->once())->method('detach');

        $holder = new SpanHolder($span, $scope);
        $holder->end();
    }

    public function testIsRecordingReturnsSpanState(): void
    {
        $span = $this->createMock(SpanInterface::class);
        $scope = $this->createMock(ScopeInterface::class);
        $span->expects($this->once())->method('isRecording')->willReturn(true);

        $holder = new SpanHolder($span, $scope);

        $this->assertTrue($holder->isRecording());
    }

    public function testSpanMutatorsReturnNewHolder(): void
    {
        $span = $this->createMock(SpanInterface::class);
        $scope = $this->createMock(ScopeInterface::class);

        $span->expects($this->once())
            ->method('setAttribute')
            ->with('key', 'value')
            ->willReturn($span);
        $span->expects($this->once())
            ->method('setAttributes')
            ->with(['one' => 1])
            ->willReturn($span);
        $span->expects($this->once())
            ->method('addEvent')
            ->with('event', ['a' => 1], 123)
            ->willReturn($span);
        $span->expects($this->once())
            ->method('recordException')
            ->with($this->isInstanceOf(RuntimeException::class), ['b' => 2])
            ->willReturn($span);
        $span->expects($this->once())
            ->method('updateName')
            ->with('new')
            ->willReturn($span);
        $span->expects($this->once())
            ->method('setStatus')
            ->with('OK', 'done')
            ->willReturn($span);

        $holder = new SpanHolder($span, $scope);

        $this->assertInstanceOf(SpanHolder::class, $holder->setAttribute('key', 'value'));
        $this->assertInstanceOf(SpanHolder::class, $holder->setAttributes(['one' => 1]));
        $this->assertInstanceOf(SpanHolder::class, $holder->addEvent('event', ['a' => 1], 123));
        $this->assertInstanceOf(SpanHolder::class, $holder->recordException(new RuntimeException('boom'), ['b' => 2]));
        $this->assertInstanceOf(SpanHolder::class, $holder->updateName('new'));
        $this->assertInstanceOf(SpanHolder::class, $holder->setStatus('OK', 'done'));
    }

    public function testSpanMutatorsOnNullSpanReturnSame(): void
    {
        $holder = new SpanHolder(null, null);

        $this->assertSame($holder, $holder->setAttribute('k', 'v'));
        $this->assertSame($holder, $holder->setAttributes(['k' => 'v']));
        $this->assertSame($holder, $holder->addEvent('event'));
        $this->assertSame($holder, $holder->recordException(new RuntimeException('boom')));
        $this->assertSame($holder, $holder->updateName('new'));
        $this->assertSame($holder, $holder->setStatus('OK'));
    }
}
