<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\UploadedFileInterface;
use Civi\Lughauth\Shared\Value\UploadBinaryContent;

final class UploadBinaryContentUnitTest extends TestCase
{
    public function testFromUploadValid(): void
    {
        $tmpPath = tempnam(sys_get_temp_dir(), 'upload_');
        file_put_contents($tmpPath, 'hello test');

        // Mock UploadedFile
        $upload = $this->createMock(UploadedFileInterface::class);
        $upload->method('getError')->willReturn(UPLOAD_ERR_OK);
        $upload->method('getClientFilename')->willReturn('test.txt');
        $upload->method('getClientMediaType')->willReturn('text/plain');
        $upload->expects($this->once())->method('moveTo')->with($this->callback(function ($path) use (&$movedPath, $tmpPath) {
            // Simulate moving the file
            copy($tmpPath, $path);
            $movedPath = $path;
            return true;
        }));

        // Mock Request
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUploadedFiles')->willReturn(['file' => $upload]);

        // Run method
        $binary = UploadBinaryContent::fromUpload($request, 'file');

        $this->assertInstanceOf(UploadBinaryContent::class, $binary);
        $this->assertSame('test.txt', $binary->name);
        $this->assertSame('text/plain', $binary->mime);
        $this->assertEquals('hello test', stream_get_contents($binary->stream));

        $pathProperty = (new ReflectionClass($binary))->getProperty('path');
        $pathProperty->setAccessible(true);
        $path = $pathProperty->getValue($binary);
        // $path = (fn() => $this->path)->call($binary);
        $this->assertFileExists($path);
        unset($binary); // triggers __destruct
        $this->assertFileDoesNotExist($path);
    }

    public function testMissingFileThrows(): void
    {
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUploadedFiles')->willReturn([]);

        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage('file is not attached');

        UploadBinaryContent::fromUpload($request, 'file');
    }

    public function testUploadErrorNoFile(): void
    {
        $upload = $this->createMock(UploadedFileInterface::class);
        $upload->method('getError')->willReturn(UPLOAD_ERR_NO_FILE);

        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUploadedFiles')->willReturn(['file' => $upload]);

        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage('No file sent.');

        UploadBinaryContent::fromUpload($request, 'file');
    }

    public function testUploadErrorExceededSize(): void
    {
        $upload = $this->createMock(UploadedFileInterface::class);
        $upload->method('getError')->willReturn(UPLOAD_ERR_INI_SIZE);

        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUploadedFiles')->willReturn(['file' => $upload]);

        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage('Exceeded filesize limit.');

        UploadBinaryContent::fromUpload($request, 'file');
    }

    public function testUploadErrorUnknown(): void
    {
        $upload = $this->createMock(UploadedFileInterface::class);
        $upload->method('getError')->willReturn(123);

        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUploadedFiles')->willReturn(['file' => $upload]);

        $this->expectException(\InvalidArgumentException::class);
        $this->expectExceptionMessage('Unknown errors.');

        UploadBinaryContent::fromUpload($request, 'file');
    }
}
