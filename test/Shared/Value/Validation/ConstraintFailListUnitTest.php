<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Value\Validation\ConstraintFailList;
use Civi\Lughauth\Shared\Value\Validation\ConstraintFail;
use Civi\Lughauth\Shared\Exception\ConstraintException;

final class ConstraintFailListUnitTest extends TestCase
{
    public function testInitiallyEmpty(): void
    {
        $list = new ConstraintFailList();
        $this->assertTrue($list->isEmpty());
        $this->assertFalse($list->hasErrors());
    }

    public function testAddSingleConstraintFail(): void
    {
        $list = new ConstraintFailList();
        $fail = new ConstraintFail('code', ['field'], ['wrong'], ['expected']);
        $list->add($fail);

        $this->assertTrue($list->hasErrors());
        $this->assertFalse($list->isEmpty());
    }

    public function testAddConstraintFailListMerges(): void
    {
        $list = new ConstraintFailList();
        $child = new ConstraintFailList();
        $fail1 = new ConstraintFail('code1', ['a'], ['x'], ['y']);
        $fail2 = new ConstraintFail('code2', ['b'], ['x'], ['y']);

        $child->add($fail1);
        $child->add($fail2);

        $list->add($child);
        $this->assertTrue($list->hasErrors());
        $this->assertEquals(2, count((new \ReflectionObject($list))->getProperty('errors')->getValue($list)));
    }

    public function testFieldPathPrefixing(): void
    {
        $list = new ConstraintFailList('user.');
        $fail = new ConstraintFail('code', ['email'], ['invalid'], []);
        $list->add($fail);

        $ref = new \ReflectionClass($list);
        $prop = $ref->getProperty('errors');
        $prop->setAccessible(true);
        $errors = $prop->getValue($list);

        $this->assertEquals(['user.email'], $errors[0]->fields);
    }

    public function testIncludeViolation(): void
    {
        $list = new ConstraintFailList();
        $fail = new ConstraintFail('code', ['f'], ['invalid']);
        $list->add($fail);

        $this->assertTrue($list->includeViolation(ConstraintFail::class));
        $this->assertFalse($list->includeViolation(\stdClass::class));
    }

    public function testIncludeViolationCode(): void
    {
        $list = new ConstraintFailList();
        $list->add(new ConstraintFail('123', ['a'], ['invalid']));
        $this->assertTrue($list->includeViolationCode(123));
        $this->assertFalse($list->includeViolationCode(456));
    }

    public function testAsConstraintException(): void
    {
        $list = new ConstraintFailList();
        $fail = new ConstraintFail('code', ['field'], ['invalid']);
        $list->add($fail);

        $ex = $list->asConstraintException();
        $this->assertInstanceOf(ConstraintException::class, $ex);
    }
}
