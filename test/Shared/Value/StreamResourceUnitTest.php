<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Value\StreamResource;

final class StreamResourceUnitTest extends TestCase
{
    public function testConstructWithValidResource(): void
    {
        $res = fopen('php://temp', 'r+');
        $stream = new StreamResource($res);
        $this->assertInstanceOf(StreamResource::class, $stream);
    }

    public function testConstructWithInvalidResourceThrows(): void
    {
        $this->expectException(\InvalidArgumentException::class);
        new StreamResource('not-a-resource');
    }

    public function testToStringReturnsFullContents(): void
    {
        $res = fopen('php://temp', 'r+');
        fwrite($res, 'abc');
        $stream = new StreamResource($res);
        $this->assertEquals('abc', (string) $stream);
    }

    public function testCloseReleasesResource(): void
    {
        $res = fopen('php://temp', 'r+');
        $stream = new StreamResource($res);
        $stream->close();

        // __toString after close should return empty
        $this->assertSame('', (string) $stream);
    }

    public function testDetachReturnsResourceAndDisablesStream(): void
    {
        $res = fopen('php://temp', 'r+');
        $stream = new StreamResource($res);
        $detached = $stream->detach();
        $this->assertIsResource($detached);
        $this->assertSame('', (string) $stream);
    }

    public function testGetSizeReturnsSize(): void
    {
        $res = fopen('php://temp', 'r+');
        fwrite($res, '12345');
        rewind($res);
        $stream = new StreamResource($res);
        $this->assertEquals(5, $stream->getSize());
        $stream->detach();
        $this->assertEquals(0, $stream->getSize());
    }

    public function testTellAndEof(): void
    {
        $res = fopen('php://temp', 'r+');
        fwrite($res, 'x');
        $stream = new StreamResource($res);
        $this->assertEquals(1, $stream->tell());
        $this->assertFalse($stream->eof());
    }

    public function testSeekAndRewind(): void
    {
        $res = fopen('php://temp', 'r+');
        fwrite($res, 'abc');
        $stream = new StreamResource($res);
        $stream->seek(1);
        $this->assertEquals(1, $stream->tell());
        $stream->rewind();
        $this->assertEquals(0, $stream->tell());
    }

    public function testSeekFailsIfNotSeekable(): void
    {
        [$r, $w] = stream_socket_pair(STREAM_PF_UNIX, STREAM_SOCK_STREAM, STREAM_IPPROTO_IP);
        fclose($w); // Cerramos escritura, el de lectura no serÃ¡ seekable
        $stream = new StreamResource($r);
        $this->expectException(\RuntimeException::class);
        $stream->seek(0);
        pclose($r);
    }

    public function testWriteAndIsWritable(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'w+');
        $stream = new StreamResource($res);
        $this->assertTrue($stream->isWritable());
        $stream->write('hello');
        rewind($res);
        try {
            $this->assertEquals('hello', stream_get_contents($res));
        } finally {
            unlink($tmp);
        }
    }

    public function testWriteFailsIfNotWritable(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'r');
        $stream = new StreamResource($res);
        $this->assertFalse($stream->isWritable());

        $this->expectException(\RuntimeException::class);
        try {
            $stream->write('x');
        } finally {
            unlink($tmp);
        }
    }

    public function testReadAndIsReadable(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'r+');
        fwrite($res, 'xyz');
        rewind($res);
        $stream = new StreamResource($res);
        $this->assertTrue($stream->isReadable());
        $this->assertEquals('x', $stream->read(1));
        unlink($tmp);
    }

    public function testReadFailsIfNotReadable(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'w');
        $stream = new StreamResource($res);
        $this->assertFalse($stream->isReadable());
        $this->expectException(\RuntimeException::class);
        try {
            $stream->read(1);
        } finally {
            unlink($tmp);
        }
    }

    public function testGetContents(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'r+');
        fwrite($res, 'stream');
        rewind($res);
        $stream = new StreamResource($res);
        $this->assertEquals('stream', $stream->getContents());
    }

    public function testGetContentsFailsIfNotReadable(): void
    {
        $tmp = tempnam(sys_get_temp_dir(), 'test');
        $res = fopen($tmp, 'w');
        $stream = new StreamResource($res);
        $this->expectException(\RuntimeException::class);
        try {
            $stream->getContents();
        } finally {
            unlink($tmp);
        }
    }

    public function testGetMetadata(): void
    {
        $res = fopen('php://temp', 'r+');
        $stream = new StreamResource($res);
        $meta = $stream->getMetadata();
        $this->assertIsArray($meta);
        $this->assertArrayHasKey('mode', $meta);

        $this->assertSame($meta['mode'], $stream->getMetadata('mode'));
        $this->assertNull($stream->getMetadata('nonexistent'));
    }
}
