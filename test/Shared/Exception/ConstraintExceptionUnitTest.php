<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Exception\ConstraintException;
use Civi\Lughauth\Shared\Value\Validation\ConstraintFail;

class ConstraintExceptionUnitTest extends TestCase
{
    public function testOfFailCreatesExceptionWithFails()
    {
        $fail1 = new ConstraintFail('CODE1', ['field1'], ['wrong1'], ['expected1']);
        $fail2 = new ConstraintFail('CODE2', ['field2'], ['wrong2'], ['expected2']);

        $exception = ConstraintException::ofFail($fail1, $fail2);

        $this->assertInstanceOf(ConstraintException::class, $exception);
        $this->assertTrue($exception->includeViolation(ConstraintFail::class));
        $this->assertFalse($exception->includeViolation(ConstraintException::class));
        $this->assertTrue($exception->includeViolationCode('CODE1'));
        $this->assertTrue($exception->includeViolationCode('CODE2'));
    }

    public function testOfErrorCreatesExceptionWithSingleFail()
    {
        $exception = ConstraintException::ofError('ERR_CODE', ['fieldA'], ['valA'], ['expectedA']);

        $this->assertInstanceOf(ConstraintException::class, $exception);
        $this->assertTrue($exception->includeViolation(ConstraintFail::class));
        $this->assertFalse($exception->includeViolation(ConstraintException::class));
        $this->assertTrue($exception->includeViolationCode('ERR_CODE'));
        $this->assertFalse($exception->includeViolationCode('ERR_NONE'));
    }

    public function testIteratorWorksCorrectly()
    {
        $fail1 = new ConstraintFail('CODE1', ['field1'], ['wrong1'], ['expected1']);
        $fail2 = new ConstraintFail('CODE2', ['field2'], ['wrong2'], ['expected2']);
        $exception = ConstraintException::ofFail($fail1, $fail2);

        $collectedCodes = [];
        foreach ($exception as $fail) {
            $collectedCodes[] = $fail->code;
        }

        $this->assertEquals(['CODE1', 'CODE2'], $collectedCodes);
    }

    public function testValidAndKey()
    {
        $fail = new ConstraintFail('CODEX', ['f'], ['w'], ['e']);
        $exception = ConstraintException::ofFail($fail);
        $exception->rewind();

        $this->assertTrue($exception->valid());
        $this->assertSame(0, $exception->key());
        $this->assertInstanceOf(ConstraintFail::class, $exception->current());
    }

    public function testNextAndValid()
    {
        $fail1 = new ConstraintFail('C1', ['f1'], ['w1'], ['e1']);
        $fail2 = new ConstraintFail('C2', ['f2'], ['w2'], ['e2']);
        $exception = ConstraintException::ofFail($fail1, $fail2);
        $exception->rewind();
        $exception->next();
        $exception->next();

        $this->assertFalse($exception->valid());
    }
}
