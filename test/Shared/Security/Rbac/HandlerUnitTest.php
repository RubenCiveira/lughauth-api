<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Security\Identity;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Security\Rbac\LughMapper;

final class HandlerUnitTest extends TestCase
{
    public function testModeDisabledByDefault(): void
    {
        $config = $this->createMock(AppConfig::class);
        $config->expects($this->once())
            ->method('get')
            ->with('security.rbac.lugh.location', '-')
            ->willReturn('-');

        $mapper = $this->createMock(LughMapper::class);
        $mapper->expects($this->never())->method('flush');
        $mapper->expects($this->never())->method('registerResourceAction');
        $mapper->expects($this->never())->method('registerResourceAttribute');
        $mapper->expects($this->never())->method('hiddenFields');
        $mapper->expects($this->never())->method('uneditableFields');
        $mapper->expects($this->never())->method('allow');

        $handler = new Handler($config, $mapper);
        $identity = new Identity(false);

        $handler->registerResourceAction('users', 'read', 'public');
        $handler->registerResourceAttribute('users', 'email', 'hidden');
        $handler->flush();

        $this->assertSame([], $handler->hiddenFields($identity, 'users'));
        $this->assertSame([], $handler->uneditableFields($identity, 'users'));
        $this->assertTrue($handler->allow($identity, 'users', 'read'));
    }

    public function testModeEnabledDelegatesToMapper(): void
    {
        $config = $this->createMock(AppConfig::class);
        $config->expects($this->once())
            ->method('get')
            ->with('security.rbac.lugh.location', '-')
            ->willReturn('http://lugh');

        $mapper = $this->createMock(LughMapper::class);
        $mapper->expects($this->once())
            ->method('registerResourceAction')
            ->with('users', 'read', 'public');
        $mapper->expects($this->once())
            ->method('registerResourceAttribute')
            ->with('users', 'email', 'hidden');
        $mapper->expects($this->once())->method('flush');
        $mapper->expects($this->once())
            ->method('hiddenFields')
            ->willReturn(['secret']);
        $mapper->expects($this->once())
            ->method('uneditableFields')
            ->willReturn(['createdAt']);
        $mapper->expects($this->once())
            ->method('allow')
            ->willReturn(false);

        $handler = new Handler($config, $mapper);
        $identity = new Identity(false);

        $handler->registerResourceAction('users', 'read', 'public');
        $handler->registerResourceAttribute('users', 'email', 'hidden');
        $handler->flush();

        $this->assertSame(['secret'], $handler->hiddenFields($identity, 'users'));
        $this->assertSame(['createdAt'], $handler->uneditableFields($identity, 'users'));
        $this->assertFalse($handler->allow($identity, 'users', 'read'));
    }
}
