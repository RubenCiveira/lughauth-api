<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Security\Connection;
use Civi\Lughauth\Shared\AppConfig;

final class ConnectionUnitTest extends TestCase
{
    protected function setUp(): void
    {
        $_SERVER = [
            'HTTP_ACCEPT_LANGUAGE' => 'en-US,en;q=0.9,es;q=0.8',
            'SERVER_NAME' => 'example.org',
            'REQUEST_URI' => '/callback',
            'REMOTE_ADDR' => '192.168.1.42'
        ];
    }

    public function testRemoteHttpWithoutProxy(): void
    {
        $connection = Connection::remoteHttp('testApp');
        $this->assertInstanceOf(Connection::class, $connection);
        $this->assertTrue($connection->remote);
        $this->assertSame('testApp', $connection->application);
        $this->assertSame('/callback', $connection->callback);
        $this->assertSame('192.168.1.42', $connection->source);
        $this->assertSame('example.org', $connection->target);
        $this->assertSame('en-US', $connection->locale);
    }

    public function testRemoteHttpWithProxyXForwardedFor(): void
    {
        $_SERVER['HTTP_X_FORWARDED_FOR'] = '10.0.0.123, 10.0.0.124';
        $config = $this->createMock(AppConfig::class);
        $config->method('get')->willReturn('true');

        $connection = Connection::remoteHttp('proxiedApp', $config);
        $this->assertSame('10.0.0.123', $connection->source);
    }

    public function testRemoteHttpWithProxyXRealIp(): void
    {
        unset($_SERVER['HTTP_X_FORWARDED_FOR']);
        $_SERVER['HTTP_X_REAL_IP'] = '10.0.0.200';

        $config = $this->createMock(AppConfig::class);
        $config->method('get')->willReturn('true');

        $connection = Connection::remoteHttp('realIpApp', $config);
        $this->assertSame('10.0.0.200', $connection->source);
    }

    public function testRemoteHttpWithIPv6Loopback(): void
    {
        $_SERVER['REMOTE_ADDR'] = '::1';

        $connection = Connection::remoteHttp('ipv6App');
        $this->assertSame('127.0.0.1', $connection->source);
    }

    public function testInRangeTrue(): void
    {
        $connection = new Connection(true, new \DateTime(), 'app', '/', '192.168.1.15', 'target', 'en');
        $this->assertTrue($connection->inRange('192.168.1.0/24'));
    }

    public function testInRangeFalse(): void
    {
        $connection = new Connection(true, new \DateTime(), 'app', '/', '192.168.2.15', 'target', 'en');
        $this->assertFalse($connection->inRange('192.168.1.0/24'));
    }
}
