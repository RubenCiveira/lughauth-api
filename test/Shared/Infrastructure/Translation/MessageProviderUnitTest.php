<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Translation\MessageProvider;

final class MessageProviderUnitTest extends TestCase
{
    public function testMessagesLoadsCatalogue(): void
    {
        $dir = $this->createTranslationsDir();
        file_put_contents($dir . '/messages.yaml', "greeting: hello\n");
        file_put_contents($dir . '/messages.es.yaml', "greeting: hola\n");

        $provider = new MessageProvider($this->createConfig(), $dir . '/compiled');
        $catalogue = $provider->messages('messages', 'es', $dir);

        $this->assertSame('hola', $catalogue->get('greeting'));
    }

    public function testMessagesThrowsOnInvalidPath(): void
    {
        $provider = new MessageProvider($this->createConfig(), sys_get_temp_dir());

        $this->expectException(RuntimeException::class);
        $provider->messages('messages', 'en', sys_get_temp_dir() . '/missing');
    }

    public function testMessagesUsesDomainBasedOnIntl(): void
    {
        $dir = $this->createTranslationsDir();
        file_put_contents($dir . '/messages.yaml', "greeting: hello\n");

        $provider = new class ($this->createConfig()) extends MessageProvider {
            protected function intlEnabled(): bool
            {
                return false;
            }
        };
        $catalogue = $provider->messages('messages', 'en', $dir);
        $this->assertSame('messages', $this->getDomain($catalogue));

        $provider = new class ($this->createConfig()) extends MessageProvider {
            protected function intlEnabled(): bool
            {
                return true;
            }
        };
        $catalogue = $provider->messages('messages', 'en', $dir);
        $this->assertSame('messages.+intl-icu', $this->getDomain($catalogue));
    }

    private function createTranslationsDir(): string
    {
        $dir = sys_get_temp_dir() . '/translations_' . uniqid();
        mkdir($dir, 0777, true);
        return $dir;
    }

    private function createConfig(): AppConfig
    {
        return new class () extends AppConfig {
            public function __construct()
            {
                $this->develop = true;
                $this->name = 'app';
                $this->managementEndpoint = '/management';
            }

            public function get(string $name, mixed $def = null): mixed
            {
                return $def;
            }
        };
    }

    private function getDomain(object $catalogue): string
    {
        $ref = new ReflectionClass($catalogue);
        $prop = $ref->getProperty('domain');
        $prop->setAccessible(true);
        return $prop->getValue($catalogue);
    }
}
