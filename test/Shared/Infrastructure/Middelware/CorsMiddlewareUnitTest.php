<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Slim\Psr7\Response;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\RequestHandlerInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Middelware\CorsMiddleware;

/**
 * Unit tests for CorsMiddleware.
 */
final class CorsMiddlewareUnitTest extends TestCase
{
    /**
     * Ensures register adds middleware and options route.
     */
    public function testRegisterAddsMiddleware(): void
    {
        /*
         * Arrange: create a Slim app mock with expectations.
         */
        $app = $this->createMock(\Slim\App::class);
        $app->expects($this->once())->method('add')->with(CorsMiddleware::class);
        $app->expects($this->once())->method('options');

        /*
         * Act: register the CORS middleware on the app.
         */
        CorsMiddleware::register($app);

        /*
         * Assert: confirm the middleware and options route were registered.
         */
    }

    /**
     * Ensures OPTIONS requests receive CORS headers.
     */
    public function testOptionsAddsHeaders(): void
    {
        /*
         * Arrange: build a CORS middleware with CORS enabled.
         */
        $config = $this->config(true);
        $middleware = new CorsMiddleware($config);
        $request = $this->request('OPTIONS');
        $handler = $this->handler();

        /*
         * Act: handle the OPTIONS request through the middleware.
         */
        $response = $middleware($request, $handler);

        /*
         * Assert: verify the response contains CORS headers.
         */
        $this->assertSame(204, $response->getStatusCode());
        $this->assertNotEmpty($response->getHeaderLine('Access-Control-Allow-Origin'));
    }

    /**
     * Ensures CORS headers are skipped when disabled.
     */
    public function testDisabledSkipsHeaders(): void
    {
        /*
         * Arrange: build a CORS middleware with CORS disabled.
         */
        $config = $this->config(false);
        $middleware = new CorsMiddleware($config);
        $request = $this->request('GET');
        $handler = $this->handler();

        /*
         * Act: handle a request with CORS disabled.
         */
        $response = $middleware($request, $handler);

        /*
         * Assert: verify no CORS headers were applied.
         */
        $this->assertSame('', $response->getHeaderLine('Access-Control-Allow-Origin'));
    }

    private function config(bool $enabled): AppConfig
    {
        return new class ($enabled) extends AppConfig {
            public function __construct(private readonly bool $enabled)
            {
                $this->develop = true;
                $this->name = 'app';
                $this->managementEndpoint = '/management';
            }

            public function is(string $name, bool $def = false): bool
            {
                return $this->enabled;
            }
        };
    }

    private function request(string $method): ServerRequestInterface
    {
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getMethod')->willReturn($method);
        $request->method('hasHeader')->willReturn(false);
        return $request;
    }

    private function handler(): RequestHandlerInterface
    {
        return new class () implements RequestHandlerInterface {
            public function handle(ServerRequestInterface $request): \Psr\Http\Message\ResponseInterface
            {
                return new Response();
            }
        };
    }
}
