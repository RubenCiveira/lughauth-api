<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsFS;

final class MetricsFSUnitTest extends TestCase
{
    public function testAppendAndListSeries(): void
    {
        $root = sys_get_temp_dir() . '/metricsfs_' . uniqid();
        $fs = new MetricsFS($root);

        $fs->appendRaw('metric', ['b' => '2', 'a' => '1'], 1, 1500);
        $series = $fs->listSeries('metric');

        $this->assertCount(1, $series);
        $labels = array_values($series)[0];
        $this->assertSame(['a' => '1', 'b' => '2'], $labels);
    }

    public function testReadJsonlStream(): void
    {
        $root = sys_get_temp_dir() . '/metricsfs_' . uniqid();
        $fs = new MetricsFS($root);
        $path = $fs->dayFile('metric', 'sha', 'raw', 1500, false);
        @mkdir(dirname($path), 0777, true);
        file_put_contents($path, json_encode(['ts' => 1, 'v' => 2]) . "\n");

        $rows = iterator_to_array(MetricsFS::readJsonlStream($path));
        $this->assertSame(1, $rows[0]['ts']);

        $gzPath = $path . '.gz';
        file_put_contents($gzPath, gzencode(json_encode(['ts' => 3, 'v' => 4]) . "\n"));
        $rows = iterator_to_array(MetricsFS::readJsonlStream($gzPath));
        $this->assertSame(3, $rows[0]['ts']);
    }

    public function testDayFileResolvesGzip(): void
    {
        $root = sys_get_temp_dir() . '/metricsfs_' . uniqid();
        $fs = new MetricsFS($root);
        $base = $fs->dayFile('metric', 'sha', 'raw', 1500, false);
        @mkdir(dirname($base), 0777, true);
        file_put_contents($base . '.gz', 'data');

        $path = $fs->dayFile('metric', 'sha', 'raw', 1500, true);

        $this->assertStringEndsWith('.gz', $path);
    }

    public function testUpsertLabelsKeepsCreatedAt(): void
    {
        $root = sys_get_temp_dir() . '/metricsfs_' . uniqid();
        $fs = new MetricsFS($root);
        $sha = MetricsFS::seriesId(['a' => '1']);

        $fs->upsertLabels('metric', $sha, ['a' => '1'], 1000);
        $fs->upsertLabels('metric', $sha, ['a' => '1'], 2000);

        $file = $fs->seriesDir('metric', $sha) . '/labels.json';
        $data = json_decode((string) file_get_contents($file), true);

        $this->assertSame(1000, $data['createdAt']);
        $this->assertSame(2000, $data['updatedAt']);
    }

    public function testRotateDoesNotFail(): void
    {
        $root = sys_get_temp_dir() . '/metricsfs_' . uniqid();
        mkdir($root, 0777, true);
        $fs = new MetricsFS($root);
        $fs->rotate();

        $this->assertTrue(is_dir($root));
    }
}
