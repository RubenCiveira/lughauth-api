<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsRotator;

final class MetricsRotatorUnitTest extends TestCase
{
    public function testRotateMetricGzipsAndDeletes(): void
    {
        $root = sys_get_temp_dir() . '/rotator_' . uniqid();
        $metricDir = $root . '/metric/series/aa/bb/raw/2020/01';
        mkdir($metricDir, 0777, true);
        $oldFile = $metricDir . '/01.jsonl';
        file_put_contents($oldFile, "{}");

        $rotator = new MetricsRotator($root, ['raw' => 1], true);
        $rotator->rotateMetric('metric');

        $this->assertFalse(file_exists($oldFile));
    }

    public function testRotateMetricSkipsGzipPartition(): void
    {
        $root = sys_get_temp_dir() . '/rotator_' . uniqid();
        $metricDir = $root . '/metric/series/aa/bb/raw/2020/01';
        mkdir($metricDir, 0777, true);
        $oldFile = $metricDir . '/01.jsonl';
        file_put_contents($oldFile, "{}");

        $rotator = new MetricsRotator($root, ['raw' => 9999], true, ['raw']);
        $rotator->rotateMetric('metric');

        $this->assertTrue(file_exists($oldFile));
    }

    public function testRotateAllSkipsMissingMetric(): void
    {
        $root = sys_get_temp_dir() . '/rotator_' . uniqid();
        mkdir($root, 0777, true);
        $rotator = new MetricsRotator($root, ['raw' => 1], false);
        $rotator->rotateAll();

        $this->assertTrue(is_dir($root));
    }

    public function testExtractYmdInvalidPath(): void
    {
        $root = sys_get_temp_dir() . '/rotator_' . uniqid();
        $rotator = new MetricsRotator($root, ['raw' => 1], false);
        $method = new ReflectionMethod($rotator, 'extractYmdFromPath');
        $method->setAccessible(true);

        $this->assertNull($method->invoke($rotator, '/invalid/path.jsonl'));
    }
}
