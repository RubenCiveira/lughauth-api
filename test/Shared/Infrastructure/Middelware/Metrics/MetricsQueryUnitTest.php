<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsFS;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsQuery;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\LabelMatcher;

final class MetricsQueryUnitTest extends TestCase
{
    public function testSeriesAndRange(): void
    {
        $fs = $this->fsWithData();
        $query = new MetricsQuery($fs);

        $series = $query->series('metric', new LabelMatcher('status', '=', '200'));
        $this->assertCount(1, $series);

        $range = $query->range('metric', 1000, 3000, 1, 'raw');
        $this->assertNotEmpty($range[0]['points']);
    }

    public function testRateAndSumBy(): void
    {
        $fs = $this->fsWithData();
        $query = new MetricsQuery($fs);

        $rate = $query->rate('metric', 1000, 3000, 1, 'raw');
        $this->assertNotEmpty($rate[0]['points']);

        $sum = $query->sumBy([
            ['labels' => ['status' => '200'], 'points' => [[1000, 1.0]]],
            ['labels' => ['status' => '200'], 'points' => [[1000, 2.0]]],
        ], ['status']);
        $this->assertSame(3.0, $sum[0]['points'][0][1]);
    }

    public function testRangeChoosesPartition(): void
    {
        $fs = new MetricsFS(sys_get_temp_dir() . '/metrics_' . uniqid());
        $query = new MetricsQuery($fs);

        $result = $query->range('metric', 0, 15 * 24 * 3600 * 1000, null, '');
        $this->assertSame([], $result);
    }

    public function testInterpolateOnGridPolicies(): void
    {
        $fs = new MetricsFS(sys_get_temp_dir() . '/metrics_' . uniqid());
        $query = new MetricsQuery($fs);
        $method = new ReflectionMethod($query, 'interpolateOnGrid');
        $method->setAccessible(true);

        $grid = [[0, NAN], [10, 2.0], [20, NAN]];
        $out = $method->invoke($query, $grid, 'zero');
        $this->assertSame(0.0, $out[0][1]);

        $grid = [[0, NAN], [10, 2.0], [20, NAN]];
        $out = $method->invoke($query, $grid, 'ffill');
        $this->assertSame(2.0, $out[0][1]);

        $grid = [[0, 2.0], [10, NAN], [20, NAN]];
        $out = $method->invoke($query, $grid, 'bfill');
        $this->assertSame(2.0, $out[1][1]);
    }

    public function testRateWithSinglePoint(): void
    {
        $fs = new MetricsFS(sys_get_temp_dir() . '/metrics_' . uniqid());
        $fs->appendRaw('metric', ['status' => '200'], 1, 1500);
        $query = new MetricsQuery($fs);

        $rate = $query->rate('metric', 1000, 2000, 1, 'raw');
        $this->assertNotEmpty($rate[0]['points']);
    }

    private function fsWithData(): MetricsFS
    {
        $fs = new MetricsFS(sys_get_temp_dir() . '/metrics_' . uniqid());
        $fs->appendRaw('metric', ['status' => '200'], 1, 1500);
        $fs->appendRaw('metric', ['status' => '200'], 2, 2500);
        return $fs;
    }
}
