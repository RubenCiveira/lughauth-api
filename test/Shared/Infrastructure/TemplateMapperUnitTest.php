<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure {
    final class TemplateMapperTestHook
    {
        public static bool $forceFileGetContentsFail = false;
    }

    if (!function_exists(__NAMESPACE__ . '\\file_get_contents')) {
        function file_get_contents(string $filename): string|false
        {
            if (TemplateMapperTestHook::$forceFileGetContentsFail) {
                return false;
            }

            return \file_get_contents($filename);
        }
    }
}

namespace {

    use DI\Container;
    use PHPUnit\Framework\TestCase;
    use Slim\Factory\AppFactory;
    use Slim\Psr7\Factory\ServerRequestFactory;
    use Twig\Environment;
    use Twig\Loader\FilesystemLoader;
    use Civi\Lughauth\Shared\Infrastructure\TemplateMapper;
    use Civi\Lughauth\Shared\Infrastructure\TemplateMapperTestHook;

    final class TemplateMapperUnitTest extends TestCase
    {
        private function templatesDir(): string
        {
            $ref = new ReflectionClass(TemplateMapper::class);
            return realpath(dirname($ref->getFileName()) . '/../../../templates');
        }

        private function buildAppWithTwig(): \Slim\App
        {
            $container = new Container();
            $loader = new FilesystemLoader($this->templatesDir());
            $container->set('view', new Environment($loader));

            AppFactory::setContainer($container);
            return AppFactory::create();
        }

        public function testTemplateMapperServesTemplateFile(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $file = $templateDir . '/page.tpl';
            file_put_contents($file, 'Hello');

            try {
                $request = (new ServerRequestFactory())->createServerRequest('GET', '/page.tpl');
                $response = $app->handle($request);

                $this->assertSame(200, $response->getStatusCode());
                $this->assertStringContainsString('Hello', (string) $response->getBody());
            } finally {
                @unlink($file);
            }
        }

        public function testTemplateMapperNormalizesEmptyPathToIndexHtml(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $file = $templateDir . '/index.html';
            file_put_contents($file, '<p>root</p>');

            try {
                $request = (new ServerRequestFactory())->createServerRequest('GET', '/');
                $response = $app->handle($request);

                $this->assertSame(200, $response->getStatusCode());
                $this->assertStringContainsString('root', (string) $response->getBody());
            } finally {
                @unlink($file);
            }
        }

        public function testTemplateMapperServesStaticWithGzip(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $file = $templateDir . '/static.html';
            file_put_contents($file, '<h1>Hi</h1>');

            try {
                $request = (new ServerRequestFactory())
                    ->createServerRequest('GET', '/static.html')
                    ->withHeader('Accept-Encoding', 'gzip');
                $response = $app->handle($request);

                $this->assertSame('gzip', $response->getHeaderLine('Content-Encoding'));
                $this->assertSame('text/html; charset=utf-8', $response->getHeaderLine('Content-Type'));
                $this->assertSame('<h1>Hi</h1>', gzdecode((string) $response->getBody()));
            } finally {
                @unlink($file);
            }
        }

        public function testTemplateMapperReturns304ForMatchingEtag(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $file = $templateDir . '/static.txt';
            file_put_contents($file, 'hello');

            try {
                $lastModifiedTime = filemtime($file) ?: time();
                $fileSize = filesize($file) ?: 0;
                $etag = sprintf('W/"%x-%x"', $fileSize, $lastModifiedTime);

                $request = (new ServerRequestFactory())
                    ->createServerRequest('GET', '/static.txt')
                    ->withHeader('If-None-Match', $etag);
                $response = $app->handle($request);

                $this->assertSame(304, $response->getStatusCode());
                $this->assertSame($etag, $response->getHeaderLine('ETag'));
            } finally {
                @unlink($file);
            }
        }

        public function testTemplateMapperFallbacksToIndexHtml(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $fallback = $templateDir . '/index.html';
            file_put_contents($fallback, 'fallback');

            try {
                $request = (new ServerRequestFactory())->createServerRequest('GET', '/missing');
                $response = $app->handle($request);

                $this->assertSame(200, $response->getStatusCode());
                $this->assertStringContainsString('fallback', (string) $response->getBody());
            } finally {
                @unlink($fallback);
            }
        }

        public function testTemplateMapperFallbacksToIndexTpl(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $fallback = $templateDir . '/index.tpl';
            file_put_contents($fallback, 'tpl fallback');

            try {
                $request = (new ServerRequestFactory())->createServerRequest('GET', '/missing');
                $response = $app->handle($request);

                $this->assertSame(200, $response->getStatusCode());
                $this->assertStringContainsString('tpl fallback', (string) $response->getBody());
            } finally {
                @unlink($fallback);
            }
        }

        public function testTemplateMapperReturns404ForTraversal(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $request = (new ServerRequestFactory())->createServerRequest('GET', '/../secret');
            $response = $app->handle($request);

            $this->assertSame(404, $response->getStatusCode());
            $this->assertStringContainsString('Not Found', (string) $response->getBody());
        }

        public function testTemplateMapperReturns500WhenGzipReadFails(): void
        {
            $app = $this->buildAppWithTwig();
            TemplateMapper::register($app);

            $templateDir = $this->templatesDir();
            $file = $templateDir . '/error.html';
            file_put_contents($file, '<p>fail</p>');

            TemplateMapperTestHook::$forceFileGetContentsFail = true;
            try {
                $request = (new ServerRequestFactory())
                    ->createServerRequest('GET', '/error.html')
                    ->withHeader('Accept-Encoding', 'gzip');
                $response = $app->handle($request);

                $this->assertSame(500, $response->getStatusCode());
                $this->assertStringContainsString('Error reading file', (string) $response->getBody());
            } finally {
                TemplateMapperTestHook::$forceFileGetContentsFail = false;
                @unlink($file);
            }
        }
    }
}
