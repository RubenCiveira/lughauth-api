<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Log\LogManagement;

final class LogManagementUnitTest extends TestCase
{
    public function testGetFiltersAndReadsLogs(): void
    {
        $dir = $this->createLogDir();
        $this->writeLog($dir . '/app-2024.jsonl', [
            ['message' => 'hello', 'level' => 100, 'level_name' => 'DEBUG', 'datetime' => '2024-01-01 00:00:00', 'extra' => ['service' => ['service.name' => 'svc'], 'traceId' => 't1']]
        ]);

        $this->writeGzLog($dir . '/app-2023.jsonl.gz', [
            ['message' => 'world', 'level' => 200, 'level_name' => 'INFO', 'datetime' => '2024-01-02 00:00:00', 'extra' => ['service' => ['service.name' => 'svc'], 'traceId' => 't2']]
        ]);

        $management = new LogManagement($this->config('app'), $dir);
        $request = $this->request(['search' => 'hello', 'limit' => 10]);

        $result = ($management->get())($request);

        $this->assertCount(1, $result);
        $this->assertSame('hello', $result[0]['message']);
    }

    public function testGetSkipsInvalidLines(): void
    {
        $dir = $this->createLogDir();
        file_put_contents($dir . '/app-2024.jsonl', "\ninvalid\n");

        $management = new LogManagement($this->config('app'), $dir);
        $result = ($management->get())($this->request([]));

        $this->assertSame([], $result);
    }

    private function createLogDir(): string
    {
        $dir = sys_get_temp_dir() . '/logs_' . uniqid();
        mkdir($dir, 0777, true);
        return $dir;
    }

    private function writeLog(string $path, array $rows): void
    {
        $lines = array_map(fn ($row) => json_encode($row, JSON_THROW_ON_ERROR), $rows);
        file_put_contents($path, implode("\n", $lines));
    }

    private function writeGzLog(string $path, array $rows): void
    {
        $lines = array_map(fn ($row) => json_encode($row, JSON_THROW_ON_ERROR), $rows);
        $content = implode("\n", $lines);
        file_put_contents($path, gzencode($content));
    }

    private function config(string $name): AppConfig
    {
        return new class ($name) extends AppConfig {
            public function __construct(private readonly string $value)
            {
                $this->develop = true;
                $this->name = $this->value;
                $this->managementEndpoint = '/management';
            }
        };
    }

    private function request(array $params): ServerRequestInterface
    {
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getQueryParams')->willReturn($params);
        return $request;
    }
}
