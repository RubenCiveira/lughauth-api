<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Trace\TraceManagement;

final class TraceManagementUnitTest extends TestCase
{
    public function testGetFiltersByTraceId(): void
    {
        $dir = $this->createTraceDir();
        $this->writeTrace($dir . '/app-2024.jsonl', [
            ['traceId' => 't1', 'name' => 'root', 'status' => 'OK', 'parentSpanId' => '0000000000000000', 'extra' => ['service' => ['service.namespace' => 'ns']]],
            ['traceId' => 't2', 'name' => 'child', 'status' => 'OK', 'parentSpanId' => '0000000000000000', 'extra' => ['service' => ['service.namespace' => 'ns']]]
        ]);

        $management = new TraceManagement($this->config('app'), $dir);
        $request = $this->request(['trace-id' => 't1']);

        $result = ($management->get())($request);

        $this->assertCount(1, $result);
        $this->assertSame('t1', $result[0]['traceId']);
    }

    public function testGetWithoutFiltersReturnsRootSpans(): void
    {
        $dir = $this->createTraceDir();
        $this->writeTrace($dir . '/app-2024.jsonl', [
            ['traceId' => 't1', 'name' => 'root', 'status' => 'OK', 'parentSpanId' => '0000000000000000', 'extra' => ['service' => ['service.namespace' => 'ns']]],
            ['traceId' => 't1', 'name' => 'child', 'status' => 'OK', 'parentSpanId' => 'span', 'extra' => ['service' => ['service.namespace' => 'ns']]]
        ]);

        $management = new TraceManagement($this->config('app'), $dir);
        $request = $this->request([]);

        $result = ($management->get())($request);

        $this->assertCount(1, $result);
        $this->assertSame('root', $result[0]['name']);
    }

    public function testGetSkipsInvalidLines(): void
    {
        $dir = $this->createTraceDir();
        file_put_contents($dir . '/app-2024.jsonl', "\ninvalid\n");

        $management = new TraceManagement($this->config('app'), $dir);
        $result = ($management->get())($this->request([]));

        $this->assertSame([], $result);
    }

    private function createTraceDir(): string
    {
        $dir = sys_get_temp_dir() . '/trace_' . uniqid();
        mkdir($dir, 0777, true);
        return $dir;
    }

    private function writeTrace(string $path, array $rows): void
    {
        $lines = [];
        foreach ($rows as $row) {
            $lines[] = json_encode($row, JSON_THROW_ON_ERROR);
        }
        file_put_contents($path, implode("\n", $lines));
    }

    private function config(string $name): AppConfig
    {
        return new class ($name) extends AppConfig {
            public function __construct(private readonly string $value)
            {
                $this->develop = true;
                $this->name = $this->value;
                $this->managementEndpoint = '/management';
            }
        };
    }

    private function request(array $params): ServerRequestInterface
    {
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getQueryParams')->willReturn($params);
        return $request;
    }
}
