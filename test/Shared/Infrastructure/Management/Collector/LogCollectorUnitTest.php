<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Log\LoggerInterface;
use Slim\Psr7\Factory\StreamFactory;
use Civi\Lughauth\Shared\Infrastructure\Management\Collector\LogCollector;

final class LogCollectorUnitTest extends TestCase
{
    public function testSetLogsRecords(): void
    {
        $logger = $this->createMock(LoggerInterface::class);
        $logger->expects($this->once())
            ->method('log')
            ->with('info', 'message', $this->arrayHasKey('service'));

        $collector = new LogCollector($logger);
        $request = $this->request([
            'resourceLogs' => [[
                'resource' => ['attributes' => [
                    ['key' => 'service.name', 'value' => ['stringValue' => 'app']]
                ]],
                'scopeLogs' => [[
                    'scope' => ['name' => 'scope'],
                    'logRecords' => [[
                        'severityText' => 'info',
                        'body' => ['stringValue' => 'message'],
                        'attributes' => [
                            ['key' => 'key', 'value' => ['stringValue' => 'val']]
                        ]
                    ]]
                ]]
            ]]
        ]);

        $result = ($collector->set())($request);

        $this->assertSame(['status' => 'ok'], $result);
    }

    private function request(array $payload): ServerRequestInterface
    {
        $stream = (new StreamFactory())->createStream(json_encode($payload, JSON_THROW_ON_ERROR));
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getBody')->willReturn($stream);
        return $request;
    }
}
