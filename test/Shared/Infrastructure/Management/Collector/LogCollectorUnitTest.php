<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Log\LoggerInterface;
use Slim\Psr7\Factory\StreamFactory;
use Civi\Lughauth\Shared\Infrastructure\Management\Collector\LogCollector;

/**
 * Unit tests for {@see LogCollector}.
 */
final class LogCollectorUnitTest extends TestCase
{
    /**
     * Ensures log records are forwarded to the logger.
     */
    public function testSetLogsRecords(): void
    {
        /* Arrange: create a logger expectation and OTLP log payload. */
        $logger = $this->createMock(LoggerInterface::class);
        $logger->expects($this->once())
            ->method('log')
            ->with('info', 'message', $this->arrayHasKey('service'));

        $collector = new LogCollector($logger);
        $request = $this->request([
            'resourceLogs' => [[
                'resource' => ['attributes' => [
                    ['key' => 'service.name', 'value' => ['stringValue' => 'app']]
                ]],
                'scopeLogs' => [[
                    'scope' => ['name' => 'scope'],
                    'logRecords' => [[
                        'severityText' => 'info',
                        'body' => ['stringValue' => 'message'],
                        'attributes' => [
                            ['key' => 'key', 'value' => ['stringValue' => 'val']]
                        ]
                    ]]
                ]]
            ]]
        ]);

        /* Act: execute the log collector handler. */
        $result = ($collector->set())($request);

        /* Assert: verify the handler returns an ok response. */
        $this->assertSame(['status' => 'ok'], $result);
        $this->assertNull($collector->get());
        $this->assertSame('log-collector', $collector->name());
    }

    /**
     * Ensures defaults are applied when optional fields are missing.
     */
    public function testSetUsesDefaults(): void
    {
        /* Arrange: logger captures defaulted context and values. */
        $logger = $this->createMock(LoggerInterface::class);
        $logger->expects($this->once())
            ->method('log')
            ->with(
                'warning',
                '',
                $this->callback(function (array $context): bool {
                    $this->assertSame('unknown', $context['service']);
                    $this->assertSame('default', $context['scope']);
                    $this->assertSame('value', $context['key']);
                    return true;
                })
            );

        $collector = new LogCollector($logger);
        $request = $this->request([
            'resourceLogs' => [[
                'resource' => ['attributes' => []],
                'scopeLogs' => [[
                    'logRecords' => [[
                        'severityText' => 'WARNING',
                        'attributes' => [
                            ['key' => 'key', 'value' => ['stringValue' => 'value']]
                        ]
                    ]]
                ]]
            ]]
        ]);

        /* Act: execute the log collector handler. */
        $result = ($collector->set())($request);

        /* Assert: verify the handler returns an ok response. */
        $this->assertSame(['status' => 'ok'], $result);
    }

    private function request(array $payload): ServerRequestInterface
    {
        $stream = (new StreamFactory())->createStream(json_encode($payload, JSON_THROW_ON_ERROR));
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getBody')->willReturn($stream);
        return $request;
    }
}
