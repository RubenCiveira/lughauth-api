<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Management\Histogram\PromQLInterpreter;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsQuery;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsFS;

final class PromQLInterpreterUnitTest extends TestCase
{
    public function testEvaluateSelectorUsesRange(): void
    {
        [$query, $root] = $this->createQuery();
        $query->range('metric', 1000, 2000, 5, 'raw');

        $engine = new PromQLInterpreter($query);
        $result = $engine->evaluate('metric{status="200"}', 1000, 2000, 5, 'raw');

        $this->assertSame('200', $result[0]['labels']['status']);
        $this->assertNotEmpty($result[0]['points']);
    }

    public function testEvaluateRateUsesRate(): void
    {
        [$query, $root] = $this->createQuery();

        $engine = new PromQLInterpreter($query);
        $result = $engine->evaluate('rate(metric[5m])', 1000, 4000, 1, 'raw');

        $this->assertNotEmpty($result[0]['points']);
    }

    public function testAggregateAvg(): void
    {
        $root = sys_get_temp_dir() . '/metrics_' . uniqid();
        $fs = new MetricsFS($root);
        $query = new MetricsQuery($fs);
        $fs->appendRaw('metric', ['status' => '200', 'instance' => 'a'], 2, 1500);
        $fs->appendRaw('metric', ['status' => '200', 'instance' => 'b'], 4, 1500);

        $engine = new PromQLInterpreter($query);
        $result = $engine->evaluate('avg by (status) (metric)', 1000, 2000, 1, 'raw');

        $this->assertSame(3.0, $result[0]['points'][0][1]);
    }

    public function testInvalidMatcherThrows(): void
    {
        [$query] = $this->createQuery();
        $engine = new PromQLInterpreter($query);

        $this->expectException(InvalidArgumentException::class);
        $engine->evaluate('metric{bad}', 0, 10, 5, 'raw');
    }

    private function createQuery(): array
    {
        $root = sys_get_temp_dir() . '/metrics_' . uniqid();
        $fs = new MetricsFS($root);
        $fs->appendRaw('metric', ['status' => '200'], 1, 1500);
        $fs->appendRaw('metric', ['status' => '200'], 2, 2500);

        return [new MetricsQuery($fs), $root];
    }
}
