<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\UriInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Histogram\HistogramManagement;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsQuery;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsFS;

/**
 * Unit tests for {@see HistogramManagement}.
 */
final class HistogramManagementUnitTest extends TestCase
{
    /**
     * Ensures histogram payloads include series and metadata.
     */
    public function testGetReturnsPayload(): void
    {
        /* Arrange: create the histogram query handler and request. */
        $query = $this->createQuery();
        $management = new HistogramManagement($this->config(), $query);
        $request = $this->request('q=metric&start=now-1h&end=now&step=60s');

        /* Act: execute the histogram handler. */
        $result = ($management->get())($request);

        /* Assert: verify metadata and series labels are returned. */
        $this->assertSame('histogram', $management->name());
        $this->assertSame(60_000, $result['stepMs']);
        $this->assertSame('200', $result['series'][0]['labels']['status']);
    }

    /**
     * Ensures missing query parameters raise an exception.
     */
    public function testGetThrowsOnMissingQuery(): void
    {
        /* Arrange: create a histogram handler without a query. */
        $management = new HistogramManagement($this->config(), $this->createQuery());

        /* Act: execute the handler with missing query parameters. */
        $this->expectException(InvalidArgumentException::class);
        ($management->get())($this->request(''));

        /* Assert: verify the invalid argument exception is thrown. */
    }

    /**
     * Ensures CSV responses are returned when requested.
     */
    public function testGetCsvFormat(): void
    {
        /* Arrange: create a handler and CSV request. */
        $management = new HistogramManagement($this->config(), $this->createQuery());
        $request = $this->request('q=metric&start=now-1h&end=now&step=60s&format=csv');

        /* Act: execute the histogram handler in CSV mode. */
        $result = ($management->get())($request);

        /* Assert: verify the CSV output includes the expected headers. */
        $this->assertStringContainsString('query,labels', $result);
    }

    private function request(string $query): ServerRequestInterface
    {
        $uri = $this->createMock(UriInterface::class);
        $uri->method('getQuery')->willReturn($query);

        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUri')->willReturn($uri);
        return $request;
    }

    private function config(): AppConfig
    {
        return new class () extends AppConfig {
            public function __construct()
            {
                $this->develop = true;
                $this->name = 'app';
                $this->managementEndpoint = '/management';
            }
        };
    }

    private function createQuery(): MetricsQuery
    {
        $root = sys_get_temp_dir() . '/metrics_' . uniqid();
        $fs = new MetricsFS($root);
        $fs->appendRaw('metric', ['status' => '200'], 1, 1500);
        return new MetricsQuery($fs);
    }
}
