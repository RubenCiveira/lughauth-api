<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\UriInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Histogram\HistogramManagement;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsQuery;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsFS;

final class HistogramManagementUnitTest extends TestCase
{
    public function testGetReturnsPayload(): void
    {
        $query = $this->createQuery();
        $management = new HistogramManagement($this->config(), $query);
        $request = $this->request('q=metric&start=now-1h&end=now&step=60s');

        $result = ($management->get())($request);

        $this->assertSame('histogram', $management->name());
        $this->assertSame(60_000, $result['stepMs']);
        $this->assertSame('200', $result['series'][0]['labels']['status']);
    }

    public function testGetThrowsOnMissingQuery(): void
    {
        $management = new HistogramManagement($this->config(), $this->createQuery());

        $this->expectException(InvalidArgumentException::class);
        ($management->get())($this->request(''));
    }

    public function testGetCsvFormat(): void
    {
        $management = new HistogramManagement($this->config(), $this->createQuery());
        $request = $this->request('q=metric&start=now-1h&end=now&step=60s&format=csv');

        $result = ($management->get())($request);

        $this->assertStringContainsString('query,labels', $result);
    }

    private function request(string $query): ServerRequestInterface
    {
        $uri = $this->createMock(UriInterface::class);
        $uri->method('getQuery')->willReturn($query);

        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getUri')->willReturn($uri);
        return $request;
    }

    private function config(): AppConfig
    {
        return new class () extends AppConfig {
            public function __construct()
            {
                $this->develop = true;
                $this->name = 'app';
                $this->managementEndpoint = '/management';
            }
        };
    }

    private function createQuery(): MetricsQuery
    {
        $root = sys_get_temp_dir() . '/metrics_' . uniqid();
        $fs = new MetricsFS($root);
        $fs->appendRaw('metric', ['status' => '200'], 1, 1500);
        return new MetricsQuery($fs);
    }
}
