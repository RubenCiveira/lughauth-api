<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Symfony\Component\Console\Output\BufferedOutput;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Migration\Phix;

final class PhixUnitTest extends TestCase
{
    public function testName(): void
    {
        $phix = new TestablePhix($this->config('mysql:host=localhost;dbname=db'), $this->managerWithMigrations(true, true, ''));
        $this->assertSame('database-schema', $phix->name());
    }

    public function testStatusUsesDumpStatus(): void
    {
        $manager = $this->managerWithMigrations(true, true, 'output');
        $phix = new TestablePhix($this->config('mysql:host=localhost;dbname=db'), $manager);
        $result = $phix->status();

        $this->assertSame(['status' => ['Init[1]' => 'Ready']], $result);
    }

    public function testMigrateDiff(): void
    {
        $manager = $this->managerWithMigrations(false, true, 'output');
        $phix = new TestablePhix($this->config('mysql:host=localhost;dbname=db'), $manager);
        $result = $phix->migrate();

        $this->assertSame('Migrated', $result['status']['Init[1]']);
        $this->assertSame('output', $result['detail']);
    }

    public function testParseWithCredentials(): void
    {
        $_ENV['DATABASE_USERNAME'] = 'user';
        $_ENV['DATABASE_PASSWORD'] = 'pass';

        $phix = new TestablePhix($this->config('mysql:host=localhost;port=3306;dbname=test'), $this->managerWithMigrations(true, true, ''));
        $data = $phix->parse();

        $this->assertSame('mysql', $data['adapter']);
        $this->assertSame('localhost', $data['host']);
        $this->assertSame('3306', $data['port']);
        $this->assertSame('test', $data['name']);
        $this->assertSame('user', $data['user']);
        $this->assertSame('pass', $data['pass']);
    }

    public function testParseThrowsOnInvalidDsn(): void
    {
        $phix = new TestablePhix($this->config('invalid_dsn'), $this->managerWithMigrations(true, true, ''));

        $this->expectException(InvalidArgumentException::class);
        $phix->parse();
    }

    private function config(string $dsn): AppConfig
    {
        return new class ($dsn) extends AppConfig {
            public function __construct(private readonly string $dsn)
            {
                $this->develop = true;
                $this->name = 'app';
                $this->managementEndpoint = '/management';
            }

            public function get(string $name, mixed $def = null): mixed
            {
                if ($name === 'database.url') {
                    return $this->dsn;
                }
                if ($name === 'database.username') {
                    return 'user';
                }
                if ($name === 'database.password') {
                    return 'pass';
                }
                return $def;
            }
        };
    }

    private function managerWithMigrations(bool $beforeUp, bool $afterUp, string $output): \Phinx\Migration\Manager
    {
        $migrations = [
            '1' => new FakeMigration('Init', $beforeUp)
        ];
        $manager = $this->getMockBuilder(\Phinx\Migration\Manager::class)
            ->disableOriginalConstructor()
            ->getMock();
        $manager->method('getMigrations')->willReturnCallback(function () use (&$migrations) {
            return $migrations;
        });
        $manager->method('getOutput')->willReturn((function () use ($output) {
            $buffer = new BufferedOutput();
            $buffer->write($output);
            return $buffer;
        })());
        $manager->method('migrate')->willReturnCallback(function () use (&$migrations, $afterUp) {
            $migrations = [
                '1' => new FakeMigration('Init', $afterUp)
            ];
        });
        return $manager;
    }
}

final class TestablePhix extends Phix
{
    public function __construct(AppConfig $config, private readonly \Phinx\Migration\Manager $manager)
    {
        parent::__construct($config);
    }

    public function parse(): array
    {
        return parent::parse();
    }

    protected function build(): \Phinx\Migration\Manager
    {
        return $this->manager;
    }
}

final class FakeMigration
{
    public function __construct(private readonly string $name, private readonly bool $up)
    {
    }

    public function getName(): string
    {
        return $this->name;
    }

    public function isMigratingUp(): bool
    {
        return $this->up;
    }
}
