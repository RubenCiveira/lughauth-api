<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Management\Health\HealthManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Health\HealthDetail;
use Civi\Lughauth\Shared\Infrastructure\Management\Health\HealthProviderInterface;

final class HealthManagementUnitTest extends TestCase
{
    public function testHealthStatusWithProviders(): void
    {
        $management = new HealthManagement();
        $management->addProvider($this->provider(HealthDetail::up('db', ['latency' => 10])));
        $management->addProvider($this->provider(HealthDetail::unknown('cache')));

        $result = ($management->get())();

        $this->assertSame('UNKWOWN', $result['status']);
        $this->assertSame('UP', $result['components']['db']['status']);
        $this->assertSame(['latency' => 10], $result['components']['db']['details']);
        $this->assertSame('UNKWOWN', $result['components']['cache']['status']);
    }

    public function testHealthStatusDownOverrides(): void
    {
        $management = new HealthManagement();
        $management->addProvider($this->provider(HealthDetail::down('db')));
        $management->addProvider($this->provider(HealthDetail::unknown('cache')));

        $result = ($management->get())();

        $this->assertSame('DOWN', $result['status']);
    }

    public function testHealthStatusWithoutProviders(): void
    {
        $management = new HealthManagement();

        $result = ($management->get())();

        $this->assertSame(['status' => 'UP'], $result);
    }

    private function provider(HealthDetail $detail): HealthProviderInterface
    {
        return new class ($detail) implements HealthProviderInterface {
            public function __construct(private readonly HealthDetail $detail)
            {
            }

            public function check(): HealthDetail
            {
                return $this->detail;
            }
        };
    }
}
