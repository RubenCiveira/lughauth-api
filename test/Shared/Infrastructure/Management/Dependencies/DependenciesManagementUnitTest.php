<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Management\Dependencies\DependenciesManagement;

final class DependenciesManagementUnitTest extends TestCase
{
    public function testGetReadsComposerLock(): void
    {
        $dir = sys_get_temp_dir() . '/deps_' . uniqid();
        mkdir($dir, 0777, true);
        file_put_contents($dir . '/composer.lock', json_encode([
            'packages' => [
                ['name' => 'pkg/a', 'version' => '1.0', 'type' => 'library', 'source' => ['url' => 'http://a']]
            ],
            'packages-dev' => [
                ['name' => 'pkg/b', 'version' => '2.0', 'dist' => ['url' => 'http://b']]
            ]
        ], JSON_THROW_ON_ERROR));

        $management = new DependenciesManagement($dir);
        $result = ($management->get())();

        $this->assertSame('dependencies', $management->name());
        $this->assertCount(2, $result);
        $this->assertSame('pkg/a', $result[0]['name']);
        $this->assertSame('pkg/b', $result[1]['name']);
    }

    public function testGetThrowsWhenMissing(): void
    {
        $dir = sys_get_temp_dir() . '/deps_missing_' . uniqid();
        mkdir($dir, 0777, true);

        $management = new DependenciesManagement($dir);

        $this->expectException(Exception::class);
        ($management->get())();
    }
}
