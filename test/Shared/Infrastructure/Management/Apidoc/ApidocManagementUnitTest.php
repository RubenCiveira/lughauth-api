<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Slim\App;
use Slim\Psr7\Response;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Infrastructure\Management\Apidoc\ApidocManagement;

/**
 * Unit tests for {@see ApidocManagement}.
 */
final class ApidocManagementUnitTest extends TestCase
{
    /**
     * Ensures the YAML format is returned when requested.
     */
    public function testGetReturnsYaml(): void
    {
        /* Arrange: create the management handler and YAML request. */
        $management = new ApidocManagement($this->createMock(App::class), $this->context('http://base'));
        $request = $this->request(['format' => 'yaml']);
        $response = new Response();

        /* Act: execute the API documentation handler. */
        $result = ($management->get())($request, $response);

        /* Assert: verify content type and payload include the spec. */
        $this->assertSame('text/plain', $result->getHeaderLine('ContentType'));
        $this->assertStringContainsString('openapi', (string) $result->getBody());
    }

    /**
     * Ensures the HTML UI is returned when no format is provided.
     */
    public function testGetReturnsHtml(): void
    {
        /* Arrange: create the management handler and HTML request. */
        $management = new ApidocManagement($this->createMock(App::class), $this->context('http://base'));
        $request = $this->request([]);
        $response = new Response();

        /* Act: execute the API documentation handler. */
        $result = ($management->get())($request, $response);

        /* Assert: verify the HTML content type and UI markup. */
        $this->assertSame('text/html', $result->getHeaderLine('ContentType'));
        $this->assertStringContainsString('Swagger UI', (string) $result->getBody());
    }

    /**
     * Ensure name and no sett
     */
    public function testNameAndNoSetter(): void
    {
        /* Arrange: create a managed */
        $management = new ApidocManagement($this->createMock(App::class), $this->context('http://base'));
        
        /* Assert: open-api is always the name, and there is no setter */
        $this->assertSame('open-api', $management->name());
        $this->assertNull($management->set());
    }

    private function request(array $params): ServerRequestInterface
    {
        $request = $this->createMock(ServerRequestInterface::class);
        $request->method('getQueryParams')->willReturn($params);
        return $request;
    }

    private function context(string $baseUrl): Context
    {
        $context = $this->createMock(Context::class);
        $context->method('getBaseUrl')->willReturn($baseUrl);
        return $context;
    }
}
