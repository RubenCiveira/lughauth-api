<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Slim\Interfaces\DispatcherInterface;
use Slim\Interfaces\RouteParserInterface;
use Slim\Routing\RouteContext;
use Slim\Routing\RoutingResults;
use Twig\Loader\ArrayLoader;
use Civi\Lughauth\Shared\Infrastructure\View\AssetOptimizingTwigEnvironment;

final class AssetOptimizingTwigEnvironmentUnitTest extends TestCase
{
    public function testPathAndAssetFunctions(): void
    {
        $request = $this->createRequest('/base');
        $env = new AssetOptimizingTwigEnvironment($request, new ArrayLoader(['tpl' => 'ok']));

        $path = $env->getFunction('path')->getCallable();
        $asset = $env->getFunction('asset')->getCallable();

        $this->assertSame('/base/users?id=1', $path('users', ['id' => 1]));
        $this->assertSame('/base/assets/app.js', $asset('app.js'));
    }

    public function testDisplayOutputsRendered(): void
    {
        $request = $this->createRequest('/base');
        $env = new AssetOptimizingTwigEnvironment($request, new ArrayLoader(['tpl' => 'hello']));

        ob_start();
        $env->display('tpl');
        $output = ob_get_clean();

        $this->assertSame('hello', $output);
    }

    private function createRequest(string $basePath): \Psr\Http\Message\ServerRequestInterface
    {
        $dispatcher = $this->createMock(DispatcherInterface::class);
        $routeParser = $this->createMock(RouteParserInterface::class);
        $routingResults = new RoutingResults($dispatcher, 'GET', '/', RoutingResults::NOT_FOUND);

        $request = $this->createMock(\Psr\Http\Message\ServerRequestInterface::class);
        $request->method('getAttribute')->willReturnMap([
            [RouteContext::ROUTE, null, null],
            [RouteContext::ROUTE_PARSER, null, $routeParser],
            [RouteContext::ROUTING_RESULTS, null, $routingResults],
            [RouteContext::BASE_PATH, null, $basePath],
        ]);

        return $request;
    }
}
