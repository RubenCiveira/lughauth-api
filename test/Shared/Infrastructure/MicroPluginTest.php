<?php

/* @autogenerated */
declare(strict_types=1);

namespace {
    use DI\Container;
    use PHPUnit\Framework\TestCase;
    use Psr\Container\ContainerInterface;
    use Slim\App;
    use Slim\Routing\RouteCollectorProxy;
    use Slim\Middleware\ErrorMiddleware;
    use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
    use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
    use Civi\Lughauth\Shared\Infrastructure\Scheduler\SchedulerManager;
    use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;

    final class MicroPluginSpy extends MicroPlugin
    {
        public ?RouteCollectorProxy $routes = null;
        public ?EventListenersRegistrarInterface $events = null;
        public ?SchedulerManager $schedulers = null;
        public ?ErrorMiddleware $errors = null;

        public function registerRoutes(RouteCollectorProxy $app): void
        {
            $this->routes = $app;
        }

        public function registerEvents(EventListenersRegistrarInterface $bus): void
        {
            $this->events = $bus;
        }

        public function registerSchedulers(SchedulerManager $bus): void
        {
            $this->schedulers = $bus;
        }

        public function registerErrorHandler(ErrorMiddleware $errorHandler): void
        {
            $this->errors = $errorHandler;
        }
    }

    final class MicroPluginBlank extends MicroPlugin
    {
    }

    /**
     * Unit tests for {@see MicroPlugin}.
     */
    final class MicroPluginTest extends TestCase
    {
        /**
         * Ensures bindServices wires all plugin hooks.
         */
        public function testBindServicesInvokesAllHooks(): void
        {
            /*
             * Arrange: build a plugin and container with required services.
             */
            $app = $this->createMock(App::class);
            $bus = $this->createMock(EventListenersRegistrarInterface::class);
            $scheduler = $this->createMock(SchedulerManager::class);
            $error = $this->createMock(ErrorMiddleware::class);
            $container = $this->createMock(Container::class);
            $container->method('get')->willReturnCallback(function (string $id) use ($app, $bus, $scheduler, $error) {
                return match ($id) {
                    App::class => $app,
                    EventListenersRegistrarInterface::class => $bus,
                    SchedulerManager::class => $scheduler,
                    ErrorMiddleware::class => $error,
                    default => null,
                };
            });
            $plugin = new MicroPluginSpy();

            /*
             * Act: bind services for the plugin.
             */
            $plugin->bindServices($container);

            /*
             * Assert: verify each hook received the expected service.
             */
            $this->assertSame($app, $plugin->routes);
            $this->assertSame($bus, $plugin->events);
            $this->assertSame($scheduler, $plugin->schedulers);
            $this->assertSame($error, $plugin->errors);
        }

        /**
         * Ensures default hooks are safe no-ops.
         */
        public function testDefaultHooksAreNoOps(): void
        {
            /*
             * Arrange: build a blank plugin and mock dependencies.
             */
            $plugin = new MicroPluginBlank();
            $routes = $this->createMock(RouteCollectorProxy::class);
            $events = $this->createMock(EventListenersRegistrarInterface::class);
            $scheduler = $this->createMock(SchedulerManager::class);
            $error = $this->createMock(ErrorMiddleware::class);
            $startup = $this->createMock(StartupProcessor::class);

            /*
             * Act: invoke default hooks with mocks.
             */
            $plugin->registerRoutes($routes);
            $plugin->registerEvents($events);
            $plugin->registerSchedulers($scheduler);
            $plugin->registerErrorHandler($error);
            $plugin->registerStartup($startup);

            /*
             * Assert: verify no exceptions were thrown.
             */
            $this->assertTrue(true);
        }

        /**
         * Ensures default management interfaces are empty.
         */
        public function testDefaultManagementInterfacesAreEmpty(): void
        {
            /*
             * Arrange: build a blank plugin and container stub.
             */
            $plugin = new MicroPluginBlank();
            $container = $this->createMock(ContainerInterface::class);

            /*
             * Act: fetch management interfaces.
             */
            $result = $plugin->getManagementsInterfaces($container);

            /*
             * Assert: verify the result is an empty array.
             */
            $this->assertSame([], $result);
        }

        /**
         * Ensures service definitions are returned unchanged.
         */
        public function testRegisterServiceDefinitionReturnsSameArray(): void
        {
            /*
             * Arrange: build a blank plugin and service definition.
             */
            $plugin = new MicroPluginBlank();
            $definition = ['service' => 'value'];

            /*
             * Act: register the service definition.
             */
            $result = $plugin->registerServiceDefinition($definition);

            /*
             * Assert: verify the definition is unchanged.
             */
            $this->assertSame($definition, $result);
        }
    }
}
