<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Monolog\Level;
use Monolog\LogRecord;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Observability\TraceContext;
use Civi\Lughauth\Shared\Infrastructure\Log\TraceContextProcessor;

/**
 * Unit tests for {@see TraceContextProcessor}.
 */
final class TraceContextProcessorUnitTest extends TestCase
{
    /**
     * Ensures trace and service context are appended to log records.
     */
    public function testInvokeAddsTraceContext(): void
    {
        /* Arrange: create trace and application context mocks plus a base log record. */
        $traceContext = $this->createMock(TraceContext::class);
        $traceContext->method('getTraceId')->willReturn('trace-123');
        $traceContext->method('getSpanId')->willReturn('span-456');

        $appContext = $this->createMock(Context::class);
        $appContext->method('getInstanceData')->willReturn([
            'service.name' => 'auth-service',
            'service.namespace' => 'core',
        ]);

        $record = new LogRecord(new DateTimeImmutable('2024-01-01 00:00:00'), 'app', Level::Info, 'hello');
        $processor = new TraceContextProcessor($traceContext, $appContext);

        /* Act: process the log record through the trace context processor. */
        $result = $processor($record);

        /* Assert: verify trace identifiers and service metadata were added. */
        $this->assertSame('trace-123', $result['extra']['traceId']);
        $this->assertSame('span-456', $result['extra']['spanId']);
        $this->assertSame([
            'service.name' => 'auth-service',
            'service.namespace' => 'core',
        ], $result['extra']['service']);
    }
}
