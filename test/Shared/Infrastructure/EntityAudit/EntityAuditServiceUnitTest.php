<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\EntityAudit\EntityAuditEntry;
use Civi\Lughauth\Shared\Infrastructure\EntityAudit\EntityAuditService;

final class EntityAuditServiceUnitTest extends TestCase
{
    public function testRecordStoresDiffValues(): void
    {
        $pdo = $this->createSqlite();
        $this->createAuditTable($pdo);
        $service = new EntityAuditService($pdo);

        $entry = new EntityAuditEntry(
            'trace',
            'span',
            'update',
            'usecase',
            'User',
            '1',
            ['name' => 'old', 'same' => 'value'],
            ['name' => 'new', 'same' => 'value'],
            'actor',
            'tenant',
            new DateTimeImmutable('2024-01-01 00:00:00'),
            '/path',
            '127.0.0.1',
            'app',
            'device',
            ['role' => 'admin']
        );

        $service->record($entry);

        $row = $pdo->query('SELECT old_values, new_values FROM _audit')->fetch(PDO::FETCH_ASSOC);
        $this->assertSame(['name' => 'old'], json_decode($row['old_values'], true));
        $this->assertSame(['name' => 'new'], json_decode($row['new_values'], true));
    }

    public function testFindByFiltersBuildsEvents(): void
    {
        $pdo = $this->createSqlite();
        $this->createAuditTable($pdo);
        $service = new EntityAuditService($pdo);

        $stmt = $pdo->prepare('INSERT INTO _audit (id, operation, usecase, trace_id, entity_type, entity_id, old_values, new_values, performed_by, tenant, timestamp, source_request, remote_address, remote_application, remote_device, claims, span_id)
            VALUES (:id, :operation, :usecase, :trace_id, :entity_type, :entity_id, :old_values, :new_values, :performed_by, :tenant, :timestamp, :source_request, :remote_address, :remote_application, :remote_device, :claims, :span_id)');
        $stmt->execute([
            'id' => 'id1',
            'operation' => 'create',
            'usecase' => 'use',
            'trace_id' => 'trace',
            'entity_type' => 'User',
            'entity_id' => '1',
            'old_values' => json_encode(new stdClass(), JSON_THROW_ON_ERROR),
            'new_values' => json_encode(['name' => 'A'], JSON_THROW_ON_ERROR),
            'performed_by' => 'actor',
            'tenant' => 'tenant',
            'timestamp' => '2024-01-01 00:00:00.000000',
            'source_request' => '/path',
            'remote_address' => '127.0.0.1',
            'remote_application' => 'app',
            'remote_device' => 'device',
            'claims' => json_encode(['role' => 'admin'], JSON_THROW_ON_ERROR),
            'span_id' => 'span',
        ]);

        $filters = [
            'performed_by' => 'actor',
            'entity_type' => 'User',
            'entity_id' => '1',
            'operation' => 'create',
            'trace_id' => 'trace',
            'span_id' => 'span',
            'from' => '2024-01-01 00:00:00',
            'to' => '2024-01-01 23:59:59',
        ];

        $events = $service->findByFilters($filters, 'tenant', 10, 0);

        $this->assertCount(1, $events);
        $this->assertSame('User', $events[0]->entityType);
        $this->assertSame(['name' => 'A'], $events[0]->newValue);
        $this->assertSame(['role' => 'admin'], $events[0]->claims);
    }

    private function createSqlite(): PDO
    {
        $pdo = new PDO('sqlite::memory:');
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        return $pdo;
    }

    private function createAuditTable(PDO $pdo): void
    {
        $pdo->exec('CREATE TABLE _audit (
            id TEXT PRIMARY KEY,
            operation TEXT,
            usecase TEXT,
            trace_id TEXT,
            entity_type TEXT,
            entity_id TEXT,
            old_values TEXT,
            new_values TEXT,
            performed_by TEXT,
            tenant TEXT,
            timestamp TEXT,
            source_request TEXT,
            remote_address TEXT,
            remote_application TEXT,
            remote_device TEXT,
            claims TEXT,
            span_id TEXT
        )');
    }
}
