<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure {
    final class StartupProcessorTestHook
    {
        public static int $errorLogCalls = 0;
        public static array $messages = [];
    }

    if (!function_exists(__NAMESPACE__ . '\\error_log')) {
        function error_log(string $message): bool
        {
            StartupProcessorTestHook::$errorLogCalls++;
            StartupProcessorTestHook::$messages[] = $message;
            return true;
        }
    }
}

namespace {

    use PHPUnit\Framework\TestCase;
    use Psr\Container\ContainerInterface;
    use Psr\Log\LoggerInterface;
    use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
    use Civi\Lughauth\Shared\Infrastructure\StartupProcess;

    final class StartupProcessorUnitTest extends TestCase
    {
        public function testBeforeAndAfterHelpers(): void
        {
            $this->assertSame(4, StartupProcessor::before(5));
            $this->assertSame(6, StartupProcessor::after(5));
        }

        public function testRunExecutesInOrderAndLogsErrors(): void
        {
            $logger = $this->createMock(LoggerInterface::class);
            $logger->expects($this->once())
                ->method('error')
                ->with($this->stringContains('Error with startup'), $this->arrayHasKey('trace'));

            $processor = new StartupProcessor($logger);
            $container = $this->createMock(ContainerInterface::class);
            $calls = [];

            $processor->register(new class ($calls) implements StartupProcess {
                public function __construct(private array &$calls)
                {
                }

                public function onStartup(ContainerInterface $container): void
                {
                    $this->calls[] = 'process';
                }
            }, -1);

            $processor->register(function (ContainerInterface $container) use (&$calls): void {
                $calls[] = 'closure';
            }, 0);

            $processor->register(function (): void {
                throw new RuntimeException('boom');
            }, 1);

            $processor->run($container);

            $this->assertSame(['process', 'closure'], $calls);
        }

    }
}
