<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Connector\FileStorage\PdoFileStorage;
use Civi\Lughauth\Shared\Connector\FileStorage\BinaryContent;
use Civi\Lughauth\Shared\Connector\FileStorage\FileStoreKey;

final class PdoFileStorageUnitTest extends TestCase
{
    public function testStoreRetrieveCommitReplaceDelete(): void
    {
        $pdo = $this->createSqlite();
        $storage = new PdoFileStorage($pdo);

        $stream = fopen('php://temp', 'r+');
        fwrite($stream, 'payload');
        rewind($stream);

        $content = new BinaryContent('file.txt', 'text/plain', new DateTime(), $stream);
        $key = $storage->tempStore($content);

        $this->assertInstanceOf(FileStoreKey::class, $key);

        $temp = $storage->retrieveTempFile($key);
        $this->assertNotNull($temp);
        $this->assertSame('file.txt', $temp->name);

        $storage->commitContent($key);
        $file = $storage->retrieveFile($key);
        $this->assertNotNull($file);
        $this->assertSame('text/plain', $file->mime);

        $newStream = fopen('php://temp', 'r+');
        fwrite($newStream, 'updated');
        rewind($newStream);
        $newContent = new BinaryContent('new.txt', 'text/plain', new DateTime(), $newStream);
        $storage->replaceContent($key, $newContent);

        $updated = $storage->retrieveFile($key);
        $this->assertSame('new.txt', $updated->name);

        $storage->deleteFile($key);
        $this->assertNull($storage->retrieveFile($key));

        fclose($stream);
        fclose($newStream);
    }

    public function testClearTempRemovesOverflow(): void
    {
        $pdo = $this->createSqlite();
        $storage = new PdoFileStorage($pdo);

        $this->setPrivateProperty($storage, 'tempCapacity', 0);

        $stmt = $pdo->prepare('INSERT INTO _filestorer (code, temp, name, mime, upload, bytes) VALUES (:code, 1, :name, :mime, :upload, :bytes)');
        $stmt->execute([
            'code' => 'a',
            'name' => 'a.txt',
            'mime' => 'text/plain',
            'upload' => '2000-01-01 00:00:00',
            'bytes' => 'one',
        ]);
        $stmt->execute([
            'code' => 'b',
            'name' => 'b.txt',
            'mime' => 'text/plain',
            'upload' => '2000-01-01 00:00:00',
            'bytes' => 'two',
        ]);

        $this->invokePrivateMethod($storage, 'clearTemp');

        $count = (int) $pdo->query('SELECT COUNT(*) FROM _filestorer')->fetchColumn();
        $this->assertSame(0, $count);
    }

    private function createSqlite(): PDO
    {
        $pdo = new PDO('sqlite::memory:');
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        return $pdo;
    }

    private function invokePrivateMethod(object $target, string $method, array $args = []): mixed
    {
        $ref = new ReflectionClass($target);
        $refMethod = $ref->getMethod($method);
        $refMethod->setAccessible(true);
        return $refMethod->invokeArgs($target, $args);
    }

    private function setPrivateProperty(object $target, string $property, mixed $value): void
    {
        $ref = new ReflectionClass($target);
        $prop = $ref->getProperty($property);
        $prop->setAccessible(true);
        $prop->setValue($target, $value);
    }
}
