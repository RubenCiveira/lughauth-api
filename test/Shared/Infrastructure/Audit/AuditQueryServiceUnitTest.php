<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Civi\Lughauth\Shared\Infrastructure\Audit\AuditQueryService;

final class AuditQueryServiceUnitTest extends TestCase
{
    public function testGetAuditLogAppliesFiltersAndIncludesChanges(): void
    {
        $pdo = $this->createSqlite();
        $this->createAuditTables($pdo);

        $pdo->exec("INSERT INTO _audit_action (id, occurred_at, actor_id, actor_type, actor_ip, tenant_id, session_id, client_id, user_agent, request_method, request_path, action_type)
            VALUES ('a1', '2024-01-02 00:00:00', 'user', 'user', '127.0.0.1', 't1', '', 'app', 'UA', 'POST', '/path', 'POST /path')");
        $payload = json_encode(['name' => 'A'], JSON_THROW_ON_ERROR);
        $stmt = $pdo->prepare('INSERT INTO _audit_change (id, action_id, target_type, target_id, change_type, change_order, payload, metadata)
            VALUES (:id, :action_id, :target_type, :target_id, :change_type, :change_order, :payload, :metadata)');
        $stmt->execute([
            'id' => 'c1',
            'action_id' => 'a1',
            'target_type' => 'User',
            'target_id' => '1',
            'change_type' => 'update',
            'change_order' => 0,
            'payload' => $payload,
            'metadata' => null,
        ]);

        $service = new AuditQueryService($pdo);
        $from = new DateTimeImmutable('2024-01-01 00:00:00');
        $to = new DateTimeImmutable('2024-01-03 00:00:00');

        $result = $service->getAuditLog('user', $from, $to);

        $this->assertCount(1, $result);
        $this->assertSame('a1', $result[0]['id']);
        $this->assertCount(1, $result[0]['changes']);
    }

    public function testGetEntityHistory(): void
    {
        $pdo = $this->createSqlite();
        $this->createAuditTables($pdo);

        $pdo->exec("INSERT INTO _audit_action (id, occurred_at, actor_id, actor_type, actor_ip, tenant_id, session_id, client_id, user_agent, request_method, request_path, action_type)
            VALUES ('a1', '2024-01-02 00:00:00', 'user', 'user', '127.0.0.1', 't1', '', 'app', 'UA', 'POST', '/path', 'POST /path')");
        $payload = json_encode(['name' => 'A'], JSON_THROW_ON_ERROR);
        $stmt = $pdo->prepare('INSERT INTO _audit_change (id, action_id, target_type, target_id, change_type, change_order, payload, metadata)
            VALUES (:id, :action_id, :target_type, :target_id, :change_type, :change_order, :payload, :metadata)');
        $stmt->execute([
            'id' => 'c1',
            'action_id' => 'a1',
            'target_type' => 'User',
            'target_id' => '1',
            'change_type' => 'update',
            'change_order' => 0,
            'payload' => $payload,
            'metadata' => null,
        ]);

        $service = new AuditQueryService($pdo);

        $history = $service->getEntityHistory('User', '1');
        $this->assertCount(1, $history);
        $this->assertSame('POST', $history[0]['request_method']);
    }

    private function createSqlite(): PDO
    {
        $pdo = new PDO('sqlite::memory:');
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        return $pdo;
    }

    private function createAuditTables(PDO $pdo): void
    {
        $pdo->exec('CREATE TABLE _audit_action (
            id TEXT PRIMARY KEY,
            occurred_at TEXT,
            actor_id TEXT,
            actor_type TEXT,
            actor_ip TEXT,
            tenant_id TEXT,
            session_id TEXT,
            client_id TEXT,
            user_agent TEXT,
            request_method TEXT,
            request_path TEXT,
            action_type TEXT
        )');
        $pdo->exec('CREATE TABLE _audit_change (
            id TEXT PRIMARY KEY,
            action_id TEXT,
            target_type TEXT,
            target_id TEXT,
            change_type TEXT,
            change_order INTEGER,
            payload TEXT,
            metadata TEXT
        )');
    }
}
