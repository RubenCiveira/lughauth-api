<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Event {
    if (!function_exists(__NAMESPACE__ . '\\error_log')) {
        function error_log(string $message): void
        {
        }
    }
}

namespace {
    require_once __DIR__ . '/EnqueueTestStubs.php';

    use PHPUnit\Framework\TestCase;
    use Civi\Lughauth\Shared\Infrastructure\Event\QueueConsumer;
    use Civi\Lughauth\Shared\Infrastructure\Event\QueueSource;

    final class QueueConsumerUnitTest extends TestCase
    {
        public function testConsumeProcessesMessages(): void
        {
            FakeAmqpConnectionFactory::$contextFactory = function () {
                return new FakeAmqpContext([
                    new FakeAmqpIncomingMessage(json_encode(['ok' => 1])),
                    new FakeAmqpIncomingMessage('invalid-json')
                ]);
            };

            $source = new QueueSource('amqp://test', 'user.*', 'exchange', 'queue', true, 10, 1, 1);
            $consumer = new QueueConsumer();

            $result = $consumer->consume($source, function (array $json) {
                $this->assertSame(['ok' => 1], $json);
            });

            $this->assertSame(1, $result['processed']);
            $this->assertSame(1, $result['failed']);
        }

        public function testDefaultQueueNameSanitizes(): void
        {
            $consumer = new QueueConsumer();
            $method = new ReflectionMethod($consumer, 'defaultQueueName');
            $method->setAccessible(true);

            $this->assertSame('app.consumer.user._', $method->invoke($consumer, 'user.*'));
        }
    }
}
