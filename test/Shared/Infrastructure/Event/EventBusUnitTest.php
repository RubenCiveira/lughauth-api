<?php

/* @autogenerated */
declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Infrastructure\Event\EventBus;
use Civi\Lughauth\Shared\Infrastructure\Event\EnqueuePublisher;
use Civi\Lughauth\Shared\Event\PublicEvent;

final class EventBusUnitTest extends TestCase
{
    public function testRegisterListenerDispatches(): void
    {
        $publisher = $this->createMock(EnqueuePublisher::class);
        $publisher->expects($this->never())->method('emitChange');

        $listener = new class () {
            public function __invoke(object $event): object
            {
                return $event;
            }
        };

        $container = $this->createMock(ContainerInterface::class);
        $container->method('get')->willReturnMap([
            [EnqueuePublisher::class, $publisher],
            [get_class($listener), $listener]
        ]);

        $bus = new EventBus($container);
        $bus->registerListener('event', get_class($listener));

        $event = new class () {
        };
        $result = $bus->dispacher->dispatch($event);

        $this->assertSame($event, $result);
    }

    public function testPublicEventIsEmitted(): void
    {
        $publisher = $this->createMock(EnqueuePublisher::class);
        $publisher->expects($this->once())
            ->method('emitChange');

        $container = $this->createMock(ContainerInterface::class);
        $container->method('get')->willReturn($publisher);

        $bus = new EventBus($container);

        $event = new class () implements PublicEvent {
            public function eventType(): string
            {
                return 'user.registered';
            }

            public function schemaVersion(): string
            {
                return 'v1';
            }

            public function payload(): array
            {
                return ['id' => '1'];
            }

            public function original(): array
            {
                return ['id' => '1'];
            }
        };

        $bus->dispacher->dispatch($event);
    }
}
