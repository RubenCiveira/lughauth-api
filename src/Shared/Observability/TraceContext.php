<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Observability;

use OpenTelemetry\API\Trace\Span;

/**
 * Resolves trace and span identifiers from the current context or headers.
 */
class TraceContext
{
    /**
     * @var string|null Cached fallback trace identifier.
     */
    private ?string $fallbackTraceId = null;
    /**
     * @var string|null Cached fallback span identifier.
     */
    private ?string $fallbackSpanId = null;
    /**
     * @var array<string, string>|null Request headers used to extract trace metadata.
     */
    private ?array $headers = null;

    /**
     * Creates a new trace context using optional headers.
     *
     * @param array<string, string>|null $headers Optional headers to inspect for tracing data.
     */
    public function __construct(?array $headers = null)
    {
        $this->headers = $headers ?? (function_exists('getallheaders') ? getallheaders() : []);
    }

    /**
     * Returns the current trace identifier.
     */
    public function getTraceId(): string
    {
        $context = Span::getCurrent()->getContext();

        if ($context && $context->isValid()) {
            return $context->getTraceId();
        }

        $traceId = $this->extractTraceId($this->headers);
        if ($traceId !== null) {
            return $traceId;
        }

        // Generate fallback traceId once
        return $this->fallbackTraceId ??= $this->generateId(16);
    }

    /**
     * Returns the current span identifier.
     */
    public function getSpanId(): string
    {
        $context = Span::getCurrent()->getContext();

        if ($context && $context->isValid()) {
            return $context->getSpanId();
        }

        $spanId = $this->headers['X-Span-Id'] ?? null;
        if ($spanId !== null) {
            return $spanId;
        }

        return $this->fallbackSpanId ??= $this->generateId(8);
    }

    private function extractTraceId(array $headers): ?string
    {
        if (isset($headers['traceparent'])) {
            $parts = explode('-', $headers['traceparent']);
            if (count($parts) === 4) {
                return $parts[1];
            }
        }

        return $headers['X-Trace-Id'] ?? null;
    }

    private function generateId(int $bytes): string
    {
        return bin2hex(random_bytes($bytes));
    }

    /**
     * Returns the trace and span identifiers as an array.
     *
     * @return array{traceId: string, spanId: string}
     */
    public function asArray(): array
    {
        return [
            'traceId' => $this->getTraceId(),
            'spanId' => $this->getSpanId(),
        ];
    }
}
