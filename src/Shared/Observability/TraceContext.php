<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Observability;

use OpenTelemetry\API\Trace\Span;

class TraceContext
{
    private ?string $fallbackTraceId = null;
    private ?string $fallbackSpanId = null;
    private ?array $headers = null;

    public function __construct(?array $headers = null)
    {
        // Captura headers una sola vez (para no depender siempre de getallheaders())
        $this->headers = $headers ?? (function_exists('getallheaders') ? getallheaders() : []);
    }

    public function getTraceId(): string
    {
        $context = Span::getCurrent()->getContext();

        if ($context && $context->isValid()) {
            return $context->getTraceId();
        }

        $traceId = $this->extractTraceId($this->headers);
        if ($traceId !== null) {
            return $traceId;
        }

        // Generate fallback traceId once
        return $this->fallbackTraceId ??= $this->generateId(16);
    }

    public function getSpanId(): string
    {
        $context = Span::getCurrent()->getContext();

        if ($context && $context->isValid()) {
            return $context->getSpanId();
        }

        $spanId = $this->headers['X-Span-Id'] ?? null;
        if ($spanId !== null) {
            return $spanId;
        }

        return $this->fallbackSpanId ??= $this->generateId(8);
    }

    private function extractTraceId(array $headers): ?string
    {
        if (isset($headers['traceparent'])) {
            $parts = explode('-', $headers['traceparent']);
            if (count($parts) === 4) {
                return $parts[1];
            }
        }

        return $headers['X-Trace-Id'] ?? null;
    }

    private function generateId(int $bytes): string
    {
        return bin2hex(random_bytes($bytes));
    }

    public function asArray(): array
    {
        return [
            'traceId' => $this->getTraceId(),
            'spanId' => $this->getSpanId(),
        ];
    }
}
