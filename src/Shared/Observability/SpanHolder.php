<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Observability;

use Throwable;
use OpenTelemetry\API\Trace\SpanInterface;
use OpenTelemetry\Context\ScopeInterface;

/**
 * Holds a reference to a span and provides a safe method to end it.
 *
 * @api
 */
class SpanHolder
{
    /**
     * @var SpanInterface|null The span instance to hold. Can be null if no span is active.
     */
    private readonly ?SpanInterface $span;
    /**
     * @var ScopeInterface|null The scope instance to hold. Can be null if no span is active.
     */
    private readonly ?ScopeInterface $scope;

    /**
     * Constructs a new SpanHolder.
     *
     * @internal This class is intended for internal use. It is not part of the public API and may change without notice.
     */
    public function __construct(?SpanInterface $span, ?ScopeInterface $scope)
    {
        $this->span = $span;
        $this->scope = $scope;
    }

    /**
     * Safely ends the held span if it exists.
     *
     * This method will call `end()` on the span only if the span is not null.
     * If no span is set, the method does nothing.
     *
     * This is useful to ensure spans are properly finished without requiring null checks in user code.
     *
     * @return void
     */
    public function end()
    {
        if ($this->span) {
            $this->span->end();
        }
        if ($this->scope) {
            $this->scope->detach();
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#isrecording
     */
    public function isRecording(): bool
    {
        return $this->span && $this->span->isRecording();
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#set-attributes
     * Adding attributes at span creation is preferred to calling setAttribute later, as samplers can only consider information
     * already present during span creation
     * @param non-empty-string $key
     * @param bool|int|float|string|array|null $value Note: arrays MUST be homogeneous, i.e. it MUST NOT contain values of different types.
     */
    public function setAttribute(string $key, bool|int|float|string|array|null $value): SpanHolder
    {
        if ($this->span) {
            return new SpanHolder($this->span->setAttribute($key, $value), $this->scope);
        } else {
            return $this;
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#set-attributes
     * An attribute with a null key will be dropped, and an attribute with a null value will be dropped but also remove any existing
     * attribute with the same key.
     * @param iterable<non-empty-string, bool|int|float|string|array|null> $attributes
     */
    public function setAttributes(iterable $attributes): SpanHolder
    {
        if ($this->span) {
            return new SpanHolder($this->span->setAttributes($attributes), $this->scope);
        } else {
            return $this;
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#add-events
     */
    public function addEvent(string $name, iterable $attributes = [], ?int $timestamp = null): SpanHolder
    {
        if ($this->span) {
            return new SpanHolder($this->span->addEvent($name, $attributes, $timestamp), $this->scope);
        } else {
            return $this;
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#record-exception
     */
    public function recordException(Throwable $exception, iterable $attributes = []): SpanHolder
    {
        if ($this->span) {
            return new SpanHolder($this->span->recordException($exception, $attributes), $this->scope);
        } else {
            return $this;
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#updatename
     *
     * @param non-empty-string $name
     */
    public function updateName(string $name): SpanHolder
    {
        if ($this->span) {
            return new SpanHolder($this->span->updateName($name), $this->scope);
        } else {
            return $this;
        }
    }

    /**
     * @see https://github.com/open-telemetry/opentelemetry-specification/blob/v1.6.1/specification/trace/api.md#set-status
     *
     */
    public function setStatus(Status $code, ?string $description = null): SpanHolder
    {
        return $this->span ? new SpanHolder($this->span->setStatus($code->value, $description), $this->scope) : $this;
    }
}
