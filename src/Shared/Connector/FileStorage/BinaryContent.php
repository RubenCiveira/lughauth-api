<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Connector\FileStorage;

/**
 * Represents binary content alongside metadata and an optional public URL.
 *
 * The public URL is an externally accessible link (e.g., a drive URL) so the API can
 * expose content without proxying it through this service.
 */
class BinaryContent
{
    /**
     * Creates a BinaryContent instance from a local file path.
     *
     * @param string $path Absolute or relative file path to read.
     * @return BinaryContent The binary content created from the file.
     */
    public static function fromFile(string $path): BinaryContent
    {
        if (!file_exists($path)) {
            throw new \InvalidArgumentException("File not found: {$path}");
        }

        if (!is_readable($path)) {
            throw new \InvalidArgumentException("File is not readable: {$path}");
        }

        $resource = fopen($path, 'rb');
        if ($resource === false) {
            throw new \RuntimeException("Failed to open file: {$path}");
        }

        $timestamp = filemtime($path);
        $lastChange = false === $timestamp ? new \DateTime("@{$timestamp}") : new \DateTime();

        $mime = self::detectMimeType($path);
        return new BinaryContent(name: basename($path), mime: $mime, lastChange: $lastChange, stream: $resource);
    }

    /**
     * Detect MIME type from file path.
     */
    private static function detectMimeType(string $path): string
    {
        $mime = false;
        if (function_exists('finfo_file')) {
            $finfo = finfo_open(FILEINFO_MIME_TYPE);
            if (false !== $finfo) {
                $mime = finfo_file($finfo, $path);
            }
            unset($finfo);
        } else {
            $mime = mime_content_type($path);
        }
        return false === $mime ? 'application/octet-stream' : $mime;

    }

    /**
     * Creates a new binary content value object.
     */
    public function __construct(
        /** @var string File name associated with the content. */
        public readonly string $name,
        /** @var string MIME type for the content. */
        public readonly string $mime,
        /** @var \DateTime Timestamp of the last change. */
        public readonly \DateTime $lastChange,
        /** @var resource Stream resource for the binary content. */
        public readonly mixed $stream,
        /** @var string|null Public URL for external access, if available. */
        public readonly ?string $publicUrl = null
    ) {
    }

    /**
     * Check if the stream resource is still open.
     */
    public function isStreamOpen(): bool
    {
        /** @psalm-suppress RedundantConditionGivenDocblockType */
        return is_resource($this->stream);
    }
}
