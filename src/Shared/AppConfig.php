<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared;

use Dotenv\Dotenv;
use Symfony\Component\Yaml\Yaml;

class AppConfig
{
    public readonly bool $develop;
    public readonly string $name;
    public readonly string $managementEndpoint;
    private readonly ?array $conf;

    public function __construct(string $path = __DIR__ . '/../..')
    {
        if (file_exists($path . '/.env')) {
            Dotenv::createImmutable($path)->load();
        }
        if (file_exists($path . '/config/application.yaml')) {
            $this->conf = $this->flattenArray(Yaml::parseFile($path . '/config/application.yaml'));
        } else {
            $this->conf = [];
        }
        $this->develop = true;
        $this->name = $_ENV['APP_NAME'] ?? 'app';
        $this->managementEndpoint = '/management';
    }

    public function get(string $name, mixed $def = null): mixed
    {
        $envName = strtoupper(str_replace('-', '_', str_replace(".", "_", $name)));
        return $_ENV[$envName] ?? $this->conf[$name] ?? $def;
    }

    public function is(string $name, bool $def = false): bool
    {
        $val = $this->get($name, $def ? 'enabled' : 'disabled');
        return 'false' !== $val && '0' !== $val && 'disabled' !== $val;
    }

    public function all(): array
    {
        $all = [];
        foreach ($_ENV as $key => $value) {
            $code = $this->keyToDump($key);
            $all[$code] = [
                'value' => $this->valueToDump($code, (string)$value)
            ];
        }
        if ($this->conf !== null) {
            foreach ($this->conf as $key => $value) {
                $code = $this->keyToDump($key);
                if (is_array($value)) {

                } else {
                    $all[$key] = [
                        'value' => $this->valueToDump($code, $value)
                    ];
                }
            }
        }
        return $all;
    }

    private function keyToDump(string $key): string
    {
        return str_replace('_', '.', strtolower($key));
    }

    private function valueToDump(string $key, string $value): string
    {
        if (stripos($key, '.secret') !== false ||
            stripos($key, 'pass') !== false || stripos($key, '.key') !== false) {
            return
                strlen($value) > 6
                    ? substr($value, 0, 2) . '****' . substr($value, -2)
                    : substr($value, 0, 1) . '****' . substr($value, -1);
        } else {
            return $value;
        }
    }

    private function flattenArray(array $array, string $prefix = ''): array
    {
        $flat = [];
        foreach ($array as $key => $value) {
            $fullKey = $prefix === '' ? $key : "$prefix.$key";
            if (is_array($value)) {
                $flat += $this->flattenArray($value, $fullKey);
            } else {
                $flat[$fullKey] = (string)$value;
            }
        }
        return $flat;
    }
}
