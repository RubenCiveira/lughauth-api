<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Security\Rbac;

use Psr\Http\Client\ClientInterface;
use Psr\Http\Message\RequestFactoryInterface;
use Psr\SimpleCache\CacheInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Security\Identity;

class LughMapper
{
    private readonly ?string $authUrl;
    private readonly ?string $apiKey;

    public function __construct(
        private readonly AppConfig $config,
        private readonly Context $context,
        private readonly CacheInterface $cache,
        private readonly RequestFactoryInterface $requestFactory,
        private readonly ClientInterface $client
    ) {
        $this->authUrl = $config->get('security.rbac.lugh.location', '-');
        $this->apiKey = $config->get('security.rbac.lugh.api.key');
    }

    public function hiddenFields(Identity $user, string $resource): array
    {
        return $this->fields($this->load(), $user, $resource, 'view');
    }
    public function uneditableFields(Identity $user, string $resource): array
    {
        return $this->fields($this->load(), $user, $resource, 'view');
    }
    public function allow(Identity $user, string $resource, string $action): bool
    {
        return $this->isAllowed($this->load(), $user, $resource, 'scope', $action);
    }

    private function load()
    {
        return json_decode($this->getGrants(), true);
    }

    private function fields(array $grants, Identity $user, string $resource, string $on): array
    {
        $roles = [...$user->roles, '@everyone', $user->anonimous() ? '@anonymous' : '@authenticated' ];
        $hiddens = [];
        foreach ($roles as $role) {
            if (isset($grants[$role][$resource]) && $grants[$role][$resource]['attributes']) {
                foreach ($grants[$role][$resource]['attributes'] as $field => $info) {
                    if (!$info[$on]) {
                        $hiddens[] = $field;
                    }
                }
            }
        }
        return $hiddens;
    }

    private function isAllowed(array $grants, Identity $user, string $resource, string $on, string $with): bool
    {
        $roles = [...$user->roles, '@everyone', $user->anonimous() ? '@anonymous' : '@authenticated' ];
        foreach ($roles as $role) {
            if (isset($grants[$role][$resource]) && $grants[$role][$resource][$on][$with]) {
                return true;
            }
        }
        return false;
    }

    private function getGrants()
    {
        $cache_key = 'lught.grants';
        if (false && $this->cache->has($cache_key)) {
            return $this->cache->get($cache_key);
        } else {
            $request = $this->requestFactory->createRequest('GET', $this->authUrl . '/grant');
            $request = $request->withAddedHeader('x-api-key', $this->apiKey);
            $response = $this->client->sendRequest($request);
            $item = '' . $response->getBody();
            $this->cache->set($cache_key, $item, new \DateInterval('PT1H'));
            return $item;
        }
    }
}
