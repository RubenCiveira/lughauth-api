<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Security\Rbac;

use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Security\FieldsAccess;

/**
 * Applies RBAC field visibility rules to field access proposals.
 */
class FieldsListener
{
    /**
     * Creates a new fields listener.
     */
    public function __construct(
        /** @var Context Runtime context providing the current identity. */
        private readonly Context $context,
        /** @var Handler RBAC handler used for field visibility checks. */
        private readonly Handler $handler
    ) {
    }

    /**
     * Evaluates the proposal and adds hidden or uneditable fields.
     *
     * @param FieldsAccess $proposal The field access proposal to evaluate.
     * @return FieldsAccess The updated proposal with restricted fields.
     */
    public function __invoke(FieldsAccess $proposal): FieldsAccess
    {
        if ('view' == $proposal->accessMode()) {
            $proposal->withAll($this->handler->hiddenFields($this->context->getIdentity(), $proposal->resourceName()));
        } else {
            $proposal->withAll($this->handler->uneditableFields($this->context->getIdentity(), $proposal->resourceName()));
        }

        return $proposal;
    }
}
