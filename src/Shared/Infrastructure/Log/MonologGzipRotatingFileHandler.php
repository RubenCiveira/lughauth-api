<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Log;

use Monolog\Level;
use Monolog\Handler\RotatingFileHandler;

final class MonologGzipRotatingFileHandler extends RotatingFileHandler
{
    public function __construct(string $filename, int $maxFiles = 0, int|string|Level $level = Level::Debug, bool $bubble = true, ?int $filePermission = null, bool $useLocking = false, string $dateFormat = self::FILE_PER_DAY, string $filenameFormat  = '{filename}-{date}')
    {
        parent::__construct($filename, $maxFiles, $level, $bubble, $filePermission, $useLocking, $dateFormat, $filenameFormat);
        register_shutdown_function([$this, 'zipRotated']);
    }
    /** Comprime a .gz cualquier archivo del patrón que no sea el actual ni el del día */
    private function zipRotated(): void
    {
        $currentUrl = $this->url; // ruta del archivo activo (propiedad protegida en StreamHandler)
        $todayDate  = (new \DateTimeImmutable('now'))->format($this->dateFormat);

        // Patrón de ficheros del mismo grupo (según filenameFormat y dateFormat)
        $glob = $this->getGlobPattern() . '*'; // ej: /var/log/app-{date}.jsonl => /var/log/app-*.jsonl
        $files = glob($glob) ?: [];
        usort($files, fn ($a, $b) => strcmp($b, $a)); // Más recientes primero

        foreach (array_slice($files, $this->maxFiles) as $file) {
            @unlink($file);
        }

        foreach (array_slice($files, 0, $this->maxFiles) as $file) {
            // ya comprimido
            if (str_ends_with($file, '.gz')) {
                continue;
            }
            // archivo actual (abierto)
            if (realpath($file) === realpath($currentUrl)) {
                continue;
            }
            // no comprimas el del día (si generas “hoy” y aún no es el actual)
            if (str_contains($file, $todayDate)) {
                continue;
            }

            $gz = $file . '.gz';
            if (!is_file($gz) && is_file($file) && filesize($file) > 0) {
                $this->gzipFile($file, $gz);
                if (is_file($gz) && filesize($gz) > 0) {
                    @unlink($file);
                }
            }
        }
    }

    private function gzipFile(string $src, string $dst, int $level = 9): void
    {
        $in = @fopen($src, 'rb');
        if (!$in) {
            return;
        }

        $gz = @gzopen($dst, 'wb' . max(1, min(9, $level)));
        if (!$gz) {
            @fclose($in);
            return;
        }

        try {
            while (!feof($in)) {
                $chunk = fread($in, 1024 * 1024);
                if ($chunk === false) {
                    break;
                }
                gzwrite($gz, $chunk);
            }
        } finally {
            @fclose($in);
            @gzclose($gz);
        }
    }
}
