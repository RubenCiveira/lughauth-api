<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\View;

use Override;
use Psr\Http\Message\ServerRequestInterface;
use Slim\Routing\RouteContext;
use Twig\Environment;
use Twig\Loader\LoaderInterface;
use Twig\TwigFunction;

/**
 * Extends Twig to provide route and asset helpers.
 */
class AssetOptimizingTwigEnvironment extends Environment
{
    /**
     * Creates a Twig environment with URL helpers based on the request.
     */
    public function __construct(
        /** @var ServerRequestInterface Incoming request used for base path resolution. */
        ServerRequestInterface $request,
        /** @var LoaderInterface Twig template loader. */
        LoaderInterface $loader,
        array $options = []
    ) {
        parent::__construct($loader, $options);

        $routeContext = RouteContext::fromRequest($request);
        $basePath = $routeContext->getBasePath();

        $this->addFunction(new TwigFunction('path', function (string $routeName, array $params = []) use ($basePath) {
            $url = $basePath . (str_starts_with($routeName, "/") ? "" : "/") . $routeName;
            if (!empty($params)) {
                $url .= '?' . http_build_query($params);
            }
            return $url;
        }));

        $this->addFunction(new TwigFunction('asset', function (string $routeName, array $params = []) use ($basePath) {
            $url = "{$basePath}/assets/{$routeName}";
            return $url;
        }));
    }

    /**
     * Renders a Twig template to a string.
     */
    #[Override]
    public function render($name, array $context = []): string
    {
        return parent::render($name, $context);
    }

    /**
     * Outputs a rendered Twig template.
     */
    #[Override]
    public function display($name, array $context = []): void
    {
        echo $this->render($name, $context);
    }
}
