<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure;

use Closure;
use Psr\Container\ContainerInterface;
use Psr\Log\LoggerInterface;
use Throwable;

class StartupProcessor
{
    public static function before(int $number): int
    {
        return $number - 1;
    }

    public static function after(int $number): int
    {
        return $number + 1;
    }

    private array $executors = [];

    public function __construct(private readonly LoggerInterface $logger){}

    public function register(Closure|StartupProcess $command, int $order = 0)
    {
        $pos = $order + 100;
        if (!isset($this->executors[$pos])) {
            $this->executors[$pos] = [];
        }

        $this->executors[$pos][] = $command;
    }

    public function run(ContainerInterface $container)
    {
        $executors = [...$this->executors];
        sort($executors);
        foreach ($executors as $execs) {
            foreach ($execs as $process) {
                try {
                    if ($process instanceof StartupProcess) {
                        $process->onStartup($container);
                    } elseif ($process instanceof Closure) {
                        $process($container);
                    }
                } catch (Throwable $th) {
                    if ($this->logger) {
                        $this->logger->error('Error with startup ' . $th->getMessage(), [
                            'trace' => $th->getTraceAsString()
                        ]);
                    } else {
                        error_log('Error with startup ' . $th->getMessage());
                        error_log('Trace: ' . $th->getTraceAsString());
                    }
                }

            }
        }
    }
}
