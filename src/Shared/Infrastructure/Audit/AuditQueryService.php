<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Audit;

use PDO;

class AuditQueryService
{
    public function __construct(
        private readonly PDO $pdo
    ) {
    }

    /**
     * Recupera acciones de auditoría con sus cambios, opcionalmente filtradas por usuario y fecha.
     *
     * @param string|null $userId
     * @param \DateTimeInterface|null $from
     * @param \DateTimeInterface|null $to
     * @return array
     */
    public function getAuditLog(?string $userId = null, ?\DateTimeInterface $from = null, ?\DateTimeInterface $to = null): array
    {
        $sql = "SELECT * FROM _audit_action WHERE 1=1";
        $params = [];

        if ($userId !== null) {
            $sql .= " AND actor_id = :user_id";
            $params['user_id'] = $userId;
        }

        if ($from !== null) {
            $sql .= " AND occurred_at >= :from";
            $params['from'] = $from->format('Y-m-d H:i:s');
        }

        if ($to !== null) {
            $sql .= " AND occurred_at <= :to";
            $params['to'] = $to->format('Y-m-d H:i:s');
        }

        $sql .= " ORDER BY occurred_at DESC";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($params);
        $actions = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // Añadir los cambios asociados a cada acción
        foreach ($actions as &$action) {
            $stmt = $this->pdo->prepare("SELECT * FROM _audit_change WHERE action_id = :action_id ORDER BY change_order");
            $stmt->execute(['action_id' => $action['id']]);
            $action['changes'] = $stmt->fetchAll(PDO::FETCH_ASSOC);
        }

        return $actions;
    }

    /**
     * Recupera histórico de una entidad (target_type + target_id), ordenado por fecha.
     *
     * @param string $targetType
     * @param string $targetId
     * @return array
     */
    public function getEntityHistory(string $targetType, string $targetId): array
    {
        $sql = "
            SELECT ac.*, aa.request_method, aa.request_path, aa.actor_id, aa.occurred_at as action_time
            FROM _audit_change ac
            JOIN _audit_action aa ON ac.action_id = aa.id
            WHERE ac.target_type = :target_type AND ac.target_id = :target_id
            ORDER BY aa.occurred_at DESC, ac.change_order ASC
        ";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([
            'target_type' => $targetType,
            'target_id' => $targetId,
        ]);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}
