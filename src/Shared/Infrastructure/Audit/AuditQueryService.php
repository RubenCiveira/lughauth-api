<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Audit;

use PDO;

/**
 * Query service for retrieving audit trail data from the database.
 *
 * Provides methods to search and retrieve audit logs with various filtering
 * options, as well as entity-specific change history. This service is intended
 * for administrative interfaces and compliance reporting.
 *
 * @see AuditMiddleware Where audit data is originally persisted.
 */
class AuditQueryService
{
    /**
     * Creates the query service with a database connection.
     *
     * @param PDO $pdo Database connection for querying audit tables.
     */
    public function __construct(
        /** @var PDO Database connection for audit queries. */
        private readonly PDO $pdo
    ) {
    }

    /**
     * Retrieves audit actions with their associated changes, optionally filtered.
     *
     * Returns a list of audit actions, each enriched with its related changes.
     * Results are ordered by occurrence time in descending order (newest first).
     *
     * @param string|null             $userId Filter by actor identifier.
     * @param \DateTimeInterface|null $from   Include only actions on or after this time.
     * @param \DateTimeInterface|null $to     Include only actions on or before this time.
     *
     * @return array<int, array<string, mixed>> List of audit actions with nested changes.
     */
    public function getAuditLog(?string $userId = null, ?\DateTimeInterface $from = null, ?\DateTimeInterface $to = null): array
    {
        $sql = "SELECT * FROM _audit_action WHERE 1=1";
        $params = [];

        if ($userId !== null) {
            $sql .= " AND actor_id = :user_id";
            $params['user_id'] = $userId;
        }

        if ($from !== null) {
            $sql .= " AND occurred_at >= :from";
            $params['from'] = $from->format('Y-m-d H:i:s');
        }

        if ($to !== null) {
            $sql .= " AND occurred_at <= :to";
            $params['to'] = $to->format('Y-m-d H:i:s');
        }

        $sql .= " ORDER BY occurred_at DESC";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute($params);
        $actions = $stmt->fetchAll(PDO::FETCH_ASSOC);

        // Añadir los cambios asociados a cada acción
        foreach ($actions as &$action) {
            $stmt = $this->pdo->prepare("SELECT * FROM _audit_change WHERE action_id = :action_id ORDER BY change_order");
            $stmt->execute(['action_id' => $action['id']]);
            $action['changes'] = $stmt->fetchAll(PDO::FETCH_ASSOC);
        }

        return $actions;
    }

    /**
     * Retrieves the complete change history for a specific entity.
     *
     * Returns all recorded changes for an entity identified by its type and ID,
     * enriched with action metadata. Results are ordered chronologically
     * (newest first) with change order preserved within each action.
     *
     * @param string $targetType The entity type (e.g., 'User', 'Order').
     * @param string $targetId   The entity's unique identifier.
     *
     * @return array<int, array<string, mixed>> List of changes with action metadata.
     */
    public function getEntityHistory(string $targetType, string $targetId): array
    {
        $sql = "
            SELECT ac.*, aa.request_method, aa.request_path, aa.actor_id, aa.occurred_at as action_time
            FROM _audit_change ac
            JOIN _audit_action aa ON ac.action_id = aa.id
            WHERE ac.target_type = :target_type AND ac.target_id = :target_id
            ORDER BY aa.occurred_at DESC, ac.change_order ASC
        ";

        $stmt = $this->pdo->prepare($sql);
        $stmt->execute([
            'target_type' => $targetType,
            'target_id' => $targetId,
        ]);

        return $stmt->fetchAll(PDO::FETCH_ASSOC);
    }
}
