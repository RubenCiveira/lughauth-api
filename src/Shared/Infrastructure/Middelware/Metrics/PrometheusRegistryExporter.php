<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics;

use Prometheus\CollectorRegistry;

final class PrometheusRegistryExporter
{
    public function __construct(
        private readonly TimeWindowPolicy $policy,
        private readonly CollectorRegistry $registry,
        private readonly MetricsSink $sink
    ) {
    }
    /**
     * @param array{
     *   include?: list<string>,
     *   exclude?: list<string>,
     *   label_allow?: list<string>,
     *   min_interval_ms?: int
     * } $opts
     */
    public function dump(array $opts = []): void
    {

        if (!$this->policy->mustTrace()) {
            return;
        }
        $renderer = new RenderJsonFormat();
        $metrics = $this->registry->getMetricFamilySamples();
        $str = $renderer->render($metrics);
        $lines = json_decode($str);
        $this->sink->appendBatch($lines);
    }
}
