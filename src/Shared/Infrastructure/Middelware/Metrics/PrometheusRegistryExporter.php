<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics;

use Prometheus\CollectorRegistry;

final class PrometheusRegistryExporter
{
    public function __construct(
        private readonly TimeWindowPolicy $policy,
        private readonly CollectorRegistry $registry,
        private readonly MetricsSink $sink
    ) {
    }

    public function dump(): void
    {
        if (!$this->policy->mustTrace()) {
            return;
        }
        $this->forceDump();
    }

    public function forceDump(): void
    {
        $renderer = new RenderJsonFormat();
        $metrics = $this->registry->getMetricFamilySamples();
        $str = $renderer->render($metrics);
        $lines = json_decode($str);
        $this->sink->appendBatch($lines);
    }
}
