<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics;

/** Matchers a lo Prometheus: ['op'=>'=','label'=>'status','value'=>'200'] o ['op'=>'~','label'=>'path','value'=>'^/api/'] */
final class LabelMatcher
{
    public function __construct(
        public string $key,
        public string $op,   // '=', '!=', '=~', '!~'
        public string $val
    ) {
    }

    public function matches(array $labels): bool
    {
        $has = array_key_exists($this->key, $labels);
        $lv  = $has ? (string)$labels[$this->key] : null;

        return match ($this->op) {
            '='  => $has && $lv === $this->val,
            '!=' => !$has || $lv !== $this->val,
            '=~' => $has && $this->regexMatch($lv, $this->val),
            '!~' => !$has || !$this->regexMatch($lv, $this->val),
            default => false,
        };
    }

    private function regexMatch(string $value, string $re2): bool
    {
        // PromQL (RE2) es "full match": ^(?:regex)$
        // Convertimos a PCRE y escapamos el delimitador elegido (~).
        $del = '~';
        $pattern = $del . '\A(?:' . str_replace($del, '\\' . $del, $re2) . ')\z' . $del . 'u';

        $ok = @preg_match($pattern, $value);
        if ($ok === false) {
            // patrÃ³n invÃ¡lido -> por seguridad, no coincide
            return false;
        }
        return $ok === 1;
    }
}
