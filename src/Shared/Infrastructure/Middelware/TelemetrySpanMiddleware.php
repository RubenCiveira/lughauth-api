<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware;

use Slim\App;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\RequestHandlerInterface;
use OpenTelemetry\Context\Context;
use OpenTelemetry\API\Trace\TracerInterface;
use OpenTelemetry\API\Trace\SpanContext;
use OpenTelemetry\API\Trace\TraceFlags;
use OpenTelemetry\API\Trace\Span;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Observability\TraceContext;

/**
 * Creates tracing spans for inbound HTTP requests.
 */
class TelemetrySpanMiddleware
{
    /**
     * Creates a new telemetry span middleware.
     */
    public function __construct(
        /** @var App Slim application instance. */
        private readonly App $app,
        /** @var AppConfig Configuration provider. */
        private readonly AppConfig $config,
        /** @var TracerInterface OpenTelemetry tracer instance. */
        private readonly TracerInterface $tracer,
        /** @var TraceContext Trace context resolver. */
        private readonly TraceContext $context
    ) {
    }

    /**
     * Creates and closes a span around the request handling.
     */
    public function __invoke(ServerRequestInterface $request, RequestHandlerInterface $handler): ResponseInterface
    {
        $basePath = $this->app->getBasePath();
        $path = $request->getUri()->getPath();
        // Eliminar el basePath del path, si lo tiene
        if (!empty($basePath) && str_starts_with($path, $basePath)) {
            $path = substr($path, strlen($basePath));
            if ($path === '') {
                $path = '/';
            }
        }
        $active = !str_starts_with($path, $this->config->managementEndpoint);
        if ($active) {
            $context = Context::getCurrent(); // contexto por defecto
            $traceparent = $request->getHeader(('traceparent'));
            if (count($traceparent)) {
                $parts = explode('-', $traceparent[0]);
                if (count($parts) === 4) {
                    [$_version, $traceId, $spanId, $_flags] = $parts;
                    $spanContext = SpanContext::createFromRemoteParent($traceId, $spanId, TraceFlags::SAMPLED);
                    $remoteSpan = Span::wrap($spanContext);
                    $context = $remoteSpan->storeInContext($context);
                }
            }
            $rootSpan = $this->tracer->spanBuilder('Request ' . $request->getMethod() . ' ' . $path)
                    ->setParent($context)
                    ->startSpan();
            $scope = $rootSpan->activate();
        }
        try {
            return $handler->handle($request);
        } finally {
            if ($active) {
                $rootSpan->end();
                $scope->detach();
            }
        }
    }
}
