<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware\Rate;

use Override;
use PDOException;
use Symfony\Component\RateLimiter\Storage\StorageInterface;
use Symfony\Component\RateLimiter\LimiterStateInterface;

class PdoRateLimiterStorage implements StorageInterface
{
    private $pdo;
    private readonly string $driver;
    private readonly string $table_name;

    public function __construct(\PDO $pdo, string $table_name = '_rate_limiter')
    {
        $this->pdo = $pdo;
        $this->table_name = $table_name;
        $this->driver = $this->pdo->getAttribute(\PDO::ATTR_DRIVER_NAME);
    }

    #[Override]
    public function save(LimiterStateInterface $limiterState): void
    {
        $on = (new \DateTimeImmutable())->add(\DateInterval::createFromDateString($limiterState->getExpirationTime() . ' seconds'));
        if ($this->driver === 'pgsql') {
            $stmt = $this->pdo->prepare('INSERT INTO '.$this->table_name.' (limiter_key, serialized, expires_at)
VALUES (:limiter_key, :serialized, :expires_at)
ON CONFLICT (limiter_key) 
DO UPDATE SET 
    serialized = EXCLUDED.serialized,
    expires_at = EXCLUDED.expires_at;');
        } else {
            $stmt = $this->pdo->prepare('
                REPLACE INTO '.$this->table_name.' (limiter_key, serialized, expires_at)
                VALUES (:limiter_key, :serialized, :expires_at)
            ');
        }
        try {
            $stmt->execute([
                ':limiter_key' => $limiterState->getId(),
                ':serialized' => base64_encode(serialize($limiterState)),
                ':expires_at' => $on->format('Y-m-d H:i:s'),
            ]);
        } catch (PDOException $ex) {

        }
    }

    #[Override]
    public function fetch(string $limiterStateId): ?LimiterStateInterface
    {
        $stmt = $this->pdo->prepare('SELECT serialized FROM '.$this->table_name.' WHERE limiter_key = :limiter_key');
        try {
            $stmt->execute([':limiter_key' => $limiterStateId]);
            $row = $stmt->fetch(\PDO::FETCH_ASSOC);
            if (!$row) {
                return null;
            }
            // Crear un objeto SlidingWindowLimiterState con los datos almacenados
            return unserialize(base64_decode($row['serialized']));
        } catch (PDOException $ex) {
            return null;
        }
    }

    #[Override]
    public function delete(string $limiterStateId): void
    {
        $stmt = $this->pdo->prepare('DELETE FROM '.$this->table_name.' WHERE limiter_key = :limiter_key');
        $stmt->execute([':limiter_key' => $limiterStateId]);
    }
}
