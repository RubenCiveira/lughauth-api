<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Middelware\Rate;

use Civi\Lughauth\Shared\AppConfig;
use Symfony\Component\RateLimiter\Storage\StorageInterface;

/**
 * Configuration container for rate limiting behavior in the application.
 *
 * This class encapsulates the definition of a rate limiter instance, including
 * its ID, policy, request limit, time interval, and resolver types for both
 * bucket (e.g., per service) and connection (e.g., per user or IP).
 */
class RateConfig
{
    /**
     * The unique identifier for the rate limiter configuration.
     * Used as the base key in storage.
     *
     * @var string
     */
    public readonly string $id;

    /**
     * The rate limiting policy (e.g., 'fixed_window', 'sliding_window').
     *
     * @var string
     */
    public readonly string $policy;

    /**
     * The maximum number of requests allowed within the given interval.
     *
     * @var int
     */
    public readonly int $limit;

    /**
     * The interval (e.g., '1 minute', '10 seconds') over which the limit applies.
     *
     * @var string
     */
    public readonly string $interval;

    /**
     * The service ID or class name of the bucket resolver.
     * This resolver defines the logical grouping of rate limits (e.g., per endpoint or service).
     *
     * @var string
     */
    public readonly string $bucketResolverType;

    /**
     * The service ID or class name of the connection resolver.
     * This resolver defines the granularity of the limit (e.g., per user or IP).
     *
     * @var string
     */
    public readonly string $connectionResolverType;

    /**
     * Constructor that assigns rate limiting parameters.
     */
    public function __construct(
        /** @var StorageInterface Storage for rate limiter state. */
        private readonly StorageInterface $storage,
        /** @var AppConfig Configuration provider. */
        private readonly AppConfig $config
    ) {
        $this->id = $config->get('app.rate-limit.id', 'app_global_limit');
        $this->policy = $config->get('app.rate-limit.policy', 'sliding_window');
        $this->limit = intval($config->get('app.rate-limit.limit', 150));
        $this->interval = $config->get('app.rate-limit.interval', '1 minute');
        $this->bucketResolverType = $config->get('app.rate-limit.bucket-resolver', BaseBucketResolver::class);
        $this->connectionResolverType = $config->get('app.rate-limit.connection-resolver', IpGranularityResolver::class);
    }

    /**
     * Returns the configured rate limiter storage.
     */
    public function storage(): StorageInterface
    {
        return $this->storage;
    }
}
