<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

use Override;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Security\AllowDecision;
use Civi\Lughauth\Shared\Security\FieldsAccess;
use Civi\Lughauth\Shared\Security\Rbac\AllowListener;
use Civi\Lughauth\Shared\Security\Rbac\FieldsListener;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Psr\Container\ContainerInterface;

/**
 * Registers RBAC listeners and startup refresh for security policies.
 */
class GenericSecurityPlugin extends MicroPlugin
{
    /**
     * Startup order for the RBAC cache refresh.
     */
    public const STARTUP_ORDER = 1000;

    /**
     * Registers RBAC listeners for allow and field access events.
     */
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(AllowDecision::class, AllowListener::class);
        $bus->registerListener(FieldsAccess::class, FieldsListener::class);
    }

    /**
     * Registers the RBAC cache refresh at startup.
     */
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->flush();
        }, GenericSecurityPlugin::STARTUP_ORDER);
    }

}
