<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

use Override;
use Cron\CronExpression;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Infrastructure\Management\Apidoc\ApidocManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Audit\AuditManagement;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\Management\Health\HealthManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Metrics\MetricsManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Migration\MigrationManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Config\ConfigManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Dependencies\DependenciesManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Log\LogManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Routes\RoutesManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Trace\TraceManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Collector\LogCollector;
use Civi\Lughauth\Shared\Infrastructure\Management\Collector\TraceCollector;
use Civi\Lughauth\Shared\Infrastructure\Management\EntityChangelog\LoadChangesManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\EntityChangelog\MarkAckManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\EntityChangelog\UpdateChangelogManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\Histogram\HistogramManagement;
use Civi\Lughauth\Shared\Infrastructure\Management\History\HistoryManagement;
use Civi\Lughauth\Shared\Infrastructure\MicroConfig;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\PrometheusRegistryExporter;
use Civi\Lughauth\Shared\Infrastructure\Scheduler\SchedulerManager;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;

/**
 * Registers management endpoints and scheduled maintenance tasks.
 */
class ManagementPlugin extends MicroPlugin
{
    /**
     * Registers the metrics export scheduler.
     */
    #[Override]
    public function registerSchedulers(SchedulerManager $bus)
    {
        $bus->register(new CronExpression('*/15 * * * *'), PrometheusRegistryExporter::class, "forceDump");
    }

    /**
     * Resolves management interfaces based on configuration flags.
     */
    #[Override]
    public function getManagementsInterfaces(ContainerInterface $container): array
    {
        $all = [];
        $def = $container->get(MicroConfig::class);
        $all[] = $container->get(HealthManagement::class);
        $all[] = $container->get(ConfigManagement::class);
        $all[] = $container->get(RoutesManagement::class);
        $all[] = $container->get(DependenciesManagement::class);
        if ($def->withMetrics) {
            $all[] = $container->get(MetricsManagement::class);
        }
        $all[] = $container->get(MigrationManagement::class);
        $all[] = $container->get(ApidocManagement::class);
        if ($def->withTelemetry) {
            $all[] = $container->get(LogManagement::class);
            $all[] = $container->get(TraceManagement::class);
            $all[] = $container->get(TraceCollector::class);
            $all[] = $container->get(LogCollector::class);
        }
        if ($def->withAudit) {
            $all[] = $container->get(HistoryManagement::class);
            $all[] = $container->get(AuditManagement::class);
        }
        $all[] = $container->get(HistogramManagement::class);
        $all[] = $container->get(LoadChangesManagement::class);
        $all[] = $container->get(MarkAckManagement::class);
        $all[] = $container->get(UpdateChangelogManagement::class);
        return $all;
    }

    /**
     * Registers startup tasks for running migrations.
     */
    #[Override]
    public function registerStartup(StartupProcessor $container): void
    {
        $container->register(function (ContainerInterface $container) {
            $migrations = $container->get(MigrationManagement::class);
            $callback = $migrations->set();
            $callback();
        });
    }
}
