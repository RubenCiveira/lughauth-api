<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

use Override;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Slim\Psr7\Response;
use Slim\Middleware\ErrorMiddleware;
use Slim\Exception\HttpMethodNotAllowedException;
use Civi\Lughauth\Shared\Exception\ConstraintException;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

/**
 * Registers HTTP error handlers for common domain exceptions.
 */
class ErrorsPlugin extends MicroPlugin
{
    /**
     * Configures error handlers for validation and auth failures.
     */
    #[Override]
    public function registerErrorHandler(ErrorMiddleware $errorHandler): void
    {
        $errorHandler->setErrorHandler(ConstraintException::class, function (ServerRequestInterface $request, ConstraintException $exception): ResponseInterface {
            $errors = [];
            foreach ($exception as $fail) {
                foreach ($fail->fields as $k => $field) {
                    $errors[$field] = [ $fail->wrongValues[$k] . ' fail for ' . $fail->code . '' ];
                }
            }
            $content = [
                "type" => "/validation-error",
                "title" => "Validation failed",
                "status" => 422,
                "errors" => $errors
            ];
            $response = new Response();
            $response->getBody()->write(json_encode($content));
            return $response->withStatus(422)->withHeader("Content-Type", "application/problem+json");
        });
        $errorHandler->setErrorHandler(UnauthorizedException::class, function (ServerRequestInterface $request, UnauthorizedException $exception): ResponseInterface {
            $response = new Response();
            $data = [
                'message' => $exception->getMessage()
            ];
            $response->getBody()->write(json_encode($data));
            return $response->withStatus(401);
        });
        $errorHandler->setErrorHandler(HttpMethodNotAllowedException::class, function (ServerRequestInterface $request, HttpMethodNotAllowedException $exception): ResponseInterface {
            $response = new Response();
            $data = [
                'message' => $exception->getMessage()
            ];
            $response->getBody()->write(json_encode($data));
            return $response->withStatus(404);
        });
    }
}
