<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

use Override;
use Exception;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Slim\Psr7\Response;
use Slim\Middleware\ErrorMiddleware;
use Civi\Lughauth\Shared\Exception\ConstraintException;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;

class ErrorsPlugin extends MicroPlugin
{
    #[Override]
    public function registerErrorHandler(ErrorMiddleware $errorHandler)
    {
        $errorHandler->setErrorHandler(ConstraintException::class, function (ServerRequestInterface $request, Exception $exception): ResponseInterface {
            echo $exception->getTraceAsString();
            die();
        });
        $errorHandler->setErrorHandler(UnauthorizedException::class, function (ServerRequestInterface $request, Exception $exception): ResponseInterface {
            $response = new Response();
            $data = [
                'message' => $exception->getMessage()
            ];
            $response->getBody()->write(json_encode($data));
            return $response->withStatus(401);
        });
    }
}
