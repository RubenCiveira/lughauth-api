<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\EntityAudit;

use PDO;

final class EntityAuditService
{
    private PDO $pdo;

    public function __construct(PDO $pdo)
    {
        $this->pdo = $pdo;
    }

    /**
     * Busca eventos de auditoría aplicando filtros.
     *
     * @return EntityAuditEntry[]
     */
    public function findByFilters(
        array $filters = [],
        ?string $tenant = null,
        int $limit = 100,
        int $offset = 0
    ): array {
        $sql = "SELECT * FROM _audit WHERE 1=1";
        $params = [];

        if (!empty($filters['performed_by'])) {
            $sql .= " AND performed_by = :performed_by";
            $params[':performed_by'] = $filters['performed_by'];
        }
        if (!empty($filters['entity_type'])) {
            $sql .= " AND entity_type = :entity_type";
            $params[':entity_type'] = $filters['entity_type'];
        }
        if (!empty($filters['entity_id'])) {
            $sql .= " AND entity_id = :entity_id";
            $params[':entity_id'] = $filters['entity_id'];
        }
        if (!empty($filters['operation'])) {
            $sql .= " AND operation = :operation";
            $params[':operation'] = $filters['operation'];
        }
        if (!empty($filters['trace_id'])) {
            $sql .= " AND trace_id = :trace_id";
            $params[':trace_id'] = $filters['trace_id'];
        }
        if (!empty($filters['span_id'])) {
            $sql .= " AND span_id = :span_id";
            $params[':span_id'] = $filters['span_id'];
        }
        if (!empty($filters['from'])) {
            $sql .= " AND timestamp >= :from";
            $params[':from'] = $filters['from']; // string o DateTimeImmutable->format()
        }
        if (!empty($filters['to'])) {
            $sql .= " AND timestamp <= :to";
            $params[':to'] = $filters['to'];
        }

        if ($tenant !== null) {
            $sql .= " AND tenant = :tenant";
            $params[':tenant'] = $tenant;
        }

        $sql .= " ORDER BY timestamp DESC LIMIT :offset, :limit";
        $params[':offset'] = $offset;
        $params[':limit'] = $limit;

        $stmt = $this->pdo->prepare($sql);

        foreach ($params as $key => $value) {
            $type = is_int($value) ? PDO::PARAM_INT : PDO::PARAM_STR;
            $stmt->bindValue($key, $value, $type);
        }

        $stmt->execute();

        $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);

        $events = [];

        foreach ($rows as $row) {
            $events[] = new EntityAuditEntry(
                traceId: $row['trace_id'],
                spanId: $row['span_id'],
                operation: $row['operation'],
                usecase: $row['usecase'],
                entityType: $row['entity_type'],
                entityId: $row['entity_id'],
                oldValue: json_decode($row['old_values'] ?? '{}', true) ?? [],
                newValue: json_decode($row['new_values'] ?? '{}', true) ?? [],
                performedBy: $row['performed_by'],
                tenant: $row['tenant'],
                timestamp: new \DateTimeImmutable($row['timestamp']),
                sourceRequest: $row['source_request'] ?? null,
                remoteAddress: $row['remote_address'] ?? null,
                remoteApplication: $row['remote_application'] ?? null,
                remoteDevice: $row['remote_device'] ?? null,
                claims: json_decode($row['claims'] ?? '{}', true) ?? []
            );
        }

        return $events;
    }

    public function record(EntityAuditEntry $event): void
    {
        $sql = "INSERT INTO _audit (
                    id, operation, usecase, trace_id, entity_type, entity_id,
                    old_values, new_values,
                    performed_by, tenant, timestamp,
                    source_request, remote_address, remote_application, remote_device,
                    claims, span_id
                ) VALUES (
                    :id, :operation, :usecase, :trace_id, :entity_type, :entity_id,
                    :old_values, :new_values,
                    :performed_by, :tenant, :timestamp,
                    :source_request, :remote_address, :remote_application, :remote_device,
                    :claims, :span_id
                )";

        // --- diff old/new (idéntico al Java) ---
        $old = $event->oldValue ?? [];
        $new = $event->newValue ?? [];

        $filteredOld = [];
        $filteredNew = [];

        $keys = array_unique(array_merge(array_keys($old), array_keys($new)));

        foreach ($keys as $key) {
            $oldVal = $old[$key] ?? null;
            $newVal = $new[$key] ?? null;

            if ($oldVal !== $newVal) {
                if ($oldVal !== null) {
                    $filteredOld[$key] = $oldVal;
                }
                if ($newVal !== null) {
                    $filteredNew[$key] = $newVal;
                }
            }
        }

        $stmt = $this->pdo->prepare($sql);

        $stmt->execute([
            ':id' => $this->uuid(),
            ':operation' => $event->operation,
            ':usecase' => $event->usecase,
            ':trace_id' => $event->traceId,
            ':entity_type' => $event->entityType,
            ':entity_id' => $event->entityId,
            ':old_values' => json_encode($filteredOld, JSON_THROW_ON_ERROR),
            ':new_values' => json_encode($filteredNew, JSON_THROW_ON_ERROR),
            ':performed_by' => $event->performedBy,
            ':tenant' => $event->tenant,
            ':timestamp' => $event->timestamp->format('Y-m-d H:i:s.u'),
            ':source_request' => $event->sourceRequest,
            ':remote_address' => $event->remoteAddress,
            ':remote_application' => $event->remoteApplication,
            ':remote_device' => $event->remoteDevice,
            ':claims' => json_encode($event->claims, JSON_THROW_ON_ERROR),
            ':span_id' => $event->spanId,
        ]);
    }

    private function uuid(): string
    {
        return sprintf(
            '%04x%04x-%04x-%04x-%04x-%04x%04x%04x',
            random_int(0, 0xffff),
            random_int(0, 0xffff),
            random_int(0, 0xffff),
            random_int(0, 0x0fff) | 0x4000,
            random_int(0, 0x3fff) | 0x8000,
            random_int(0, 0xffff),
            random_int(0, 0xffff),
            random_int(0, 0xffff)
        );
    }
}
