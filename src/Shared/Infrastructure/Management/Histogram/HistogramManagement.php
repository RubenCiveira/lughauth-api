<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Histogram;

use Closure;
use Override;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;
use Civi\Lughauth\Shared\Infrastructure\Middelware\Metrics\MetricsQuery;

class HistogramManagement implements ManagementInterface
{
    public function __construct(
        private readonly AppConfig $config,
        private readonly MetricsQuery $querier
        //, private readonly string $path = __DIR__ . '/../../../../../var/log'
    ) {
    }

    #[Override]
    public function name(): string
    {
        return 'histogram';
    }

    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $now = (int)(microtime(true) * 1000);
            $start = $now - 3600 * 10000; // 1h
            $step = 60; // 60s

//            return $row = $this->querier->range('app_http_status_codes', $start, $now, $step);


            $engine = new PromQLInterpreter($this->querier);

            return $engine->evaluate(
                'app_http_status_codes{status="200",path=~"/api/.*"}',
                $start,
                $now,
                $step
            );
            // return $ts;

            // $params = $request->getQueryParams();
            // $search = $params['search'] ?? null;
            // $traceId = $params['trace-id'] ?? null;
            // $spanId = $params['span-id'] ?? null;
            // $level = $params['level'] ?? null;
            // $service_name = $params['service-name'] ?? null;
            // $service_namespace = $params['service-namespace'] ?? null;
            // $service_version = $params['service-version'] ?? null;
            // $service_instance = $params['service-instance'] ?? null;
            // $environment = $params['deployment-environment'] ?? null;
            // $levelName = $params['level-name'] ?? null;
            // $to = isset($params['to']) ? strtotime($params['to']) : null;
            // $from = isset($params['from']) ? strtotime($params['from']) : null;

            // $offset        = max(0, (int)($params['offset'] ?? 0));
            // $limit         = max(1, min(500, (int)($params['limit'] ?? 100)));
            // $results = [];
            // return $results;
        };
    }

    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
