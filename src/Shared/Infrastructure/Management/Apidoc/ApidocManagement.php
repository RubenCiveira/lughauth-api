<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Apidoc;

use Closure;
use Override;
use Slim\App;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

class ApidocManagement implements ManagementInterface
{
    public function __construct(private readonly App $app, private readonly Context $context)
    {
    }

    #[Override]
    public function name(): string
    {
        return 'open-api';
    }

    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request, ResponseInterface $response): ResponseInterface {
            $params = $request->getQueryParams();
            if ('yaml' === ($params['format'] ?? '')) {
                $yaml = file_get_contents(__DIR__ . '/../../../../../templates/api-doc/openapi.yaml');
                $response->getBody()->write($yaml);
                return $response->withHeader('ContentType', 'text/plain');
            } else {
                $base = $this->context->getBaseUrl() . '/swagger/';
                $yaml = $this->context->getBaseUrl() . '/management/open-api?format=yaml';
                $response->getBody()->write(<<<HTML
                    <!-- HTML for static distribution bundle build -->
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <title>Swagger UI</title>
                        <link rel="stylesheet" type="text/css" href="{$base}swagger-ui.css" />
                        <link rel="stylesheet" type="text/css" href="{$base}index.css" />
                        <link rel="icon" type="image/png" href="{$base}favicon-32x32.png" sizes="32x32" />
                        <link rel="icon" type="image/png" href="{$base}favicon-16x16.png" sizes="16x16" />
                    </head>

                    <body>
                        <div id="swagger-ui"></div>
                        <script src="{$base}swagger-ui-bundle.js" charset="UTF-8"> </script>
                        <script src="{$base}swagger-ui-standalone-preset.js" charset="UTF-8"> </script>
                        <script>
                            window.onload = function() {
                            //<editor-fold desc="Changeable Configuration Block">

                            // the following lines will be replaced by docker/configurator, when it runs in a docker-container
                            window.ui = SwaggerUIBundle({
                                url: "{$yaml}",
                                dom_id: '#swagger-ui',
                                deepLinking: true,
                                presets: [
                                SwaggerUIBundle.presets.apis,
                                SwaggerUIStandalonePreset
                                ],
                                plugins: [
                                SwaggerUIBundle.plugins.DownloadUrl
                                ],
                                layout: "StandaloneLayout"
                            });

                            //</editor-fold>
                            };
                        </script>
                    </body>
                    </html>
                HTML);
                return $response->withHeader('ContentType', 'text/html');
            }
        };
    }

    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
