<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\EntityChangelog;

use Closure;
use Override;
use DateTimeImmutable;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Exception\ConstraintException;
use Civi\Lughauth\Shared\Infrastructure\EntityChangelog\EntityChangelogService;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Marks pending entity changelog entries as acknowledged.
 */
class MarkAckManagement implements ManagementInterface
{
    /**
     * Creates a new ack management handler.
     */
    public function __construct(
        /** @var EntityChangelogService Changelog query service. */
        private readonly EntityChangelogService $query
    ) {
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'entity-changelo-query-ack';
    }

    /**
     * Returns a handler that acknowledges processed changes.
     *
     * @return Closure|null Closure that marks entries as acknowledged.
     */
    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $params = $request->getQueryParams();
            if (isset($params['entity'])
                    && isset($params['last-date']) && isset($params['last-entry'])
                    && isset($params['queue'])) {
                $this->query->ackChanges(
                    $params['entity'],
                    $params['queue'],
                    new DateTimeImmutable($params['last-date']),
                    $params['last-entry']
                );
                return [];
            } else {
                throw ConstraintException::ofError(
                    'E1',
                    ['entity', 'last-date', 'last-entry', 'queue'],
                    ['','','',''],
                    ['not-null', 'not-null', 'not-null', 'not-null']
                );
            }
        };
    }

    /**
     * No write handler is provided for changelog acknowledgements.
     */
    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
