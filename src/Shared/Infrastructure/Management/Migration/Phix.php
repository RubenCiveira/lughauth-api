<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Migration;

use Override;
use Phinx\Config\Config;
use Phinx\Migration\Manager;
use Symfony\Component\Console\Input\StringInput;
use Civi\Lughauth\Shared\AppConfig;
use Symfony\Component\Console\Output\BufferedOutput;

/**
 * Manages database migrations using Phinx.
 */
class Phix implements MigrationInterface
{
    /**
     * Creates a new Phinx migration provider.
     */
    public function __construct(
        /** @var AppConfig Configuration provider. */
        private readonly AppConfig $config
    ) {
    }

    /**
     * Returns the migration provider name.
     */
    #[Override]
    public function name(): string
    {
        return 'database-schema';
    }

    /**
     * Returns migration status for the current environment.
     */
    #[Override]
    public function status(): array
    {
        $data = ['status' => []];
        $manager = $this->build();
        $this->dumpStatus($manager, $data['status']);
        return $data;
    }

    /**
     * Executes pending migrations and returns a status summary.
     */
    #[Override]
    public function migrate(): array
    {
        $previous = [];
        $current = [];

        $manager = $this->build();
        $this->dumpStatus($manager, $previous);
        $manager->migrate('current');
        $this->dumpStatus($manager, $current);

        $data = ['status' => []];
        foreach ($previous as $key => $value) {
            if ($value == "Ready") {
                $data['status'][$key] = "Ready";
            } else {
                $curr = $current[$key];
                if ($curr == "Ready") {
                    $data['status'][$key] = "Migrated";
                } else {
                    $data['status'][$key] = "Failed";
                }
            }
        }

        $output = $manager->getOutput();
        $data['detail'] = $output instanceof BufferedOutput ? $output->fetch() : "";
        return $data;
    }

    protected function dumpStatus(Manager $manager, array &$data): void
    {
        $migrations = $manager->getMigrations('current');
        foreach ($migrations as $version => $migration) {
            $data[ $migration->getName() . "[{$version}]" ] = $migration->isMigratingUp() ? "Ready" : "Pending";
        }
    }

    protected function build(): Manager
    {
        $pg = $this->parse();
        $of = $pg['adapter']; // mysql
        $configArray = [
            'paths' => [
                'migrations' => realpath(__DIR__ . '/../../../../../migrations/' . $of . '/schema'),
                'seed' => realpath(__DIR__ . '/../../../../../migrations/' . $of . '/data'),
            ],
            'environments' => [
                'default_migration_table' => '_migration_phix_log',
                'default_environment' => 'current',
                'current' => $pg,
            ]
        ];

        $config = new Config($configArray);
        $output = new BufferedOutput();

        return new Manager($config, new StringInput(''), $output);
    }

    protected function parse(): array
    {
        // Ejemplo esperado: pgsql:host=localhost;port=5432;dbname=baas;schema=public
        $dsn = $this->config->get("database.url");
        $parts = explode(':', $dsn, 2);
        if (count($parts) !== 2) {
            throw new \InvalidArgumentException("DSN invÃ¡lido: $dsn");
        }
        $adapter = $parts[0];
        $parameters = [];
        foreach (explode(';', $parts[1]) as $chunk) {
            if (trim($chunk) === '') {
                continue;
            }
            $split = explode('=', $chunk, 2);
            if (isset($split[1])) {
                [$key, $value] = $split;
                $parameters[trim($key)] = trim($value);
            }
        }
        $response = ['adapter' => $adapter];
        if (isset($parameters['host'])) {
            $response['host'] = $parameters['host'];
        }
        if (isset($parameters['port'])) {
            $response['port'] = $parameters['port'];
        }
        if (isset($parameters['dbname'])) {
            $response['name'] = $parameters['dbname'];
        }
        if (isset($_ENV['DATABASE_USERNAME'])) {
            $response['user'] = $this->config->get('database.username');
        }
        if (isset($_ENV['DATABASE_PASSWORD'])) {
            $response['pass'] = $this->config->get('database.password');
        }
        return $response;
    }
}
