<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Migration;

use Closure;
use Override;
use Throwable;
use Psr\Log\LoggerInterface;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Exposes migration status and execution through management endpoints.
 */
class MigrationManagement implements ManagementInterface
{
    /**
     * @var MigrationInterface[] Registered migration providers.
     */
    private array $providers;

    /**
     * Creates a new migration management handler.
     */
    public function __construct(
        ContainerInterface $container,
        /** @var LoggerInterface Logger for migration failures. */
        private readonly LoggerInterface $logger
    ) {
        $this->providers = [ $container->get(Phix::class) ];
    }

    /**
     * Adds a migration provider.
     */
    public function addProvider(MigrationInterface $provider)
    {
        $this->providers[] = $provider;
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'migration';
    }
    /**
     * Returns a handler that reports migration status.
     */
    #[Override]
    public function get(): ?Closure
    {
        $providers = $this->providers;
        return function () use ($providers): array {
            $data = [];
            foreach ($providers as $provider) {
                $data[ $provider->name() ] = $provider->status();
            }
            return $data;
        };
    }

    /**
     * Returns a handler that triggers migrations.
     */
    #[Override]
    public function set(): ?Closure
    {
        $providers = $this->providers;
        return function () use ($providers): array {
            $data = [];
            foreach ($providers as $provider) {
                try {
                    $data[ $provider->name() ] = $provider->migrate();
                } catch (Throwable $th) {
                    $data[ $provider->name() ] = $th->getMessage() . "\n" . $th->getTraceAsString();
                    $this->logger->critical("fail on migration step", [
                        'message' => $th->getMessage(),
                        'trace' => $th->getTraceAsString()
                    ]);
                }
            }
            return $data;
        };
    }

}
