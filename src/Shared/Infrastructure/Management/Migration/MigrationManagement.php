<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Migration;

use Closure;
use Override;
use Throwable;
use Psr\Log\LoggerInterface;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

class MigrationManagement implements ManagementInterface
{
    private array $providers;

    public function __construct(ContainerInterface $container, private readonly LoggerInterface $logger)
    {
        $this->providers = [ $container->get(Phix::class) ];
    }

    public function addProvider(MigrationInterface $provider)
    {
        $this->providers[] = $provider;
    }

    #[Override]
    public function name(): string
    {
        return 'migration';
    }
    #[Override]
    public function get(): ?Closure
    {
        $providers = $this->providers;
        return function () use ($providers): array {
            $data = [];
            foreach ($providers as $provider) {
                $data[ $provider->name() ] = $provider->status();
            }
            return $data;
        };
    }

    #[Override]
    public function set(): ?Closure
    {
        $providers = $this->providers;
        return function () use ($providers): array {
            $data = [];
            foreach ($providers as $provider) {
                try {
                    $data[ $provider->name() ] = $provider->migrate();
                } catch (Throwable $th) {
                    $data[ $provider->name() ] = $th->getMessage() . "\n" . $th->getTraceAsString();
                    $this->logger->critical("fail on migration step", [
                        'message' => $th->getMessage(),
                        'trace' => $th->getTraceAsString()
                    ]);
                }
            }
            return $data;
        };
    }

}
