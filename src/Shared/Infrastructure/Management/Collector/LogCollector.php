<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Collector;

use Closure;
use Override;
use Psr\Log\LoggerInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Collects log payloads and forwards them to the configured logger.
 */
class LogCollector implements ManagementInterface
{
    /**
     * Creates a new log collector management handler.
     */
    public function __construct(
        /** @var LoggerInterface Logger used to persist incoming log records. */
        private readonly LoggerInterface $logger
    ) {
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'log-collector';
    }

    /**
     * No read handler is provided for log collection.
     */
    #[Override]
    public function get(): ?Closure
    {
        return null;
    }

    /**
     * Returns a handler that ingests and logs OTLP log records.
     *
     * @return Closure|null Closure that processes log payloads.
     */
    #[Override]
    public function set(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $body = json_decode((string) $request->getBody(), true);

            foreach ($body['resourceLogs'] ?? [] as $resourceLog) {
                $serviceName = $this->extractServiceName($resourceLog['resource']['attributes'] ?? []);

                foreach ($resourceLog['scopeLogs'] ?? [] as $scopeLog) {
                    foreach ($scopeLog['logRecords'] ?? [] as $log) {
                        $level = strtolower($log['severityText'] ?? 'info');
                        $message = $log['body']['stringValue'] ?? '';
                        $context = $this->extractAttributes($log['attributes'] ?? []);

                        // AÃ±ade el nombre del servicio y el scope
                        $context['service'] = $serviceName;
                        $context['scope'] = $scopeLog['scope']['name'] ?? 'default';

                        // Usa Monolog o cualquier Logger PSR
                        $this->logger->log($level, $message, $context);
                    }
                }
            }

            return ['status' => 'ok'];
        };
    }

    private function extractAttributes(array $attributes): array
    {
        $context = [];
        foreach ($attributes as $attr) {
            $key = $attr['key'];
            $value = reset($attr['value']); // e.g., stringValue
            $context[$key] = $value;
        }
        return $context;
    }

    private function extractServiceName(array $attributes): string
    {
        foreach ($attributes as $attr) {
            if ($attr['key'] === 'service.name') {
                return $attr['value']['stringValue'] ?? 'unknown';
            }
        }
        return 'unknown';
    }
}
