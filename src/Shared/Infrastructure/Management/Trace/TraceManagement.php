<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Trace;

use Closure;
use Override;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

class TraceManagement implements ManagementInterface
{
    public function __construct(
        private readonly AppConfig $config,
        private readonly string $path = __DIR__ . '/../../../../../var/trace'
    ) {
    }

    #[Override]
    public function name(): string
    {
        return 'trace';
    }

    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $params = $request->getQueryParams();
            $traceId = $params['trace-id'] ?? null;

            $traceFiles = glob($this->path . '/' . $this->config->name . '-*.json'); // eg: traces/app-2025-06-04.json
            rsort($traceFiles); // m√°s recientes primero

            $results = [];

            foreach ($traceFiles as $file) {
                $handle = fopen($file, 'r');
                if (!$handle) {
                    continue;
                }
                while (($line = fgets($handle)) !== false) {
                    if (!trim($line)) {
                        continue;
                    }
                    $span = json_decode($line, true);
                    if (!is_array($span)) {
                        continue;
                    }
                    if ($traceId && $traceId !== ($span['traceId'] ?? null)) {
                        continue;
                    }
                    $results[] = $span;
                }
                fclose($handle);
            }
            return $results;
        };
    }

    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
