<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Trace;

use Closure;
use Override;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Exposes trace spans stored on disk for management queries.
 */
class TraceManagement implements ManagementInterface
{
    /**
     * Creates a new trace management handler.
     */
    public function __construct(
        /** @var AppConfig Application configuration. */
        private readonly AppConfig $config,
        /** @var string Path to the trace storage directory. */
        private readonly string $path = __DIR__ . '/../../../../../var/trace'
    ) {
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'trace';
    }

    /**
     * Returns a handler that filters stored trace spans.
     *
     * @return Closure|null Closure that returns the trace query results.
     */
    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $params = $request->getQueryParams();
            $search = $params['search'] ?? null;
            $traceId = $params['trace-id'] ?? null;
            $status = $params['status'] ?? null;
            $service_name = $params['service-name'] ?? null;
            $service_namespace = $params['service-namespace'] ?? null;
            $service_version = $params['service-version'] ?? null;
            $service_instance = $params['service-instance'] ?? null;
            $environment = $params['deployment.environment'] ?? null;

            $offset        = max(0, (int)($params['offset'] ?? 0));
            $limit         = max(1, min(500, (int)($params['limit'] ?? 100)));

            $hasFilters = (bool) array_filter([
                $traceId
            ], fn ($v) => $v !== null && $v !== '');

            $traceFiles = glob($this->path . '/' . $this->config->name . '-*.jsonl*'); // eg: traces/app-2025-06-04.json
            rsort($traceFiles); // más recientes primero

            $results = [];
            $matchedSeen = 0;

            foreach ($traceFiles as $file) {
                $handle = fopen($file, 'r');
                if (!$handle) {
                    continue;
                }
                foreach ($this->iterateLines($file) as $line) {
                    if (!trim($line)) {
                        continue;
                    }
                    $span = json_decode($line, true);
                    if (!is_array($span)) {
                        continue;
                    }
                    if ($status && $span['status'] !== $status) {
                        continue;
                    }
                    if ($service_name && ($span['extra']['service']['sdervice.name']) !== $service_name) {
                        continue;
                    }
                    if ($service_namespace && ($span['extra']['service']['service.namespace']) !== $service_namespace) {
                        continue;
                    }
                    if ($service_version && ($span['extra']['service']['service.version']) !== $service_version) {
                        continue;
                    }
                    if ($service_instance && ($span['extra']['service']['service.instance.id']) !== $service_instance) {
                        continue;
                    }
                    if ($environment && ($span['extra']['service']['deployment.environment']) !== $environment) {
                        continue;
                    }
                    if ($traceId && $traceId !== ($span['traceId'] ?? null)) {
                        continue;
                    }
                    // Búsqueda textual
                    if ($search && stripos($span['name'], $search) === false) {
                        continue;
                    }
                    if ($matchedSeen++ < $offset) {
                        continue;
                    }
                    if ($hasFilters) {
                        $results[] = $span;
                    } elseif ($span['parentSpanId'] === '0000000000000000') {
                        $results[] = $span;
                    }
                    if (count($results) >= $limit) {
                        break 2;
                    }
                }
                fclose($handle);
            }
            return $results;
        };
    }

    /**
     * No write handler is provided for traces.
     */
    #[Override]
    public function set(): ?Closure
    {
        return null;
    }

    private function iterateLines(string $file): \Generator
    {
        $isGz = str_ends_with($file, '.gz');

        if ($isGz) {
            $h = @gzopen($file, 'rb');
            if ($h === false) {
                return;
            }
            try {
                while (!gzeof($h)) {
                    $line = gzgets($h);
                    if ($line === false) {
                        break;
                    }
                    yield rtrim($line, "\r\n");
                }
            } finally {
                @gzclose($h);
            }
        } else {
            $h = @fopen($file, 'rb');
            if ($h === false) {
                return;
            }
            try {
                while (!feof($h)) {
                    $line = fgets($h);
                    if ($line === false) {
                        break;
                    }
                    yield rtrim($line, "\r\n");
                }
            } finally {
                @fclose($h);
            }
        }
    }
}
