<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Audit;

use Closure;
use Override;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Exception\ConstraintException;
use Civi\Lughauth\Shared\Infrastructure\Audit\AuditQueryService;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Exposes audit log queries for management use.
 */
class AuditManagement implements ManagementInterface
{
    /**
     * Creates a new audit management handler.
     */
    public function __construct(
        /** @var AuditQueryService Audit query service. */
        private readonly AuditQueryService $query
    ) {
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'audit';
    }

    /**
     * Returns a handler that retrieves audit log entries.
     */
    #[Override]
    public function get(): ?Closure
    {
        return function (ServerRequestInterface $request): array {
            $params = $request->getQueryParams();
            if (isset($params['user'])) {
                return $this->query->getAuditLog(
                    $params['user'],
                    isset($params['from']) ? new \DateTimeImmutable($params['from']) : null,
                    isset($params['to']) ? new \DateTimeImmutable($params['to']) : null,
                );
            } else {
                throw ConstraintException::ofError('E1', ['user'], [''], ['not-null']);
            }
        };
    }

    /**
     * No write handler is provided for audit logs.
     */
    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
