<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Management\Dependencies;

use Closure;
use Override;
use Civi\Lughauth\Shared\Infrastructure\Management\ManagementInterface;

/**
 * Exposes dependency information from composer.lock.
 */
class DependenciesManagement implements ManagementInterface
{
    /**
     * Creates a new dependencies management handler.
     */
    public function __construct(
        /** @var string Path to the project root. */
        private readonly string $path = __DIR__ . '/../../../../../'
    ) {
    }

    /**
     * Returns the management endpoint name.
     */
    #[Override]
    public function name(): string
    {
        return 'dependencies';
    }

    /**
     * Returns a handler that lists dependency metadata.
     */
    #[Override]
    public function get(): ?Closure
    {
        return function (): array {
            $lockFile = $this->path . '/composer.lock';
            if (!file_exists($lockFile)) {
                throw new \Exception('composer.lock not found');
            }
            $data = json_decode(file_get_contents($lockFile), true);
            $packages = array_merge($data['packages'] ?? [], $data['packages-dev'] ?? []);

            return array_map(function ($pkg) {
                return [
                    'name'    => $pkg['name'],
                    'version' => $pkg['version'],
                    'type'    => $pkg['type'] ?? 'library',
                    'source'  => $pkg['source']['url'] ?? ($pkg['dist']['url'] ?? null),
                ];
            }, $packages);
        };
    }

    /**
     * No write handler is provided for dependencies.
     */
    #[Override]
    public function set(): ?Closure
    {
        return null;
    }
}
