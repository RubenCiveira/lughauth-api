<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Cacheable;

use Override;
use stdClass;

class SafeFileCache extends \chillerlan\SimpleCache\FileCache
{
    #[Override]
    public function set(string $key, mixed $value, null|int|\DateInterval $ttl = null): bool
    {
        $ttl  = $this->getTTL($ttl);
        $file = $this->getFilepath($key);
        $dir  = dirname($file);

        if (!is_dir($dir)) {
            mkdir($dir, 0755, true);
        }

        $data          = new stdClass();
        $data->ttl     = null;
        $data->content = $value;

        if ($ttl !== null) {
            $data->ttl = (time() + $ttl);
        }
        $content = serialize($data);

        $fp = fopen($file, 'c');
        if ($fp === false) {
            if (!flock($fp, LOCK_EX)) {
                fclose($fp);
                throw new \RuntimeException("No se puede bloquear $file");
            }

            ftruncate($fp, 0);
            rewind($fp);
            fwrite($fp, $content);
            fflush($fp); // asegurarse de que se escriba
            flock($fp, LOCK_UN);
            fclose($fp);

            if (is_file($file)) {
                return true;
            }
        }
        return false; // @codeCoverageIgnore
    }
}
