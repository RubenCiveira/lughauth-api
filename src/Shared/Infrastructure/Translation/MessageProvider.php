<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Translation;

use RuntimeException;
use Civi\Lughauth\Shared\AppConfig;
use Symfony\Component\Translation\Translator;
use Symfony\Component\Translation\Loader\YamlFileLoader;
use Symfony\Component\Translation\Formatter\MessageFormatter;

class MessageProvider
{
    public function __construct(
        private readonly AppConfig $config,
        private readonly string $compiled = __DIR__ . '/../../../var/compiled/langs'
    ) {
    }

    public function messages(string $name, string $lang, string $path = __DIR__ . '/../../../translations'): MessageCatalogue
    {
        // private readonly Translator $translator;
        if (!$this->intlEnabled()) {
            $domain = $name;
        } else {
            $domain = $name . '.+intl-icu';
        }
        $loader = new YamlFileLoader();
        $dir = realpath($path);
        if ($dir===false || $dir==='') {
            throw new RuntimeException("Error trying to get inexistent dire {$path} with {$name}");
        }
        $file = $dir . ($name[0] !== '/' ? '/' : '') . $name;
        $translator = new Translator(
            $lang,
            new MessageFormatter(),
            $this->config->develop ? null : $this->compiled
        );
        $translator->addLoader('yaml', $loader);
        if ($lang && $lang != 'en') {
            $translator->addResource('yaml', $file  . '.' . $lang . '.yaml', $lang, $domain);
        }
        $translator->addResource('yaml', $file . '.yaml', 'en', $domain);
        $translator->setFallbackLocales(['en']);
        return new MessageCatalogue($translator, $domain);
    }

    protected function intlEnabled(): bool
    {
        return extension_loaded('intl');
    }
}
