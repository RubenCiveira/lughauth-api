<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Translation;

use RuntimeException;
use Civi\Lughauth\Shared\AppConfig;
use Symfony\Component\Translation\Translator;
use Symfony\Component\Translation\Loader\YamlFileLoader;
use Symfony\Component\Translation\Formatter\MessageFormatter;

/**
 * Builds translation catalogues from YAML resources.
 */
class MessageProvider
{
    /**
     * Creates a new message provider.
     */
    public function __construct(
        /** @var AppConfig Application configuration. */
        private readonly AppConfig $config,
        /** @var string Path to compiled translation cache. */
        private readonly string $compiled = __DIR__ . '/../../../var/compiled/langs'
    ) {
    }

    /**
     * Builds a message catalogue for the requested domain and locale.
     */
    public function messages(string $name, string $lang, string $path = __DIR__ . '/../../../translations'): MessageCatalogue
    {
        // private readonly Translator $translator;
        if (!$this->intlEnabled()) {
            $domain = $name;
        } else {
            $domain = $name . '.+intl-icu';
        }
        $loader = new YamlFileLoader();
        $dir = realpath($path);
        if ($dir === false || $dir === '') {
            throw new RuntimeException("Error trying to get inexistent dire {$path} with {$name}");
        }
        $file = $dir . ($name[0] !== '/' ? '/' : '') . $name;
        $translator = new Translator(
            $lang,
            new MessageFormatter(),
            $this->config->develop ? null : $this->compiled
        );
        $translator->addLoader('yaml', $loader);
        if ($lang && $lang != 'en') {
            $translator->addResource('yaml', $file  . '.' . $lang . '.yaml', $lang, $domain);
        }
        $translator->addResource('yaml', $file . '.yaml', 'en', $domain);
        $translator->setFallbackLocales(['en']);
        return new MessageCatalogue($translator, $domain);
    }

    /**
     * Indicates whether the intl extension is available.
     */
    protected function intlEnabled(): bool
    {
        return extension_loaded('intl');
    }
}
