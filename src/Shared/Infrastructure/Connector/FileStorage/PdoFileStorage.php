<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared\Infrastructure\Connector\FileStorage;

use PDO;
use Override;
use Ramsey\Uuid\Uuid;
use Civi\Lughauth\Shared\Connector\FileStorage\FileStorageInterface;
use Civi\Lughauth\Shared\Connector\FileStorage\BinaryContent;
use Civi\Lughauth\Shared\Connector\FileStorage\FileStoreKey;

class PdoFileStorage implements FileStorageInterface
{
    private $tempCapacity = 1000;
    private $minutesLifeTime = 60;
    private readonly string $driver;

    public function __construct(private readonly PDO $pdo)
    {
        $this->driver = $this->pdo->getAttribute(PDO::ATTR_DRIVER_NAME);
        $this->up();
    }

    #[Override]
    public function tempStore(BinaryContent $source): FileStoreKey
    {
        $this->clearTemp($on);
        if ($this->driver === 'pgsql') {
            $stmt = $this->pdo->prepare('INSERT INTO _filestorer (code, temp, name, mime, upload, bytes) VALUES (:code, 1, :name, :mime, :upload, :bytes)');
        } else {
            $stmt = $this->pdo->prepare('INSERT INTO _filestorer (code, temp, name, mime, upload, bytes) VALUES (:code, 1, :name, :mime, :upload, :bytes)');
        }
        $uid = Uuid::uuid4()->toString();
        $stmt->bindValue('code', $uid, PDO::PARAM_STR);
        $stmt->bindValue('name', $source->name, PDO::PARAM_STR);
        $stmt->bindValue('mime', $source->mime, PDO::PARAM_STR);
        $stmt->bindValue('upload', $source->lastChange->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('bytes', $source->stream, PDO::PARAM_LOB);
        $stmt->execute();
        return new FileStoreKey($uid);
    }

    #[Override]
    public function retrieveTempFile(FileStoreKey $key): ?BinaryContent
    {
        return $this->retrieveFromAllFile($on, $key->key, true);
    }

    #[Override]
    public function retrieveFile(FileStoreKey $key): ?BinaryContent
    {
        return $this->retrieveFromAllFile($on, $key->key, false);
    }

    #[Override]
    public function commitContent(FileStoreKey $key): FileStoreKey
    {
        $this->clearTemp($on);
        $now = new \DateTime();
        if ($this->driver == 'pgsql') {
            $stmt = $this->pdo->prepare('UPDATE ${on} SET upload = :upload, temp = 0 where code = :code');
        } else {
            $stmt = $this->pdo->prepare('UPDATE ${on} SET upload = :upload, temp = 0 where code = :code');
        }
        $stmt->bindValue('upload', $now->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('code', $key->key, PDO::PARAM_STR);
        $stmt->execute();
        return $key;
    }

    #[Override]
    public function replaceContent(FileStoreKey $key, BinaryContent $content)
    {
        $stmt = $this->pdo->prepare('UPDATE ${on} SET name = :name, mime = :mime, upload = :upload, bytes = :bytes WHERE code = :code');
        $stmt->bindValue('code', $key->key, PDO::PARAM_STR);
        $stmt->bindValue('name', $content->name, PDO::PARAM_STR);
        $stmt->bindValue('mime', $content->mime, PDO::PARAM_STR);
        $stmt->bindValue('upload', $content->lastChange->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('bytes', $content->stream, PDO::PARAM_LOB);
        $stmt->execute();
    }

    #[Override]
    public function deleteFile(FileStoreKey $key)
    {
        $stmt = $this->pdo->prepare('DELETE from _filestorer WHERE code = :code');
        $stmt->bindValue('code', $key->key, PDO::PARAM_STR);
        $stmt->execute();
    }

    private function clearTemp(string $on)
    {
        $now = new \DateTime();
        $expires = $now->sub(new \DateInterval('PT' . $this->minutesLifeTime . 'M'));
        $stmt = $this->pdo->prepare('DELETE FROM ${on} WHERE temp = 1 and upload < :upload');
        $stmt->bindValue('upload', $expires->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->execute();
        if ($this->driver === 'pgsql') {
            $stmt = $this->pdo->prepare('SELECT code FROM ${on} where temp = 1 order by upload desc limit 50 offset :offset');
        } else {
            $stmt = $this->pdo->prepare('SELECT code FROM ${on} where temp = 1 order by upload desc limit 50 offset :offset');
        }
        $stmt->bindValue('offset', $this->tempCapacity, PDO::PARAM_INT);
        $stmt->execute();
        $keys = [];
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $keys[] = $row['code'];
        }
        if ($keys) {
            $placeholders = implode(',', array_fill(0, count($keys), '?'));
            if ($this->driver === 'pgsql') {
                $stmt = $this->pdo->prepare('DELETE FROM ${on} where temp = 1 and code in (' . $placeholders . ')');
            } else {
                $stmt = $this->pdo->prepare('DELETE FROM ${on} where temp = 1 and code in (' . $placeholders . ')');
            }
            $stmt->execute($keys);
        }
    }

    private function up()
    {
        if ($this->driver === 'pgsql') {
            $query = $this->pdo->prepare("CREATE TABLE IF NOT EXISTS _filestorer (
                code VARCHAR(250) NOT NULL PRIMARY KEY,
                temp SMALLINT NOT NULL DEFAULT 0,
                name VARCHAR(250) NOT NULL,
                mime VARCHAR(250) NOT NULL,
                upload TIMESTAMP NOT NULL,
                bytes BYTEA NOT NULL
            );");
        } else {
            $query = $this->pdo->prepare("CREATE TABLE IF NOT EXISTS `_filestorer` (
                `code` varchar(250) NOT NULL,
                `temp` smallint(6) NOT NULL DEFAULT 0,
                `name` varchar(250) NOT NULL,
                `mime` varchar(250) NOT NULL,
                `upload` timestamp NOT NULL,
                `bytes` longblob NOT NULL,
                PRIMARY KEY (`code`)
                )");
        }
        $query->execute();
    }

    private function retrieveFromAllFile(string $key, bool $temp)
    {
        $stmt = $this->pdo->prepare('SELECT name, mime, upload, bytes FROM _filestorer WHERE temp=:temp and code=:code');
        $stmt->bindValue('temp', $temp, PDO::PARAM_BOOL);
        $stmt->bindValue('code', $key, PDO::PARAM_STR);
        $stmt->bindColumn('name', $name, PDO::PARAM_STR);
        $stmt->bindColumn('mime', $mime, PDO::PARAM_STR);
        $stmt->bindColumn('upload', $upload, PDO::PARAM_STR);
        $stmt->bindColumn('bytes', $resource, PDO::PARAM_LOB);
        $stmt->execute();
        if ($stmt->fetch(PDO::FETCH_BOUND)) {
            return new BinaryContent(name: $name, mime: $mime, lastChange: new \DateTime($upload), stream: $resource);
        }
    }
}
