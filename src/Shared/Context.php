<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared;

use DI\ContainerBuilder;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Security\Connection;
use Civi\Lughauth\Shared\Security\Identity;

class Context
{
    private ?Identity $identity = null;
    private ?Connection $connection = null;

    public function __construct(private readonly ContainerBuilder $builder)
    {

    }

    public function setSecurityContext(Connection $connection, Identity $identity)
    {
        $this->identity = $identity;
        $this->connection = $connection;
    }

    public function getIdentity(): ?Identity
    {
        if ($this->identity == null) {
            $this->identity = Identity::anonimous();
        }
        return $this->identity;
    }

    public function getConnection(): ?Connection
    {
        if ($this->connection == null) {
            $this->connection = Connection::remoteHttp();
        }
        return $this->connection;
    }

    public function detachedContainer(): ContainerInterface
    {
        return $this->builder->build();
    }

    public function getBaseUrl(): string
    {
        $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
        $host = $_SERVER['HTTP_HOST'] ?? 'localhost';
        $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
        $basePath = rtrim(str_replace(basename($scriptName), '', $scriptName), '/');
        return rtrim($scheme . '://' . $host . $basePath, '/');
    }

    public function getCurrentPath(): string
    {
        $requestUri = $_SERVER['REQUEST_URI'] ?? '/';
        $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
        $basePath = rtrim(str_replace(basename($scriptName), '', $scriptName), '/');

        // Elimina el basePath y query string
        $path = preg_replace('#\?.*$#', '', $requestUri);
        $path = substr($path, strlen($basePath));

        return '/' . ltrim($path, '/');
    }
}
