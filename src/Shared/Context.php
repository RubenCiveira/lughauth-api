<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Shared;

use DI\ContainerBuilder;
use Psr\Container\ContainerInterface;
use Civi\Lughauth\Shared\Security\Connection;
use Civi\Lughauth\Shared\Security\Identity;

class Context
{
    private ?Identity $identity = null;
    private ?Connection $connection = null;

    public function __construct(private readonly ContainerBuilder $builder, private readonly AppConfig $config)
    {

    }

    public function setSecurityContext(Connection $connection, Identity $identity)
    {
        $this->identity = $identity;
        $this->connection = $connection;
    }

    public function getIdentity(): Identity
    {
        if ($this->identity == null) {
            $this->identity = Identity::anonimous();
        }
        return $this->identity;
    }

    public function getConnection(): Connection
    {
        if ($this->connection == null) {
            $this->connection = Connection::remoteHttp();
        }
        return $this->connection;
    }

    public function detachedContainer(): ContainerInterface
    {
        return $this->builder->build();
    }

    public function getBaseUrl(): string
    {
        $scheme = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? 'https' : 'http';
        $host = $_SERVER['HTTP_HOST'] ?? 'localhost';
        $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
        $basePath = rtrim(str_replace(basename($scriptName), '', $scriptName), '/');
        return rtrim($scheme . '://' . $host . $basePath, '/');
    }

    public function getCurrentPath(): string
    {
        $requestUri = $_SERVER['REQUEST_URI'] ?? '/';
        $scriptName = $_SERVER['SCRIPT_NAME'] ?? '';
        $basePath = rtrim(str_replace(basename($scriptName), '', $scriptName), '/');

        // Elimina el basePath y query string
        $path = preg_replace('#\?.*$#', '', $requestUri);
        $path = substr($path, strlen($basePath));

        return '/' . ltrim($path, '/');
    }

    public function getInstanceData(): array
    {
        return [
            'service.name' => $this->config->get('app.id.name', 'phylax'),
            'service.namespace' => $this->config->get('app.id.namespace', 'backoffice'),
            'service.version' => $this->config->get('app.id.version', '1.0.0'),
            'service.instance.id' => $this->config->get('app.id.instance', php_uname('n') . '-' . getmypid()),
            'deployment.environment' => $this->config->get('app.id.enviroment', 'prod'),
        ];
    }
}
