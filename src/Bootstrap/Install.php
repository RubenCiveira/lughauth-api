<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Bootstrap;

use Throwable;
use OpenApi\Generator;
use OpenApi\Attributes as OA;
use Symfony\Component\Yaml\Yaml;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Migration\Phix;

#[OA\Info(
    title: "Mi API REST",
    version: "1.0.0",
    description: "Documentación generada automáticamente"
)]
class Install
{
    public static function bootstrap()
    {
        echo "==========\n";
        echo "- Checking open ssl\n";
        $privateKeyResource = openssl_pkey_new([
            'private_key_type' => OPENSSL_KEYTYPE_RSA,
            'private_key_bits' => 4096,
        ]);
        if ($privateKeyResource === false) {
            while ($msg = openssl_error_string()) {
                echo "OpenSSL error: $msg\n";
            }
            throw new \RuntimeException('No se pudo generar la clave RSA');
        }
        echo "==========\n";
        echo "- Migrating bbdd\n";
        try {
            $phinx = new Phix(new AppConfig());
            $phinx->migrate();
        } catch (Throwable $fail) {
            echo "- Error migrating bbdd ". $fail->getMessage() . "\n";
        }
        echo "==== Borrar cache\n";
        $cacheDir = realpath(__DIR__ . '/../../var/cache/');
        if ($cacheDir && is_dir($cacheDir)) {
            exec("rm -rf " . escapeshellarg($cacheDir));
            echo " - Cache directory cleared: $cacheDir\n";
        }
        $compiledDir = realpath(__DIR__ . '/../../var/compiled/');
        if ($compiledDir && is_dir($compiledDir)) {
            exec("rm -rf " . escapeshellarg($compiledDir));
            echo " - Cache directory cleared: $compiledDir\n";
        }
        $flag = realpath(__DIR__ . '/../../var/startup.flag');
        if ($flag) {
            unlink($flag);
        }
        $lock = realpath(__DIR__ . '/../../var/startup.lock');
        if ($lock) {
            unlink($lock);
        }
        self::openApi();
        echo "==== Borrar flags\n";
    }

    private static function openApi()
    {
        // Ruta de directorio que contiene las anotaciones
        $scanPaths = [__DIR__ . '/../'];

        // Generar el objeto OpenApi
        $gen = new Generator();
        $openapi = $gen->generate($scanPaths);

        // Exportar a YAML
        $yaml = Yaml::dump(json_decode($openapi->toJson(), true), 20, 2);

        // Guardar en archivo
        $output = __DIR__ . '/../../templates/api-doc/openapi.yaml';
        if (!is_dir(dirname($output))) {
            mkdir(dirname($output), 0777, true);
        }
        file_put_contents($output, $yaml);
    }

    private static function info()
    {
    }
}
