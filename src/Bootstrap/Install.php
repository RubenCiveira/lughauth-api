<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Bootstrap;

use Throwable;
use RecursiveDirectoryIterator;
use RecursiveIteratorIterator;
use OpenApi\Generator;
use OpenApi\Attributes as OA;
use Symfony\Component\Yaml\Yaml;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Infrastructure\Management\Migration\Phix;

#[OA\Info(
    title: "Mi API REST",
    version: "1.0.0",
    description: "Documentación generada automáticamente"
)]
class Install
{
    public static function bootstrap()
    {
        echo "==========\n";
        echo "- Checking open ssl\n";
        $privateKeyResource = openssl_pkey_new([
            'private_key_type' => OPENSSL_KEYTYPE_RSA,
            'private_key_bits' => 4096,
        ]);
        if ($privateKeyResource === false) {
            while ($msg = openssl_error_string()) {
                echo "OpenSSL error: $msg\n";
            }
            throw new \RuntimeException('No se pudo generar la clave RSA');
        }
        echo "==========\n";
        echo "- Migrating bbdd\n";
        try {
            $phinx = new Phix(new AppConfig());
            $phinx->migrate();
        } catch (Throwable $fail) {
            echo "- Error migrating bbdd ". $fail->getMessage() . "\n";
        }
        echo "==== Borrar cache\n";
        $cacheDir = realpath(__DIR__ . '/../../var/cache/');
        if ($cacheDir && is_dir($cacheDir)) {
            exec("rm -rf " . escapeshellarg($cacheDir));
            echo " - Cache directory cleared: $cacheDir\n";
        }
        $compiledDir = realpath(__DIR__ . '/../../var/compiled/');
        if ($compiledDir && is_dir($compiledDir)) {
            exec("rm -rf " . escapeshellarg($compiledDir));
            echo " - Cache directory cleared: $compiledDir\n";
        }
        $flag = realpath(__DIR__ . '/../../var/startup.flag');
        if ($flag) {
            unlink($flag);
        }
        $lock = realpath(__DIR__ . '/../../var/startup.lock');
        if ($lock) {
            unlink($lock);
        }
        self::openApi();
        self::compileDi();
        echo "==== Borrar flags\n";
    }

    private static function openApi()
    {
        // Ruta de directorio que contiene las anotaciones
        $scanPaths = [__DIR__ . '/../'];

        // Generar el objeto OpenApi
        $gen = new Generator();
        $openapi = $gen->generate($scanPaths);

        // Exportar a YAML
        $yaml = Yaml::dump(json_decode($openapi->toJson(), true), 20, 2);

        // Guardar en archivo
        $output = __DIR__ . '/../../templates/api-doc/openapi.yaml';
        if (!is_dir(dirname($output))) {
            mkdir(dirname($output), 0777, true);
        }
        file_put_contents($output, $yaml);
    }

    private static function info()
    {
    }

    private static function compileDi()
    {
        $srcDir = __DIR__ . '/..';
        $outputFile = __DIR__ . '/../../var/cache/di-definitions.php';
        if (file_exists($outputFile)) {
            unlink($outputFile);
        }

        $included = [];
        $definitions = [];

        $rii = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($srcDir));

        foreach ($rii as $file) {
            if (!$file->isFile() || $file->getExtension() !== 'php') {
                continue;
            }

            $contents = file_get_contents($file->getPathname());

            if (!preg_match('/^namespace\s+(.+?);/m', $contents, $nsMatch)) {
                continue;
            }
            $namespace = trim($nsMatch[1]);

            if (!in_array(realpath($file->getPathname()), $included)) {
                $included[] = realpath($file->getPathname());
            }
            /*
            preg_match_all('/^use\s+([^;]+);/m', $contents, $useMatches);
            foreach ($useMatches[1] as $fqcn) {
                $fqcn = trim($fqcn);
                if (class_exists($fqcn) || interface_exists($fqcn)) {
                    try {
                        $rc = new \ReflectionClass($fqcn);
                        $file = $rc->getFileName();
                        if ($file && file_exists($file) && in_array(realpath($file), $included)) {
                            $included[] = realpath($file);
                        }
                    } catch (\ReflectionException) {
                        // Saltar clases que no pueden ser cargadas/reflejadas
                    }
                }
            }
            */
            if (!preg_match('/^class\s+([a-zA-Z0-9_]+)/m', $contents, $classMatch)) {
                continue;
            }
            $class = trim($classMatch[1]);

            $fqcn = $namespace . '\\' . $class;
            if (str_ends_with($class, 'Controller')) {
                $definitions[$fqcn] = "autowire($fqcn::class)";
            }
            // $definitions[$fqcn] = "autowire($fqcn::class)";
        }

        ksort($definitions);

        $code = "<?php\n";
        foreach ($included as $inc) {
            // $code .= "require_once \"".$inc."\";\n";
        }
        $code .= "use function DI\\autowire;\n\n";
        $code .= "return [\n";
        foreach ($definitions as $fqcn => $autowireCall) {
            $code .= "    {$fqcn}::class => {$autowireCall},\n";
        }
        $code .= "];\n";

        if (!is_dir(dirname($outputFile))) {
            mkdir(dirname($outputFile), 0775, true);
        }

        file_put_contents($outputFile, $code);
        echo "Generated DI definitions in $outputFile\n";
    }
}
