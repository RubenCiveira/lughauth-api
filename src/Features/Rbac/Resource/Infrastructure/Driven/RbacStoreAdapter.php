<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Rbac\Resource\Infrastructure\Driven;

use Override;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\Gateway\RelyingPartyReadGateway;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\Gateway\RelyingPartyWriteGateway;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\RelyingPartyAttributes;
use Civi\Lughauth\Features\Access\Role\Domain\Gateway\RoleReadGateway;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;
use Civi\Lughauth\Features\Rbac\Acl\Application\PolicyEngine;
use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;
use Civi\Lughauth\Features\Rbac\Resource\Domain\Gateway\RbacStoreRepository;
use Civi\Lughauth\Features\Rbac\Resource\Domain\RoleGrant;

class RbacStoreAdapter implements RbacStoreRepository
{
    public function __construct(
        private readonly RelyingPartyWriteGateway $parties,
        private readonly RelyingPartyReadGateway $readParties,
        private readonly RoleReadGateway $roles,
    ) {
    }
    /**
     * @param string $relyingParty
     * @param list<ScopeList> $paramMap
     */
    #[Override]
    public function registerScopes(string $relyingParty, array $paramMap): void
    {
        $party = $this->parties->findOneForUpdateByCode($relyingParty);
        if ($party === null) {
            return;
        }
        $json = $party->getScopes() ?? "";
        if( $json ) {
            $paramMap = array_merge( json_decode($json, true), $paramMap);
        }
        $att = new RelyingPartyAttributes();
        $att->scopes( json_encode($paramMap) );
        $this->parties->update($party, $party->replace($att));
    }

    /**
     * @param string $relyingParty
     * @param list<Property> $paramMap
     */
    #[Override]
    public function registerSchema(string $relyingParty, array $paramMap): void
    {
        $party = $this->parties->findOneForUpdateByCode($relyingParty);
        if ($party === null) {
            return;
        }
        $json = $party->getSchemas() ?? "";
        if( $json ) {
            $paramMap = array_merge( json_decode($json, true), $paramMap);
        }
        $att = new RelyingPartyAttributes();
        $att->schemas( json_encode($paramMap) );
        $this->parties->update($party, $party->replace($att));
    }

    /**
     * @param string $relyingParty
     * @return list<RoleGrant>
     */
    #[Override]
    public function granted(string $relyingParty): array
    {
        $party = $this->readParties->findOneByCode($relyingParty);
        if ($party === null) {
            return [];
        }
        $dsl = $party->getPolicies();
        if( !$dsl ) {
            return [];
        }
        $secRoles = $this->roles->list();
        $roles = [];
        $scopes = [];
        $schemas = [];
        foreach($secRoles as $secRole) {
            $roles[] = $secRole->getName();
        }
        if( $party->getScopes() ) {
            $scopes = json_decode($party->getScopes(), true);
        }
        if( $party->getSchemas() ) {
            $schemas = json_decode($party->getSchemas(), true);
        }
        $resources = [];
        foreach($scopes as $scc) {
            if( $scc['resource']['name'] && is_array($scc['scopes']) ) {
                if( !$resources[ $scc['resource']['name'] ] ) {
                    $resources[ $scc['resource']['name'] ] = ['scopes' => [], 'attributes' => []];
                }
                foreach($scc['scopes'] as $scc) {
                    $resources[ $scc['resource']['name'] ]['scopes'] = [];
                }
            }
        }
        $engine = new PolicyEngine();
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setRoles($roles);
        $engine->setResources([
            'article' => ['attributes' => ['title', 'content', 'author']]
        ]);
        return $engine->expand();
    }
    private function parseRules(string $dsl): RuleSet
    {
        $parser = new DslParser();
        $array = $parser->parse($dsl);
        return RuleSet::fromArray($array);
    }
}
