<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Rbac\Resource\Infrastructure\Driven;

use Override;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\Gateway\RelyingPartyReadGateway;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\Gateway\RelyingPartyWriteGateway;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\RelyingPartyAttributes;
use Civi\Lughauth\Features\Access\Role\Domain\Gateway\RoleReadGateway;
use Civi\Lughauth\Features\Rbac\Acl\Application\DslParser;
use Civi\Lughauth\Features\Rbac\Acl\Application\PolicyEngine;
use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;
use Civi\Lughauth\Features\Rbac\Resource\Domain\Gateway\RbacStoreRepository;
use Civi\Lughauth\Features\Rbac\Resource\Domain\RoleGrant;

class RbacStoreAdapter implements RbacStoreRepository
{
    public function __construct(
        private readonly RelyingPartyWriteGateway $parties,
        private readonly RelyingPartyReadGateway $readParties,
        private readonly RoleReadGateway $roles,
    ) {
    }
    /**
     * @param string $relyingParty
     * @param list<ScopeList> $paramMap
     */
    #[Override]
    public function registerScopes(string $relyingParty, array $paramMap): void
    {
        $party = $this->parties->findOneForUpdateByCode($relyingParty);
        if ($party === null) {
            return;
        }
        $json = json_decode($party->getScopes(), true);
        $data = is_array($json) ? $json : [];
        foreach ($paramMap as $item) {
            if (isset($item->resource->name)) {
                // 'documents' => ['attributes' => [], 'actions' => ['edit', 'delete']]
                if (!isset($data[$item->resource->name])) {
                    $data[$item->resource->name] = [];
                }
                foreach ($item->scopes as $scope) {
                    $data[$item->resource->name][] = $scope->name;
                }
                $data[$item->resource->name] = array_unique($data[$item->resource->name]);
            }
        }
        $att = new RelyingPartyAttributes();
        $att->scopes(json_encode($data));
        $this->parties->update($party, $party->replace($att));
    }

    /**
     * @param string $relyingParty
     * @param list<Property> $paramMap
     */
    #[Override]
    public function registerSchema(string $relyingParty, array $paramMap): void
    {
        $party = $this->parties->findOneForUpdateByCode($relyingParty);
        if ($party === null) {
            return;
        }
        $json = json_decode($party->getSchemas(), true);
        $data = is_array($json) ? $json : [];
        foreach ($paramMap as $item) {
            if (isset($item->resource->name)) {
                if (!isset($data[$item->resource->name])) {
                    $data[$item->resource->name] = [];
                }
                foreach ($item->scopes as $schemas) {
                    $data[$item->resource->name][] = $schemas->name;
                }
                $data[$item->resource->name] = array_unique($data[$item->resource->name]);
            }
        }
        $att = new RelyingPartyAttributes();
        $att->schemas(json_encode($data));
        $this->parties->update($party, $party->replace($att));
    }

    /**
     * @param string $relyingParty
     * @return list<RoleGrant>
     */
    #[Override]
    public function granted(string $relyingParty): array
    {
        $party = $this->readParties->findOneByCode($relyingParty);
        if ($party === null) {
            return [];
        }
        $dsl = $party->getPolicies();
        if (!$dsl) {
            return [];
        }
        $secRoles = $this->roles->list();
        $roles = [];
        $scopes = [];
        $schemas = [];
        foreach ($secRoles as $secRole) {
            $roles[] = $secRole->getName();
        }
        if ($party->getScopes()) {
            $scopes = json_decode($party->getScopes(), true);
        }
        if ($party->getSchemas()) {
            $schemas = json_decode($party->getSchemas(), true);
        }
        $resources = [];
        foreach ($scopes as $name => $scc) {
            $resources[$name]['actions'] = $scc;
        }
        foreach ($schemas as $name => $scc) {
            $resources[$name]['attributes'] = $scc;
        }
        $engine = new PolicyEngine();
        $engine->setRuleSet($this->parseRules($dsl));
        $engine->setRoles($roles);
        $engine->setResources($resources);
        $expand = $engine->expand();
        foreach ($expand as $key => $his) {
            foreach ($his as $res => $info) {
                $expand[$key][$res]['attributes'] = [];
                if (isset($resources[$res]['attributes'])) {
                    foreach ($resources[$res]['attributes'] as $field) {
                        $expand[$key][$res]['attributes'][$field] = [
                            'view' => in_array($field, $expand[$key][$res]['view']) ? true : false,
                            'modify' => in_array($field, $expand[$key][$res]['modify']) ? true : false,
                        ];
                    }
                }
                if (isset($resources[$res]['actions'])) {
                    foreach ($resources[$res]['actions'] as $field) {
                        $expand[$key][$res]['scope'][$field] = in_array($field, $expand[$key][$res]['actions']) ? true : false;
                    }
                }
                unset($expand[$key][$res]['view']);
                unset($expand[$key][$res]['modify']);
                unset($expand[$key][$res]['actions']);
            }
        }
        return $expand;
    }
    private function parseRules(string $dsl): RuleSet
    {
        $parser = new DslParser();
        $array = $parser->parse($dsl);
        return RuleSet::fromArray($array);
    }
}
