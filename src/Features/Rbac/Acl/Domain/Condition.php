<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Rbac\Acl\Domain;

class Condition
{
    public function __construct(
        private readonly array $data
    ) {
    }

    public static function fromArray(array $data): self
    {
        // Normaliza role == "X" en role in ["X"]
        if (isset($data['==']) && isset($data['==']['role'])) {
            $data = ['in' => ['role' => [$data['==']['role']]]];
        }

        // Normaliza role != "X" en role not_in ["X"]
        if (isset($data['!=']) && isset($data['!=']['role'])) {
            $data = ['not_in' => ['role' => [$data['!=']['role']]]];
        }

        // Normaliza role in "X" en array (por si acaso alguien mete solo un valor)
        if (isset($data['in']['role']) && !is_array($data['in']['role'])) {
            $data['in']['role'] = [$data['in']['role']];
        }

        if (isset($data['not_in']['role']) && !is_array($data['not_in']['role'])) {
            $data['not_in']['role'] = [$data['not_in']['role']];
        }

        return new self($data);
    }

    public function toArray(): array
    {
        return $this->data;
    }

    public function matches(string $role): bool
    {
        if (isset($this->data['flag'])) {
            return match ($this->data['flag']) {
                '@everyone'     => true,
                '@authenticated' => $role !== '@anonymous',
                '@anonymous'     => $role === '@anonymous',
                default => false,
            };
        }

        if (isset($this->data['in']['role'])) {
            return in_array($role, $this->data['in']['role'], true);
        }

        if (isset($this->data['not_in']['role'])) {
            return !in_array($role, $this->data['not_in']['role'], true);
        }
        return false;
    }
}
