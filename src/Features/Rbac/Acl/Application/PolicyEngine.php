<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Rbac\Acl\Application;

use Civi\Lughauth\Features\Rbac\Acl\Domain\RuleSet;
use Civi\Lughauth\Features\Rbac\Acl\Domain\MatchRule;

class PolicyEngine
{
    private array $roles = [];
    private RuleSet $ruleSet;
    private array $resources = [];

    public function setRoles(array $roles): void
    {
        $this->roles = $roles;
    }

    public function setRuleSet(RuleSet $ruleSet): void
    {
        $this->ruleSet = $ruleSet;
    }

    public function setResources(array $resources): void
    {
        $this->resources = $resources;
    }

    public function expand(): array
    {
        $result = [];
        $baseRoles = $this->roles;
        $expandedRoles = [];

        foreach ($baseRoles as $role) {
            $effective = $this->getEffectiveRoles($role);

            if (!in_array('@everyone', $effective, true)) {
                $effective[] = '@everyone';
            }

            if ($role === '@anonymous') {
                $effective[] = '@anonymous';
            } else {
                $effective[] = '@authenticated';
            }

            $expandedRoles[$role] = array_unique($effective);
        }

        // Asegurar que los pseudoroles estén presentes también como claves en la salida
        foreach (['@everyone', '@authenticated', '@anonymous'] as $pseudo) {
            if (!array_key_exists($pseudo, $expandedRoles)) {
                if ($pseudo === '@everyone') {
                    $expandedRoles[$pseudo] = ['@everyone'];
                } elseif ($pseudo === '@authenticated') {
                    $expandedRoles[$pseudo] = ['@authenticated', '@everyone'];
                } elseif ($pseudo === '@anonymous') {
                    $expandedRoles[$pseudo] = ['@anonymous', '@everyone'];
                }
            }
        }

        foreach ($expandedRoles as $role => $effectiveRoles) {
            foreach ($this->resources as $resource => $declared) {
                $rulesList = $this->ruleSet->getMatchingResources($resource);
                if (empty($rulesList)) {
                    continue;
                }
                $resRules = array_shift($rulesList);
                foreach ($rulesList as $extra) {
                    $resRules = $resRules->merge($extra);
                }
                if (!$resRules) {
                    continue;
                }
                $viewable = [];
                $editable = [];
                foreach ($declared['attributes'] ?? [] as $field) {
                    $canView = $this->isAllowed(
                        $field,
                        $resRules->getAttributes(),
                        $effectiveRoles,
                        'attributes:view'
                    );
                    $canEdit = $this->isAllowed(
                        $field,
                        $resRules->getAttributes(),
                        $effectiveRoles,
                        'attributes:modify'
                    );
                    if ($canView) {
                        $viewable[] = $field;
                    }
                    if ($canView && $canEdit) {
                        $editable[] = $field;
                    }
                }
                $result[$role][$resource] = [
                    'view' => $viewable,
                    'modify' => $editable,
                ];
            }
        }
        return $result;
    }

    private function getEffectiveRoles(string $role): array
    {
        $r = $this->ruleSet->getRole($role);
        $all = [$role];
        if ($r) {
            foreach ($r->getInherits() as $parent) {
                $all = array_merge($all, $this->getEffectiveRoles($parent));
            }
        }
        return array_unique($all);
    }

    private function isAllowed(
        string $field,
        array $rules,
        array $roles,
        string $type
    ): bool {
        $matching = array_filter($rules, function (MatchRule $rule) use ($field, $roles, $type) {
            if ($rule->getType() !== $type) {
                return false;
            }
            if (!in_array($field, $rule->getItems(), true) && !in_array('*', $rule->getItems(), true)) {
                return false;
            }

            foreach ($roles as $r) {
                if ($rule->getCondition()->matches($r)) {
                    return true;
                }
            }
            return false;
        });

        if (empty($matching)) {
            return false;
        }

        $anyDeny = false;
        $allAllow = true;

        foreach ($matching as $rule) {
            foreach ($roles as $r) {
                if ($rule->getCondition()->matches($r)) {
                    if ($rule->getEffect() === 'deny') {
                        $anyDeny = true;
                    }
                    if ($rule->getEffect() !== 'allow') {
                        $allAllow = false;
                    }
                }
            }
        }
        return !$anyDeny && $allAllow;
    }
}
