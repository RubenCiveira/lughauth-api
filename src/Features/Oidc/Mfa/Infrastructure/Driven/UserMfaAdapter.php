<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Mfa\Infrastructure\Driven;

use Override;
use RobThree\Auth\TwoFactorAuth;
use RobThree\Auth\Providers\Qr\EndroidQrCodeProvider; // if using Endroid
use Civi\Lughauth\Features\Access\Tenant\Domain\Gateway\TenantReadGateway;
use Civi\Lughauth\Features\Access\TenantConfig\Domain\Gateway\TenantConfigReadGateway;
use Civi\Lughauth\Features\Access\User\Domain\Gateway\UserReadGateway;
use Civi\Lughauth\Features\Access\User\Domain\Gateway\UserWriteGateway;
use Civi\Lughauth\Features\Oidc\Mfa\Domain\Gateway\UserMfaRepository;
use Civi\Lughauth\Features\Oidc\Mfa\Domain\PublicLoginMfaBuildResponse;
use Civi\Lughauth\Shared\Exception\NotFoundException;
use Civi\Lughauth\Shared\Security\AesCypherService;

class UserMfaAdapter implements UserMfaRepository
{
    public function __construct(
        private readonly TenantReadGateway $tenants,
        private readonly TenantConfigReadGateway $configs,
        private readonly UserReadGateway $users,
        private readonly UserWriteGateway $usersWriter,
        private readonly AesCypherService $cypher
    ) {
    }

    #[Override]
    public function configurationForNewMfa(string $tenant, string $username): PublicLoginMfaBuildResponse
    {
        $theTenant = $this->tenants->findOneByName($tenant);
        if (!$theTenant) {
            throw new NotFoundException('tenant ' . $tenant);
        }
        $theUser = $this->users->findOneByTenantAndName($theTenant, $username);
        if (!$theUser) {
            throw new NotFoundException('tenant ' . $username);
        }
        $theConfig = $this->configs->findOneByTenant($theTenant);
        $label = $theConfig ? $theConfig->getInnerLabel() : $theTenant->getName() ;
        $delegated = new TwoFactorAuth(new EndroidQrCodeProvider(), $label);
        $seed = $delegated->createSecret();
        $qrCode = $delegated->getQRCodeImageAsDataUri($label, $seed);
        $url = $delegated->getQRText($label, $seed);
        return new PublicLoginMfaBuildResponse(
            seed: $seed,
            message: '',
            image: $qrCode
        );
    }

    #[Override]
    public function verifyOtp(string $tenant, string $username, string $otp): bool
    {
        $theTenant = $this->tenants->findOneByName($tenant);
        if (!$theTenant) {
            throw new NotFoundException('tenant ' . $tenant);
        }
        $theUser = $this->usersWriter->findOneForUpdateByTenantAndName($theTenant, $username);
        if (!$theUser) {
            throw new NotFoundException('tenant ' . $username);
        }
        $delegated = new TwoFactorAuth(new EndroidQrCodeProvider());
        $secret = $theUser->getPlainSecondFactorSeed($this->cypher);
        return $delegated->verifyCode($secret, $otp);
    }
    #[Override]
    public function verifyNewOpt(string $tenant, string $username, string $seed, string $otp): bool
    {
        $delegated = new TwoFactorAuth(new EndroidQrCodeProvider());
        return $delegated->verifyCode($seed, $otp);
    }
    #[Override]
    public function storeSeed(string $tenant, string $username, string $seed): void
    {
        $theTenant = $this->tenants->findOneByName($tenant);
        if (!$theTenant) {
            throw new NotFoundException('tenant ' . $tenant);
        }
        $theUser = $this->usersWriter->findOneForUpdateByTenantAndName($theTenant, $username);
        if (!$theUser) {
            throw new NotFoundException('tenant ' . $username);
        }
        $this->usersWriter->update($theUser, $theUser->setMfaSeed($this->cypher, $seed));
    }
}
