<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\DelegateLogin\Infrastructure\Driven;

use Override;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Value\Random;
use Civi\Lughauth\Shared\Security\AesCypherService;
use Civi\Lughauth\Shared\Exception\NotFoundException;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Domain\Gateway\TenantLoginProviderFilter;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Domain\Gateway\TenantLoginProviderReadGateway;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Domain\TenantLoginProvider;
use Civi\Lughauth\Features\Access\User\Domain\Gateway\UserWriteGateway;
use Civi\Lughauth\Features\Access\User\Domain\User;
use Civi\Lughauth\Features\Access\User\Domain\UserAttributes;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserPasswordVO;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Oidc\Common\Infrastructure\Driven\UserLoaderAdapter;
use Civi\Lughauth\Features\Oidc\DelegateLogin\Domain\DelegatedLoginProvider;
use Civi\Lughauth\Features\Oidc\DelegateLogin\Domain\DelegatedUserData;
use Civi\Lughauth\Features\Oidc\DelegateLogin\Domain\Gateway\DelegateLoginRepository;
use Civi\Lughauth\Features\Oidc\DelegateLogin\Infrastructure\Provider\GoogleOAuthProvider;
use Civi\Lughauth\Features\Oidc\User\Domain\Gateway\LoginGateway;

class DelegateLoginAdapter implements DelegateLoginRepository
{
    private readonly string $clientId;
    private readonly string $secretId;

    public function __construct(
        private readonly AppConfig $conf,
        private readonly Context $context,
        private readonly UserLoaderAdapter $userLoader,
        private readonly UserWriteGateway $users,
        private readonly LoginGateway $login,
        private readonly AesCypherService $cypher,
        private readonly TenantLoginProviderReadGateway $loginProviders
    ) {
        $this->clientId = $conf->get('google.client.id');
        $this->secretId = $conf->get('google.secret');
    }

    #[Override]
    public function save(string $tenant, AuthenticationRequest $client, DelegatedUserData $user, string $providerId): AuthenticationResult
    {
        $theTenant = $this->userLoader->checkTenant($tenant, '-');
        $filter = new TenantLoginProviderFilter(
            uids: [ $providerId ],
            tenant: $theTenant
        );
        if (!$existent = $this->loginProviders->retrieve($filter)) {
            throw new NotFoundException('No provider ' . $providerId);
        }
        $prev = $this->users->findOneForUpdateByTenantAndName(
            $theTenant,
            $user->email
        );
        if (!$prev) {
            $enabled = $existent->getUsersEnabledByDefault();
            $attr = new UserAttributes();
            $attr->uid(Random::comb());
            $attr->name($user->email);
            $attr->provider($existent->getSource());
            $attr->tenant($theTenant);
            $attr->password(UserPasswordVO::fromPlainText($this->cypher, Random::password()));
            $prev = $this->users->create(User::create($attr));
            if ($enabled) {
                $prev = $this->users->update($prev, $prev->enable());
            }
        }
        $challenges = new AuthorizedChalleges();
        $challenges->username = $user->email;
        $this->login->fillPreAuthenticated($tenant, $client, $challenges);
        // Si no existe lo creo
        return new AuthenticationResult(
            valid: true,
            id: $user->email,
            tenant: $tenant,
            tenantName: 'tenantName',
            scope: $client->scope,
            audiences: $client->audiences,
            roles: ['rol-1'],
            groups: ['group-1']
        );
    }
    #[Override]
    public function providers(string $tenant): array
    {
        // La lista de registros de google.
        $providers = [];
        $theTenant = $this->userLoader->checkTenant($tenant, '-');
        $filter = new TenantLoginProviderFilter(
            tenant: $theTenant
        );
        $all = $this->loginProviders->list($filter);
        foreach ($all as $a) {
            if ($provider = $this->loadProvider($a)) {
                $providers[] = $provider;
            }
        }
        return $providers;
    }
    #[Override]
    public function getProvider(string $tenant, string $id): DelegatedLoginProvider
    {
        $theTenant = $this->userLoader->checkTenant($tenant, '-');
        $filter = new TenantLoginProviderFilter(
            uids: [ $id ],
            tenant: $theTenant
        );
        if ($existent = $this->loginProviders->retrieve($filter)) {
            if ($provider = $this->loadProvider($existent)) {
                return $provider;
            }
        }
        throw new NotFoundException('');
    }

    private function loadProvider(TenantLoginProvider $provider): ?DelegatedLoginProvider
    {
        if( $provider->getDisabled() ) {
            return null;
        } else if ($provider->getSource() == 'GOOGLE') {
            return
                new GoogleOAuthProvider(
                    $this->conf,
                    $this->context,
                    $provider->uid(),
                    $provider->getPublicKey(),
                    $provider->getPrivateKey()
                );
        } else {
            return null;
        }
    }
}
