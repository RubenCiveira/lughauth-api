<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Common\Infrastructure\Driver\Rest;

use Civi\Lughauth\Shared\Context;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

class OpenIdConfigurationController
{
    public function __construct(private readonly Context $context)
    {

    }
    public function get(ServerRequestInterface $request, ResponseInterface $response, array $args): ResponseInterface
    {

        $tenant = $args['tenant'];
        // Extraer la base URL de la solicitud
        $baseUrl = $this->context->getBaseUrl() . '/oauth';

        // TODO: obtener de configuración la url externa.

        // Lógica para obtener la configuración del tenant irá aquí (simulada más adelante).
        // Deberás implementar la lógica para obtener los datos del tenant desde una base de datos o configuración.
        // Construir las URLs utilizando la base URL del servidor
        $mtlsEndpointAliases = [
            "token_endpoint" => "$baseUrl/openid/$tenant/token",
            "revocation_endpoint" => "$baseUrl/openid/$tenant/revoke",
            "introspection_endpoint" => "$baseUrl/openid/$tenant/introspect",
            "device_authorization_endpoint" => "$baseUrl/openid/$tenant/device",
            "registration_endpoint" => "$baseUrl/openid/$tenant/register",
            "userinfo_endpoint" => "$baseUrl/openid/$tenant/userinfo",
            "pushed_authorization_request_endpoint" => "$baseUrl/openid/$tenant/par",
            "backchannel_authentication_endpoint" => "$baseUrl/openid/$tenant/backchannel"
        ];

        $data = [
            "issuer" => "$baseUrl/openid/$tenant",
            "authorization_endpoint" => "$baseUrl/openid/$tenant/authorize",
            "token_endpoint" => "$baseUrl/openid/$tenant/token",
            "introspection_endpoint" => "$baseUrl/openid/$tenant/introspect",
            "userinfo_endpoint" => "$baseUrl/openid/$tenant/userinfo",
            "end_session_endpoint" => "$baseUrl/openid/$tenant/logout",
            "frontchannel_logout_session_supported" => true,
            "frontchannel_logout_supported" => true,
            "jwks_uri" => "$baseUrl/openid/$tenant/jwks",
            "check_session_iframe" => "$baseUrl/openid/$tenant/check-session",
            "grant_types_supported" => ['authorization_code', 'implicit', 'refresh_token', 'client_credentials'],
            "acr_values_supported" => ['urn:mace:incommon:iap:silver'],
            "response_types_supported" => ['code', 'token', 'id_token'],
            "subject_types_supported" => ['public', 'pairwise'],
            "id_token_signing_alg_values_supported" => ['RS256'],
            "id_token_encryption_alg_values_supported" => ['RSA-OAEP'],
            "id_token_encryption_enc_values_supported" => ['A256GCM'],
            "userinfo_signing_alg_values_supported" => ['RS256'],
            "userinfo_encryption_alg_values_supported" => ['RSA-OAEP'],
            "userinfo_encryption_enc_values_supported" => ['A256GCM'],
            "request_object_signing_alg_values_supported" => ['RS256'],
            "request_object_encryption_alg_values_supported" => ['RSA-OAEP'],
            "request_object_encryption_enc_values_supported" => ['A256GCM'],
            "response_modes_supported" => ['query', 'fragment', 'form_post'],
            "registration_endpoint" => "$baseUrl/openid/$tenant/register",
            "token_endpoint_auth_methods_supported" => ['client_secret_basic', 'client_secret_post'],
            "token_endpoint_auth_signing_alg_values_supported" => ['RS256'],
            "introspection_endpoint_auth_methods_supported" => ['client_secret_basic'],
            "introspection_endpoint_auth_signing_alg_values_supported" => ['RS256'],
            "authorization_signing_alg_values_supported" => ['RS256'],
            "authorization_encryption_alg_values_supported" => ['RSA-OAEP'],
            "authorization_encryption_enc_values_supported" => ['A256GCM'],
            "claims_supported" => ['sub', 'iss', 'name', 'email'],
            "claim_types_supported" => ['normal'],
            "claims_parameter_supported" => true,
            "scopes_supported" => ['openid', 'profile', 'email'],
            "request_parameter_supported" => true,
            "request_uri_parameter_supported" => true,
            "require_request_uri_registration" => true,
            "code_challenge_methods_supported" => ['plain', 'S256'],
            "tls_client_certificate_bound_access_tokens" => false,
            "revocation_endpoint" => "$baseUrl/openid/$tenant/revoke",
            "revocation_endpoint_auth_methods_supported" => ['client_secret_basic'],
            "revocation_endpoint_auth_signing_alg_values_supported" => ['RS256'],
            "backchannel_logout_supported" => true,
            "backchannel_logout_session_supported" => true,
            "device_authorization_endpoint" => "$baseUrl/openid/$tenant/device",
            "backchannel_token_delivery_modes_supported" => ['poll', 'ping'],
            "backchannel_authentication_endpoint" => "$baseUrl/openid/$tenant/backchannel",
            "backchannel_authentication_request_signing_alg_values_supported" => ['RS256'],
            "require_pushed_authorization_requests" => true,
            "pushed_authorization_request_endpoint" => "$baseUrl/openid/$tenant/par",
            "mtls_endpoint_aliases" => $mtlsEndpointAliases,
            "authorization_response_iss_parameter_supported" => true
        ];
        $response->getBody()->write(json_encode($data));
        return $response->withHeader('Content-Type', 'application/json');
    }
}
