<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Common\Application\Usecase;

use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Value\Random;
use Civi\Lughauth\Shared\Security\AesCypherService;
use Civi\Lughauth\Shared\Infrastructure\Sql\SqlTemplate;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\Gateway\RelyingPartyWriteGateway;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\RelyingParty;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\RelyingPartyAttributes;
use Civi\Lughauth\Features\Access\Role\Domain\Gateway\RoleWriteGateway;
use Civi\Lughauth\Features\Access\Role\Domain\Role;
use Civi\Lughauth\Features\Access\Role\Domain\RoleAttributes;
use Civi\Lughauth\Features\Access\Role\Domain\RoleRef;
use Civi\Lughauth\Features\Access\Tenant\Domain\Gateway\TenantWriteGateway;
use Civi\Lughauth\Features\Access\Tenant\Domain\Tenant;
use Civi\Lughauth\Features\Access\Tenant\Domain\TenantAttributes;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\Gateway\TrustedClientWriteGateway;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\TrustedClient;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\TrustedClientAttributes;
use Civi\Lughauth\Features\Access\User\Domain\Gateway\UserWriteGateway;
use Civi\Lughauth\Features\Access\User\Domain\User;
use Civi\Lughauth\Features\Access\User\Domain\UserAttributes;
use Civi\Lughauth\Features\Access\User\Domain\UserRef;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserPasswordVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\Gateway\UserIdentityWriteGateway;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\UserIdentity;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\UserIdentityAttributes;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesItem;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesListRef;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesRoleVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesUidVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesVersionVO;
use Civi\Lughauth\Features\Access\ApiKeyClient\Domain\ApiKeyClient;
use Civi\Lughauth\Features\Access\ApiKeyClient\Domain\ApiKeyClientAttributes;
use Civi\Lughauth\Features\Access\ApiKeyClient\Domain\Gateway\ApiKeyClientWriteGateway;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\ValueObject\TrustedClientAllowedRedirectsItem;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\ValueObject\TrustedClientAllowedRedirectsUidVO;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\ValueObject\TrustedClientAllowedRedirectsUrlVO;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\ValueObject\TrustedClientAllowedRedirectsVersionVO;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\ValueObject\TrustedClientSecretOauthVO;

class InstallUsecase
{
    public function __construct(
        private readonly Context $context,
        private readonly SqlTemplate $template,
        private readonly AesCypherService $cypher,
        private readonly RelyingPartyWriteGateway $createReling,
        private readonly TrustedClientWriteGateway $createTruted,
        private readonly TenantWriteGateway $createTenant,
        private readonly RoleWriteGateway $createRole,
        private readonly UserWriteGateway $createUser,
        private readonly UserIdentityWriteGateway $createIdentity,
        private readonly ApiKeyClientWriteGateway $apiKeys,
    ) {
    }

    public function install()
    {
        try {
            $this->template->begin();
            $this->init('sesamo');
            $this->template->commit();
        } finally {
            $this->template->close();
        }
    }

    private function init(string $password)
    {
        $party = new RelyingPartyAttributes();
        $party->uid(Random::comb());
        $party->apiKey('1111');
        $party->code('phylax-api');
        $party->enabled(true);
        $created = $this->createReling->create(RelyingParty::create($party));
        $this->createReling->update($created, $created->enable());

        $localhost = new TrustedClientAllowedRedirectsItem(
            uid: TrustedClientAllowedRedirectsUidVO::from(Random::comb()),
            url: TrustedClientAllowedRedirectsUrlVO::from('http://localhost:4200/*'),
            version: TrustedClientAllowedRedirectsVersionVO::from(0)
        );

        $trust = new TrustedClientAttributes();
        $trust->uid(Random::comb());
        $trust->code('phylax-ui');
        $trust->secretOauth(TrustedClientSecretOauthVO::fromPlainText($this->cypher, '123456'));
        $trust->publicAllow(true);
        $trust->allowedRedirects([$localhost]);
        $trust->enabled(true);
        $created = $this->createTruted->create(TrustedClient::create($trust));
        $this->createTruted->update($created, $created->enable());

        $admin = new RoleAttributes();
        $admin->uid(Random::comb());
        $admin->name("ADMIN");
        $admin = $this->createRole->create(Role::create($admin));

        $root = new RoleAttributes();
        $root->uid(Random::comb());
        $root->name("ROOT");
        $root = $this->createRole->create(Role::create($root));

        $tenant = new TenantAttributes();
        $tenant->uid(Random::comb());
        $tenant->root(true);
        $tenant->name("main");
        $tenant->domain("main");
        $createdTenant = $this->createTenant->create(Tenant::create($tenant));
        $createdTenant = $this->createTenant->update($createdTenant, $createdTenant->enable());

        $user = new UserAttributes();
        $user->uid(Random::comb());
        $user->name("ROOT");
        $user->tenant($createdTenant);
        $user->password(UserPasswordVO::fromPlainText($this->cypher, $password));
        $user->enabled(true);
        $created = $this->createUser->create(User::create($user));
        $this->createUser->update($created, $created->enable());

        $roleAdmin = new UserIdentityRolesItem(
            uid: UserIdentityRolesUidVO::from(Random::comb()),
            role: UserIdentityRolesRoleVO::from(new RoleRef($admin->uid())),
            version: UserIdentityRolesVersionVO::from(0)
        );
        $roleRoot = new UserIdentityRolesItem(
            uid: UserIdentityRolesUidVO::from(Random::comb()),
            role: UserIdentityRolesRoleVO::from(new RoleRef($root->uid())),
            version: UserIdentityRolesVersionVO::from(0)
        );

        $identity = new UserIdentityAttributes();
        $identity->uid(Random::comb());
        $identity->user(new UserRef($user->getUid()));
        $identity->roles(new UserIdentityRolesListRef($roleAdmin, $roleRoot));
        $this->createIdentity->create(UserIdentity::create($identity));

        $apiKey = new ApiKeyClientAttributes();
        $apiKey->uid(Random::comb());
        $apiKey->code('Initial collector');
        $apiKey->key('hcaik_01jtteh99vbsv4qrj22trvh3wg35g1n4tgkcxzgqv0034y2cby7dceaf43');
        $apiKey->scopes('collect');
        $created = $this->apiKeys->create(ApiKeyClient::create($apiKey));
        $this->apiKeys->update($created, $created->enable());

        $apiKey = new ApiKeyClientAttributes();
        $apiKey->uid(Random::comb());
        $apiKey->code('Initial syn client');
        $apiKey->key('sck_01jtteh99vbsv4qrj22trvh3wg35g2n3tgkcxngqv0034y2cby7dceaf43');
        $apiKey->scopes('sync');
        $created = $this->apiKeys->create(ApiKeyClient::create($apiKey));
        $this->apiKeys->update($created, $created->enable());

    }

}
