<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Forms;

use Override;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Oidc\User\Domain\PublicLoginAuthResponse;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\DecorateHtml;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\HtmlSecurer;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\PublicLogin;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\PublicMfa;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\Exception\LoginException;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;
use Civi\Lughauth\Shared\Infrastructure\Translation\MessageProvider;

class NewMfaForm implements AuthorizationForm
{
    public function __construct(
        private readonly MessageProvider $messages,
        private readonly PublicLogin $publicLogin,
        private readonly PublicMfa $publicMfa,
        private readonly DecorateHtml $decorator,
        private readonly HtmlSecurer $securer
    ) {
    }

    #[Override]
    public function step(): string
    {
        return 'build-mfa';
    }
    #[Override]
    public function handle(?AuthenticationResult $pe): bool
    {
        return $pe?->error == AuthenticationResult::ERR_NEW_MFA_REQUIRED;
    }
    #[Override]
    public function paint(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $locale = '';

        $token = $this->publicMfa->configurationForNewMfa($tenant, $challenges->username);

        $js = $this->securer->configureScripts([
            $this->securer->addSign("sign"),
            $this->securer->addSign("bsign"),
            $this->securer->focusOn("mfa_code"),
        ]);
        $translator = $this->messages->messages('forms', $locale, __DIR__ . '/../../Translations');

        $title = $translator->get("newmfa.title");
        $error = $pe?->errorMessage
            ? $translator->get("newmfa.error-format", [$error = $translator->get('error.' . strtolower($pe?->errorMessage))])
            : false;
        $help = $translator->get("newmfa.help");
        $code = $translator->get("newmfa.code");
        $send = $translator->get("newmfa.send");

        $backText = $translator->get(
            "newmfa.back-text",
            ["<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("newmfa.back-label") . "\" />"]
        );

        $error = $error ? '<p class="error">' . $error . '</p>' : '';
        $seed = $this->securer->encrypt($token->seed);
        $message = $token->message ? "<h2>" . $token->message . "</h2>" : "";
        $image = $token->image ? "<img src=\"" . $token->image . "\" />" : "";

        $response->getBody()->write($this->decorator->getFullPage(
            $request,
            'New mfa',
            $js . <<<HTML
                    <h1>{$title}</h1>
                    <p>{$help}</p>
                    {$error}
                    {$image}
                    {$message}
                    <form method="POST">
                        <input type="hidden" name="csid" id="sign" />
                        <input type="hidden" name="seed" value="{$seed}" />
                        <input type="hidden" name="step" value="build-mfa" />
                        <label>{$code}
                            <input type="text" name="mfa_code" id="mfa_code" value="" />
                        </label>
                        <input class="primary-button" type="submit" value="{$send}" />
                    </form>
                    <form method="POST">
                        <input type="hidden" name="csid" id="bsign" />
                        <input type="hidden" name="step" value="build-mfa" />
                        <input class="inline" type="submit" value="RESET" />
                    </form>
                    <form method="POST">
                        <input type="hidden" name="step" value="start" />
                        {$backText}
                    </form>
                HTML,
            $locale
        ));
        return $response;
    }

    #[Override]
    public function autenticate(
        AuthenticationRequest $request,
        string $tenant,
        string $issuer,
        string $csid,
        string $state,
        string $nonce,
        AuthorizedChalleges $challenges,
        mixed $body
    ): PublicLoginAuthResponse {
        $seed = isset($body["seed"]) ? $this->securer->decrypt($body["seed"]) : '';
        $code = $body['mfa_code'] ?? '';
        if ($seed && $this->publicMfa->verifyNewOpt($tenant, $challenges->username, $seed, $code)) {
            $challenges->mfa = true;
            return $this->publicLogin->preAutenticate($request, $challenges, $tenant, $issuer, $csid, $state, $nonce);
        } else {
            throw new LoginException(auth: AuthenticationResult::newMfaRequired('wrong_auth_code'));
        }
    }
}
