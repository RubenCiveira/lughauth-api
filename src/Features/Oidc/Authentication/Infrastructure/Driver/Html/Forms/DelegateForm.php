<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Forms;

use Override;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Oidc\User\Domain\PublicLoginAuthResponse;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\DecorateHtml;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\HtmlSecurer;
use Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services\PublicLogin;
use Civi\Lughauth\Features\Oidc\DelegateLogin\Application\DelegateLogin;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;

class DelegateForm implements AuthorizationForm
{
    public function __construct(
        private readonly DelegateLogin $delegated,
        private readonly PublicLogin $publicLogin,
        private readonly DecorateHtml $decorator,
        private readonly HtmlSecurer $securer
    ) {
    }

    #[Override]
    public function step(): string
    {
        return 'delegated-login';
    }
    #[Override]
    public function handle(?AuthenticationResult $pe): bool
    {
        return false;
    }
    #[Override]
    public function paint(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $body = $request->getParsedBody();
        $params = $request->getQueryParams();
        $route = '/openid/-/delegated/verify';
        if (isset($params['provider-data']) && isset($params['provider'])) {
            $js = $this->securer->configureScripts([
                $this->securer->addSign("sign"),
                $this->securer->autoSubmit("login")
            ]);
            $html = $this->decorator->getFullPage(
                $request,
                'Login',
                $js . <<<HTML
                    <form id="login" method="POST">
                        <input type="hidden" name="csid" id="sign" />
                        <input type="hidden" name="provider" value="{$params['provider']}" />
                        <input type="hidden" name="provider-data" value="{$params['provider-data']}" />
                        <input type="hidden" name="step" value="delegated-login" />
                    </form>
                HTML,
                'es'
            );
            $response->getBody()->write($html);
            return $response;
        } else {
            $target = $this->delegated->getTargetEndpoint($route, $tenant, $body['delegated-provider'], $request->getQueryParams());
            if ($target->method == 'GET') {
                return $response->withStatus(302)->withHeader('Location', $target->url);
            } else {
                $response->getBody()->write(
                    $this->decorator->getFullPage(
                        $request,
                        'Delegated login',
                        "<h1>Tengo que definir el mÃ©todo de url para {$target->method}</h1>",
                        $locale
                    )
                );
                return $response;
            }
        }
    }

    #[Override]
    public function autenticate(
        AuthenticationRequest $request,
        string $tenant,
        string $issuer,
        string $csid,
        string $state,
        string $nonce,
        AuthorizedChalleges $challenges,
        mixed $body
    ): PublicLoginAuthResponse {
        $route = '/openid/-/delegated/verify';
        $result = $this->delegated->validateRedirection($route, $body['provider'], $body['provider-data'], $tenant, $request);
        if ($result && $result->valid) {
            $challenges->username = $result->id;
            return $this->publicLogin->preAutenticate($request, $challenges, $tenant, $issuer, $csid, $state, $nonce);
        } else {
            throw new UnauthorizedException('-');
        }
    }

}
