<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Html\Services;

use RecursiveIteratorIterator;
use RecursiveDirectoryIterator;
use Psr\Http\Message\RequestInterface;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Infrastructure\View\TwigBuilder;

class DecorateHtml
{
    private readonly string $assetsPath;

    public function __construct(
        AppConfig $config,
        Context $context,
        private readonly TwigBuilder $builder
    ) {
        $this->assetsPath = $config->get('oidc.theme.path', $context->getBaseUrl() . '/');
    }

    public function getFullPage(RequestInterface $request, string $title, string $innerContent, string $locale): string
    {
        $usedTheme = 'corporate';
        $srcDir = __DIR__ . "/../Themes/{$usedTheme}/";
        $targetDir = realpath('.') . "/.assets/oidc/{$usedTheme}";
        $this->dumpTheme($srcDir, $targetDir);
        // Index vars.
        $theme = "{$this->assetsPath}.assets/oidc/{$usedTheme}";
        $callback = require $srcDir . '/index.php';
        return $callback($theme, $title, $innerContent, $locale);
    }

    private function dumpTheme(string $srcDir, string $targetDir)
    {
        $allowedExtensions = ['html', 'js', 'css', 'png', 'jpg', 'jpeg', 'webp']; // aÃ±ade las que necesites

        if (!is_dir($targetDir)) {
            mkdir($targetDir, 0777, true);
        }

        $iterator = new RecursiveIteratorIterator(
            new RecursiveDirectoryIterator($srcDir, RecursiveDirectoryIterator::SKIP_DOTS),
            RecursiveIteratorIterator::SELF_FIRST
        );

        foreach ($iterator as $item) {
            $relativePath = substr($item->getPathname(), strlen($srcDir));
            $destPath = $targetDir . DIRECTORY_SEPARATOR . $relativePath;

            if ($item->isDir()) {
                if (!is_dir($destPath)) {
                    mkdir($destPath, 0777, true);
                }
            } else {
                $ext = pathinfo($item->getFilename(), PATHINFO_EXTENSION);
                if (in_array($ext, $allowedExtensions)) {
                    copy($item->getPathname(), $destPath);
                }
            }
        }
    }
}
