<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Authentication\Infrastructure\Driver\Rest;

use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Oidc\Authentication\Application\TokenGranter\TokenGranterMediator;
use Civi\Lughauth\Features\Oidc\Client\Domain\Gateway\ClientStoreGateway;
use Civi\Lughauth\Features\Oidc\Key\Domain\KeysManagerService;
use Civi\Lughauth\Features\Oidc\Session\Domain\Gateway\TemporalKeysGateway;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

class TokenController
{
    public function __construct(
        private readonly Context $context,
        private readonly TokenGranterMediator $granter,
        private readonly ClientStoreGateway $clientDataGateway,
        private readonly TemporalKeysGateway $temporals,
        private readonly KeysManagerService $manager
    ) {
    }

    public function post(ServerRequestInterface $request, ResponseInterface $response, array $args): ResponseInterface
    {
        $tenant = $args['tenant'];
        $params = $request->getParsedBody();
        // Get client data
        $withRefresh = true;
        $grant = $params['grant_type'] ?? '';
        if ("authorization_code" == $grant) {
            $code = $this->temporals->retrieveTemporalAuthCode($params['code'] ?? '');
            if (!$code) {
                throw new UnauthorizedException("Unkonw code");
            }
            $client = $code->client;
            $auth = $code->data;
            $withRefresh = false;
            $identity = ['nonce' => $code->nonce ];
        } else {
            if (!isset($_SERVER['PHP_AUTH_USER']) || !isset($_SERVER['PHP_AUTH_PW'])) {
                throw new UnauthorizedException(message: 'Unauthorized.');
            }
            $client = $this->clientDataGateway->clientData($_SERVER['PHP_AUTH_USER'], $_SERVER['PHP_AUTH_PW']);
            if (!$client) {
                throw new UnauthorizedException(message: 'Unauthorized.');
            }
            if (false === array_search($grant, $client->grants)) {
                throw new UnauthorizedException(message: 'Unauthorized.');
            }
            $audiences = isset($params['audience']) ? explode(",", $params['audience']) : [];
            $auth = $this->granter->autenticate(
                $grant,
                $tenant,
                new AuthenticationRequest($client, "", "", null, [$client->id, ...$audiences]),
                $params
            );
            $identity = [];
        }
        if (!$auth->valid) {
            throw new UnauthorizedException("No auth");
        }
        $issuer = $this->context->getBaseUrl().'/oauth/openid/'. $tenant;
        $data = [
            'aud' => $this->tokenAudiences($client->id, $auth->audiences),
            'azp' => $client->id,
            'iss' => $issuer,
            'sub' => $auth->id,
            'tenant' => $auth->tenant,
            'scope' => $auth->scope,
            'roles' => $auth->roles,
            'groups' => $auth->groups
        ];
        $identity = [...$data, ...$identity];
        $expiration = new \DateInterval("PT10M");
        $now = new \DateTimeImmutable();
        $expires = $now->add($expiration);
        $data = [
            'token_type' => 'Bearer',
            'expires_in' => $expires->getTimestamp() - $now->getTimestamp(),
            'id_token' => $this->manager->sign($tenant, $identity, $expiration),
            'access_token' => $this->manager->sign($tenant, array_merge($data, [
                // https://www.iana.org/assignments/jwt/jwt.xhtml
                'scope' => $auth->scope,
                'roles' => $auth->roles,
                'groups' => $auth->groups
            ]), $expiration),
        ];
        if ($withRefresh) {
            $data['refresh_token'] = $this->manager->sign($tenant, array_merge($data, ['scope' => ['refresh'] ]), new \DateInterval("PT10H"));
        }
        $response->getBody()->write(json_encode($data));
        return $response->withHeader('Content-Type', 'application/json');
    }

    private function tokenAudiences($clientId, $audiences)
    {
        $aud = array_values(array_unique([$clientId, ...$audiences ?? []]));
        return count($aud) == 1 ? $aud[0] : $aud;
    }
}
