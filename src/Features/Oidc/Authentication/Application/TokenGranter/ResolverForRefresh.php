<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Oidc\Authentication\Application\TokenGranter;

use Override;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Oidc\Key\Domain\KeysManagerService;
use Civi\Lughauth\Features\Oidc\User\Application\Usecase\LoginUsecase;
use Jose\Bundle\JoseFramework\DependencyInjection\Source\KeyManagement\KeyManagementSource;

class ResolverForRefresh implements TokenGranterStrategy
{
    public function __construct(
        private readonly LoginUsecase $userLoginGateway,
        private readonly KeysManagerService $manager
    ) {

    }

    #[Override]
    public function canHandle(string $grantType, array $params): bool
    {
        return 'refresh_token' === $grantType;
    }

    #[Override]
    public function autenticate(string $tenant, AuthenticationRequest $client, array $params): AuthenticationResult
    {
        $token = $params['refresh_token'];
        $key = $this->manager->verifiedKeypass($tenant, $token);
        $challenges = new AuthorizedChalleges();
        $challenges->session = true;
        $challenges->username = $key;
        return $this->userLoginGateway->fillPreAuthenticated($tenant, $client, $challenges);
    }
}
