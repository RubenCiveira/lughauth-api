<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Rcab\Resouce\Infrastructure\Driven;

use Psr\Http\Message\ResponseInterface ;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Features\Rcab\Resource\Domain\Scope;
use Civi\Lughauth\Features\Rcab\Resource\Domain\ScopeKind;
use Civi\Lughauth\Features\Rcab\Resource\Domain\ScopeList;
use Civi\Lughauth\Features\Rcab\Resource\Domain\Resource;
use Civi\Lughauth\Features\Rcab\Resource\Domain\Property;
use Civi\Lughauth\Features\Rcab\Resource\Domain\Gateway\PartyVerifierGateway;
use Civi\Lughauth\Features\Rcab\Resource\Domain\Gateway\RbacStoreGateway;

class ResourceRegister
{
    public function __construct(private readonly PartyVerifierGateway $verifier, private readonly RbacStoreGateway $schemaStore)
    {
    }
    public function registerScopes(ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $apiKey = $request->getHeaderLine('x-api-Key');
        $json = json_decode((string) $request->getBody(), true);

        if (!is_array($json)) {
            return $this->badRequest($response, 'Invalid JSON input.');
        }

        $trust = $this->verifier->findOptional($apiKey);
        if ($trust === null) {
            return $this->forbidden($response);
        }

        try {
            $scopes = array_map([$this, 'hydrateScopeList'], $json);
            $this->schemaStore->registerScopes($trust, $scopes);
        } catch (\Throwable $e) {
            return $this->badRequest($response, $e->getMessage());
        }

        return $response->withStatus(204);
    }

    public function registerSchemas(ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $apiKey = $request->getHeaderLine('API-Key');
        $json = json_decode((string) $request->getBody(), true);

        if (!is_array($json)) {
            return $this->badRequest($response, 'Invalid JSON input.');
        }

        $trust = $this->verifier->findOptional($apiKey);
        if ($trust === null) {
            return $this->forbidden($response);
        }

        try {
            $properties = array_map(
                fn (array $item) => new Property($item['name'], $item['description']),
                $json
            );
            $this->schemaStore->registerSchema($trust, $properties);
        } catch (\Throwable $e) {
            return $this->badRequest($response, $e->getMessage());
        }

        return $response->withStatus(204);
    }

    private function hydrateScopeList(array $data): ScopeList
    {
        if (!isset($data['resource'], $data['scopes']) || !is_array($data['scopes'])) {
            throw new \InvalidArgumentException("ScopeList must include 'resource' and 'scopes'.");
        }

        $resource = new Resource(
            $data['resource']['name'] ?? throw new \InvalidArgumentException("Missing resource name."),
            $data['resource']['description'] ?? ''
        );

        $scopes = array_map(function (array $scopeData): Scope {
            return new Scope(
                $scopeData['name'] ?? throw new \InvalidArgumentException("Missing scope name."),
                $scopeData['description'] ?? '',
                ScopeKind::from($scopeData['kind'] ?? throw new \InvalidArgumentException("Missing scope kind."))
            );
        }, $data['scopes']);

        return new ScopeList($resource, $scopes);
    }

    private function forbidden(ResponseInterface $response): ResponseInterface
    {
        $response->getBody()->write(json_encode(['error' => 'Client not allowed.']));
        return $response->withStatus(403)->withHeader('Content-Type', 'application/json');
    }

    private function badRequest(ResponseInterface $response, string $message): ResponseInterface
    {
        $response->getBody()->write(json_encode(['error' => $message]));
        return $response->withStatus(400)->withHeader('Content-Type', 'application/json');
    }
}
