<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Test\Plan\PlanTenant\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Infrastructure\Driver\Rest\PlanTenantAllowController;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Infrastructure\Driver\Rest\PlanTenantListController;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Infrastructure\Driver\Rest\PlanTenantRetrieveController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Application\Usecase\Retrieve\PlanTenantRetrieveAllowDecision;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Application\Usecase\List\PlanTenantListAllowDecision;
use Civi\Lughauth\Features\Test\Plan\PlanTenant\Infrastructure\Driven\PlanTenantChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class PlanTenantPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/plan/tenants', [$this, 'setRoutesForPlanTenant']);
        $app->group('/api/me/acl/plan/tenants', [$this, 'setRoutesForPlanTenantAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(PlanTenantRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(PlanTenantListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, PlanTenantChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("plan-tenant", "list", "READ");
            $handler->registerResourceAction("plan-tenant", "retrieve", "READ");

            $handler->registerResourceAttribute("plan-tenant", "name", "MANAGE");
            $handler->registerResourceAttribute("plan-tenant", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForPlanTenantAcl(RouteCollectorProxy $planTenantGroup)
    {
        $planTenantGroup->get('', [PlanTenantAllowController::class, 'genericAllow']);
        $planTenantGroup->get('/{uid}', [PlanTenantAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForPlanTenant(RouteCollectorProxy $planTenantGroup)
    {
        $planTenantGroup->get('', [PlanTenantListController::class, 'list']);
        $planTenantGroup->get('/{uid}', [PlanTenantRetrieveController::class, 'retrieve']);
    }
}
