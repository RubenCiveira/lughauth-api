<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain;

use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeUidVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeUserVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeUserAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeTempSecondFactorSeedVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeTempSecondFactorSeedAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeTempSecondFactorSeedExpirationVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeTempSecondFactorSeedExpirationAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeFailedLoginAttemptsVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeFailedLoginAttemptsAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeRegisterCodeVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeRegisterCodeAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeRegisterCodeUrlVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeRegisterCodeUrlAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeRegisterCodeExpirationVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeRegisterCodeExpirationAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeRecoveryCodeVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeRecoveryCodeAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeRecoveryCodeExpirationVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeRecoveryCodeExpirationAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\UserAccessTemporalCodeVersionVO;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\ValueObject\Accesor\UserAccessTemporalCodeVersionAccesor;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Formula\FailedLoginAttemptsCalculator;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeCreateEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeUpdateEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeDeleteEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeMarkLoginFailEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeMarkLoginBlockEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeMarkLoginOkEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeGenerateMfaTemporalCodeEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeResetMfaTemporalCodeEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeGeneratedRegisterVerificationEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeResetRegisterVerificationEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeGeneratePasswordRecoverEvent;
use Civi\Lughauth\Features\Access\UserAccessTemporalCode\Domain\Event\UserAccessTemporalCodeResetPasswordRecoverEvent;
use Civi\Lughauth\Features\Access\User\Domain\UserRef;
use Civi\Lughauth\Shared\Security\AesCypherService;

class UserAccessTemporalCode extends UserAccessTemporalCodeRef
{
    use UserAccessTemporalCodeUserAccesor;
    use UserAccessTemporalCodeTempSecondFactorSeedAccesor;
    use UserAccessTemporalCodeTempSecondFactorSeedExpirationAccesor;
    use UserAccessTemporalCodeFailedLoginAttemptsAccesor;
    use UserAccessTemporalCodeRegisterCodeAccesor;
    use UserAccessTemporalCodeRegisterCodeUrlAccesor;
    use UserAccessTemporalCodeRegisterCodeExpirationAccesor;
    use UserAccessTemporalCodeRecoveryCodeAccesor;
    use UserAccessTemporalCodeRecoveryCodeExpirationAccesor;
    use UserAccessTemporalCodeVersionAccesor;
    private array $recordedEvents = [];

    public function __construct(
        UserAccessTemporalCodeUidVO|string $uid,
        UserAccessTemporalCodeUserVO|UserRef $user,
        UserAccessTemporalCodeTempSecondFactorSeedVO|string|null $tempSecondFactorSeed = null,
        UserAccessTemporalCodeTempSecondFactorSeedExpirationVO|\DateTimeImmutable|null $tempSecondFactorSeedExpiration = null,
        UserAccessTemporalCodeFailedLoginAttemptsVO|int|null $failedLoginAttempts = null,
        UserAccessTemporalCodeRegisterCodeVO|string|null $registerCode = null,
        UserAccessTemporalCodeRegisterCodeUrlVO|string|null $registerCodeUrl = null,
        UserAccessTemporalCodeRegisterCodeExpirationVO|\DateTimeImmutable|null $registerCodeExpiration = null,
        UserAccessTemporalCodeRecoveryCodeVO|string|null $recoveryCode = null,
        UserAccessTemporalCodeRecoveryCodeExpirationVO|\DateTimeImmutable|null $recoveryCodeExpiration = null,
        UserAccessTemporalCodeVersionVO|int|null $version = null,
    ) {
        parent::__construct($uid);
        $this->_user = UserAccessTemporalCodeUserVO::from($user);
        $this->_tempSecondFactorSeed = null === $tempSecondFactorSeed ? UserAccessTemporalCodeTempSecondFactorSeedVO::empty() : UserAccessTemporalCodeTempSecondFactorSeedVO::from($tempSecondFactorSeed);
        $this->_tempSecondFactorSeedExpiration = null === $tempSecondFactorSeedExpiration ? UserAccessTemporalCodeTempSecondFactorSeedExpirationVO::empty() : UserAccessTemporalCodeTempSecondFactorSeedExpirationVO::from($tempSecondFactorSeedExpiration);
        $this->_failedLoginAttempts = null === $failedLoginAttempts ? UserAccessTemporalCodeFailedLoginAttemptsVO::empty() : UserAccessTemporalCodeFailedLoginAttemptsVO::from($failedLoginAttempts);
        $this->_registerCode = null === $registerCode ? UserAccessTemporalCodeRegisterCodeVO::empty() : UserAccessTemporalCodeRegisterCodeVO::from($registerCode);
        $this->_registerCodeUrl = null === $registerCodeUrl ? UserAccessTemporalCodeRegisterCodeUrlVO::empty() : UserAccessTemporalCodeRegisterCodeUrlVO::from($registerCodeUrl);
        $this->_registerCodeExpiration = null === $registerCodeExpiration ? UserAccessTemporalCodeRegisterCodeExpirationVO::empty() : UserAccessTemporalCodeRegisterCodeExpirationVO::from($registerCodeExpiration);
        $this->_recoveryCode = null === $recoveryCode ? UserAccessTemporalCodeRecoveryCodeVO::empty() : UserAccessTemporalCodeRecoveryCodeVO::from($recoveryCode);
        $this->_recoveryCodeExpiration = null === $recoveryCodeExpiration ? UserAccessTemporalCodeRecoveryCodeExpirationVO::empty() : UserAccessTemporalCodeRecoveryCodeExpirationVO::from($recoveryCodeExpiration);
        $this->_version = null === $version ? UserAccessTemporalCodeVersionVO::empty() : UserAccessTemporalCodeVersionVO::from($version);
    }
    public function replace(UserAccessTemporalCodeAttributes $values): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_user = $values->getUserOrDefault($this->_user);
        $value->_tempSecondFactorSeed = $values->getTempSecondFactorSeedOrDefault($this->_tempSecondFactorSeed);
        $value->_tempSecondFactorSeedExpiration = $values->getTempSecondFactorSeedExpirationOrDefault($this->_tempSecondFactorSeedExpiration);
        $value->_failedLoginAttempts = $values->getFailedLoginAttemptsOrDefault($this->_failedLoginAttempts);
        $value->_registerCode = $values->getRegisterCodeOrDefault($this->_registerCode);
        $value->_registerCodeUrl = $values->getRegisterCodeUrlOrDefault($this->_registerCodeUrl);
        $value->_registerCodeExpiration = $values->getRegisterCodeExpirationOrDefault($this->_registerCodeExpiration);
        $value->_recoveryCode = $values->getRecoveryCodeOrDefault($this->_recoveryCode);
        $value->_recoveryCodeExpiration = $values->getRecoveryCodeExpirationOrDefault($this->_recoveryCodeExpiration);
        $value->_version = $values->getVersionOrDefault($this->_version);
        return $value;
    }
    public static function calculatedFields(): array
    {
        return [ 'failedLoginAttempts'];
    }
    public static function create(UserAccessTemporalCodeAttributes $values): UserAccessTemporalCode
    {
        $calculated = clone $values;
        $calculated->failedLoginAttempts(FailedLoginAttemptsCalculator::calculateFailedLoginAttempts());
        $value = $calculated->build();
        $value->recordedEvents[] = new UserAccessTemporalCodeCreateEvent($value);
        return $value;
    }
    public function update(UserAccessTemporalCodeAttributes $values): UserAccessTemporalCode
    {
        $calculated = clone $values;
        $calculated->failedLoginAttempts(FailedLoginAttemptsCalculator::calculateFailedLoginAttempts($this));
        $value = $this->replace($calculated);
        $value->recordedEvents[] = new UserAccessTemporalCodeUpdateEvent($value);
        return $value;
    }
    public function delete(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->recordedEvents[] = new UserAccessTemporalCodeDeleteEvent($value);
        return $value;
    }
    public function markLoginFail(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_failedLoginAttempts = UserAccessTemporalCodeFailedLoginAttemptsVO::from($this->getFailedLoginAttempts() + 1);
        $value->recordedEvents[] = new UserAccessTemporalCodeMarkLoginFailEvent(payload: $value);
        return $value;
    }
    public function markLoginBlock(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_failedLoginAttempts = UserAccessTemporalCodeFailedLoginAttemptsVO::from(0);
        $value->recordedEvents[] = new UserAccessTemporalCodeMarkLoginBlockEvent(payload: $value);
        return $value;
    }
    public function markLoginOk(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_failedLoginAttempts = UserAccessTemporalCodeFailedLoginAttemptsVO::from(0);
        $value->recordedEvents[] = new UserAccessTemporalCodeMarkLoginOkEvent(payload: $value);
        return $value;
    }
    public function generateMfaTemporalCode(AesCypherService $cypher, string|null $tempSecondFactorSeed, \DateTimeImmutable|null $tempSecondFactorSeedExpiration): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_tempSecondFactorSeed = UserAccessTemporalCodeTempSecondFactorSeedVO::fromPlainText($cypher, $tempSecondFactorSeed);
        $value->_tempSecondFactorSeedExpiration = UserAccessTemporalCodeTempSecondFactorSeedExpirationVO::from($tempSecondFactorSeedExpiration);
        $value->recordedEvents[] = new UserAccessTemporalCodeGenerateMfaTemporalCodeEvent(payload: $value);
        return $value;
    }
    public function resetMfaTemporalCode(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_tempSecondFactorSeed = UserAccessTemporalCodeTempSecondFactorSeedVO::from(null);
        $value->_tempSecondFactorSeedExpiration = UserAccessTemporalCodeTempSecondFactorSeedExpirationVO::from(null);
        $value->recordedEvents[] = new UserAccessTemporalCodeResetMfaTemporalCodeEvent(payload: $value);
        return $value;
    }
    public function generatedRegisterVerification(string|null $registerCode, string|null $registerCodeUrl, \DateTimeImmutable|null $registerCodeExpiration): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_registerCode = UserAccessTemporalCodeRegisterCodeVO::from($registerCode);
        $value->_registerCodeUrl = UserAccessTemporalCodeRegisterCodeUrlVO::from($registerCodeUrl);
        $value->_registerCodeExpiration = UserAccessTemporalCodeRegisterCodeExpirationVO::from($registerCodeExpiration);
        $value->recordedEvents[] = new UserAccessTemporalCodeGeneratedRegisterVerificationEvent(payload: $value);
        return $value;
    }
    public function resetRegisterVerification(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_registerCode = UserAccessTemporalCodeRegisterCodeVO::from(null);
        $value->_registerCodeUrl = UserAccessTemporalCodeRegisterCodeUrlVO::from(null);
        $value->_registerCodeExpiration = UserAccessTemporalCodeRegisterCodeExpirationVO::from(null);
        $value->recordedEvents[] = new UserAccessTemporalCodeResetRegisterVerificationEvent(payload: $value);
        return $value;
    }
    public function generatePasswordRecover(string|null $url, string|null $recoveryCode, \DateTimeImmutable|null $recoveryCodeExpiration): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_recoveryCode = UserAccessTemporalCodeRecoveryCodeVO::from($recoveryCode);
        $value->_recoveryCodeExpiration = UserAccessTemporalCodeRecoveryCodeExpirationVO::from($recoveryCodeExpiration);
        $value->recordedEvents[] = new UserAccessTemporalCodeGeneratePasswordRecoverEvent(payload: $value, url: $url);
        return $value;
    }
    public function resetPasswordRecover(): UserAccessTemporalCode
    {
        $value = clone $this;
        $value->_tempSecondFactorSeed = UserAccessTemporalCodeTempSecondFactorSeedVO::from(null);
        $value->_tempSecondFactorSeedExpiration = UserAccessTemporalCodeTempSecondFactorSeedExpirationVO::from(null);
        $value->recordedEvents[] = new UserAccessTemporalCodeResetPasswordRecoverEvent(payload: $value);
        return $value;
    }
    public function asPublicJson(): array
    {
        $data = [];
        $data['uid'] = $this->uid();
        $user = $this->getUser()?->uid();
        if ($user) {
            $data['user'] = ['$ref' => $user];
        }
        $data['tempSecondFactorSeedExpiration'] = $this->getTempSecondFactorSeedExpiration();
        $data['failedLoginAttempts'] = $this->getFailedLoginAttempts();
        $data['registerCode'] = $this->getRegisterCode();
        $data['registerCodeUrl'] = $this->getRegisterCodeUrl();
        $data['registerCodeExpiration'] = $this->getRegisterCodeExpiration();
        $data['recoveryCode'] = $this->getRecoveryCode();
        $data['recoveryCodeExpiration'] = $this->getRecoveryCodeExpiration();
        $data['version'] = $this->getVersion();
        return $data;
    }
    public function toAttributes(): UserAccessTemporalCodeAttributes
    {
        return (new UserAccessTemporalCodeAttributes())
          ->uid($this->uid())
          ->user($this->_user)
          ->tempSecondFactorSeed($this->_tempSecondFactorSeed)
          ->tempSecondFactorSeedExpiration($this->_tempSecondFactorSeedExpiration)
          ->failedLoginAttempts($this->_failedLoginAttempts)
          ->registerCode($this->_registerCode)
          ->registerCodeUrl($this->_registerCodeUrl)
          ->registerCodeExpiration($this->_registerCodeExpiration)
          ->recoveryCode($this->_recoveryCode)
          ->recoveryCodeExpiration($this->_recoveryCodeExpiration)
          ->version($this->_version);
    }
    public function getTheEvents(): array
    {
        return [...$this->recordedEvents];
    }
}
