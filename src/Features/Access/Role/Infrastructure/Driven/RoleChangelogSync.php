<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Role\Infrastructure\Driven;

use Civi\Lughauth\Shared\Observability\LoggerAwareTrait;
use Civi\Lughauth\Shared\Observability\TracerAwareTrait;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogService;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class RoleChangelogSync
{
    use LoggerAwareTrait;
    use TracerAwareTrait;

    public function __construct(
        private readonly RolePdoConnector $conn,
        private readonly EntityChangeLogService $changelog,
    ) {
    }
    public function __invoke(EntityChangeLogSyncEvent $event): EntityChangeLogSyncEvent
    {
        $values = $this->conn->list(null, null);
        $traces = [];
        foreach ($values as $value) {
            $traces[ $value->uid() ] = $value->asPublicJson();
        }
        $this->changelog->resyncEntityLog('role', $traces);
        return $event;
    }
}
