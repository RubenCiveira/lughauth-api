<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\TenantTermsOfUse\Infrastructure\Driven;

use Override;
use Throwable;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\ValueObject\TenantTermsOfUseAttachedVO;
use Civi\Lughauth\Shared\Connector\FileStorage\FileStoreKey;
use Civi\Lughauth\Shared\Connector\FileStorage\BinaryContent;
use Civi\Lughauth\Shared\Exception\NotFoundException;
use Civi\Lughauth\Shared\Infrastructure\Connector\FileStorage\PdoFileStorage;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\Gateway\TenantTermsOfUseReadRepository;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\Gateway\TenantTermsOfUseSlide;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\Gateway\TenantTermsOfUseFilter;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\Gateway\TenantTermsOfUseCursor;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\TenantTermsOfUseRef;
use Civi\Lughauth\Features\Access\TenantTermsOfUse\Domain\TenantTermsOfUse;
use Civi\Lughauth\Shared\Observability\LoggerAwareTrait;
use Civi\Lughauth\Shared\Observability\TracerAwareTrait;

class TenantTermsOfUseReadRepositoryAdapter implements TenantTermsOfUseReadRepository
{
    use LoggerAwareTrait;
    use TracerAwareTrait;

    public function __construct(
        private readonly PdoFileStorage $store,
        private readonly TenantTermsOfUsePdoConnector $conn,
    ) {
    }
    #[Override]
    public function enrich(TenantTermsOfUseRef $ref): ?TenantTermsOfUse
    {
        if ($ref instanceof TenantTermsOfUse) {
            return $ref;
        } elseif (!$ref->_private_enrich) {
            $ref->_private_enrich = $this->conn->retrieve(new TenantTermsOfUseFilter(uids: [ $ref->uid() ]));
        }
        return $ref->_private_enrich;
    }
    #[Override]
    public function list(?TenantTermsOfUseFilter $filter = null, ?TenantTermsOfUseCursor $sort = null): TenantTermsOfUseSlide
    {
        $this->logDebug("List for Tenant terms of use on adapter ");
        $span = $this->startSpan("List for Tenant terms of use on adapter");
        try {
            $values = $this->conn->list($filter, $sort);
            $last = end($values);
            return new TenantTermsOfUseSlide(function ($slide, $next) use ($filter) {
                return $this->list($filter, $next);
            }, new TenantTermsOfUseCursor($sort?->limit ?? 100, $last->uid ?? null), $values);
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
    #[Override]
    public function retrieve(?TenantTermsOfUseFilter $filter): ?TenantTermsOfUse
    {
        $this->logDebug("Retrieve for Tenant terms of use on adapter ");
        $span = $this->startSpan("Retrieve for Tenant terms of use on adapter");
        try {
            return $this->conn->retrieve($filter);
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
    #[Override]
    public function exists(?TenantTermsOfUseFilter $filter): bool
    {
        $this->logDebug("Exists for Tenant terms of use on adapter ");
        $span = $this->startSpan("Exists for Tenant terms of use on adapter");
        try {
            return $this->conn->exists($filter);
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
    #[Override]
    public function count(?TenantTermsOfUseFilter $filter = null): int
    {
        $this->logDebug("Count for Tenant terms of use on adapter ");
        $span = $this->startSpan("Count for Tenant terms of use on adapter");
        try {
            return $this->conn->count($filter);
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
    #[Override]
    public function readAttached(string $key): BinaryContent
    {
        $this->logDebug("Load Attached childs for Tenant terms of use on adapter ");
        $span = $this->startSpan("Load Attached childs for Tenant terms of use on adapter");
        try {
            $binary = $this->store->retrieveFile(new FileStoreKey($key));
            if ($binary) {
                return $binary;
            } else {
                throw new NotFoundException('');
            }
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
    #[Override]
    public function findOneByUid(string $uid): ?TenantTermsOfUse
    {
        $this->logDebug("Find on by uid for Tenant terms of use on adapter");
        $span = $this->startSpan("Find on by uid for Tenant terms of use on adapter");
        try {
            return $this->conn->retrieve(new TenantTermsOfUseFilter(uids: [$uid]));
        } catch (Throwable $ex) {
            $span->recordException($ex);
            throw $ex;
        } finally {
            $span->end();
        }
    }
}
