<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderAllowController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderListController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderCreateController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderRetrieveController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderUpdateController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderDeleteController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderEnableController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderDisableController;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driver\Rest\TenantLoginProviderTempMetadataUploadController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Service\Visibility\TenantLoginProviderRestrictFilterToVisibility;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Filter\TenantAccesible;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Fields\TenantLoginProviderExcludingdRoot;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Service\Visibility\TenantLoginProviderCollectNonEditableFields;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Create\TenantLoginProviderCreateAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Update\TenantLoginProviderUpdateAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Retrieve\TenantLoginProviderRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\List\TenantLoginProviderListAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Delete\TenantLoginProviderDeleteAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Enable\IsAutenticatedEnableAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Enable\TenantLoginProviderEnableAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Policy\Allow\Disable\IsAutenticatedDisableAllow;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Application\Usecase\Disable\TenantLoginProviderDisableAllowDecision;
use Civi\Lughauth\Features\Access\TenantLoginProvider\Infrastructure\Driven\TenantLoginProviderChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class TenantLoginProviderPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/access/login-providers', [$this, 'setRoutesForTenantLoginProvider']);
        $app->group('/api/me/acl/access/login-providers', [$this, 'setRoutesForTenantLoginProviderAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(TenantLoginProviderRestrictFilterToVisibility::class, TenantAccesible::class);
        $bus->registerListener(TenantLoginProviderCollectNonEditableFields::class, TenantLoginProviderExcludingdRoot::class);
        $bus->registerListener(TenantLoginProviderCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(TenantLoginProviderUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(TenantLoginProviderRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(TenantLoginProviderListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(TenantLoginProviderDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(TenantLoginProviderEnableAllowDecision::class, IsAutenticatedEnableAllow::class);
        $bus->registerListener(TenantLoginProviderDisableAllowDecision::class, IsAutenticatedDisableAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, TenantLoginProviderChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("tenant-login-provider", "list", "READ");
            $handler->registerResourceAction("tenant-login-provider", "create", "WRITE");
            $handler->registerResourceAction("tenant-login-provider", "retrieve", "READ");
            $handler->registerResourceAction("tenant-login-provider", "update", "WRITE");
            $handler->registerResourceAction("tenant-login-provider", "delete", "WRITE");
            $handler->registerResourceAction("tenant-login-provider", "enable", "WRITE");
            $handler->registerResourceAction("tenant-login-provider", "disable", "WRITE");

            $handler->registerResourceAttribute("tenant-login-provider", "tenant", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "name", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "source", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "disabled", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "directAccess", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "publicKey", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "privateKey", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "certificate", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "metadata", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "usersEnabledByDefault", "MANAGE");
            $handler->registerResourceAttribute("tenant-login-provider", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForTenantLoginProviderAcl(RouteCollectorProxy $tenantLoginProviderGroup)
    {
        $tenantLoginProviderGroup->get('', [TenantLoginProviderAllowController::class, 'genericAllow']);
        $tenantLoginProviderGroup->get('/{uid}', [TenantLoginProviderAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForTenantLoginProvider(RouteCollectorProxy $tenantLoginProviderGroup)
    {
        $tenantLoginProviderGroup->get('', [TenantLoginProviderListController::class, 'list']);
        $tenantLoginProviderGroup->post('', [TenantLoginProviderCreateController::class, 'create']);
        $tenantLoginProviderGroup->get('/{uid}', [TenantLoginProviderRetrieveController::class, 'retrieve']);
        $tenantLoginProviderGroup->get('/{uid}/metadata', [TenantLoginProviderRetrieveController::class, 'retrieveMetadata']);
        $tenantLoginProviderGroup->put('/{uid}', [TenantLoginProviderUpdateController::class, 'update']);
        $tenantLoginProviderGroup->delete('/{uid}', [TenantLoginProviderDeleteController::class, 'delete']);
        $tenantLoginProviderGroup->delete('', [TenantLoginProviderDeleteController::class, 'deleteAllForQuery']);
        $tenantLoginProviderGroup->get('/~/delete-status/{uid}', [TenantLoginProviderDeleteController::class, 'checkDeleteAllForQueryStatus']);
        $tenantLoginProviderGroup->patch('/~/enable', [TenantLoginProviderEnableController::class, 'enableAllForQuery']);
        $tenantLoginProviderGroup->patch('/{uid}/enable', [TenantLoginProviderEnableController::class, 'enable']);
        $tenantLoginProviderGroup->get('/~/enable-status/{uid}', [TenantLoginProviderEnableController::class, 'checkEnableAllForQueryStatus']);
        $tenantLoginProviderGroup->patch('/~/disable', [TenantLoginProviderDisableController::class, 'disableAllForQuery']);
        $tenantLoginProviderGroup->patch('/{uid}/disable', [TenantLoginProviderDisableController::class, 'disable']);
        $tenantLoginProviderGroup->get('/~/disable-status/{uid}', [TenantLoginProviderDisableController::class, 'checkDisableAllForQueryStatus']);
        $tenantLoginProviderGroup->post('/-/temp-metadata', [TenantLoginProviderTempMetadataUploadController::class, 'uploadTemp']);
        $tenantLoginProviderGroup->get('/-/temp-metadata', [TenantLoginProviderTempMetadataUploadController::class, 'getTemp']);
    }
}
