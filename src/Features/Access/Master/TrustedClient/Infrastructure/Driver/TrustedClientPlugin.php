<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientAllowController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientListController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientCreateController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientRetrieveController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientUpdateController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientDeleteController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientEnableController;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driver\Rest\TrustedClientDisableController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Create\CreateTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Create\TrustedClientCreateAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Update\TrustedClientUpdateAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Update\UpdateTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Retrieve\RetrieveTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Retrieve\TrustedClientRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\List\ListTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\List\TrustedClientListAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Delete\DeleteTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Delete\TrustedClientDeleteAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Enable\EnableTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Enable\TrustedClientEnableAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Enable\IsAutenticatedEnableAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Disable\DisableTrustedClientOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Usecase\Disable\TrustedClientDisableAllowDecision;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Application\Policy\Allow\Disable\IsAutenticatedDisableAllow;
use Civi\Lughauth\Features\Access\Master\TrustedClient\Infrastructure\Driven\TrustedClientChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class TrustedClientPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/access/trusted-clients', [$this, 'setRoutesForTrustedClient']);
        $app->group('/api/me/acl/access/trusted-clients', [$this, 'setRoutesForTrustedClientAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(TrustedClientCreateAllowDecision::class, CreateTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(TrustedClientUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(TrustedClientUpdateAllowDecision::class, UpdateTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientRetrieveAllowDecision::class, RetrieveTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(TrustedClientListAllowDecision::class, ListTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(TrustedClientDeleteAllowDecision::class, DeleteTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(TrustedClientEnableAllowDecision::class, EnableTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientEnableAllowDecision::class, IsAutenticatedEnableAllow::class);
        $bus->registerListener(TrustedClientDisableAllowDecision::class, DisableTrustedClientOnlyForRootAllow::class);
        $bus->registerListener(TrustedClientDisableAllowDecision::class, IsAutenticatedDisableAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, TrustedClientChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("trusted-client", "list", "READ");
            $handler->registerResourceAction("trusted-client", "create", "WRITE");
            $handler->registerResourceAction("trusted-client", "retrieve", "READ");
            $handler->registerResourceAction("trusted-client", "update", "WRITE");
            $handler->registerResourceAction("trusted-client", "delete", "WRITE");
            $handler->registerResourceAction("trusted-client", "enable", "WRITE");
            $handler->registerResourceAction("trusted-client", "disable", "WRITE");

            $handler->registerResourceAttribute("trusted-client", "code", "MANAGE");
            $handler->registerResourceAttribute("trusted-client", "publicAllow", "MANAGE");
            $handler->registerResourceAttribute("trusted-client", "secretOauth", "MANAGE");
            $handler->registerResourceAttribute("trusted-client", "enabled", "MANAGE");
            $handler->registerResourceAttribute("trusted-client", "allowedRedirects", "MANAGE");
            $handler->registerResourceAttribute("trusted-client", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForTrustedClientAcl(RouteCollectorProxy $trustedClientGroup)
    {
        $trustedClientGroup->get('', [TrustedClientAllowController::class, 'genericAllow']);
        $trustedClientGroup->get('/{uid}', [TrustedClientAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForTrustedClient(RouteCollectorProxy $trustedClientGroup)
    {
        $trustedClientGroup->get('', [TrustedClientListController::class, 'list']);
        $trustedClientGroup->post('', [TrustedClientCreateController::class, 'create']);
        $trustedClientGroup->get('/{uid}', [TrustedClientRetrieveController::class, 'retrieve']);
        $trustedClientGroup->put('/{uid}', [TrustedClientUpdateController::class, 'update']);
        $trustedClientGroup->delete('/{uid}', [TrustedClientDeleteController::class, 'delete']);
        $trustedClientGroup->delete('', [TrustedClientDeleteController::class, 'deleteAllForQuery']);
        $trustedClientGroup->get('/~/delete-status/{uid}', [TrustedClientDeleteController::class, 'checkDeleteAllForQueryStatus']);
        $trustedClientGroup->patch('/~/enable', [TrustedClientEnableController::class, 'enableAllForQuery']);
        $trustedClientGroup->patch('/{uid}/enable', [TrustedClientEnableController::class, 'enable']);
        $trustedClientGroup->get('/~/enable-status/{uid}', [TrustedClientEnableController::class, 'checkEnableAllForQueryStatus']);
        $trustedClientGroup->patch('/~/disable', [TrustedClientDisableController::class, 'disableAllForQuery']);
        $trustedClientGroup->patch('/{uid}/disable', [TrustedClientDisableController::class, 'disable']);
        $trustedClientGroup->get('/~/disable-status/{uid}', [TrustedClientDisableController::class, 'checkDisableAllForQueryStatus']);
    }
}
