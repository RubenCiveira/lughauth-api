<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyAllowController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyListController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyCreateController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyRetrieveController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyUpdateController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyDeleteController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyEnableController;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driver\Rest\RelyingPartyDisableController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Create\CreateRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Create\RelyingPartyCreateAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Update\RelyingPartyUpdateAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Update\UpdateRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Retrieve\RetrieveRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Retrieve\RelyingPartyRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\List\ListRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\List\RelyingPartyListAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Delete\DeleteRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Delete\RelyingPartyDeleteAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Enable\EnableRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Enable\RelyingPartyEnableAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Enable\IsAutenticatedEnableAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Disable\DisableRelyingPartyOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Usecase\Disable\RelyingPartyDisableAllowDecision;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Application\Policy\Allow\Disable\IsAutenticatedDisableAllow;
use Civi\Lughauth\Features\Access\Master\RelyingParty\Infrastructure\Driven\RelyingPartyChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class RelyingPartyPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/access/relying-parties', [$this, 'setRoutesForRelyingParty']);
        $app->group('/api/me/acl/access/relying-parties', [$this, 'setRoutesForRelyingPartyAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(RelyingPartyCreateAllowDecision::class, CreateRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(RelyingPartyUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(RelyingPartyUpdateAllowDecision::class, UpdateRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyRetrieveAllowDecision::class, RetrieveRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(RelyingPartyListAllowDecision::class, ListRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(RelyingPartyDeleteAllowDecision::class, DeleteRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(RelyingPartyEnableAllowDecision::class, EnableRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyEnableAllowDecision::class, IsAutenticatedEnableAllow::class);
        $bus->registerListener(RelyingPartyDisableAllowDecision::class, DisableRelyingPartyOnlyForRootAllow::class);
        $bus->registerListener(RelyingPartyDisableAllowDecision::class, IsAutenticatedDisableAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, RelyingPartyChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("relying-party", "list", "READ");
            $handler->registerResourceAction("relying-party", "create", "WRITE");
            $handler->registerResourceAction("relying-party", "retrieve", "READ");
            $handler->registerResourceAction("relying-party", "update", "WRITE");
            $handler->registerResourceAction("relying-party", "delete", "WRITE");
            $handler->registerResourceAction("relying-party", "enable", "WRITE");
            $handler->registerResourceAction("relying-party", "disable", "WRITE");

            $handler->registerResourceAttribute("relying-party", "code", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "apiKey", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "enabled", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "scopes", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "schemas", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "policies", "MANAGE");
            $handler->registerResourceAttribute("relying-party", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForRelyingPartyAcl(RouteCollectorProxy $relyingPartyGroup)
    {
        $relyingPartyGroup->get('', [RelyingPartyAllowController::class, 'genericAllow']);
        $relyingPartyGroup->get('/{uid}', [RelyingPartyAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForRelyingParty(RouteCollectorProxy $relyingPartyGroup)
    {
        $relyingPartyGroup->get('', [RelyingPartyListController::class, 'list']);
        $relyingPartyGroup->post('', [RelyingPartyCreateController::class, 'create']);
        $relyingPartyGroup->get('/{uid}', [RelyingPartyRetrieveController::class, 'retrieve']);
        $relyingPartyGroup->put('/{uid}', [RelyingPartyUpdateController::class, 'update']);
        $relyingPartyGroup->delete('/{uid}', [RelyingPartyDeleteController::class, 'delete']);
        $relyingPartyGroup->delete('', [RelyingPartyDeleteController::class, 'deleteAllForQuery']);
        $relyingPartyGroup->get('/~/delete-status/{uid}', [RelyingPartyDeleteController::class, 'checkDeleteAllForQueryStatus']);
        $relyingPartyGroup->patch('/~/enable', [RelyingPartyEnableController::class, 'enableAllForQuery']);
        $relyingPartyGroup->patch('/{uid}/enable', [RelyingPartyEnableController::class, 'enable']);
        $relyingPartyGroup->get('/~/enable-status/{uid}', [RelyingPartyEnableController::class, 'checkEnableAllForQueryStatus']);
        $relyingPartyGroup->patch('/~/disable', [RelyingPartyDisableController::class, 'disableAllForQuery']);
        $relyingPartyGroup->patch('/{uid}/disable', [RelyingPartyDisableController::class, 'disable']);
        $relyingPartyGroup->get('/~/disable-status/{uid}', [RelyingPartyDisableController::class, 'checkDisableAllForQueryStatus']);
    }
}
