<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Master\RelyingParty\Domain\Gateway;

use Civi\Lughauth\Features\Access\Master\RelyingParty\Domain\RelyingParty;

class RelyingPartySlide extends \ArrayIterator
{
    private readonly ?RelyingParty $last;
    private readonly RelyingPartyCursor $nextCursor;
    public function __construct(
        private readonly ?\Closure $next,
        private readonly ?RelyingPartyCursor $cursor,
        private readonly array $values
    ) {
        parent::__construct($values);
        $this->last = $values ? end($values) : null;
        $this->nextCursor = new RelyingPartyCursor(
            limit: $this->cursor->limit(),
            sinceUid: $this->last ? $this->last->uid() : null,
            sinceCode: $this->last ? $this->last->getCode() : null,
        );
    }
    public function cursor(): ?RelyingPartyCursor
    {
        return $this->cursor;
    }
    public function nextCursor(): RelyingPartyCursor
    {
        return $this->nextCursor;
    }
    public function values(): array
    {
        return $this->values;
    }
    public function current(): RelyingParty
    {
        return parent::current();
    }
    public function map(\Closure $fn): RelyingPartySlide
    {
        return new RelyingPartySlide($this->next, $this->cursor, array_map($fn, $this->values));
    }
    public function slide(\Closure $fn): RelyingPartySlide
    {
        $filtered = array_filter($this->values, $fn);
        $collected = $filtered;
        $last = $this->last;
        $next = $this->next;
        $cursor = $this->cursor;
        if (count($collected) == $cursor->limit()) {
            while (
                count($collected) < count($this->values) && $next
            ) {
                $nextSlide = ($this->next)($this, $cursor->next($last, $cursor->limit()));
                if (count($nextSlide)) {
                    $nextFiltered = array_filter($nextSlide->values, $fn);
                    $collected = array_merge($collected, $nextFiltered);
                    $cursor = $nextSlide->cursor;
                    $next = $nextSlide->next;
                    $last = $nextSlide->last;
                } else {
                    break;
                }
            }
            return new RelyingPartySlide($next, $cursor, $collected);
        } else {
            return $this;
        }
    }
}
