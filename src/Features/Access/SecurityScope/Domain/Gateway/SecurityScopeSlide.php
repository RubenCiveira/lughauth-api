<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\SecurityScope\Domain\Gateway;

use Civi\Lughauth\Features\Access\SecurityScope\Domain\SecurityScope;

class SecurityScopeSlide extends \ArrayIterator
{
    private readonly ?SecurityScope $last;
    private readonly SecurityScopeCursor $nextCursor;
    public function __construct(
        private readonly ?\Closure $next,
        private readonly ?SecurityScopeCursor $cursor,
        private readonly array $values
    ) {
        parent::__construct($values);
        $this->last = $values ? end($values) : null;
        $this->nextCursor = new SecurityScopeCursor(
            limit: $this->cursor->limit(),
            sinceUid: $this->last ? $this->last->uid() : null,
        );
    }
    public function cursor(): ?SecurityScopeCursor
    {
        return $this->cursor;
    }
    public function nextCursor(): SecurityScopeCursor
    {
        return $this->nextCursor;
    }
    public function values(): array
    {
        return $this->values;
    }
    public function current(): SecurityScope
    {
        return parent::current();
    }
    public function map(\Closure $fn): SecurityScopeSlide
    {
        return new SecurityScopeSlide($this->next, $this->cursor, array_map($fn, $this->values));
    }
    public function slide(\Closure $fn): SecurityScopeSlide
    {
        $filtered = array_filter($this->values, $fn);
        $collected = $filtered;
        $last = $this->last;
        $next = $this->next;
        $cursor = $this->cursor;
        if (count($collected) == $cursor->limit()) {
            while (
                count($collected) < count($this->values) && $next
            ) {
                $nextSlide = ($this->next)($this, $cursor->next($last, $cursor->limit()));
                if (count($nextSlide)) {
                    $nextFiltered = array_filter($nextSlide->values, $fn);
                    $collected = array_merge($collected, $nextFiltered);
                    $cursor = $nextSlide->cursor;
                    $next = $nextSlide->next;
                    $last = $nextSlide->last;
                } else {
                    break;
                }
            }
            return new SecurityScopeSlide($next, $cursor, $collected);
        } else {
            return $this;
        }
    }
}
