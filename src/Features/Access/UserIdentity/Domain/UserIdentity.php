<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\UserIdentity\Domain;

use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityUidVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityUserVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\Accesor\UserIdentityUserAccesor;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRelyingPartyVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\Accesor\UserIdentityRelyingPartyAccesor;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityTrustedClientVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\Accesor\UserIdentityTrustedClientAccesor;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesListRef;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityRolesVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\Accesor\UserIdentityRolesAccesor;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\UserIdentityVersionVO;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\ValueObject\Accesor\UserIdentityVersionAccesor;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\Event\UserIdentityCreateEvent;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\Event\UserIdentityUpdateEvent;
use Civi\Lughauth\Features\Access\UserIdentity\Domain\Event\UserIdentityDeleteEvent;
use Civi\Lughauth\Features\Access\User\Domain\UserRef;
use Civi\Lughauth\Features\Access\RelyingParty\Domain\RelyingPartyRef;
use Civi\Lughauth\Features\Access\TrustedClient\Domain\TrustedClientRef;

class UserIdentity extends UserIdentityRef
{
    use UserIdentityUserAccesor;
    use UserIdentityRelyingPartyAccesor;
    use UserIdentityTrustedClientAccesor;
    use UserIdentityRolesAccesor;
    use UserIdentityVersionAccesor;
    private array $recordedEvents = [];

    public function __construct(
        UserIdentityUidVO|string $uid,
        UserIdentityUserVO|UserRef $user,
        UserIdentityRolesVO|UserIdentityRolesListRef| array |null $roles,
        UserIdentityRelyingPartyVO|RelyingPartyRef|null $relyingParty = null,
        UserIdentityTrustedClientVO|TrustedClientRef|null $trustedClient = null,
        UserIdentityVersionVO|int|null $version = null,
    ) {
        parent::__construct($uid);
        $this->_user = UserIdentityUserVO::from($user);
        $this->_relyingParty = null === $relyingParty ? UserIdentityRelyingPartyVO::empty() : UserIdentityRelyingPartyVO::from($relyingParty);
        $this->_trustedClient = null === $trustedClient ? UserIdentityTrustedClientVO::empty() : UserIdentityTrustedClientVO::from($trustedClient);
        $this->_roles = UserIdentityRolesVO::from($roles);
        $this->_version = null === $version ? UserIdentityVersionVO::empty() : UserIdentityVersionVO::from($version);
    }
    public function replace(UserIdentityAttributes $values): UserIdentity
    {
        $value = clone $this;
        $value->_user = $values->getUserOrDefault($this->_user);
        $value->_relyingParty = $values->getRelyingPartyOrDefault($this->_relyingParty);
        $value->_trustedClient = $values->getTrustedClientOrDefault($this->_trustedClient);
        $value->_roles = $values->getRolesOrDefault($this->_roles);
        $value->_version = $values->getVersionOrDefault($this->_version);
        return $value;
    }
    public static function calculatedFields(): array
    {
        return [];
    }
    public static function create(UserIdentityAttributes $values): UserIdentity
    {
        $value = $values->build();
        $value->recordedEvents[] = new UserIdentityCreateEvent($value);
        return $value;
    }
    public function update(UserIdentityAttributes $values): UserIdentity
    {
        $value = $this->replace($values);
        $value->recordedEvents[] = new UserIdentityUpdateEvent($value, $this);
        return $value;
    }
    public function delete(): UserIdentity
    {
        $value = clone $this;
        $value->recordedEvents[] = new UserIdentityDeleteEvent($value);
        return $value;
    }
    public function asPublicJson(): array
    {
        $data = [];
        $data['uid'] = $this->uid();
        $user = $this->getUser()?->uid();
        if ($user) {
            $data['user'] = ['$ref' => $user];
        }
        $relyingParty = $this->getRelyingParty()?->uid();
        if ($relyingParty) {
            $data['relyingParty'] = ['$ref' => $relyingParty];
        }
        $trustedClient = $this->getTrustedClient()?->uid();
        if ($trustedClient) {
            $data['trustedClient'] = ['$ref' => $trustedClient];
        }
        $roles = $this->getRoles();
        if ($roles) {
            $data['roles'] = [];
            foreach ($roles as $row) {
                $jsonRow = [];
                $jsonRow['uid'] = $row->uid();
                $role = $row->getRole()?->uid();
                if ($role) {
                    $jsonRow['role'] = ['$ref' => $role];
                }
                $jsonRow['version'] = $row->getVersion();
                $data['roles'][] = $jsonRow;
            }
        }
        $data['version'] = $this->getVersion();
        return $data;
    }
    public function toAttributes(): UserIdentityAttributes
    {
        return (new UserIdentityAttributes())
          ->uid($this->uid())
          ->user($this->_user)
          ->relyingParty($this->_relyingParty)
          ->trustedClient($this->_trustedClient)
          ->roles($this->_roles)
          ->version($this->_version);
    }
    public function getTheEvents(): array
    {
        return [...$this->recordedEvents];
    }
}
