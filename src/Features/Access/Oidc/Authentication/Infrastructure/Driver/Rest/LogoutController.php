<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Rest;

use Civi\Lughauth\Features\Access\Oidc\Session\Domain\Gateway\SessionStoreGateway;
use Civi\Lughauth\Shared\Infrastructure\Http\Cookie;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

class LogoutController
{
    public function __construct(private readonly SessionStoreGateway $sessionStore)
    {
    }

    public function logout(ServerRequestInterface $request, ResponseInterface $response, array $args): ResponseInterface
    {
        $session = $request->getCookieParams();
        $redirect = $request->getQueryParams();
        return $this->destroy($response, $session['AUTH_SESSION_ID'] ?? '')->withStatus(302)->withHeader('Location', $redirect['post_logout_redirect_uri']);
    }

    public function revoke(ServerRequestInterface $request, ResponseInterface $response, array $args): ResponseInterface
    {
        $session = $request->getCookieParams();
        return $this->destroy($response, $session['AUTH_SESSION_ID'] ?? '');
    }

    private function destroy(
        ResponseInterface $response,
        string $session
    ): ResponseInterface {
        $this->sessionStore->deleteSession($session);
        // remove cookies
        $authCookie = new Cookie(name: 'AUTH_SESSION_ID');
        $preCookie = new Cookie(name: 'PRE_SESSION_ID');
        return $preCookie->remove($authCookie->remove($response));
    }
}
