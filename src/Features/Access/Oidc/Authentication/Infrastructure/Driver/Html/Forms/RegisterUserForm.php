<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Forms;

use Override;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Access\Oidc\User\Domain\PublicLoginAuthResponse;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\DecorateHtml;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\HtmlSecurer;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\PublicLogin;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\Exception\LoginException;
use Civi\Lughauth\Shared\Infrastructure\Translation\MessageProvider;

class RegisterUserForm implements AuthorizationForm
{
    public function __construct(
        private readonly MessageProvider $messages,
        private readonly PublicLogin $publicLogin,
        private readonly DecorateHtml $decorator,
        private readonly HtmlSecurer $securer
    ) {
    }

    #[Override]
    public function step(): string
    {
        return 'register-user';
    }

    #[Override]
    public function handle(?AuthenticationResult $pe): bool
    {
        return $pe?->error == AuthenticationResult::ERR_WAITING_USER_VERIFY;
    }

    #[Override]
    public function paint(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $locale = '';
        $params = $request->getQueryParams();
        if (($params['verify_send'] ?? 'false') === 'true') {
            return $this->paintConfirm($pe, $locale, $base, $tenant, $challenges, $body, $request, $response);
        } elseif ($pe) {
            return $this->paintWait($pe, $locale, $base, $tenant, $challenges, $body, $request, $response);
        } else {
            return $this->paintAsk($pe, $locale, $base, $tenant, $challenges, $body, $request, $response);
        }
    }

    #[Override]
    public function autenticate(
        AuthenticationRequest $request,
        string $tenant,
        string $issuer,
        string $csid,
        string $state,
        string $nonce,
        AuthorizedChalleges $challenges,
        mixed $body
    ): PublicLoginAuthResponse {
        if (isset($body['user'])) {
            $user = $body['user'] ?? '';
            $accept = $body['accept'] ?? false;
            $pass  = $this->securer->decrypt($body["pass"] ?? '');
            if ($accept !== 'accept') {
                throw new LoginException(AuthenticationResult::unknowUser($tenant, $user, 'conditions_requierd'));
            } else {
                $url = $this->publicLogin->askRegisterUser($request, '&_use_code=', $user, $pass, $tenant, $state, $nonce);
                throw new LoginException(AuthenticationResult::waitNewuserVerify($url));
            }
        } else {
            $code = $this->securer->decrypt($body["code"]);
            return $this->publicLogin->confirmRegisterUser($request, $challenges, $code, $tenant, $issuer, $csid, $state, $nonce);
        }
    }

    public function paintAsk(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $js = $this->securer->configureScripts([
            $this->securer->addSign("sign"),
            $this->securer->focusOn("user"),
            $this->securer->cypher([['from' => 'type_pass', 'to' => 'pass']], 'regform'),
        ]);
        $translator = $this->messages->messages('forms', $locale, __DIR__ . '/../../Translations');

        $title = $translator->get("registeruser.ask.title");
        $error = $pe?->errorMessage
            ? $translator->get("registeruser.ask.error-format", [$error = $translator->get('error.' . strtolower($pe?->errorMessage))])
            : false;

        $help = $translator->get("registeruser.ask.help");
        $send = $translator->get("registeruser.ask.send");
        $name = $translator->get("registeruser.ask.email");
        $pass = $translator->get("registeruser.ask.password");

        $accept = '<input type="hidden" name="accept" value="accept" />';
        if ($terms = $this->publicLogin->getRegisterConsent($tenant)) {
            $accept = '<input type="checkbox" name="accept" value="accept" />' .
                            '<textarea type="text" readonly>' . $terms . '</textarea>';
        }

        $backText = $translator->get(
            "registeruser.ask.back-text",
            ["<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("registeruser.ask.back-label") . "\" />"]
        );
        $error = $error ? '<p class="error">' . $error . '</p>' : '';
        $response->getBody()->write($this->decorator->getFullPage(
            $request,
            'New pass',
            $js . <<<HTML
                    <h1> $title </h1>
                    <p> $help </p>
                    {$error}
                    <form id="regform" method="POST">
                        <input type="hidden" name="csid" id="sign" />
                        <input type="hidden" name="step" value="register-user" />
                        <label>{$name}
                            <input type="text" name="user" id="user" value="" />
                        </label>
                        <label>{$pass}
                            <input type="password" id="type_pass" value="" />
                        </label>
                        <input type="hidden" name="pass" id="pass" value="" />
                        {$accept}
                        <input class="primary-button" type="submit" value="{$send}" />
                    </form>
                    <form method="POST">
                        <input type="hidden" name="step" value="" />
                        {$backText}
                    </form>
                HTML,
            $locale
        ));
        return $response;
    }

    public function paintConfirm(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $params = $request->getQueryParams();
        $js = $this->securer->configureScripts([
            $this->securer->addSign("sign"),
            $this->securer->focusOn("type_code"),
            $this->securer->cypher([['from' => 'type_code', 'to' => 'code'] ], 'recform'),
        ]);
        $translator = $this->messages->messages('forms', $locale, __DIR__ . '/../../Translations');

        $title = $translator->get("registeruser.code.title");
        $error = $pe?->errorMessage
            ? $translator->get("registeruser.code.error-format", [$error = $translator->get('error.' . strtolower($pe?->errorMessage))])
            : false;

        $help = $translator->get("registeruser.code.help");
        $send = $translator->get("registeruser.code.send");
        $code = $translator->get("registeruser.code.validation");
        $pass = $translator->get("registeruser.code.newpass");

        $backText = $translator->get(
            "registeruser.code.back-text",
            ["<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("registeruser.code.back-label") . "\" />"]
        );
        $error = $error ? '<p class="error">' . $error . '</p>' : '';
        $defaultCode = $params['_use_code'] ?? '';
        $response->getBody()->write($this->decorator->getFullPage(
            $request,
            'New pass',
            $js . <<<HTML
                    <h1> $title </h1>
                    <p> $help </p>
                    {$error}
                    <form id="recform" method="POST">
                        <input type="hidden" name="csid" id="sign" />
                        <input type="hidden" name="step" value="register-user" />
                        <input type="hidden" name="code" id="code" value="" />
                        <label>{$code}
                            <input type="text" id="type_code" value="{$defaultCode}" />
                        </label>
                        <input class="primary-button" type="submit" value="{$send}" />
                    </form>
                    <form method="POST">
                        <input type="hidden" name="step" value="" />
                        {$backText}
                    </form>
                HTML
            ,
            $locale
        ));
        return $response;
    }

    public function paintWait(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $js = $this->securer->configureScripts([
            $this->securer->addSign("sign"),
            $this->securer->focusOn("type_code"),
            $this->securer->cypher([['from' => 'type_code', 'to' => 'code'],
                ['from' => 'type_new_pass', 'to' => 'new_pass']], 'recform'),
        ]);
        $translator = $this->messages->messages('forms', $locale, __DIR__ . '/../../Translations');

        $url = $pe->id;
        $title = $translator->get("registeruser.info.title");
        $error = $pe?->errorMessage
            ? $translator->get("registeruser.info.error-format", [$error = $translator->get('error.' . strtolower($pe?->errorMessage))])
            : false;

        $help = $translator->get("registeruser.info.help");
        $send = $translator->get(
            "registeruser.info.goto-text",
            ['<a href="'.$url.'">' . $translator->get("registeruser.info.goto-label") . '</a>' ]
        );

        $backText = $translator->get(
            "registeruser.info.back-text",
            ["<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("registeruser.info.back-label") . "\" />"]
        );
        $error = $error ? '<p class="error">' . $error . '</p>' : '';
        $response->getBody()->write($this->decorator->getFullPage(
            $request,
            'New pass',
            $js . <<<HTML
                    <h1>{$title}</h1>
                    <p>{$help}</p>
                    {$error}
                    {$send}
                    <form method="POST">
                        <input type="hidden" name="step" value="" />
                        {$backText}
                    </form>
                HTML,
            $locale
        ));
        return $response;
    }
}
