<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Forms;

use Override;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\DecorateHtml;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\HtmlSecurer;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services\PublicLogin;
use Civi\Lughauth\Features\Access\Oidc\User\Domain\PublicLoginAuthResponse;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Application\DelegateLogin;
use Civi\Lughauth\Shared\Exception\UnauthorizedException;
use Civi\Lughauth\Shared\Infrastructure\Translation\MessageProvider;

class LoginForm implements AuthorizationForm
{
    public function __construct(
        private readonly MessageProvider $messages,
        private readonly PublicLogin $publicLogin,
        private readonly DecorateHtml $decorator,
        private readonly HtmlSecurer $securer,
        private readonly DelegateLogin $delegated,
    ) {
    }

    #[Override]
    public function step(): string
    {
        return '';
    }

    #[Override]
    public function handle(?AuthenticationResult $pe): bool
    {
        return $pe === null
            || $pe instanceof UnauthorizedException
            || $pe->error == AuthenticationResult::ERR_WRONG_CREDENTIAL
            || $pe->error == AuthenticationResult::ERR_UNKNOW_USER;
    }

    #[Override]
    public function paint(?AuthenticationResult $pe, string $locale, string $base, string $tenant, AuthorizedChalleges $challenges, ?array $body, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $locale = '';
        $js = $this->securer->configureScripts([
            $this->securer->focusOn("username"),
            $this->securer->addSign("sign"),
            $this->securer->cypher([['from' => 'type_password', 'to' => 'password']], 'login')
        ]);
        $translator = $this->messages->messages('forms', $locale, __DIR__ . '/../../Translations');

        $title = $translator->get("login.title");
        $help = $translator->get("login.help", ['tenant' => $tenant]);
        $error = $pe?->error
            ? $translator->get("login.error-format", ['error' => $translator->get('error.' . strtolower($pe?->error))])
            : false;

        $username = $translator->get("login.username");
        $password = $translator->get("login.password");
        // Allow recober by exposes.

        $recoverText = $translator->get("login.recover-text", [
             "<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("login.recover-label") . "\"/>"
        ]);
        $registerText = $translator->get("login.register-text", [
             "<input class=\"inline\" type=\"submit\" value=\"" . $translator->get("login.register-label") . "\"/>"
        ]);
        $enter = $translator->get("login.enter");

        $delegatedLogins = "";
        foreach ($this->delegated->providers($tenant) as $provider) {
            $info = $provider->info();
            $delegatedLogins .= <<<HTML
                <form method="POST" id="social-form-{$info->id}" class="social-form">
                    <input type="hidden" name="step" value="delegated-login" />
                    <input type="hidden" name="delegated-provider" value="{$info->id}" />
                    <button type="submit" class="social-button">
                        <img src="{$info->logo}" alt="{$info->name}" />
                    </button>
                </form>
                HTML;
        }
        $recoverPass = "";
        if ($this->publicLogin->allowUserRecoverPassword($tenant)) {
            $recoverPass .= <<<HTML
                <form method="POST">
                    <input type="hidden" name="step" value="recover-pass" />
                    {$recoverText}
                </form>
                HTML;
        }
        $registerUser = "";
        if ($this->publicLogin->allowUserRegister($tenant)) {
            $registerUser .= <<<HTML
                <form method="POST">
                    <input type="hidden" name="step" value="register-user" />
                    {$registerText}
                </form>
                HTML;
        }

        $error = $error ? '<p class="error">' . $error . '</p>' : '';
        $delegatedLogins = $delegatedLogins ? "<div class=\"social-login-buttons\">{$delegatedLogins}</div>" : '';

        $response->getBody()->write(
            $this->decorator->getFullPage(
                $request,
                'Login',
                $js . <<<HTML
                    <h1>{$title}</h1>
                    <p>{$help}</p>
                    {$error}
                    <form id="login" method="POST">
                        <input type="hidden" name="csid" id="sign" />
                        <input type="hidden" id="password" name="password" value="" />
                        <label> {$username} 
                            <input type="text" id="username" name="username" value="" />
                        </label>
                        <label> {$password}
                            <input type="password" id="type_password" value="" />
                        </label>
                        <input class="primary-button" type="submit" value="{$enter}" />
                    </form>
                    {$recoverPass}
                    {$registerUser}
                    {$delegatedLogins}
                HTML,
                'es'
            )
        );
        return $response;
    }

    #[Override]
    public function autenticate(
        AuthenticationRequest $request,
        string $tenant,
        string $issuer,
        string $csid,
        string $state,
        string $nonce,
        AuthorizedChalleges $challenges,
        mixed $body
    ): PublicLoginAuthResponse {
        $password = $this->securer->decrypt($body["password"]);
        $challenges->username = $body['username'];
        return $this->publicLogin->autenticate($request, $challenges, $tenant, $body['username'], $password, $issuer, $csid, $state, $nonce);
    }
}
