<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Authentication\Infrastructure\Driver\Html\Services;

use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Shared\Security\AesCypherService;
use Civi\Lughauth\Features\Access\Oidc\Session\Domain\Gateway\TemporalKeysGateway;

class HtmlSecurer
{
    private readonly string $assetsPath;

    public function __construct(
        AppConfig $config,
        Context $context,
        private readonly AesCypherService $cipher,
        private readonly TemporalKeysGateway $keys
    ) {
        $this->assetsPath = $config->get('oidc.assets.path', $context->getBaseUrl() . '/oauth/assets/');
    }

    public function verifyToken(string $token): ?string
    {
        return $this->keys->verifyToken($token);
    }

    public function addSignAndSend(string $name, string $form)
    {
        return $this->addSignCode($name, true, $form);
    }

    public function addSign(string $name)
    {
        return $this->addSignCode($name, false, '');
    }

    public function encrypt(string $value): string
    {
        return $this->keys->encrypt($value);
    }

    public function decrypt(string $value): string
    {
        return $this->keys->verifyCypher($value);
    }

    public function focusOn(string $name): Snipped
    {
        return new Snipped(code: "document.getElementById('" . $name . "').focus();", dependecies: []);
    }

    public function autoSubmit(string $form): Snipped
    {
        return new Snipped(code: "document.getElementById('".$form."').submit();", dependecies: []);
    }

    public function cypher(array $fields, string $form)
    {
        $secret = $this->keys->currentKey();
        $group = "";
        foreach ($fields as $field) {
            $uid = "q" . uniqid();
            $group .= ""
                . "let plainPassword" . $uid . " = document.getElementById('" . $field['from']
                . "').value;" . "  let encryptedPassword" . $uid . " = await encrypt(plainPassword"
                . $uid . ", '" . $secret . "');"
                . "  document.getElementById('"
                . $field['from'] . "').value = '';"
                . "document.getElementById('"
                . $field['to'] . "').value = encryptedPassword" . $uid . ";";
        }
        return new Snipped(code: "document.getElementById('" . $form
            . "').addEventListener('submit', async function(event) {"
            . "event.preventDefault();"
            . $group
            . 'event.target.submit();'
            . " });", dependecies: ["oauth.min.js"]);
    }

    public function configureScripts(array $spnippeds): string
    {
        $imp = "";
        $code = "";
        foreach ($spnippeds as $snipped) {
            if (is_string($snipped)) {
                $code .= $snipped;
            } else {
                if ($snipped->dependecies) {
                    foreach ($snipped->dependecies as $dep) {
                        $row = "<script src=\"" . $this->assetsPath . $dep . "\"></script>";
                        if (false === strpos($imp, $row)) {
                            $imp .= $row;
                        }
                    }
                }
                if (false === strpos($code, $snipped->code)) {
                    $code .= $snipped->code;
                }
            }
        }
        return "" . $imp. "<script>"
            . "document.addEventListener('DOMContentLoaded', async function(event) {" . $code . "});"
            . "</script>";
    }

    private function addSignCode(string $name, bool $send, string $form): mixed
    {
        $secret = $this->keys->currentKey();
        return new Snipped(
            code: ""
                . "  document.getElementById(\"" . $name . "\").value = await signToken('".$secret."');"
                . ($send ? "document.getElementById(\"" . $form . "\").submit();" : ""),
            dependecies: ["jsrsasign-jwths-min.js", "oauth.min.js"]
        );
    }
}

class Snipped
{
    public function __construct(
        public readonly string $code,
        public readonly array $dependecies
    ) {
    }
}
