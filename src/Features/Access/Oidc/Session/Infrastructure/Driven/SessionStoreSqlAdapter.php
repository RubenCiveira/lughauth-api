<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Session\Infrastructure\Driven;

use PDO;
use Override;
use DateInterval;
use DateTimeImmutable;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthorizedChalleges;
use Civi\Lughauth\Features\Access\Oidc\Client\Domain\ClientData;
use Civi\Lughauth\Features\Access\Oidc\Session\Domain\Gateway\SessionStoreRepository;
use Civi\Lughauth\Features\Access\Oidc\Session\Domain\SessionInfo;

class SessionStoreSqlAdapter implements SessionStoreRepository
{
    public function __construct(
        private readonly PDO $pdo
    ) {
        $this->clearTemp();
    }

    #[Override]
    public function loadSession(string $state): ?SessionInfo
    {
        $now = new \DateTime();
        $stmt = $this->pdo->prepare('SELECT client_id, expiration, issuer, auth_data, csid FROM _oauth_session where session = :session and expiration > :now');
        $stmt->bindValue('session', $state, PDO::PARAM_STR);
        $stmt->bindValue('now', $now->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->execute();
        $result = null;
        if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $data = (array)json_decode($row['auth_data']);
            // $now = new \DateTime();
            // $until = new \DateTime($row['expiration']);
            $result = new SessionInfo(
                csid: $row['csid'],
                issuer: $row['issuer'],
                userId: $data['userId'],
                clientId: $row['client_id'],
                withMfa: $data['withMfa'],
            );
        }
        return $result;
    }

    #[Override]
    public function saveSession(
        string $state,
        ClientData $client,
        string $issuer,
        AuthorizedChalleges $keypass,
        AuthenticationResult $validationData,
        string $csid,
        DateInterval $expiration
    ): void {
        $now = new DateTimeImmutable();

        $data = ['withMfa' => $keypass->mfa, 'userId' => $validationData->id ];
        $expires = $now->add($expiration);

        $stmt = $this->pdo->prepare('INSERT INTO _oauth_session ' .
            '(session, expiration, client_id, issuer, auth_data, csid) VALUES ' .
            '(:state, :expiration, :client, :issuer, :data, :csid)');
        $stmt->bindValue('state', $state, PDO::PARAM_STR);
        $stmt->bindValue('expiration', $expires->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('client', $client->id, PDO::PARAM_STR);
        $stmt->bindValue('issuer', $issuer, PDO::PARAM_STR);
        $stmt->bindValue('data', json_encode($data), PDO::PARAM_STR);
        $stmt->bindValue('csid', $csid, PDO::PARAM_STR);
        $stmt->execute();
    }

    #[Override]
    public function updateSession(string $newState, string $oldState)
    {
        $stmt = $this->pdo->prepare('UPDATE _oauth_session set session = :old, expiration = :new where session = :old');
        $stmt->bindValue('old', $newState, PDO::PARAM_STR);
        $stmt->bindValue('new', $oldState, PDO::PARAM_STR);
        $stmt->execute();
    }

    #[Override]
    public function deleteSession(String $state)
    {
        $stmt = $this->pdo->prepare('DELETE FROM _oauth_session where session = :session');
        $stmt->bindValue('session', $state, PDO::PARAM_STR);
        $stmt->execute();
    }

    private function clearTemp()
    {
        $now = new \DateTimeImmutable();
        $stmt = $this->pdo->prepare('DELETE FROM _oauth_session where expiration < :expiration');
        $stmt->bindValue('expiration', $now->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->execute();
    }
}
