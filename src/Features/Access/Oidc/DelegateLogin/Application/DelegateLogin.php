<?php

/* @autogenerated */

namespace Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Application;

use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Civi\Lughauth\Shared\Context;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationRequest;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\DelegatedLoginEndpoint;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\Gateway\DelegateLoginGateway;

class DelegateLogin
{
    public function __construct(
        private readonly Context $context,
        private readonly DelegateLoginGateway $delegate
    ) {
    }

    public function providers(string $tenant): array
    {
        return $this->delegate->providers($tenant);
    }

    public function redirectToTenant(string $directory, string $path, ServerRequestInterface $request, ResponseInterface $response): ResponseInterface
    {
        $params = $request->getQueryParams();
        $state = $params['state'];
        $info = json_decode(base64_decode($state), true);
        $tenant = $info['tenant'] ?? null;
        unset($info['tenant']);
        $info['step'] = 'delegated-login';
        $info['provider-data'] = base64_encode(json_encode($params));

        $url = $this->context->getBaseUrl() . $directory . $tenant . $path;

        $queryString = http_build_query($info);
        // Comprobamos si la URL ya tiene parÃ¡metros
        $separator = parse_url($url, PHP_URL_QUERY) ? '&' : '?';
        // Concatenamos
        $finalUrl = $url . $separator . $queryString;
        return $response->withHeader('Location', $finalUrl)->withStatus(302);
    }

    public function validateRedirection(string $route, string $providerId, string $data, string $tenant, AuthenticationRequest $request): ?AuthenticationResult
    {
        $info = json_decode(base64_decode($data), true);
        $provider =  $this->delegate->getProvider($tenant, $providerId);
        $clientData = $provider->authorize($this->context->getBaseUrl() . $route, $info);
        return  $clientData ? $this->delegate->save($tenant, $request, $clientData, $providerId) : null;
    }

    public function getTargetEndpoint(string $route, string $tenant, string $providerId, array $data): DelegatedLoginEndpoint
    {
        $provider =  $this->delegate->getProvider($tenant, $providerId);
        $data['tenant'] = $tenant;
        $data['provider'] = $providerId;
        $state = base64_encode(json_encode($data));
        return $provider->delegeatedUrl($this->context->getBaseUrl() . $route, $state);
    }
}
