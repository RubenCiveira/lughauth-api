<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Infrastructure\Provider;

use Override;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\DelegatedLoginEndpoint;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\DelegatedLoginProvider;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\DelegatedProviderDescription;
use Civi\Lughauth\Features\Access\Oidc\DelegateLogin\Domain\DelegatedUserData;
use Civi\Lughauth\Shared\AppConfig;
use Civi\Lughauth\Shared\Context;
use League\OAuth2\Client\Provider\Google;
use League\OAuth2\Client\Provider\Exception\IdentityProviderException;

class GoogleOAuthProvider implements DelegatedLoginProvider
{
    private readonly string $assetsPath;

    public function __construct(
        AppConfig $config,
        Context $context,
        private readonly string $id,
        private readonly string $clientId,
        private readonly string $secretId
    ) {
        $this->assetsPath = $config->get('oidc.assets.path', $context->getBaseUrl() . '/oauth/assets/');
    }
    #[Override]
    public function info(): DelegatedProviderDescription
    {
        return new DelegatedProviderDescription(
            id: $this->id,
            name: 'Google',
            logo: $this->assetsPath . '/socials/google.png'
        );
    }
    #[Override]
    public function delegeatedUrl(string $redirect, string $state): DelegatedLoginEndpoint
    {
        if (session_status() !== PHP_SESSION_ACTIVE) {
            session_start();
        }
        $provider = new Google([
            'clientId' => $this->clientId,
            'clientSecret' => $this->secretId,
            'redirectUri' => $redirect,
            'state' => $state
        ]);
        return new DelegatedLoginEndpoint('GET', $provider->getAuthorizationUrl([
            'state' => $state
        ]));
    }

    public function authorize(string $redirect, array $request): ?DelegatedUserData
    {
        $provider = new Google([
            'clientId' => $this->clientId,
            'clientSecret' => $this->secretId,
            'redirectUri' => $redirect,
        ]);
        try {
            $token = $provider->getAccessToken('authorization_code', ['code' => $request['code']]);
            $user = $provider->getResourceOwner($token);
            $data = $user->toArray();
            return new DelegatedUserData(
                $data['sub'],
                $data['name'],
                $data['email']
            );
        } catch (IdentityProviderException $ex) {
            return null;
        }
    }
}
