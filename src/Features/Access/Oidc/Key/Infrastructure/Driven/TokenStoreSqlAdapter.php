<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\Key\Infrastructure\Driven;

use PDO;
use Override;
use Civi\Lughauth\Features\Access\Oidc\Key\Domain\KeyPair;
use Civi\Lughauth\Features\Access\Oidc\Key\Domain\Gateway\TokenStoreRepository;

class TokenStoreSqlAdapter implements TokenStoreRepository
{
    private readonly bool $useTenant;
    public function __construct(
        private readonly \PDO $pdo
    ) {
        $this->useTenant = false;
        $this->clearTemp();
    }

    #[Override]
    public function currentKey(string $tenant): ?KeyPair
    {
        if (!$this->useTenant) {
            $tenant = "-";
        }
        $since = new \DateTIme();
        $stmt = $this->pdo->prepare('SELECT keyid, private, public FROM _oauth_keys_storer WHERE expiration >= :since and since <= :since and tenant = :tenant');
        $stmt->bindValue('since', $since->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('tenant', $tenant);
        $stmt->execute();
        if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            return $this->map($row);
        } else {
            return null;
        }
    }

    #[Override]
    public function nextKeysExpiration(string $tenant): \DateTimeImmutable
    {
        if (!$this->useTenant) {
            $tenant = "-";
        }
        $since = new \DateTIme();
        $stmt = $this->pdo->prepare('SELECT MAX(expiration) as expiration FROM _oauth_keys_storer WHERE since >= :since and tenant = :tenant');
        $stmt->bindValue('since', $since->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('tenant', $tenant);
        $stmt->execute();
        if ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            return $row['expiration'] ? new \DateTimeImmutable($row['expiration']) : new \DateTimeImmutable();
        } else {
            return new \DateTimeImmutable();
        }
    }

    /**
     * return PublicKey[]
    */
    #[Override]
    public function listKeys(string $tenant): array
    {
        if (!$this->useTenant) {
            $tenant = "-";
        }
        $result = [];
        $since = new \DateTIme();
        $stmt = $this->pdo->prepare('SELECT keyid, private, public FROM _oauth_keys_storer WHERE expiration >= :since and tenant = :tenant');
        $stmt->bindValue('since', $since->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('tenant', $tenant);
        $stmt->execute();
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $result[] = $this->map($row);// new KeyPair(kid: $row['keyid'], alg: 'RS256', keyUse: 'sig', publicKey: $row['public'], privateKey: $row['private'] );
        }
        return $result;
    }

    #[Override]
    public function saveKey(string $tenant, KeyPair $pair, \DateTimeImmutable $start, \DateInterval $caducidad)
    {
        if (!$this->useTenant) {
            $tenant = "-";
        }
        $stmt = $this->pdo->prepare('INSERT INTO _oauth_keys_storer (expiration, since, keyid, private, public, tenant) VALUES (:expiration, :since, :keyid, :private, :public, :tenant)');
        $stmt->bindValue('since', $start->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('expiration', $start->add($caducidad)->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->bindValue('keyid', $pair->kid, PDO::PARAM_STR);
        $stmt->bindValue('private', $pair->privateKey, PDO::PARAM_STR);
        $stmt->bindValue('public', $pair->publicKey, PDO::PARAM_STR);
        $stmt->bindValue('tenant', $tenant, PDO::PARAM_STR);
        $stmt->execute();
    }

    private function clearTemp()
    {
        $now = new \DateTime();
        $expires = $now->sub(new \DateInterval('PT1H'));
        $stmt = $this->pdo->prepare('DELETE FROM _oauth_keys_storer WHERE expiration < :expiration');
        $stmt->bindValue('expiration', $expires->format('Y-m-d H:i:s'), PDO::PARAM_STR);
        $stmt->execute();
    }

    private function map($row): KeyPair
    {
        return new KeyPair(kid: $row['keyid'], alg: 'RS256', keyUse: 'sig', publicKey: $row['public'], privateKey: $row['private']);
    }
}
