<?php

/* @autogenerated */
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Oidc\User\Infrastructure\Driven;

use Override;
use DateInterval;
use DateTimeImmutable;
use Civi\Lughauth\Shared\Value\Random;
use Civi\Lughauth\Shared\Security\AesCypherService;
use Civi\Lughauth\Features\Access\Master\User\Domain\Gateway\UserWriteGateway;
use Civi\Lughauth\Features\Access\Master\UserAccessTemporalCode\Domain\Gateway\UserAccessTemporalCodeWriteGateway;
use Civi\Lughauth\Features\Access\Master\TenantConfig\Domain\Gateway\TenantConfigReadGateway;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\AuthenticationResult;
use Civi\Lughauth\Features\Access\Oidc\Authentication\Domain\Exception\LoginException;
use Civi\Lughauth\Features\Access\Oidc\Common\Infrastructure\Driven\UserLoaderAdapter;
use Civi\Lughauth\Features\Access\Oidc\User\Domain\Gateway\ChangePasswordRepository;

class ChangePasswordAdapter implements ChangePasswordRepository
{
    public function __construct(
        private readonly UserLoaderAdapter $users,
        private readonly TenantConfigReadGateway $configs,
        private readonly UserWriteGateway $repository,
        private readonly UserAccessTemporalCodeWriteGateway $codes,
        private readonly AesCypherService $cypher,
        private readonly Random $randomizer,
    ) {
    }

    #[Override]
    public function requestForChange(string $url, string $tenant, string $username): void
    {
        $verify = md5($this->randomizer->comb());
        try {
            $theTenant = $this->users->checkTenant($tenant, $username);
            $theUser = $this->users->checkUserNameOrEmail($theTenant, $username);
            $code = $this->users->userCodeForUpdate($theUser);
            $this->users->updateCode($code->generatePasswordRecover(str_ends_with($url, '=') ? $url . $verify : $url, $verify, new DateTimeImmutable()->add(new DateInterval("P1D"))));
        } catch (LoginException $_le) {
            // User or tenant dont exists...
        }
    }
    #[Override]
    public function allowRecover(string $tenant): bool
    {
        $theTenant = $this->users->checkTenant($tenant, '-');
        $conf = $this->configs->findOneByTenant($theTenant);
        return ($conf && $conf->isAllowRecoverPass());
    }
    #[Override]
    public function validateChangeRequest(string $tenant, string $code, string $newPass): ?string
    {
        $theTenant = $this->users->checkTenant($tenant, $code);
        [$user, $userCode] = $this->users->checkUserByRecoveryCode($theTenant, $code);
        if ($code !== $userCode->getRecoveryCode()) {
            return null;
        }
        $this->codes->update($userCode, $userCode->resetPasswordRecover());
        $this->repository->update($user, $user->changePassword($this->cypher, $newPass));
        return $user->getName();
    }

    #[Override]
    public function forceUpdatePassword(string $tenant, string $username, string $oldPass, string $newPass): bool
    {
        $theTenant = $this->users->checkTenant($tenant, $username);
        $theUser = $this->users->checkUser($theTenant, $username);
        if ($oldPass !== $theUser->getPlainPassword($this->cypher)) {
            throw new LoginException(AuthenticationResult::newPasswordRequired('wrong_old_pass'));
        }
        $changed = $theUser->changePassword($this->cypher, $newPass);
        return !!$this->repository->update($theUser, $changed);
    }
}
