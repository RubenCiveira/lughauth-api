<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityAllowController;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityListController;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityCreateController;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityRetrieveController;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityUpdateController;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driver\Rest\TenantPartySecurityDeleteController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Service\Visibility\TenantPartySecurityRestrictFilterToVisibility;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Filter\TenantAccesible;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Fields\TenantPartySecurityExcludingdRoot;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Service\Visibility\TenantPartySecurityCollectNonEditableFields;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Usecase\Create\TenantPartySecurityCreateAllowDecision;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Usecase\Update\TenantPartySecurityUpdateAllowDecision;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Usecase\Retrieve\TenantPartySecurityRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Usecase\List\TenantPartySecurityListAllowDecision;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Application\Usecase\Delete\TenantPartySecurityDeleteAllowDecision;
use Civi\Lughauth\Features\Access\TenantPartySecurity\Infrastructure\Driven\TenantPartySecurityChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class TenantPartySecurityPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/tenant-party-security', [$this, 'setRoutesForTenantPartySecurity']);
        $app->group('/api/me/acl/tenant-party-security', [$this, 'setRoutesForTenantPartySecurityAcl']);
        $app->group('/api/access/tenant-party-security', [$this, 'setRoutesForTenantPartySecurity']);
        $app->group('/api/me/acl/access/tenant-party-security', [$this, 'setRoutesForTenantPartySecurityAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(TenantPartySecurityRestrictFilterToVisibility::class, TenantAccesible::class);
        $bus->registerListener(TenantPartySecurityCollectNonEditableFields::class, TenantPartySecurityExcludingdRoot::class);
        $bus->registerListener(TenantPartySecurityCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(TenantPartySecurityUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(TenantPartySecurityRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(TenantPartySecurityListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(TenantPartySecurityDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, TenantPartySecurityChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("tenant-party-security", "list", "READ");
            $handler->registerResourceAction("tenant-party-security", "create", "WRITE");
            $handler->registerResourceAction("tenant-party-security", "retrieve", "READ");
            $handler->registerResourceAction("tenant-party-security", "update", "WRITE");
            $handler->registerResourceAction("tenant-party-security", "delete", "WRITE");

            $handler->registerResourceAttribute("tenant-party-security", "tenant", "MANAGE");
            $handler->registerResourceAttribute("tenant-party-security", "relyingParty", "MANAGE");
            $handler->registerResourceAttribute("tenant-party-security", "policies", "MANAGE");
            $handler->registerResourceAttribute("tenant-party-security", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForTenantPartySecurityAcl(RouteCollectorProxy $tenantPartySecurityGroup)
    {
        $tenantPartySecurityGroup->get('', [TenantPartySecurityAllowController::class, 'genericAllow']);
        $tenantPartySecurityGroup->get('/{uid}', [TenantPartySecurityAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForTenantPartySecurity(RouteCollectorProxy $tenantPartySecurityGroup)
    {
        $tenantPartySecurityGroup->get('', [TenantPartySecurityListController::class, 'list']);
        $tenantPartySecurityGroup->post('', [TenantPartySecurityCreateController::class, 'create']);
        $tenantPartySecurityGroup->get('/{uid}', [TenantPartySecurityRetrieveController::class, 'retrieve']);
        $tenantPartySecurityGroup->put('/{uid}', [TenantPartySecurityUpdateController::class, 'update']);
        $tenantPartySecurityGroup->delete('/{uid}', [TenantPartySecurityDeleteController::class, 'delete']);
        $tenantPartySecurityGroup->delete('', [TenantPartySecurityDeleteController::class, 'deleteAllForQuery']);
        $tenantPartySecurityGroup->get('/~/delete-status/{uid}', [TenantPartySecurityDeleteController::class, 'checkDeleteAllForQueryStatus']);
    }
}
