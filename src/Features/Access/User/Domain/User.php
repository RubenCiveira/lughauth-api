<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\User\Domain;

use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserUidVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserTenantVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserTenantAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserNameVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserNameAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserPasswordVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserPasswordAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserEmailVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserEmailAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserEnabledVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserEnabledAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserTemporalPasswordVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserTemporalPasswordAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserUseSecondFactorsVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserUseSecondFactorsAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserSecondFactorSeedVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserSecondFactorSeedAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserTempSecondFactorSeedVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserTempSecondFactorSeedAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserFailedLoginAttemptsVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserFailedLoginAttemptsAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserBlockedUntilVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserBlockedUntilAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserRecoveryCodeVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserRecoveryCodeAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserRecoveryCodeExpirationVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserRecoveryCodeExpirationAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserLanguageVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserLanguageAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserProviderVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserProviderAccesor;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\UserVersionVO;
use Civi\Lughauth\Features\Access\User\Domain\ValueObject\Accesor\UserVersionAccesor;
use Civi\Lughauth\Features\Access\User\Domain\Formula\EnabledCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\SecondFactorSeedCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\TempSecondFactorSeedCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\FailedLoginAttemptsCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\BlockedUntilCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\RecoveryCodeCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\RecoveryCodeExpirationCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Formula\ProviderCalculator;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserCreateEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserUpdateEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserDeleteEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserDisableEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserEnableEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserUnlockEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserBlockEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserSetMfaSeedEvent;
use Civi\Lughauth\Features\Access\User\Domain\Event\UserChangePasswordEvent;
use Civi\Lughauth\Features\Access\Tenant\Domain\TenantRef;
use Civi\Lughauth\Shared\Security\AesCypherService;

class User extends UserRef
{
    use UserTenantAccesor;
    use UserNameAccesor;
    use UserPasswordAccesor;
    use UserEmailAccesor;
    use UserEnabledAccesor;
    use UserTemporalPasswordAccesor;
    use UserUseSecondFactorsAccesor;
    use UserSecondFactorSeedAccesor;
    use UserTempSecondFactorSeedAccesor;
    use UserFailedLoginAttemptsAccesor;
    use UserBlockedUntilAccesor;
    use UserRecoveryCodeAccesor;
    use UserRecoveryCodeExpirationAccesor;
    use UserLanguageAccesor;
    use UserProviderAccesor;
    use UserVersionAccesor;
    private array $recordedEvents = [];

    public function __construct(
        UserUidVO|string $uid,
        UserTenantVO|TenantRef $tenant,
        UserNameVO|string $name,
        UserPasswordVO|string $password,
        UserEmailVO|string|null $email = null,
        UserEnabledVO|bool|null $enabled = null,
        UserTemporalPasswordVO|bool|null $temporalPassword = null,
        UserUseSecondFactorsVO|bool|null $useSecondFactors = null,
        UserSecondFactorSeedVO|string|null $secondFactorSeed = null,
        UserTempSecondFactorSeedVO|string|null $tempSecondFactorSeed = null,
        UserFailedLoginAttemptsVO|int|null $failedLoginAttempts = null,
        UserBlockedUntilVO|\DateTimeImmutable|null $blockedUntil = null,
        UserRecoveryCodeVO|string|null $recoveryCode = null,
        UserRecoveryCodeExpirationVO|\DateTimeImmutable|null $recoveryCodeExpiration = null,
        UserLanguageVO|string|null $language = null,
        UserProviderVO|string|null $provider = null,
        UserVersionVO|int|null $version = null,
    ) {
        parent::__construct($uid);
        $this->_tenant = UserTenantVO::from($tenant);
        $this->_name = UserNameVO::from($name);
        $this->_password = UserPasswordVO::from($password);
        $this->_email = null === $email ? UserEmailVO::empty() : UserEmailVO::from($email);
        $this->_enabled = null === $enabled ? UserEnabledVO::empty() : UserEnabledVO::from($enabled);
        $this->_temporalPassword = null === $temporalPassword ? UserTemporalPasswordVO::empty() : UserTemporalPasswordVO::from($temporalPassword);
        $this->_useSecondFactors = null === $useSecondFactors ? UserUseSecondFactorsVO::empty() : UserUseSecondFactorsVO::from($useSecondFactors);
        $this->_secondFactorSeed = null === $secondFactorSeed ? UserSecondFactorSeedVO::empty() : UserSecondFactorSeedVO::from($secondFactorSeed);
        $this->_tempSecondFactorSeed = null === $tempSecondFactorSeed ? UserTempSecondFactorSeedVO::empty() : UserTempSecondFactorSeedVO::from($tempSecondFactorSeed);
        $this->_failedLoginAttempts = null === $failedLoginAttempts ? UserFailedLoginAttemptsVO::empty() : UserFailedLoginAttemptsVO::from($failedLoginAttempts);
        $this->_blockedUntil = null === $blockedUntil ? UserBlockedUntilVO::empty() : UserBlockedUntilVO::from($blockedUntil);
        $this->_recoveryCode = null === $recoveryCode ? UserRecoveryCodeVO::empty() : UserRecoveryCodeVO::from($recoveryCode);
        $this->_recoveryCodeExpiration = null === $recoveryCodeExpiration ? UserRecoveryCodeExpirationVO::empty() : UserRecoveryCodeExpirationVO::from($recoveryCodeExpiration);
        $this->_language = null === $language ? UserLanguageVO::empty() : UserLanguageVO::from($language);
        $this->_provider = null === $provider ? UserProviderVO::empty() : UserProviderVO::from($provider);
        $this->_version = null === $version ? UserVersionVO::empty() : UserVersionVO::from($version);
    }
    public function replace(UserAttributes $values): User
    {
        $value = clone $this;
        $value->_tenant = $values->getTenantOrDefault($this->_tenant);
        $value->_name = $values->getNameOrDefault($this->_name);
        $value->_password = $values->getPasswordOrDefault($this->_password);
        $value->_email = $values->getEmailOrDefault($this->_email);
        $value->_enabled = $values->getEnabledOrDefault($this->_enabled);
        $value->_temporalPassword = $values->getTemporalPasswordOrDefault($this->_temporalPassword);
        $value->_useSecondFactors = $values->getUseSecondFactorsOrDefault($this->_useSecondFactors);
        $value->_secondFactorSeed = $values->getSecondFactorSeedOrDefault($this->_secondFactorSeed);
        $value->_tempSecondFactorSeed = $values->getTempSecondFactorSeedOrDefault($this->_tempSecondFactorSeed);
        $value->_failedLoginAttempts = $values->getFailedLoginAttemptsOrDefault($this->_failedLoginAttempts);
        $value->_blockedUntil = $values->getBlockedUntilOrDefault($this->_blockedUntil);
        $value->_recoveryCode = $values->getRecoveryCodeOrDefault($this->_recoveryCode);
        $value->_recoveryCodeExpiration = $values->getRecoveryCodeExpirationOrDefault($this->_recoveryCodeExpiration);
        $value->_language = $values->getLanguageOrDefault($this->_language);
        $value->_provider = $values->getProviderOrDefault($this->_provider);
        $value->_version = $values->getVersionOrDefault($this->_version);
        return $value;
    }
    public static function calculatedFields(): array
    {
        return [ 'enabled', 'secondFactorSeed', 'tempSecondFactorSeed', 'failedLoginAttempts', 'blockedUntil', 'recoveryCode', 'recoveryCodeExpiration', 'provider'];
    }
    public static function create(UserAttributes $values): User
    {
        $calculated = clone $values;
        $calculated->enabled(EnabledCalculator::calculateEnabled());
        $calculated->secondFactorSeed(SecondFactorSeedCalculator::calculateSecondFactorSeed());
        $calculated->tempSecondFactorSeed(TempSecondFactorSeedCalculator::calculateTempSecondFactorSeed());
        $calculated->failedLoginAttempts(FailedLoginAttemptsCalculator::calculateFailedLoginAttempts());
        $calculated->blockedUntil(BlockedUntilCalculator::calculateBlockedUntil());
        $calculated->recoveryCode(RecoveryCodeCalculator::calculateRecoveryCode());
        $calculated->recoveryCodeExpiration(RecoveryCodeExpirationCalculator::calculateRecoveryCodeExpiration());
        $calculated->provider(ProviderCalculator::calculateProvider());
        $value = $calculated->build();
        $value->recordedEvents[] = new UserCreateEvent($value);
        return $value;
    }
    public function update(UserAttributes $values): User
    {
        $calculated = clone $values;
        $calculated->enabled(EnabledCalculator::calculateEnabled($this));
        $calculated->secondFactorSeed(SecondFactorSeedCalculator::calculateSecondFactorSeed($this));
        $calculated->tempSecondFactorSeed(TempSecondFactorSeedCalculator::calculateTempSecondFactorSeed($this));
        $calculated->failedLoginAttempts(FailedLoginAttemptsCalculator::calculateFailedLoginAttempts($this));
        $calculated->blockedUntil(BlockedUntilCalculator::calculateBlockedUntil($this));
        $calculated->recoveryCode(RecoveryCodeCalculator::calculateRecoveryCode($this));
        $calculated->recoveryCodeExpiration(RecoveryCodeExpirationCalculator::calculateRecoveryCodeExpiration($this));
        $calculated->provider(ProviderCalculator::calculateProvider($this));
        $value = $this->replace($calculated);
        $value->recordedEvents[] = new UserUpdateEvent($value);
        return $value;
    }
    public function delete(): User
    {
        $value = clone $this;
        $value->recordedEvents[] = new UserDeleteEvent($value);
        return $value;
    }
    public function disable(): User
    {
        $value = clone $this;
        $value->_enabled = UserEnabledVO::from(false);
        $value->recordedEvents[] = new UserDisableEvent(payload: $value);
        return $value;
    }
    public function enable(): User
    {
        $value = clone $this;
        $value->_enabled = UserEnabledVO::from(true);
        $value->recordedEvents[] = new UserEnableEvent(payload: $value);
        return $value;
    }
    public function unlock(): User
    {
        $value = clone $this;
        $value->_blockedUntil = UserBlockedUntilVO::from(null);
        $value->recordedEvents[] = new UserUnlockEvent(payload: $value);
        return $value;
    }
    public function block(\DateTimeImmutable|null $blockedUntil): User
    {
        $value = clone $this;
        $value->_blockedUntil = UserBlockedUntilVO::from($blockedUntil);
        $value->recordedEvents[] = new UserBlockEvent(payload: $value);
        return $value;
    }
    public function setMfaSeed(AesCypherService $cypher, string|null $secondFactorSeed): User
    {
        $value = clone $this;
        $value->_secondFactorSeed = UserSecondFactorSeedVO::fromPlainText($cypher, $secondFactorSeed);
        $value->_useSecondFactors = UserUseSecondFactorsVO::from(true);
        $value->recordedEvents[] = new UserSetMfaSeedEvent(payload: $value);
        return $value;
    }
    public function changePassword(AesCypherService $cypher, string $password): User
    {
        $value = clone $this;
        $value->_password = UserPasswordVO::fromPlainText($cypher, $password);
        $value->_temporalPassword = UserTemporalPasswordVO::from(false);
        $value->recordedEvents[] = new UserChangePasswordEvent(payload: $value);
        return $value;
    }
    public function toAttributes(): UserAttributes
    {
        return (new UserAttributes())
          ->uid($this->uid())
          ->tenant($this->_tenant)
          ->name($this->_name)
          ->password($this->_password)
          ->email($this->_email)
          ->enabled($this->_enabled)
          ->temporalPassword($this->_temporalPassword)
          ->useSecondFactors($this->_useSecondFactors)
          ->secondFactorSeed($this->_secondFactorSeed)
          ->tempSecondFactorSeed($this->_tempSecondFactorSeed)
          ->failedLoginAttempts($this->_failedLoginAttempts)
          ->blockedUntil($this->_blockedUntil)
          ->recoveryCode($this->_recoveryCode)
          ->recoveryCodeExpiration($this->_recoveryCodeExpiration)
          ->language($this->_language)
          ->provider($this->_provider)
          ->version($this->_version);
    }
    public function getTheEvents(): array
    {
        return [...$this->recordedEvents];
    }
}
