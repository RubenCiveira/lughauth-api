<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\User\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserAllowController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserListController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserCreateController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserRetrieveController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserUpdateController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserDeleteController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserDisableController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserEnableController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserUnlockController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserAcceptController;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driver\Rest\UserRejectController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\User\Application\Service\Visibility\UserRestrictFilterToVisibility;
use Civi\Lughauth\Features\Access\User\Application\Policy\Filter\TenantAccesible;
use Civi\Lughauth\Features\Access\User\Application\Policy\Fields\UserExcludingdRoot;
use Civi\Lughauth\Features\Access\User\Application\Service\Visibility\UserCollectNonEditableFields;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Create\UserCreateAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Create\CreateUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Update\UserUpdateAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Update\UpdateUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Retrieve\UserRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Retrieve\RetrieveUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\List\ListUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\List\UserListAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Delete\UserDeleteAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Delete\DeleteUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Disable\DisableUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Disable\UserDisableAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Disable\IsAutenticatedDisableAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Enable\IsAutenticatedEnableAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Enable\UserEnableAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Enable\EnableUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Unlock\UnlockUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Unlock\UserUnlockAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Unlock\IsAutenticatedUnlockAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Accept\IsAutenticatedAcceptAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Accept\UserAcceptAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Accept\AcceptUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Reject\RejectUserOnlyForRootAllow;
use Civi\Lughauth\Features\Access\User\Application\Usecase\Reject\UserRejectAllowDecision;
use Civi\Lughauth\Features\Access\User\Application\Policy\Allow\Reject\IsAutenticatedRejectAllow;
use Civi\Lughauth\Features\Access\User\Infrastructure\Driven\UserChangelogSync;
use Civi\Lughauth\Shared\Infrastructure\EntityChangeLog\EntityChangeLogSyncEvent;

class UserPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/access/users', [$this, 'setRoutesForUser']);
        $app->group('/api/me/acl/access/users', [$this, 'setRoutesForUserAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(UserRestrictFilterToVisibility::class, TenantAccesible::class);
        $bus->registerListener(UserCollectNonEditableFields::class, UserExcludingdRoot::class);
        $bus->registerListener(UserCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(UserCreateAllowDecision::class, CreateUserOnlyForRootAllow::class);
        $bus->registerListener(UserUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(UserUpdateAllowDecision::class, UpdateUserOnlyForRootAllow::class);
        $bus->registerListener(UserRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(UserRetrieveAllowDecision::class, RetrieveUserOnlyForRootAllow::class);
        $bus->registerListener(UserListAllowDecision::class, ListUserOnlyForRootAllow::class);
        $bus->registerListener(UserListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(UserDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(UserDeleteAllowDecision::class, DeleteUserOnlyForRootAllow::class);
        $bus->registerListener(UserDisableAllowDecision::class, DisableUserOnlyForRootAllow::class);
        $bus->registerListener(UserDisableAllowDecision::class, IsAutenticatedDisableAllow::class);
        $bus->registerListener(UserEnableAllowDecision::class, IsAutenticatedEnableAllow::class);
        $bus->registerListener(UserEnableAllowDecision::class, EnableUserOnlyForRootAllow::class);
        $bus->registerListener(UserUnlockAllowDecision::class, UnlockUserOnlyForRootAllow::class);
        $bus->registerListener(UserUnlockAllowDecision::class, IsAutenticatedUnlockAllow::class);
        $bus->registerListener(UserAcceptAllowDecision::class, IsAutenticatedAcceptAllow::class);
        $bus->registerListener(UserAcceptAllowDecision::class, AcceptUserOnlyForRootAllow::class);
        $bus->registerListener(UserRejectAllowDecision::class, RejectUserOnlyForRootAllow::class);
        $bus->registerListener(UserRejectAllowDecision::class, IsAutenticatedRejectAllow::class);
        $bus->registerListener(EntityChangeLogSyncEvent::class, UserChangelogSync::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("user", "list", "READ");
            $handler->registerResourceAction("user", "create", "WRITE");
            $handler->registerResourceAction("user", "retrieve", "READ");
            $handler->registerResourceAction("user", "update", "WRITE");
            $handler->registerResourceAction("user", "delete", "WRITE");
            $handler->registerResourceAction("user", "accept", "WRITE");
            $handler->registerResourceAction("user", "reject", "WRITE");
            $handler->registerResourceAction("user", "disable", "WRITE");
            $handler->registerResourceAction("user", "enable", "WRITE");
            $handler->registerResourceAction("user", "unlock", "WRITE");

            $handler->registerResourceAttribute("user", "tenant", "MANAGE");
            $handler->registerResourceAttribute("user", "name", "MANAGE");
            $handler->registerResourceAttribute("user", "password", "MANAGE");
            $handler->registerResourceAttribute("user", "email", "MANAGE");
            $handler->registerResourceAttribute("user", "wellcomeAt", "MANAGE");
            $handler->registerResourceAttribute("user", "enabled", "MANAGE");
            $handler->registerResourceAttribute("user", "approve", "MANAGE");
            $handler->registerResourceAttribute("user", "temporalPassword", "MANAGE");
            $handler->registerResourceAttribute("user", "useSecondFactors", "MANAGE");
            $handler->registerResourceAttribute("user", "secondFactorSeed", "MANAGE");
            $handler->registerResourceAttribute("user", "blockedUntil", "MANAGE");
            $handler->registerResourceAttribute("user", "provider", "MANAGE");
            $handler->registerResourceAttribute("user", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForUserAcl(RouteCollectorProxy $userGroup)
    {
        $userGroup->get('', [UserAllowController::class, 'genericAllow']);
        $userGroup->get('/{uid}', [UserAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForUser(RouteCollectorProxy $userGroup)
    {
        $userGroup->get('', [UserListController::class, 'list']);
        $userGroup->post('', [UserCreateController::class, 'create']);
        $userGroup->get('/{uid}', [UserRetrieveController::class, 'retrieve']);
        $userGroup->put('/{uid}', [UserUpdateController::class, 'update']);
        $userGroup->delete('/{uid}', [UserDeleteController::class, 'delete']);
        $userGroup->delete('', [UserDeleteController::class, 'deleteAllForQuery']);
        $userGroup->get('/~/delete-status/{uid}', [UserDeleteController::class, 'checkDeleteAllForQueryStatus']);
        $userGroup->patch('/~/disable', [UserDisableController::class, 'disableAllForQuery']);
        $userGroup->patch('/{uid}/disable', [UserDisableController::class, 'disable']);
        $userGroup->get('/~/disable-status/{uid}', [UserDisableController::class, 'checkDisableAllForQueryStatus']);
        $userGroup->patch('/~/enable', [UserEnableController::class, 'enableAllForQuery']);
        $userGroup->patch('/{uid}/enable', [UserEnableController::class, 'enable']);
        $userGroup->get('/~/enable-status/{uid}', [UserEnableController::class, 'checkEnableAllForQueryStatus']);
        $userGroup->patch('/~/unlock', [UserUnlockController::class, 'unlockAllForQuery']);
        $userGroup->patch('/{uid}/unlock', [UserUnlockController::class, 'unlock']);
        $userGroup->get('/~/unlock-status/{uid}', [UserUnlockController::class, 'checkUnlockAllForQueryStatus']);
        $userGroup->patch('/~/accept', [UserAcceptController::class, 'acceptAllForQuery']);
        $userGroup->patch('/{uid}/accept', [UserAcceptController::class, 'accept']);
        $userGroup->get('/~/accept-status/{uid}', [UserAcceptController::class, 'checkAcceptAllForQueryStatus']);
        $userGroup->patch('/~/reject', [UserRejectController::class, 'rejectAllForQuery']);
        $userGroup->patch('/{uid}/reject', [UserRejectController::class, 'reject']);
        $userGroup->get('/~/reject-status/{uid}', [UserRejectController::class, 'checkRejectAllForQueryStatus']);
    }
}
