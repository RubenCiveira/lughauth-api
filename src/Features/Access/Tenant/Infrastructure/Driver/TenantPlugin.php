<?php

# @autogenerated
declare(strict_types=1);

namespace Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver;

use Psr\Container\ContainerInterface;
use Override;
use Slim\Routing\RouteCollectorProxy;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantAllowController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantListController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantCreateController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantRetrieveController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantUpdateController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantDeleteController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantEnableController;
use Civi\Lughauth\Features\Access\Tenant\Infrastructure\Driver\Rest\TenantDisableController;
use Civi\Lughauth\Shared\Security\Rbac\Handler;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin;
use Civi\Lughauth\Shared\Infrastructure\MicroPlugin\GenericSecurityPlugin;
use Civi\Lughauth\Shared\Infrastructure\StartupProcessor;
use Civi\Lughauth\Shared\Event\EventListenersRegistrarInterface;
use Civi\Lughauth\Features\Access\Tenant\Application\Service\Visibility\TenantRestrictFilterToVisibility;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Filter\TenantAccesible;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Create\IsAutenticatedCreateAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Create\TenantCreateAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Create\CreateTenantOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Update\IsAutenticatedUpdateAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Update\TenantUpdateAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Update\UpdateTenantOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Retrieve\IsAutenticatedRetrieveAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Retrieve\TenantRetrieveAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\List\IsAutenticatedListAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\List\TenantListAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Delete\IsAutenticatedDeleteAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Delete\TenantDeleteAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Delete\DeleteTenantOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Enable\IsAutenticatedEnableAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Enable\TenantEnableAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Enable\EnableTenantOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Disable\DisableTenantOnlyForRootAllow;
use Civi\Lughauth\Features\Access\Tenant\Application\Usecase\Disable\TenantDisableAllowDecision;
use Civi\Lughauth\Features\Access\Tenant\Application\Policy\Allow\Disable\IsAutenticatedDisableAllow;

class TenantPlugin extends MicroPlugin
{
    #[Override]
    public function registerRoutes(RouteCollectorProxy $app)
    {
        $app->group('/api/access/tenants', [$this, 'setRoutesForTenant']);
        $app->group('/api/me/acl/access/tenants', [$this, 'setRoutesForTenantAcl']);
    }
    #[Override]
    public function registerEvents(EventListenersRegistrarInterface $bus)
    {
        $bus->registerListener(TenantRestrictFilterToVisibility::class, TenantAccesible::class);
        $bus->registerListener(TenantCreateAllowDecision::class, IsAutenticatedCreateAllow::class);
        $bus->registerListener(TenantCreateAllowDecision::class, CreateTenantOnlyForRootAllow::class);
        $bus->registerListener(TenantUpdateAllowDecision::class, IsAutenticatedUpdateAllow::class);
        $bus->registerListener(TenantUpdateAllowDecision::class, UpdateTenantOnlyForRootAllow::class);
        $bus->registerListener(TenantRetrieveAllowDecision::class, IsAutenticatedRetrieveAllow::class);
        $bus->registerListener(TenantListAllowDecision::class, IsAutenticatedListAllow::class);
        $bus->registerListener(TenantDeleteAllowDecision::class, IsAutenticatedDeleteAllow::class);
        $bus->registerListener(TenantDeleteAllowDecision::class, DeleteTenantOnlyForRootAllow::class);
        $bus->registerListener(TenantEnableAllowDecision::class, IsAutenticatedEnableAllow::class);
        $bus->registerListener(TenantEnableAllowDecision::class, EnableTenantOnlyForRootAllow::class);
        $bus->registerListener(TenantDisableAllowDecision::class, DisableTenantOnlyForRootAllow::class);
        $bus->registerListener(TenantDisableAllowDecision::class, IsAutenticatedDisableAllow::class);
    }
    #[Override]
    public function registerStartup(StartupProcessor $processor): void
    {
        $processor->register(function (ContainerInterface $container) {
            $handler = $container->get(Handler::class);
            $handler->registerResourceAction("tenant", "list", "READ");
            $handler->registerResourceAction("tenant", "create", "WRITE");
            $handler->registerResourceAction("tenant", "retrieve", "READ");
            $handler->registerResourceAction("tenant", "update", "WRITE");
            $handler->registerResourceAction("tenant", "delete", "WRITE");
            $handler->registerResourceAction("tenant", "enable", "WRITE");
            $handler->registerResourceAction("tenant", "disable", "WRITE");

            $handler->registerResourceAttribute("tenant", "name", "MANAGE");
            $handler->registerResourceAttribute("tenant", "root", "MANAGE");
            $handler->registerResourceAttribute("tenant", "domain", "MANAGE");
            $handler->registerResourceAttribute("tenant", "enabled", "MANAGE");
            $handler->registerResourceAttribute("tenant", "markForDelete", "MANAGE");
            $handler->registerResourceAttribute("tenant", "markForDeleteTime", "MANAGE");
            $handler->registerResourceAttribute("tenant", "version", "MANAGE");
        }, StartupProcessor::before(GenericSecurityPlugin::STARTUP_ORDER));
    }
    public function setRoutesForTenantAcl(RouteCollectorProxy $tenantGroup)
    {
        $tenantGroup->get('', [TenantAllowController::class, 'genericAllow']);
        $tenantGroup->get('/{uid}', [TenantAllowController::class, 'contextualAllow']);
    }
    public function setRoutesForTenant(RouteCollectorProxy $tenantGroup)
    {
        $tenantGroup->get('', [TenantListController::class, 'list']);
        $tenantGroup->post('', [TenantCreateController::class, 'create']);
        $tenantGroup->get('/{uid}', [TenantRetrieveController::class, 'retrieve']);
        $tenantGroup->put('/{uid}', [TenantUpdateController::class, 'update']);
        $tenantGroup->delete('/{uid}', [TenantDeleteController::class, 'delete']);
        $tenantGroup->delete('', [TenantDeleteController::class, 'deleteAllForQuery']);
        $tenantGroup->get('/~/delete-status/{uid}', [TenantDeleteController::class, 'checkDeleteAllForQueryStatus']);
        $tenantGroup->patch('/~/enable', [TenantEnableController::class, 'enableAllForQuery']);
        $tenantGroup->patch('/{uid}/enable', [TenantEnableController::class, 'enable']);
        $tenantGroup->get('/~/enable-status/{uid}', [TenantEnableController::class, 'checkEnableAllForQueryStatus']);
        $tenantGroup->patch('/~/disable', [TenantDisableController::class, 'disableAllForQuery']);
        $tenantGroup->patch('/{uid}/disable', [TenantDisableController::class, 'disable']);
        $tenantGroup->get('/~/disable-status/{uid}', [TenantDisableController::class, 'checkDisableAllForQueryStatus']);
    }
}
